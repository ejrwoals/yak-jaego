# 약국 재고 관리 및 분석 시스템 (Jaego)

> **⚡ 빠른 시작**: `python app.py` 명령 하나로 두 가지 워크플로우 중 선택하여 실행!

## 🏥 프로젝트 개요

**yak-jaego**는 약국의 재고 관리와 사용량 분석을 위한 Python 기반 자동화 도구입니다. 여러 개의 월별 CSV 파일을 자동으로 통합하여 시계열 분석을 수행하고, 시각적으로 이해하기 쉬운 인터랙티브 HTML 보고서를 생성합니다.

### 🔀 두 가지 워크플로우

1. **📊 약국 재고 관리 및 분석 시스템 (시계열 분석)**
   - 월별 CSV 데이터의 시계열 분석 및 트렌드 파악
   - 장기적인 조제 패턴 분석 및 통계 생성

2. **📦 약 주문 수량 산출 시스템** (NEW!)
   - 현재 재고와 과거 소비 패턴 기반 주문 필요 약품 식별
   - 런웨이(재고 소진 예상 기간) 기반 우선순위 정렬

### 📊 주요 기능

#### 공통 기능
- **🔄 월별 CSV 자동 통합**: 여러 개의 월별 CSV 파일을 약품코드 기준으로 자동 병합
- **🧮 다중 인코딩 지원**: UTF-8, CP949, EUC-KR 인코딩 자동 감지
- **💾 데이터 무결성**: 약품코드 string 처리 및 float 형태 자동 정규화

#### 워크플로우 1: 시계열 분석
- **📈 시계열 분석**: 시간에 따른 조제수량 변화 추세 분석 및 3개월 이동평균 계산
- **⚡ 경량 스파크라인**: SVG 기반 초경량 트렌드 차트로 빠른 로딩 (1800+ 약품도 즉시 표시)
- **🎯 On-demand 상세 차트**: 클릭시에만 Plotly 차트 동적 생성으로 성능 최적화
- **🔍 즉각 검색**: 전체 약품 목록에서 실시간 검색

#### 워크플로우 2: 주문 수량 산출 (NEW!)
- **🚨 긴급 주문 식별**: 런웨이 1개월 미만 약품 자동 하이라이트
- **📊 런웨이 이중 계산**: 월평균 및 3개월 이동평균 기반 두 가지 런웨이 제공
- **🎨 색상 코딩**: 재고 부족 약품을 빨간색으로 강조 표시
- **📋 자동 정렬**: 런웨이 오름차순으로 긴급도 순서 정렬
- **🌐 전문적인 HTML 보고서**: 반응형 인터랙티브 대시보드 자동 생성

## 🚀 빠른 시작

### 필수 요구사항

- Python 3.7 이상
- pip (Python 패키지 관리자)

### 설치 방법

1. **저장소 클론**
   ```bash
   git clone https://github.com/ejrwoals/yak-jaego.git
   cd yak-jaego
   ```

2. **가상환경 설정 (권장)**
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```

3. **의존성 설치**
   ```bash
   pip install -r requirements.txt
   ```

### 데이터 준비

#### 워크플로우 1 (시계열 분석)에 필요한 데이터

1. **Excel 파일을 월별 CSV로 변환**:
   - Excel에서 월별 약품 사용량 파일을 엽니다
   - `파일` → `다른 이름으로 저장` → `CSV(쉼표로 분리)(*.csv)` 선택
   - 파일명에 날짜 정보 포함 (예: `2025-01.csv`, `2025-02.csv` 또는 `202501.csv` 형식)
   - `data/` 폴더에 모든 월별 파일을 저장합니다

2. **CSV 파일 형식 요구사항**:
   - `약품명`: 의약품명
   - `제약회사`: 제조회사명
   - `약품코드`: 고유 식별 코드 (숫자/문자 혼합 가능, 자동으로 string 처리)
   - `재고수량`: 현재 재고량
   - `조제수량`: 해당 월의 사용량

3. **파일명 규칙**:
   - 지원 형식: `YYYY-MM.csv`, `YYYYMM.csv`, `YYYY_MM.csv`, `YYYY년 MM월.csv`
   - 예시: `2025-01.csv`, `202501.csv`, `2025_01.csv`, `2025년 1월.csv`

#### 워크플로우 2 (주문 수량 산출)에 필요한 데이터

1. **today.csv 파일 준비**:
   - 현재 시점의 재고 현황을 담은 CSV 파일
   - 루트 디렉토리에 `today.csv`로 저장
   - 필수 컬럼: `약품명`, `약품코드`, `제약회사`, `재고수량`

2. **processed_inventory_timeseries.csv**:
   - 워크플로우 1을 먼저 실행하여 자동 생성
   - 과거 조제 패턴 데이터가 포함됨

## 📖 사용 방법

### 🎯 메인 실행 (권장)

```bash
python app.py
```

**워크플로우 선택 메뉴가 표시됩니다:**
```
🏥 Jaego - 약국 재고 관리 시스템
============================================================

사용 가능한 워크플로우:
  1. 약국 재고 관리 및 분석 시스템 (시계열 분석)
  2. 약 주문 수량 산출 시스템
  0. 종료

============================================================
실행할 워크플로우 번호를 입력하세요:
```

### 워크플로우 1: 시계열 분석

**실행 과정:**
1. `data/` 폴더에서 월별 CSV 파일 자동 감지 및 로드
2. 약품코드 기준으로 데이터 자동 통합
3. 시계열 통계 계산 (월평균, 3개월 이동평균, 런웨이)
4. 처리된 데이터를 `processed_inventory_timeseries.csv`로 저장
5. 경량 HTML 보고서 생성 및 브라우저에서 자동 열기

**출력 파일:**
- `processed_inventory_timeseries.csv`: 통합 시계열 데이터
- `inventory_report_YYYYMMDD_HHMMSS.html`: 시계열 분석 보고서

### 워크플로우 2: 주문 수량 산출 (NEW!)

**실행 전 요구사항:**
- `today.csv`: 현재 재고 현황 파일
- `processed_inventory_timeseries.csv`: 워크플로우 1을 먼저 실행하여 생성

**실행 과정:**
1. 시계열 분석 데이터 로드 (`processed_inventory_timeseries.csv`)
2. 오늘의 재고 데이터 로드 (`today.csv`)
3. 데이터 병합 및 런웨이 계산
   - 월평균 조제수량 기반 런웨이
   - 3개월 이동평균 기반 런웨이
4. HTML/CSV 보고서 생성 (런웨이 오름차순 정렬)

**출력 파일:**
- `order_calc_reports/order_calculator_report_YYYYMMDD_HHMMSS.html`: 주문 권장 보고서
- `order_calc_reports/order_calculator_report_YYYYMMDD_HHMMSS.csv`: 주문 권장 데이터

**보고서 특징:**
- 🚨 런웨이 < 1개월 약품은 빨간색으로 강조
- 📊 긴급도 순서로 자동 정렬
- 📈 월평균 및 3개월 이동평균 기반 이중 런웨이 제공

### 📂 개별 모듈 실행 (고급 사용자)

```bash
# 1. CSV 데이터 처리만
python read_csv.py

# 2. 시계열 보고서 생성만 (processed_inventory_timeseries.csv 필요)
python generate_report.py

# 3. 주문 수량 산출만 (today.csv 및 processed_inventory_timeseries.csv 필요)
python drug_order_calculator.py
```

### 📊 보고서 사용법

#### 워크플로우 1: 시계열 분석 보고서

1. **빠른 트렌드 확인**: 테이블의 "트렌드" 컬럼에서 각 약품의 조제수량 변화를 스파크라인으로 즉시 확인
   - 검정 점선: 실제 월별 조제수량
   - 주황색 실선: 3개월 이동평균 (더 안정적인 추세)

2. **상세 분석**: 약품 행을 클릭하면 모달로 상세 차트 표시
   - 월별 조제수량 추이
   - 3개월 이동평균선
   - 전체 평균선
   - 인터랙티브 줌/팬 기능

3. **실시간 검색**: 상단 검색창에서 약품명, 제약회사, 약품코드로 즉시 검색

**보고서 내용:**
- 📈 재고 현황 요약 통계 (총 약품 수, 데이터 기간, 총 재고수량, 월평균 총 조제량)
- 📊 런웨이 분석 차트 (재고 부족/충분 약품 분류)
- 🔍 상세 재고 테이블 (검색/정렬 기능)
  - 약품명, 제약회사, 약품코드
  - 재고수량, 월평균 조제수량, 런웨이
  - 트렌드 스파크라인
- ⚠️ 주의사항 약품 목록 (재고 부족 3개월 이하)
- 📱 반응형 디자인 (모바일 최적화)

#### 워크플로우 2: 주문 수량 산출 보고서 (NEW!)

1. **요약 대시보드**: 총 약품 수 및 긴급 주문 필요 약품 개수 확인

2. **우선순위 테이블**: 런웨이 오름차순으로 정렬된 약품 목록
   - 🔴 빨간색 행: 런웨이 < 1개월 (긴급 주문 필요)
   - ⚪ 흰색 행: 런웨이 ≥ 1개월 (정상)

3. **이중 런웨이 계산**:
   - 월평균 조제수량 기반 런웨이
   - 3개월 이동평균 기반 런웨이 (계절성 반영)

**보고서 내용:**
- 📊 요약 통계 (총 약품 수, 긴급 주문 필요 약품 수)
- 📋 상세 약품 테이블
  - 약품명, 약품코드, 제약회사
  - 현재 재고수량
  - 월평균 조제수량, 3개월 이동평균
  - 런웨이 (개월), 3-MA 런웨이 (개월)
- 🎨 색상 코딩으로 긴급도 시각화
- 📱 반응형 디자인 (모바일 최적화)

## 📁 프로젝트 구조

```
yak-jaego/
├── data/                          # 입력 CSV 데이터 폴더
│   ├── 2023-09.csv                # 2023년 9월 데이터
│   ├── 2023-10.csv                # 2023년 10월 데이터
│   ├── 2024-01.csv                # 2024년 1월 데이터
│   ├── ...                        # 기타 월별 데이터
│   └── 2025-09.csv                # 2025년 9월 데이터
├── order_calc_reports/            # 주문 수량 산출 보고서 폴더 (자동 생성)
│   ├── order_calculator_report_YYYYMMDD_HHMMSS.html
│   └── order_calculator_report_YYYYMMDD_HHMMSS.csv
├── app.py                         # 🎯 메인 워크플로우 선택기 (권장)
├── read_csv.py                    # CSV 데이터 읽기 및 시계열 통합 모듈
├── generate_report.py             # 시계열 분석 HTML 보고서 생성 모듈
├── drug_order_calculator.py       # 📦 주문 수량 산출 모듈 (NEW!)
├── requirements.txt               # Python 의존성 목록
├── today.csv                      # 현재 재고 현황 (워크플로우 2에 필요)
├── processed_inventory_timeseries.csv  # 처리된 시계열 데이터 (생성됨)
├── inventory_report_YYYYMMDD_HHMMSS.html  # 시계열 분석 보고서
└── README.md                      # 프로젝트 문서
```

## 🔧 상세 기능

### app.py - 워크플로우 선택 및 실행

#### 주요 특징:
- **워크플로우 선택 메뉴**: 2가지 분석 방법 중 선택 가능
- **원스톱 솔루션**: 하나의 명령어로 전체 분석 과정 완료
- **단계별 진행**: 명확한 워크플로우
- **자동화**: 월별 파일 감지, 통합, 분석 모두 자동
- **오류 처리**: 문제 발생시 친절한 안내 메시지

### read_csv.py - CSV 데이터 처리 엔진

#### 주요 기능:

1. **월별 CSV 파일 자동 로드** (`load_multiple_csv_files`)
   - `data/` 폴더의 모든 CSV 파일 스캔
   - 파일명에서 날짜 정보 자동 추출 (정규표현식 사용)
   - 다중 인코딩 자동 감지 (UTF-8, CP949, EUC-KR)
   - 시간순 정렬

2. **약품코드 기준 시계열 통합** (`merge_by_drug_code`)
   - 약품코드를 string으로 일관성있게 처리
   - **float 형태 자동 정규화**: `673400030.0` → `673400030` (중복 방지)
   - 각 약품별로 월별 조제수량 시계열 데이터 구축
   - 가장 최근 월의 재고수량 저장

3. **통계 계산** (`calculate_statistics`)
   - 월평균 조제수량 산출
   - 3개월 이동평균 계산 (추세 파악용)
   - 런웨이 계산 (재고 소진 예상 기간)

#### 데이터 무결성 보장:

```python
# 약품코드 정규화 예시
"673400030"   → "673400030"   # 이미 정수형
"673400030.0" → "673400030"   # float 형태 정규화
"ZP123456"    → "ZP123456"    # 문자 혼합 코드
```

#### 런웨이 계산 로직:

```python
runway_months = 최종_재고수량 / 월평균_조제수량

# 표시 형식:
# 1개월 이상: "X.XX개월"
# 1개월 미만: "X.XX일" (1개월 = 30.417일)
```

### generate_report.py - 시계열 분석 시각화 및 보고서 (성능 최적화)

#### 최적화 전략:

1. **경량 SVG 스파크라인** (`create_sparkline_svg`)
   - Plotly 대신 순수 SVG `<polyline>` 사용
   - 파일 크기: 수십 MB → 수 MB로 감소
   - 로딩 속도: 10초+ → 1-2초로 개선
   - 검정 점선(실제 값) + 주황색 실선(3개월 이동평균)

2. **On-demand 차트 생성**
   - 상세 차트는 클릭시에만 JavaScript로 동적 생성
   - 차트 데이터를 `data-chart-data` 속성에 JSON으로 저장
   - 차트 캐시로 중복 생성 방지

3. **즉각 검색 유지**
   - 전체 데이터가 HTML에 포함되어 즉시 검색 가능
   - JavaScript 기반 클라이언트 사이드 필터링

#### 보고서 구성요소:

1. **대시보드 요약**
   - 총 약품 수
   - 데이터 기간 (자동 계산)
   - 총 재고 수량
   - 월평균 총 조제량

2. **런웨이 분석 차트**
   - 재고 부족 약품 (런웨이 3개월 이하) - 색상 그라디언트

### drug_order_calculator.py - 주문 수량 산출 모듈 (NEW!)

#### 주요 기능:

1. **데이터 로드 및 전처리**
   - `processed_inventory_timeseries.csv`에서 과거 소비 패턴 로드
   - `today.csv`에서 현재 재고 현황 로드
   - numpy 타입 표기 파싱 (예: `np.int64(34)` → `34`)
   - 약품코드 기준으로 데이터 병합

2. **런웨이 계산**
   - **월평균 런웨이**: 현재 재고수량 / 월평균 조제수량
   - **3-MA 런웨이**: 현재 재고수량 / 3개월 이동평균
   - 무한대 값 처리 (조제수량이 0인 경우 → 999로 표시)

3. **우선순위 정렬**
   - 런웨이 오름차순 정렬 (긴급도 순서)
   - 런웨이 < 1개월 약품 자동 강조

4. **보고서 생성**
   - HTML 보고서: 색상 코딩 포함 인터랙티브 테이블
   - CSV 보고서: 엑셀 등에서 후처리 가능
   - `order_calc_reports/` 디렉토리에 자동 저장

#### 런웨이 계산 로직:

```python
# 월평균 기반
runway = 현재_재고수량 / 월평균_조제수량

# 3개월 이동평균 기반
ma3_runway = 현재_재고수량 / 3개월_이동평균

# 긴급 주문 판단
if runway < 1.0 or ma3_runway < 1.0:
    # 빨간색으로 강조 표시
    is_urgent = True
```
   - 재고 충분 약품 (런웨이 3개월 초과) - 녹색
   - 페이지네이션 지원 (30개씩)

3. **상세 데이터 테이블**
   - 실시간 검색 기능
   - 클릭 가능한 행 (모달 트리거)
   - 경량 SVG 스파크라인 표시
   - 모바일 반응형

4. **모달 상세 차트** (클릭시 표시)
   - 월별 조제수량 라인 차트
   - 3개월 이동평균선
   - 전체 평균 기준선
   - Plotly 인터랙티브 기능 (줌, 팬, 호버)

#### 기술 스택:
- **Backend**: Python, Pandas, NumPy
- **Visualization**: Plotly.js (on-demand), SVG (inline)
- **Frontend**: HTML5, CSS3, Vanilla JavaScript
- **Styling**: 현대적인 그라디언트 디자인, 반응형 그리드

## 🎯 핵심 개선 사항

### v2.0 주요 업데이트

1. **시계열 분석 기능 추가**
   - 단일 CSV → 여러 월별 CSV 통합 분석
   - 시간에 따른 조제수량 변화 추적
   - 3개월 이동평균으로 안정적인 추세 파악

2. **성능 대폭 개선**
   - 1800+ 약품 로딩 시간: 10초+ → 1-2초
   - HTML 파일 크기: 수십 MB → 수 MB
   - 검색 반응 속도 유지

3. **데이터 무결성 강화**
   - 약품코드 float 형태 자동 정규화
   - 같은 약품의 중복 라인 자동 병합
   - string 타입 일관성 보장

4. **UX 개선**
   - 테이블에서 즉시 트렌드 확인 (스파크라인)
   - 클릭시 상세 분석 (모달)
   - 전체 검색 성능 유지

## 📊 샘플 데이터

프로젝트에 포함된 샘플 CSV 데이터:
- 2023년 9월 ~ 2025년 9월 (25개월)
- 월별 CSV 파일 형태
- 약품 1800+ 종류
- 실제 약국 운영 패턴을 반영한 데이터

## 🛠️ 고급 설정

### 파일명 패턴 커스터마이징

`read_csv.py`의 `extract_month_from_file` 함수에서 정규표현식 수정:

```python
patterns = [
    r'(\d{4})[-_]?(\d{2})',  # 2025-01, 202501, 2025_01
    r'(\d{4})년\s*(\d{1,2})월',  # 2025년 1월
    # 추가 패턴...
]
```

### 스파크라인 스타일 커스터마이징

`generate_report.py`의 `create_sparkline_svg` 함수에서 색상/선 스타일 수정:

```python
# 실제 값 라인
stroke="black" stroke-dasharray="2,2" stroke-width="1"

# 3개월 이동평균 라인
stroke="orange" stroke-width="2"
```

### 보고서 테마 커스터마이징

`generate_report.py`의 CSS 섹션에서 색상 테마 변경:

```css
/* 메인 그라디언트 */
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
```

### 알림 임계값 설정

런웨이 경고 기준 변경:

```python
# generate_report.py의 analyze_runway 함수에서
if months <= 3:  # 3개월 이하 → 부족 경고
    low_data.append((months, row['약품명']))
else:
    high_data.append((months, row['약품명']))
```

## 🔍 문제 해결

### 일반적인 오류 및 해결방법

1. **CSV 파일 읽기 오류**
   ```
   해결: Excel에서 'CSV(UTF-8)(*.csv)' 형식으로 다시 저장
   ```

2. **파일명 날짜 인식 오류**
   ```
   해결: 파일명을 YYYY-MM.csv 또는 YYYYMM.csv 형식으로 변경
   예: 2025-01.csv, 202501.csv
   ```

3. **약품코드 중복 문제**
   ```
   해결: 자동으로 float 형태(.0) 제거 및 통합됨
   예: 673400030과 673400030.0이 자동으로 하나로 병합
   ```

4. **인코딩 오류**
   ```
   해결: UTF-8, CP949, EUC-KR 자동 감지 및 변환
   ```

5. **데이터 형식 오류**
   ```
   해결: Excel에서 숫자 형식 확인 후 CSV로 재저장
   ```

6. **보고서 로딩 느림**
   ```
   해결: v2.0에서 대폭 개선됨 (경량 SVG 스파크라인 사용)
   1800+ 약품도 1-2초 내 로딩
   ```

7. **모달이 열리지 않음**
   ```
   해결: 브라우저 콘솔에서 JavaScript 에러 확인
   최신 브라우저 사용 권장 (Chrome, Firefox, Safari)
   ```
