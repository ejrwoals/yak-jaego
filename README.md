# 약국 재고 관리 및 분석 시스템 (Jaego)

> **⚡ 빠른 시작**:
> 1. **관리자**: `python init_db.py` (최초 1회, DB 초기화) 또는 웹 UI에서 DB 재생성 버튼 클릭
> 2. **사용자**: `python web_app.py` (웹 브라우저에서 실행)

## 🏥 프로젝트 개요

**yak-jaego**는 약국의 재고 관리와 사용량 분석을 위한 Python 기반 자동화 도구입니다. SQLite 데이터베이스 기반으로 여러 개의 월별 데이터 파일(CSV, XLS, XLSX)을 통합하여 시계열 분석을 수행하고, 시각적으로 이해하기 쉬운 인터랙티브 HTML 보고서를 생성합니다.

### 🎯 핵심 아키텍처

**SQLite 데이터베이스 기반 시스템**
- `recent_inventory.sqlite3`: 각 약품의 최신 재고 수량 저장
- `processed_inventory.sqlite3`: 시계열 통계 데이터 (1년 이동평균, 3개월 이동평균, 런웨이 등)
- `checked_items.sqlite3`: 긴급 약품 확인 상태 저장
- `drug_thresholds.sqlite3`: 개별 약품 임계값 설정 저장
- `drug_memos.sqlite3`: 통합 메모 저장 (모든 보고서에서 공유)
- `patients.sqlite3`: 환자 정보 저장 (환자명, 주민번호 앞자리(필수, 6자리), 방문주기_일)
- `drug_patient_map.sqlite3`: 약품-환자 매핑 저장 (many-to-many 관계, 1회_처방량 포함)
- `drug_flags.sqlite3`: 특별관리 플래그 저장 (별표 토글)
- `drug_periodicity.sqlite3`: 약품별 주기성 지표 저장 (avg_interval, interval_cv, height_cv, acf_max, peak_count, active_months_ratio)
- `suggestion_skips.sqlite3`: 약품 추천 건너뛰기 기록 저장
- ⚠️ **DB 재생성 시 보존되는 데이터**: "DB 재생성" 버튼은 `recent_inventory`와 `processed_inventory`만 재생성하며, 사용자 설정 DB(`checked_items`, `drug_thresholds`, `drug_memos`, `patients`, `drug_patient_map`, `drug_flags`, `suggestion_skips`)는 영향받지 않음. 단, `drug_periodicity`는 재계산됨
- **약품별 최신 재고 추적**: 각 약품마다 가장 최근에 기록된 재고를 자동 채택
- **음수 재고 지원**: 마이너스 재고도 정확히 반영
- **확인 상태 영구 저장**: 체크한 긴급 약품 상태를 DB에 보존하여 재확인 피로 감소

### 🔀 세 가지 워크플로우

1. **📊 재고 관리 보고서**
   - 사용자 정의 N개월 이동평균 (1~12개월 선택 가능)
   - 단일 런웨이 지표로 진입장벽 낮춤
   - 초보자 및 일상적 사용에 최적화
   - N개월 이동평균 기준 내림차순 정렬

2. **📦 약 주문 수량 산출**
   - **today.csv에 있는 약품만** 표시 (오늘 나간 약품)
   - 현재 재고와 과거 소비 패턴 기반 주문 필요 약품 식별
   - 메인 테이블: 3개월 이동평균 기반 런웨이로 간소화 (빠른 파악용)
   - 📅 당일 소모량: today 파일의 조제수량(전문약)/판매수량(일반약) 통합 표시
   - 📊 트렌드 아이콘: 3개월 vs 1년 이동평균 비교로 사용 추세 표시 (📈 상승, ➖ 유지, 📉 하락)
   - 📈 인라인 차트: 테이블 행 클릭 시 통계 카드(1년/3개월 이동평균 및 런웨이) + 트렌드 차트 + 주문량 계산기 확장
   - 🧮 주문량 계산기: 1/2/3개월 목표 런웨이별 필요 주문 수량 자동 계산

3. **📈 고변동성 약품 보고서**
   - **CV (Coefficient of Variation)** 기반 변동성 분석: 표준편차 / 평균
   - 3단계 분류: 고변동성(CV > 0.5), 중변동성(0.3 ≤ CV ≤ 0.5), 저변동성(CV < 0.3)
   - 사용자 정의 임계값: 슬라이더로 고/중/저 경계 조절 가능
   - **분석 기간 선택**: 전체 기간, 최근 3/6/9/12/24개월 중 선택 (기본 12개월)
   - 📊 산점도 (Plotly): X축 평균 사용량, Y축 CV - 관리 우선순위 시각화
   - 메인 테이블: CV 내림차순 정렬, 스파크라인, 인라인 차트, 메모 기능
   - **3분류 시스템**: 가중 등장률 기반으로 정규/단발성/신규 약품 자동 분류
   - 📌 **단발성 약품**: 가중 등장률 < 20% + 최근 2개월 내 등장 없음 (보라색 사이드바 책갈피 + 모달)
   - 🆕 **신규 약품**: 가중 등장률 < 20% + 최근 2개월 내 등장 있음 (초록색 사이드바 책갈피 + 모달)
   - 재고 관리가 어려운 "들쭉날쭉" 약품 식별에 최적화

### 📊 주요 기능

#### 공통 기능
- **🗄️ SQLite 데이터베이스**: 안정적인 데이터 저장 및 관리
- **🔄 월별 CSV 자동 통합**: 여러 개의 월별 CSV 파일을 약품코드 기준으로 자동 병합
- **🧮 다중 인코딩 지원**: UTF-8, CP949, EUC-KR 인코딩 자동 감지
- **💾 데이터 무결성**: 약품코드 string 처리 및 float 형태 자동 정규화
- **📅 최신 재고 자동 채택**: 각 약품별로 가장 최근 월의 재고 자동 선택
- **➖ 음수 재고 지원**: 마이너스 재고 정확히 반영
- **⚙️ 약품 개별 관리**: 통합 관리 페이지에서 재고 수정, 약품명 수정, 임계값 설정, 메모 관리, 환자 태그, 특별관리 플래그를 한 곳에서 관리
- **🎯 최소 안전 재고량 자동 설정**: 환자-약품 연결 시 등록된 환자들의 최대 처방량을 임계값으로 자동 저장 (기존 임계값보다 높은 경우에만 업데이트되어 수동 설정값을 덮어쓰지 않음)
- **👥 환자 관리**: 환자 관리 페이지(`/patient/manage`)에서 환자별 약품 재고 상태를 한눈에 확인 (부족/딱맞음/충분 3단계 표시)
- **💡 약품 추천**: 약품 추천 페이지(`/patient/suggest`)에서 주기적 사용 패턴을 보이는 약품에 대해 "이 약품을 사용하는 환자는 누구입니까?" 제안 제공
  - Weighted Euclidean Distance + KNN (K=3) 기반 추천 (scipy.cdist 사용)
  - 6차원 Feature Vector: avg_interval(평균 피크 간격), interval_cv(피크 간격 변동계수), height_cv(피크 높이 변동계수), acf_max(자기상관 최대값), peak_count(피크 수), active_months_ratio(활성 월 비율)
  - Feature 가중치: avg_interval(2.0) > interval_cv(1.5) > height_cv(1.0) > acf_max(0.8) > peak_count(0.5) = active_months_ratio(0.5)
  - Pre-filtering: 월평균 사용량 200개 이상인 약품은 추천 대상에서 제외 (정규분포로 근사 가능)
  - 활성화 조건: 약품이 등록된 환자 5명 이상
  - Combobox 형태 환자 검색 (기존 환자 검색 + 신규 환자 즉시 등록)
  - 등록 완료 모달: 3가지 워크플로우 선택 ("이 약품에 환자 추가", "환자의 다른 약품", "다음 추천으로")
  - 검색 기반 약품 등록: 전체 약품 검색 후 선택하여 처방량 입력 (환자의 다른 약품 등록 시)
  - 등록된 약품 참조: 환자에게 이미 등록된 약품을 태그로 표시, 검색 결과에서 중복 등록 방지 (비활성화 처리)
- **📊 동시 방문 대비용 재고 계산**: 환자별 방문주기와 처방량 기반으로 포아송 이항분포를 적용하여 동시 방문 확률을 계산하고, 허용 리스크 수준에 따라 필요한 안전 재고량을 자동 산출

#### 워크플로우 1: 재고 관리 보고서
- **🎯 사용자 정의 이동평균**: 1~12개월 중 선택 가능 (기본 3개월)
- **📊 단일 런웨이 지표**: 하나의 이동평균만 사용하여 직관적 분석
- **⬇️ 스마트 정렬**: N개월 이동평균 기준 내림차순 정렬 (많이 쓰는 약품 우선)
- **💊 전문약/일반약 분리 분석**: 조제수량(전문약) 또는 판매수량(일반약) 기준 선택 가능
- **🧹 깔끔한 랜딩 페이지**: 테이블 기본 숨김, 검색 시에만 일치하는 약품 표시
- **🔍 스마트 검색**: 약품명, 제약회사, 약품코드로 검색 -> 해당 약품만 테이블에 표시
- **📑 통일된 모달 UI**: 모든 탭(긴급/부족/충분/악성재고)에서 동일한 테이블 구조
- **👁 숨김 처리 기능**: 확인 완료된 약품을 숨김 처리하여 목록 정리, 별도 "숨김 약품" 탭에서 관리
- **📈 트렌드 스파크라인**: 모든 모달 테이블에 스파크라인 표시
- **📈 상세 트렌드 모달**: 클릭 시 상세 트렌드 차트 표시, 현재 재고 수준을 빨간 점선으로 표시

#### 워크플로우 2: 주문 수량 산출
- **📋 today.csv 기반 필터링**: 오늘 나간 약품만 표시
- **🔄 자동 재고 업데이트**: today.csv 발견 시 DB 자동 업데이트
- **🎚️ 사용자 정의 강조 임계값**: 슬라이더로 런웨이 기준 조절 (0.5~6개월, 기본 1개월)
- **⚙️ 개별 임계값 설정**: 특정 약품에 별도 재고/런웨이 임계값 설정, 전용 모달에서 상태 카드로 관리
- **🚨 긴급 주문 식별**: 글로벌 임계값 미만 약품 자동 하이라이트 (메인 테이블)
- **🆕 신규 약품 알림**: 시계열 데이터 없는 신규 약품 자동 감지, 사이드바 책갈피로 표시 (hover 시 펼쳐짐)
- **🏷️ 신규 약품 자동 분류**: today 파일의 조제수량/판매수량 기반 전문약/일반약 자동 분류
- **⚠️ 음수 재고 경고**: 재고 < 0인 약품 사이드바 책갈피로 경고 표시
- **📊 메인 테이블 간소화**: 3개월 이동평균 기반 런웨이만 표시 (빠른 파악용)
- **📅 당일 소모량 컬럼**: today 파일의 조제수량(전문약)/판매수량(일반약) 통합 표시
- **🎨 색상 코딩**: 재고 부족 약품을 빨간색으로 강조 표시
- **📋 자동 정렬**: 런웨이 오름차순으로 긴급도 순서 정렬
- **📈 인라인 트렌드 차트**: 테이블 행 클릭 시 통계 카드(1년/3개월 이동평균 및 런웨이 4종) + 조제수량 추이 차트 표시
- **🧮 주문량 계산기**: 목표 런웨이(1/2/3개월) 버튼 선택 시 필요 주문량 자동 계산
- **📊 프로그레스바 시각화**: 현재 런웨이 vs 목표 런웨이를 직관적으로 비교

#### 워크플로우 3: 고변동성 약품 보고서
- **📊 CV (변동계수) 분석**: CV = 표준편차 / 평균으로 사용량 변동성 측정
- **🎚️ 사용자 정의 임계값**: 고/중 경계, 중/저 경계 슬라이더로 조절
- **📅 분석 기간 선택**: 전체 기간, 최근 3/6/9/12/24개월 중 선택 (기본 12개월), 선택 기간 내 사용 이력 없는 약품은 자동 제외
- **🔴🟡🟢 3단계 분류**: 고변동성(CV > 0.5), 중변동성(0.3 ≤ CV ≤ 0.5), 저변동성(CV < 0.3)
- **📈 산점도 시각화 (Plotly)**: X축 평균 사용량, Y축 CV - 우상단 약품이 관리 우선순위
- **🔍 스마트 검색**: 약품명, 제약회사, 약품코드로 검색
- **📑 그룹별 필터**: 요약 카드 클릭 시 해당 그룹만 필터링
- **📈 인라인 차트**: 테이블 행 클릭 시 통계 카드(CV, 가중 등장률, 평균 사용량, 현재 재고, 3개월 이동평균) + 트렌드 차트 표시
- **📊 스파크라인**: 테이블에서 사용량 추이 간략 표시
- **📝 메모 기능**: 약품별 메모 입력/수정 (통합 메모 DB에 저장, 모든 보고서에서 공유)
- **🔄 3분류 시스템**: 가중 등장률 기반 약품 분류
  - **정규 약품**: 가중 등장률 >= 20% (메인 테이블에서 CV 분석)
  - **단발성 약품**: 가중 등장률 < 20% + 최근 2개월 내 등장 없음 (보라색 사이드바 책갈피 + 모달)
  - **신규 약품**: 가중 등장률 < 20% + 최근 2개월 내 등장 있음 (초록색 사이드바 책갈피 + 모달)
- **📌 가중 등장률**: 최근 달에 높은 가중치 부여 (가장 오래된 달 = 0.1, 가장 최근 달 = 1.0, 선형 감소 방식)

## 🚀 빠른 시작

### 필수 요구사항

- Python 3.7 이상
- pip (Python 패키지 관리자)

### 설치 방법

1. **저장소 클론**
   ```bash
   git clone https://github.com/ejrwoals/yak-jaego.git
   cd yak-jaego
   ```

2. **가상환경 설정 (권장)**
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```

3. **의존성 설치**
   ```bash
   pip install -r requirements.txt
   ```

### 데이터 준비

#### 월별 데이터 파일 준비 (필수)

1. **지원하는 파일 형식**:
   - **CSV 파일** (`.csv`): 쉼표로 구분된 텍스트 파일
   - **Excel 파일** (`.xls`, `.xlsx`): Excel 파일을 CSV로 변환할 필요 없이 바로 사용 가능
   - 파일명에 날짜 정보 포함 (예: `2025-01.xlsx`, `2025-02.csv`, `202501.xls`)
   - `data/` 폴더에 모든 월별 파일을 저장합니다

2. **파일 형식 요구사항**:
   - `약품명`: 의약품명
   - `제약회사`: 제조회사명
   - `약품코드`: 고유 식별 코드 (숫자/문자 혼합 가능, 자동으로 string 처리)
   - `재고수량`: 현재 재고량 (음수 가능)
   - `조제수량`: 해당 월의 사용량 (전문약의 경우)
   - `판매수량`: 해당 월의 판매량 (일반약의 경우)

3. **파일명 규칙**:
   - 지원 형식: `YYYY-MM.*`, `YYYYMM.*`, `YYYY_MM.*`, `YYYY년 MM월.*` (확장자: csv, xls, xlsx)
   - 예시: `2025-01.csv`, `202501.xlsx`, `2025_01.xls`, `2025년 1월.csv`

#### today 파일 준비 (주문 수량 산출에 필요)

1. **today 파일** (CSV 또는 Excel 형식):
   - 오늘 나간 약품의 재고 현황을 담은 파일
   - **웹 UI에서 직접 업로드** 가능 (파일명 자유)
   - 지원 형식:
     - `*.csv` (CSV 파일)
     - `*.xls` (Excel 97-2003 파일, 윈도우 호환)
     - `*.xlsx` (최신 Excel 파일)
   - 필수 컬럼: `약품명`, `약품코드`, `제약회사`, `재고수량`
   - 선택 컬럼: `조제수량`, `판매수량` (신규 약품 유형 자동 분류 및 당일 소모량 표시용)
   - **중요**: 업로드한 파일에 있는 약품들만 주문 보고서에 표시됩니다
   - **편의성**: Excel 파일을 CSV로 수동 변환할 필요 없이 바로 사용 가능

## 📖 사용 방법

### 🔧 1단계: DB 초기화 (관리자, 최초 1회)

**방법 1: 터미널 명령어 (권장 - 최초 실행 시)**

```bash
python init_db.py
```

**방법 2: 웹 UI 버튼 (신규 데이터 반영 시)**

1. `python web_app.py` 실행
2. 데이터베이스 정보 섹션 클릭하여 펼치기
3. **🔄 DB 재생성 (새 데이터 반영)** 버튼 클릭
4. 확인 후 자동으로 DB 재생성 완료

**실행 과정:**
1. `data/` 폴더의 모든 월별 데이터 파일 로드 (CSV, XLS, XLSX)
2. 전문약 데이터 처리 및 통계 계산
3. 일반약 데이터 처리 및 통계 계산
4. `recent_inventory.sqlite3` 생성 (각 약품의 최신 재고)
5. `processed_inventory.sqlite3` 생성 (시계열 통계 데이터)
6. `drug_periodicity.sqlite3` 생성 (약품별 주기성 지표 계산)

**생성되는 DB:**
- `recent_inventory.sqlite3`: 현재 재고 데이터
  - 약품코드, 약품명, 제약회사, 약품유형(전문약/일반약), 현재_재고수량
  - 각 약품별로 가장 최근에 기록된 재고를 자동 채택
- `processed_inventory.sqlite3`: 시계열 통계 데이터
  - 1년_이동평균, 월별_조제수량_리스트, 3개월_이동평균_리스트, 런웨이 등
- `drug_periodicity.sqlite3`: 주기성 지표 데이터
  - avg_interval, interval_cv, height_cv, acf_max, peak_count, active_months_ratio, periodicity_score

### 🎯 2단계: 워크플로우 실행 (사용자)

```bash
python web_app.py
```

**실행 과정:**
1. 명령어 실행 시 웹 브라우저가 자동으로 열립니다 (http://127.0.0.1:5000)
2. 랜딩 페이지에서 원하는 워크플로우 버튼 클릭:
   - **재고 관리 보고서**: 전문약/일반약 시계열 분석
   - **약 주문 수량 산출**: 런웨이 기반 주문 계산
   - **고변동성 약품 보고서**: CV 기반 변동성 분석
3. 보고서가 자동으로 생성되어 새 탭에서 열립니다
4. 종료: 웹 UI 우측 하단의 **🛑 종료** 버튼 클릭 (또는 터미널에서 `Ctrl+C`)

**특징:**
- 직관적인 그래픽 인터페이스
- 클릭만으로 워크플로우 실행
- 보고서는 새 탭에서 열려 메인 앱과 독립적으로 사용 가능
- 여러 보고서를 연속으로 생성하고 비교 가능

### 워크플로우 1: 재고 관리 보고서

**실행 과정:**
1. **보고서 유형 선택**:
   - 전문약 보고서 (조제수량 기준)
   - 일반약 보고서 (판매수량 기준)
2. **이동평균 기간 선택**: 1~12개월 중 선택 (기본 3개월)
3. `processed_inventory.sqlite3`에서 데이터 로드
4. 선택한 약품유형만 필터링
5. HTML 보고서 생성 및 브라우저에서 자동 열기

**출력 파일:**
- `inventory_reports/simple_report_YYYYMMDD_HHMMSS.html`: 재고 관리 보고서

**보고서 내용:**
- 재고 현황 요약 통계 (긴급/부족/충분/악성재고)
- 상세 재고 테이블 (검색/정렬 기능, 스파크라인)
- 상세 트렌드 모달 (클릭 시 차트 표시, 현재 재고 수준 빨간 점선 표시)
- 숨김 처리 기능으로 확인 완료 약품 관리

### 워크플로우 2: 주문 수량 산출

**실행 전 요구사항:**
- 오늘 나간 약품의 재고 현황 파일 (csv/xls/xlsx, 웹 UI에서 업로드)
- `processed_inventory.sqlite3`: init_db.py로 생성된 DB
- `recent_inventory.sqlite3`: init_db.py로 생성된 DB

**실행 과정:**
1. 웹 UI에서 재고 현황 파일 업로드 (파일명 자유)
2. 업로드된 파일로 자동으로 `recent_inventory.sqlite3` 업데이트
3. 업로드된 파일에서 오늘 나간 약품 코드 추출
4. processed_inventory DB에서 시계열 통계 로드
5. recent_inventory DB에서 현재 재고 로드 → **업로드 파일 약품만 필터링**
6. 데이터 병합 및 런웨이 계산
7. HTML/CSV 보고서 생성 (런웨이 오름차순 정렬)

**출력 파일:**
- `order_calc_reports/order_calculator_report_YYYYMMDD_HHMMSS.html`: 주문 권장 보고서
- `order_calc_reports/order_calculator_report_YYYYMMDD_HHMMSS.csv`: 주문 권장 데이터

**보고서 특징:**
- 🚨 런웨이 < 1개월 약품은 빨간색으로 강조 (메인 테이블)
- 🆕 **신규 약품 책갈피**: processed_inventory에 없는 신규 약품 자동 감지, 우측 사이드바 책갈피로 표시 (런웨이 계산 불가)
- 🏷️ **신규 약품 자동 분류**: today 파일의 조제수량 > 0 이면 전문약, 판매수량 > 0 이면 일반약으로 자동 분류
- ⚠️ **음수 재고 책갈피**: 재고 < 0인 약품을 우측 사이드바 책갈피로 경고 표시
- 📋 오늘 나간 약품만 표시 (업로드된 파일 기준)
- 📊 긴급도 순서로 자동 정렬
- 📊 **메인 테이블 간소화**: 3개월 이동평균 기반 런웨이만 표시 (빠른 파악용)
- 📅 **당일 소모량 컬럼**: today 파일의 조제수량(전문약)/판매수량(일반약) 통합 표시
- 📊 **트렌드 아이콘**: 3개월 이동평균과 1년 이동평균 비교로 사용 추세 한눈에 파악 (📈 +15% 이상 상승, ➖ ±15% 이내 유지, 📉 -15% 이상 하락)
- 📈 **인라인 트렌드 차트**: 테이블 행 클릭 시 통계 카드(1년/3개월 이동평균 및 런웨이 4종) + 조제수량 추이 차트 표시
- 🧮 **주문량 계산기**: 목표 런웨이(1/2/3개월) 선택 시 필요 주문량 자동 계산
- 📊 **프로그레스바**: 현재 런웨이 vs 목표 런웨이 시각적 비교

### 워크플로우 3: 고변동성 약품 보고서

**실행 과정:**
1. **약품 유형 선택**: 전문약 (조제수량 기준) 또는 일반약 (판매수량 기준)
2. **분석 기간 선택**: 전체 기간, 최근 3/6/9/12/24개월 중 선택 (기본 12개월)
3. **CV 임계값 설정**: 슬라이더로 고/중 경계, 중/저 경계 조절
4. `processed_inventory.sqlite3`에서 시계열 데이터 로드 및 선택 기간으로 슬라이싱
5. 선택 기간 내 사용 이력이 없는 약품 자동 제외
6. 각 약품별 CV 계산 및 변동성 그룹 분류
7. HTML 보고서 생성 및 브라우저에서 자동 열기 (헤더에 분석 기간 표시)

**출력 파일:**
- `volatility_reports/volatility_report_[mode]_YYYYMMDD_HHMMSS.html`: 고변동성 약품 보고서

**보고서 내용:**
- 변동성 요약 통계 (고/중/저 그룹별 개수)
- 산점도: 평균 사용량 vs CV (관리 우선순위 시각화)
- 상세 테이블: CV 내림차순 정렬, 스파크라인, 사용량 범위
- 인라인 차트: 행 클릭 시 통계 카드(CV, 가중 등장률, 평균 사용량, 현재 재고, 3개월 이동평균) + 트렌드 차트 표시
- 📌 **단발성 약품 책갈피**: 가중 등장률 20% 미만 + 최근 2개월 내 등장 없는 약품 (보라색 사이드바 책갈피 + 모달)
- 🆕 **신규 약품 책갈피**: 가중 등장률 20% 미만 + 최근 2개월 내 등장 있는 약품 (초록색 사이드바 책갈피 + 모달)

**활용 방법:**
- 우상단 (고사용량 + 고변동성) 약품: 관리 우선순위 높음, 안전재고 확대 필요
- 고변동성 약품: 사용량 예측이 어려우므로 더 많은 버퍼 재고 필요
- 저변동성 약품: 예측이 쉬우므로 적정 재고로 효율적 관리 가능

### 🔄 재고 업데이트 (선택 사항)

today 파일을 업데이트한 후 DB만 갱신하고 싶을 때:

```bash
python inventory_updater.py
```

**동작:**
- today 파일(csv/xls/xlsx)의 재고 정보를 `recent_inventory.sqlite3`에 반영
- UPSERT 방식으로 안전하게 업데이트 (중복 실행해도 안전)
- 워크플로우 2를 실행하면 자동으로 실행되므로 선택 사항

## 📁 프로젝트 구조

```
yak-jaego/
├── data/                          # 입력 데이터 폴더 (CSV, XLS, XLSX)
│   ├── 2023-09.csv                # 2023년 9월 데이터
│   ├── 2023-10.xlsx               # 2023년 10월 데이터
│   ├── 2024-01.xls                # 2024년 1월 데이터
│   └── ...                        # 기타 월별 데이터
├── templates/                     # 웹 UI HTML 템플릿 폴더
│   ├── index.html                 # 랜딩 페이지
│   ├── drug_manage.html           # 약품 개별 관리 페이지 (통합 관리)
│   ├── patient_manage.html        # 환자 관리 페이지 (환자별 약품 재고 상태)
│   ├── patient_suggest.html       # 약품 추천 페이지 (주기성 기반 환자-약품 매칭)
│   ├── workflow_simple.html       # 재고 관리 워크플로우 페이지
│   ├── workflow_order.html        # 주문 계산 워크플로우 페이지
│   ├── workflow_volatility.html   # 고변동성 약품 보고서 워크플로우 페이지
│   └── error.html                 # 에러 페이지
├── inventory_reports/             # 재고 관리 보고서 폴더 (자동 생성)
│   └── simple_report_YYYYMMDD_HHMMSS.html      # 재고 관리 보고서 (N-MA)
├── order_calc_reports/            # 주문 수량 산출 보고서 폴더 (자동 생성)
│   ├── order_calculator_report_YYYYMMDD_HHMMSS.html
│   └── order_calculator_report_YYYYMMDD_HHMMSS.csv
├── volatility_reports/            # 고변동성 약품 보고서 폴더 (자동 생성)
│   └── volatility_report_YYYYMMDD_HHMMSS.html  # 고변동성 약품 보고서 (CV 분석)
├── init_db.py                     # 🔧 DB 초기화 스크립트 (관리자용)
├── web_app.py                     # 🌐 웹 UI 메인 애플리케이션 (사용자용)
├── read_csv.py                    # CSV 데이터 읽기 및 시계열 통합 모듈
├── generate_single_ma_report.py   # 재고 관리 HTML 보고서 생성 모듈 (N-MA)
├── generate_volatility_report.py  # 고변동성 약품 보고서 생성 모듈 (CV 분석)
├── drug_order_calculator.py       # 주문 수량 산출 모듈
├── inventory_db.py                # recent_inventory.sqlite3 관리 모듈
├── processed_inventory_db.py      # processed_inventory.sqlite3 관리 모듈
├── checked_items_db.py            # checked_items.sqlite3 관리 모듈 (체크 상태 저장)
├── drug_thresholds_db.py          # drug_thresholds.sqlite3 관리 모듈 (개별 임계값)
├── drug_memos_db.py               # drug_memos.sqlite3 관리 모듈 (통합 메모)
├── patients_db.py                 # patients.sqlite3 관리 모듈 (환자 정보)
├── drug_patient_map_db.py         # drug_patient_map.sqlite3 관리 모듈 (약품-환자 매핑)
├── drug_flags_db.py               # drug_flags.sqlite3 관리 모듈 (특별관리 플래그)
├── drug_periodicity_db.py         # drug_periodicity.sqlite3 관리 모듈 (주기성 지표)
├── suggestion_db.py               # suggestion_skips.sqlite3 관리 모듈 (건너뛰기 기록)
├── periodicity_calculator.py      # 주기성 지표 계산 모듈 (interval_cv, height_cv, acf_max)
├── suggestion_engine.py           # 약품 추천 엔진 (Feature Vector 코사인 유사도)
├── buffer_calculator.py           # 동시 방문 대비용 재고 계산 모듈 (포아송 이항분포)
├── inventory_updater.py           # 재고 업데이트 모듈 (today 파일 → DB)
├── utils.py                       # 공통 유틸리티 함수 (Excel 파일 읽기 포함)
├── requirements.txt               # Python 의존성 목록
├── today.csv/xls/xlsx             # 오늘 나간 약품의 재고 현황 (사용자 제공)
├── recent_inventory.sqlite3       # 최신 재고 DB (자동 생성)
├── processed_inventory.sqlite3    # 시계열 통계 DB (자동 생성)
├── checked_items.sqlite3          # 체크 상태 DB (자동 생성)
├── drug_thresholds.sqlite3        # 개별 임계값 DB (자동 생성)
├── drug_memos.sqlite3             # 통합 메모 DB (자동 생성)
├── patients.sqlite3               # 환자 정보 DB (자동 생성)
├── drug_patient_map.sqlite3       # 약품-환자 매핑 DB (자동 생성)
├── drug_flags.sqlite3             # 특별관리 플래그 DB (자동 생성)
├── drug_periodicity.sqlite3       # 주기성 지표 DB (자동 생성, init_db 시 재계산)
├── suggestion_skips.sqlite3       # 추천 건너뛰기 기록 DB (자동 생성)
└── README.md                      # 프로젝트 문서
```

## 🔧 상세 기능

### init_db.py - DB 초기화 (관리자용)

#### 주요 기능:
- **월별 데이터 통합**: data/ 폴더의 모든 데이터 파일(CSV, XLS, XLSX) 로드 및 통합
- **전문약/일반약 처리**: 두 가지 약품 유형을 모두 처리하여 DB에 저장
- **최신 재고 채택**: 각 약품별로 가장 최근 월의 재고를 자동 선택
- **통계 계산**: 1년 이동평균 (12개월), 3개월 이동평균, 런웨이 자동 계산
- **주기성 지표 계산**: 각 약품별 interval_cv, height_cv, acf_max, periodicity_score 계산
- **DB 생성**: recent_inventory.sqlite3, processed_inventory.sqlite3, drug_periodicity.sqlite3 생성

#### 실행 단계:
1. Step 1~3: 월별 데이터 로드 및 전문약/일반약 처리
2. Step 4: recent_inventory.sqlite3 및 processed_inventory.sqlite3 생성
3. Step 4.5: drug_periodicity.sqlite3 주기성 지표 계산 (약품 추천 기능용)

#### 실행 시점:
- 최초 설치 후 1회
- 새로운 월별 데이터가 추가되었을 때
- DB 재구축이 필요할 때

### web_app.py - 웹 UI 메인 애플리케이션 (사용자용)

#### 주요 특징:
- **Flask 기반 웹 인터페이스**: 브라우저에서 직관적으로 사용
- **DB 준비 상태 확인**: 두 개의 DB 존재, 데이터 개수, 데이터 기간 표시
- **DB 재생성 버튼**: 웹 UI에서 직접 DB 재생성 가능 (터미널 명령어 불필요)
- **워크플로우 선택**: 랜딩 페이지에서 버튼 클릭으로 워크플로우 실행
- **새 탭 보고서**: 보고서가 새 탭에서 열려 메인 앱과 독립적으로 사용
- **오류 처리**: DB 없으면 init_db.py 실행 안내

### inventory_db.py - 최신 재고 DB 관리

#### 주요 기능:
- `recent_inventory.sqlite3` 관리
- **재고 업데이트 시점** (4가지 상황):
  1. `init_db.py` 실행 시 (DB 초기화/재생성)
  2. `inventory_updater.py` CLI 실행 시
  3. 웹 UI에서 today 파일 업로드 시 (`/api/calculate-order`)
  4. 웹 UI에서 개별 약품 재고 수정 시 (`/api/update-inventory`) ← v3.10 신규
- 테이블 스키마:
  ```sql
  CREATE TABLE recent_inventory (
      약품코드 TEXT PRIMARY KEY,
      약품명 TEXT,
      제약회사 TEXT,
      약품유형 TEXT,  -- '전문약' 또는 '일반약'
      현재_재고수량 REAL,  -- 음수 가능
      최종_업데이트일시 TEXT
  )
  ```
- UPSERT 연산 지원 (INSERT OR REPLACE)

### processed_inventory_db.py - 시계열 통계 DB 관리

#### 주요 기능:
- `processed_inventory.sqlite3` 관리
- 테이블 스키마:
  ```sql
  CREATE TABLE processed_inventory (
      약품코드 TEXT PRIMARY KEY,
      약품명 TEXT,
      제약회사 TEXT,
      약품유형 TEXT,
      "1년_이동평균" REAL,
      최종_재고수량 REAL,
      런웨이 TEXT,
      월별_조제수량_리스트 TEXT,  -- JSON
      "3개월_이동평균_리스트" TEXT,  -- JSON
      최종_업데이트일시 TEXT
  )
  ```
- JSON 직렬화로 Python 리스트 저장
- numpy 타입 자동 변환

### read_csv.py - 데이터 처리 엔진

#### 주요 기능:

1. **월별 데이터 파일 자동 로드** (`load_multiple_csv_files`)
   - `data/` 폴더의 모든 데이터 파일(CSV, XLS, XLSX) 스캔
   - 파일명에서 날짜 정보 자동 추출 (정규표현식 사용)
   - CSV: 다중 인코딩 자동 감지 (UTF-8, CP949, EUC-KR)
   - Excel: calamine(xls) 및 openpyxl(xlsx) 엔진으로 자동 처리
   - 시간순 정렬

2. **약품코드 기준 시계열 통합** (`merge_by_drug_code`)
   - **전문약/일반약 모드 지원**: `mode='dispense'` (조제수량) 또는 `mode='sale'` (판매수량)
   - **약품코드 기준 lookup**: PRIMARY KEY로 안정적인 데이터 통합
   - **float 형태 자동 정규화**: `673400030.0` → `673400030` (중복 방지)
   - **최신 데이터 우선 채택**: 약품명/제약회사/재고수량 모두 역순 탐색으로 최신 월 우선
   - **약품명 변경 자동 반영**: 사용자가 약품명을 수정해도 약품코드 기준으로 자동 매칭 및 최신 값 채택
   - **음수 재고 지원**: 마이너스 재고도 정확히 반영
   - **자동 필터링**: 전체 기간 동안 소모량이 0인 약품 제외

3. **통계 계산** (`calculate_statistics`)
   - 1년 이동평균 산출 (최근 12개월 평균, 계절성 반영)
   - 3개월 이동평균 계산 (단기 추세 파악용)
   - 런웨이 계산 (재고 소진 예상 기간, 1년 이동평균 기반)

#### 데이터 무결성 보장:

```python
# 약품코드 정규화 예시
"673400030"   → "673400030"   # 이미 정수형
"673400030.0" → "673400030"   # float 형태 정규화
"ZP123456"    → "ZP123456"    # 문자 혼합 코드
```

#### 최신 데이터 채택 로직 (Robust Design):

```python
# 모든 메타데이터를 최신 월 우선으로 채택 (역순 탐색)
months_reversed = list(reversed(months))  # 2025-09 → 2025-08 → ...

# Step 1: 약품명/제약회사 채택 (최신 월 우선)
for month in months_reversed:
    if 약품이_해당_월에_존재 and 약품명이_유효함:
        약품명 = 해당_월의_약품명  # 사용자 변경 반영
        제약회사 = 해당_월의_제약회사
        break  # 최신 정보 발견

# Step 2: 월별 조제/판매 수량 수집 (시간순 정방향)
for month in months:  # 시계열 데이터는 정방향
    월별_수량_리스트.append(해당_월의_조제수량)

# Step 3: 재고수량 채택 (최신 월 우선)
for month in months_reversed:
    if 약품이_해당_월에_존재 and 재고수량이_유효함:
        재고수량 = 해당_월의_재고  # 음수 포함
        break  # 최신 재고 발견
```

**핵심 설계 원칙**:
- ✅ **약품코드**: PRIMARY KEY, 불변 식별자
- ✅ **약품명/제약회사**: 최신 월 우선 (사용자가 변경해도 자동 반영)
- ✅ **재고수량**: 최신 월 우선 (음수 포함)
- ✅ **월별 수량**: 시간순 (시계열 분석용)

### drug_order_calculator.py - 주문 수량 산출

#### 주요 기능:

1. **today.csv 기반 필터링**
   - today.csv에서 오늘 나간 약품 코드 추출
   - DB 데이터를 today.csv 약품만 필터링
   - 실용적인 주문 보고서 생성

2. **자동 재고 업데이트**
   - today.csv 발견 시 자동으로 inventory_updater 호출
   - recent_inventory.sqlite3 자동 업데이트

3. **런웨이 계산**
   - **1년 이동평균 런웨이**: 현재 재고수량 / 1년 이동평균 (기본)
   - **3-MA 런웨이**: 현재 재고수량 / 3개월 이동평균 (단기 추세)
   - 무한대 값 처리 (조제수량이 0인 경우 → 999로 표시)

4. **보고서 생성**
   - HTML 보고서: 색상 코딩 포함 인터랙티브 테이블
   - CSV 보고서: 엑셀 등에서 후처리 가능
   - 런웨이 오름차순 정렬 (긴급도 순서)

### inventory_updater.py - 재고 업데이트

#### 주요 기능:
- today 파일(csv/xls/xlsx) → recent_inventory.sqlite3 업데이트
- 다양한 Excel 형식 자동 감지 및 처리
- UPSERT 연산으로 안전한 업데이트
- 중복 실행해도 문제없음

### generate_volatility_report.py - 고변동성 약품 보고서

#### 주요 기능:

1. **CV (Coefficient of Variation) 계산**
   - CV = 표준편차 / 평균으로 사용량 변동성 측정
   - 0이 아닌 유효한 사용량 데이터만 사용
   - 최소 2개월 이상 데이터 필요

2. **변동성 3단계 분류**
   - 고변동성 (high): CV > 고/중 경계 (기본 0.5)
   - 중변동성 (mid): 중/저 경계 ≤ CV ≤ 고/중 경계 (기본 0.3~0.5)
   - 저변동성 (low): CV < 중/저 경계 (기본 0.3)
   - 임계값은 사용자가 슬라이더로 조절 가능

3. **3분류 시스템 (정규/단발성/신규)**
   - **가중 등장률 계산**: 최근 달에 높은 가중치 부여 (가장 오래된 달 = 0.1, 가장 최근 달 = 1.0, 선형 감소)
   - **정규 약품**: 가중 등장률 >= 20% (메인 테이블에서 CV 분석 대상)
   - **단발성 약품**: 가중 등장률 < 20% + 최근 2개월 내 등장 없음 (보라색 사이드바 책갈피)
   - **신규 약품**: 가중 등장률 < 20% + 최근 2개월 내 등장 있음 (초록색 사이드바 책갈피)
   - 각 모달에서 스파크라인, 인라인 차트(통계 카드 포함) 등 메인 테이블과 동일한 기능 제공

4. **산점도 시각화 (Plotly)**
   - X축: 평균 월 사용량 (로그 스케일)
   - Y축: CV 값
   - 그룹별 색상 구분 (빨강/노랑/초록)
   - 임계값 경계선 표시

5. **보고서 테이블**
   - CV 내림차순 정렬 (고변동성 약품 우선)
   - 스파크라인으로 사용량 추이 표시
   - 인라인 차트 확장 (행 클릭 시)
   - 그룹별 필터링 (요약 카드 클릭)

#### 출력 파일:
- `volatility_reports/volatility_report_[mode]_YYYYMMDD_HHMMSS.html`

### buffer_calculator.py - 동시 방문 대비용 재고 계산

#### 주요 기능:
- **포아송 이항분포 기반 동시 방문 확률 계산**
  - N명의 환자가 각각 p_i = 1/방문주기_일 확률로 특정 일에 방문
  - 동시에 k명 이상 방문할 확률을 동적 프로그래밍으로 효율적 계산
- **허용 리스크 수준별 버퍼 산출**
  - `relaxed` (절약): 흔한 동시 방문만 대비
  - `normal` (보통): 일반적인 동시 방문 대비
  - `safe` (안전, 권장): 드문 동시 방문까지 대비
  - `very_safe` (매우 안전): 매우 드문 동시 방문까지 대비
  - Threshold 값: 3%, 0.3%, 0.03%, 0.003% (10x 간격)
  - 10x 간격 선택 이유: 포아송 분포에서 연속된 k값(동시 방문자 수) 간 확률 비율이 일반적으로 5~20x 범위이므로, 10x 간격이 각 레벨마다 다른 버퍼 결과를 산출하기에 적절함
- **최소 버퍼 계산 로직**
  - 허용 리스크 이하가 되는 최소 동시 방문자 수(k) 결정
  - 상위 k명의 처방량 합산으로 필요 버퍼 산출
  - 환자별 처방량, 방문확률, 버퍼 포함 여부 상세 반환

#### 데이터 요구사항:
- `patients_db.sqlite3`: 환자의 `방문주기_일` 정보
- `drug_patient_map.sqlite3`: 약품-환자 매핑 및 `1회_처방량` 정보

### periodicity_calculator.py - 주기성 지표 계산

#### 주요 기능:
- **피크 탐지**: 월별 사용량에서 사용량 > 0인 달을 피크로 탐지
- **interval_cv (피크 간격 변동계수)**: 피크 사이 간격의 표준편차/평균 (낮을수록 규칙적)
- **height_cv (피크 높이 변동계수)**: 피크 사용량의 표준편차/평균 (낮을수록 같은 환자일 가능성)
- **acf_max (자기상관 최대값)**: lag 2~6 범위에서 자기상관 최대값 (주기성 강도)
- **periodicity_score (종합 점수)**: `100 * acf_max * (1/(1+interval_cv)) * (1/(1+height_cv))`

#### 분석 기준:
- 피크 3개 이상: 분석 가능 (제안 대상)
- 피크 2개 이하: 신규 약품으로 분류 (데이터 부족)

### suggestion_engine.py - 약품 추천 엔진

#### 주요 기능:
- **Weighted Euclidean Distance + KNN 기반 추천**: scipy.cdist 사용, K=3 고정
- **KNN 방식**: 등록된 약품들 중 가장 가까운 K개와의 평균 거리로 유사도 측정
- **가중치 기반 정렬**: 거리가 가까운 약품 우선 추천
- **페널티 시스템**: 건너뛰기 횟수, 이미 등록된 환자 수에 따라 우선순위 조정
- **Pre-filtering**: 월평균 사용량 200개 이상인 약품은 추천 대상에서 제외

#### 활성화 조건:
- 약품이 등록된 환자 5명 이상 (MIN_PATIENTS_FOR_ACTIVATION)

#### Feature Vector 구성 (6차원):
- avg_interval (가중치 2.0): 평균 피크 간격, 로그 변환 정규화 (1개월=0.0, 6개월+=1.0)
- interval_cv (가중치 1.5): 피크 간격 변동계수, 낮을수록 1에 가까움
- height_cv (가중치 1.0): 피크 높이 변동계수, 낮을수록 1에 가까움
- acf_max (가중치 0.8): 자기상관 최대값, (-1~1) -> (0~1) 변환
- peak_count (가중치 0.5): 피크 수, min(1, value/15) 정규화
- active_months_ratio (가중치 0.5): 활성 월 비율, non_zero_months / total_months

#### API 엔드포인트:
- `GET /api/suggestion/status`: 활성화 상태 확인
- `GET /api/suggestion/next`: 다음 추천 약품 조회
- `POST /api/suggestion/register`: 환자-약품 등록
- `POST /api/suggestion/skip`: 추천 건너뛰기
- `GET /api/suggestion/new-drugs`: 신규 약품 목록 (피크 부족)
- `GET /api/suggestion/stats`: 추천 통계

### utils.py - 공통 유틸리티 함수

#### 주요 기능:
- **Excel 파일 읽기**: CSV, XLS, XLSX 형식 자동 감지
  - `calamine` 엔진: 윈도우에서 생성된 오래된 .xls 파일 지원
  - `openpyxl` 엔진: 최신 .xlsx 파일 지원
- 약품코드 정규화 및 데이터 검증
- 다중 인코딩 지원 (UTF-8, CP949, EUC-KR)

## 🛠️ 고급 설정

### DB 재구축

**새로운 월별 데이터가 추가되었을 때** (예: 2025-10.xlsx 추가):

**방법 1: 웹 UI 버튼 사용 (권장)**

1. `data/` 폴더에 새 데이터 파일 추가
   ```bash
   cp ~/Downloads/2025-10.xlsx data/
   ```

2. 웹 브라우저에서:
   - 데이터베이스 정보 섹션 펼치기
   - **🔄 DB 재생성 (새 데이터 반영)** 버튼 클릭
   - 확인 후 자동으로 DB 재생성 완료
   - 업데이트된 데이터 기간 즉시 확인 가능

**방법 2: 터미널 명령어**

```bash
# 1. data/ 폴더에 새 데이터 파일 추가 (CSV, XLS, XLSX 모두 가능)
cp ~/Downloads/2025-10.xlsx data/

# 2. DB 재초기화 (기존 DB는 자동으로 덮어쓰기 확인)
python init_db.py
```

**참고**:
- 새 월별 데이터 추가 시 전체 DB 재구축이 필요합니다 (시계열 통계 재계산)
- CSV, XLS, XLSX 형식 모두 지원하며 수동 변환 불필요
- 약품명이 변경되어도 약품코드 기준으로 자동 매칭되어 최신 값이 반영됩니다
- 웹 UI 사용 시: 실시간 진행 상황 표시 및 완료 후 자동 업데이트
- 터미널 사용 시: 기존 DB 덮어쓰기 전 확인 메시지 표시

### 파일명 패턴 커스터마이징

`read_csv.py`의 `extract_month_from_file` 함수에서 정규표현식 수정:

```python
patterns = [
    r'(\d{4})[-_]?(\d{2})',  # 2025-01, 202501, 2025_01
    r'(\d{4})년\s*(\d{1,2})월',  # 2025년 1월
    # 추가 패턴...
]
```

### 알림 임계값 설정

런웨이 경고 기준은 웹 UI에서 슬라이더로 조절할 수 있습니다 (0.5~6개월, 기본 1개월).
개별 약품에 대해서는 약품 개별 관리 페이지에서 별도 임계값을 설정할 수 있습니다.

## 🔍 문제 해결

### 일반적인 오류 및 해결방법

1. **"DB가 없습니다" 오류**
   ```
   해결: python init_db.py 실행
   ```

2. **파일 읽기 오류**
   ```
   해결:
   - Excel 파일(.xls, .xlsx)을 직접 사용 가능 (변환 불필요)
   - CSV 파일 사용 시 'CSV(UTF-8)(*.csv)' 형식으로 저장
   ```

3. **파일명 날짜 인식 오류**
   ```
   해결: 파일명을 YYYY-MM.* 또는 YYYYMM.* 형식으로 변경 (확장자: csv, xls, xlsx)
   예: 2025-01.csv, 202501.xlsx, 2025_01.xls
   ```

4. **약품코드 중복 문제**
   ```
   해결: 자동으로 float 형태(.0) 제거 및 통합됨
   예: 673400030과 673400030.0이 자동으로 하나로 병합
   ```

5. **인코딩 오류**
   ```
   해결: UTF-8, CP949, EUC-KR 자동 감지 및 변환
   ```

6. **약품코드 선행 0 소실 및 중복 데이터**
   ```
   증상: '073100370'과 '73100370'이 중복으로 존재
   해결: DB 재생성 (웹 UI에서 DB 재생성 버튼 클릭)
   ```

## 📝 라이선스

이 프로젝트는 MIT 라이선스 하에 배포됩니다.