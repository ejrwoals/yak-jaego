# 약국 재고 관리 및 분석 시스템 (Jaego)

> **⚡ 빠른 시작**:
> 1. **관리자**: `python init_db.py` (최초 1회, DB 초기화) 또는 웹 UI에서 DB 재생성 버튼 클릭
> 2. **사용자**: `python web_app.py` (웹 브라우저에서 실행)

## 🏥 프로젝트 개요

**yak-jaego**는 약국의 재고 관리와 사용량 분석을 위한 Python 기반 자동화 도구입니다. SQLite 데이터베이스 기반으로 여러 개의 월별 데이터 파일(CSV, XLS, XLSX)을 통합하여 시계열 분석을 수행하고, 시각적으로 이해하기 쉬운 인터랙티브 HTML 보고서를 생성합니다.

### 🎯 핵심 아키텍처

**SQLite 데이터베이스 기반 시스템**
- `recent_inventory.sqlite3`: 각 약품의 최신 재고 수량 저장
- `processed_inventory.sqlite3`: 시계열 통계 데이터 (1년 이동평균, 3개월 이동평균, 런웨이 등)
- `checked_items.sqlite3`: 긴급 약품 확인 상태 저장 (v3.5 신규)
- **약품별 최신 재고 추적**: 각 약품마다 가장 최근에 기록된 재고를 자동 채택
- **음수 재고 지원**: 마이너스 재고도 정확히 반영
- **확인 상태 영구 저장**: 체크한 긴급 약품 상태를 DB에 보존하여 재확인 피로 감소

### 🔀 세 가지 워크플로우

1. **📊 단순 재고 관리 보고서 (신규 v3.6)**
   - 사용자 정의 N개월 이동평균 (1~12개월 선택 가능)
   - 단일 런웨이 지표로 진입장벽 낮춤
   - 초보자 및 일상적 사용에 최적화
   - N개월 이동평균 기준 내림차순 정렬

2. **📈 상세 재고 관리 보고서 (시계열 분석)**
   - 월별 CSV 데이터의 시계열 분석 및 트렌드 파악
   - 1년 + 3개월 이중 이동평균 분석
   - 장기 트렌드와 단기 변화 동시 파악
   - 전문약/일반약 개별 보고서 생성

3. **📦 약 주문 수량 산출**
   - **today.csv에 있는 약품만** 표시 (오늘 나간 약품)
   - 현재 재고와 과거 소비 패턴 기반 주문 필요 약품 식별
   - 런웨이(재고 소진 예상 기간) 기반 우선순위 정렬

### 📊 주요 기능

#### 공통 기능
- **🗄️ SQLite 데이터베이스**: 안정적인 데이터 저장 및 관리
- **🔄 월별 CSV 자동 통합**: 여러 개의 월별 CSV 파일을 약품코드 기준으로 자동 병합
- **🧮 다중 인코딩 지원**: UTF-8, CP949, EUC-KR 인코딩 자동 감지
- **💾 데이터 무결성**: 약품코드 string 처리 및 float 형태 자동 정규화
- **📅 최신 재고 자동 채택**: 각 약품별로 가장 최근 월의 재고 자동 선택
- **➖ 음수 재고 지원**: 마이너스 재고 정확히 반영

#### 워크플로우 1: 단순 재고 관리 보고서 (v3.7 개선)
- **🎯 사용자 정의 이동평균**: 1~12개월 중 선택 가능 (기본 3개월)
- **📊 단일 런웨이 지표**: 하나의 이동평균만 사용하여 직관적 분석
- **⬇️ 스마트 정렬**: N개월 이동평균 기준 내림차순 정렬 (많이 쓰는 약품 우선)
- **💊 전문약/일반약 분리 분석**: 조제수량(전문약) 또는 판매수량(일반약) 기준 선택 가능
- **🧹 깔끔한 랜딩 페이지**: 테이블 기본 숨김, 검색 시에만 일치하는 약품 표시
- **🔍 스마트 검색**: 약품명, 제약회사, 약품코드로 검색 → 해당 약품만 테이블에 표시
- **📑 통일된 모달 UI**: 모든 탭(긴급/부족/충분/악성재고)에서 동일한 테이블 구조
- **✅ 체크박스 + 메모 기능**: 모든 탭에서 확인 상태 및 메모 관리 가능
- **📈 트렌드 스파크라인**: 모든 모달 테이블에 스파크라인 표시
- **📊 뷰 토글**: 부족/충분 탭에서 테이블 ↔ 막대 그래프 전환

#### 워크플로우 2: 상세 재고 관리 보고서 (시계열 분석)
- **📈 이중 이동평균**: 1년 이동평균 + 3개월 이동평균 동시 분석
- **🔄 이중 런웨이**: 장기(12-MA) + 단기(3-MA) 런웨이 제공
- **💊 전문약/일반약 분리 분석**: 조제수량(전문약) 또는 판매수량(일반약) 기준 선택 가능
- **🎯 자동 필터링**: 전체 기간 동안 소모량이 0인 품목 자동 제외
- **⚡ 경량 스파크라인**: SVG 기반 초경량 트렌드 차트로 빠른 로딩
- **🎯 On-demand 상세 차트**: 클릭시에만 Plotly 차트 동적 생성으로 성능 최적화
- **🔍 즉각 검색**: 전체 약품 목록에서 실시간 검색
- **✅ 긴급 약품 체크박스**: 재고 소진 약품 확인 상태를 영구 저장하여 재확인 피로 감소
- **📝 메모 기능**: 긴급 약품별 메모 작성 및 영구 보존

#### 워크플로우 3: 주문 수량 산출
- **📋 today.csv 기반 필터링**: 오늘 나간 약품만 표시
- **🔄 자동 재고 업데이트**: today.csv 발견 시 DB 자동 업데이트
- **🚨 긴급 주문 식별**: 런웨이 1개월 미만 약품 자동 하이라이트
- **📊 런웨이 이중 계산**: 1년 이동평균 및 3개월 이동평균 기반 두 가지 런웨이 제공
- **🎨 색상 코딩**: 재고 부족 약품을 빨간색으로 강조 표시
- **📋 자동 정렬**: 런웨이 오름차순으로 긴급도 순서 정렬

## 🚀 빠른 시작

### 필수 요구사항

- Python 3.7 이상
- pip (Python 패키지 관리자)

### 설치 방법

1. **저장소 클론**
   ```bash
   git clone https://github.com/ejrwoals/yak-jaego.git
   cd yak-jaego
   ```

2. **가상환경 설정 (권장)**
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```

3. **의존성 설치**
   ```bash
   pip install -r requirements.txt
   ```

### 데이터 준비

#### 월별 데이터 파일 준비 (필수)

1. **지원하는 파일 형식**:
   - **CSV 파일** (`.csv`): 쉼표로 구분된 텍스트 파일
   - **Excel 파일** (`.xls`, `.xlsx`): Excel 파일을 CSV로 변환할 필요 없이 바로 사용 가능
   - 파일명에 날짜 정보 포함 (예: `2025-01.xlsx`, `2025-02.csv`, `202501.xls`)
   - `data/` 폴더에 모든 월별 파일을 저장합니다

2. **파일 형식 요구사항**:
   - `약품명`: 의약품명
   - `제약회사`: 제조회사명
   - `약품코드`: 고유 식별 코드 (숫자/문자 혼합 가능, 자동으로 string 처리)
   - `재고수량`: 현재 재고량 (음수 가능)
   - `조제수량`: 해당 월의 사용량 (전문약의 경우)
   - `판매수량`: 해당 월의 판매량 (일반약의 경우)

3. **파일명 규칙**:
   - 지원 형식: `YYYY-MM.*`, `YYYYMM.*`, `YYYY_MM.*`, `YYYY년 MM월.*` (확장자: csv, xls, xlsx)
   - 예시: `2025-01.csv`, `202501.xlsx`, `2025_01.xls`, `2025년 1월.csv`

#### today 파일 준비 (워크플로우 2에 필요)

1. **today 파일** (CSV 또는 Excel 형식):
   - 오늘 나간 약품의 재고 현황을 담은 파일
   - **웹 UI에서 직접 업로드** 가능 (파일명 자유)
   - 지원 형식:
     - `*.csv` (CSV 파일)
     - `*.xls` (Excel 97-2003 파일, 윈도우 호환)
     - `*.xlsx` (최신 Excel 파일)
   - 필수 컬럼: `약품명`, `약품코드`, `제약회사`, `재고수량`
   - **중요**: 업로드한 파일에 있는 약품들만 주문 보고서에 표시됩니다
   - **편의성**: Excel 파일을 CSV로 수동 변환할 필요 없이 바로 사용 가능

## 📖 사용 방법

### 🔧 1단계: DB 초기화 (관리자, 최초 1회)

**방법 1: 터미널 명령어 (권장 - 최초 실행 시)**

```bash
python init_db.py
```

**방법 2: 웹 UI 버튼 (신규 데이터 반영 시)**

1. `python web_app.py` 실행
2. 데이터베이스 정보 섹션 클릭하여 펼치기
3. **🔄 DB 재생성 (새 데이터 반영)** 버튼 클릭
4. 확인 후 자동으로 DB 재생성 완료

**실행 과정:**
1. `data/` 폴더의 모든 월별 데이터 파일 로드 (CSV, XLS, XLSX)
2. 전문약 데이터 처리 및 통계 계산
3. 일반약 데이터 처리 및 통계 계산
4. `recent_inventory.sqlite3` 생성 (각 약품의 최신 재고)
5. `processed_inventory.sqlite3` 생성 (시계열 통계 데이터)

**생성되는 DB:**
- `recent_inventory.sqlite3`: 현재 재고 데이터
  - 약품코드, 약품명, 제약회사, 약품유형(전문약/일반약), 현재_재고수량
  - 각 약품별로 가장 최근에 기록된 재고를 자동 채택
- `processed_inventory.sqlite3`: 시계열 통계 데이터
  - 1년_이동평균, 월별_조제수량_리스트, 3개월_이동평균_리스트, 런웨이 등

### 🎯 2단계: 워크플로우 실행 (사용자)

```bash
python web_app.py
```

**실행 과정:**
1. 명령어 실행 시 웹 브라우저가 자동으로 열립니다 (http://127.0.0.1:5000)
2. 랜딩 페이지에서 원하는 워크플로우 버튼 클릭:
   - **재고 관리 보고서**: 전문약/일반약 시계열 분석
   - **약 주문 수량 산출**: 런웨이 기반 주문 계산
3. 보고서가 자동으로 생성되어 새 탭에서 열립니다
4. 종료: 웹 UI 우측 하단의 **🛑 종료** 버튼 클릭 (또는 터미널에서 `Ctrl+C`)

**특징:**
- 직관적인 그래픽 인터페이스
- 클릭만으로 워크플로우 실행
- 보고서는 새 탭에서 열려 메인 앱과 독립적으로 사용 가능
- 여러 보고서를 연속으로 생성하고 비교 가능

### 워크플로우 1: 시계열 분석 보고서

**실행 과정:**
1. **보고서 유형 선택**:
   - `1` 입력: 전문약 보고서 (조제수량 기준)
   - `2` 입력: 일반약 보고서 (판매수량 기준)
2. `processed_inventory.sqlite3`에서 데이터 로드
3. 선택한 약품유형만 필터링
4. HTML 보고서 생성 및 브라우저에서 자동 열기

**출력 파일:**
- `inventory_report_dispense_YYYYMMDD_HHMMSS.html`: 전문약 시계열 분석 보고서
- `inventory_report_sale_YYYYMMDD_HHMMSS.html`: 일반약 시계열 분석 보고서

**보고서 내용:**
- 📈 재고 현황 요약 통계
- 📊 런웨이 분석 차트 (재고 부족/충분 약품 분류)
- 🔍 상세 재고 테이블 (검색/정렬 기능, 스파크라인)
- ⚠️ 주의사항 약품 목록 (런웨이 또는 3-MA 런웨이가 1개월 미만인 경우 빨간색 강조)

### 워크플로우 2: 주문 수량 산출

**실행 전 요구사항:**
- 오늘 나간 약품의 재고 현황 파일 (csv/xls/xlsx, 웹 UI에서 업로드)
- `processed_inventory.sqlite3`: init_db.py로 생성된 DB
- `recent_inventory.sqlite3`: init_db.py로 생성된 DB

**실행 과정:**
1. 웹 UI에서 재고 현황 파일 업로드 (파일명 자유)
2. 업로드된 파일로 자동으로 `recent_inventory.sqlite3` 업데이트
3. 업로드된 파일에서 오늘 나간 약품 코드 추출
4. processed_inventory DB에서 시계열 통계 로드
5. recent_inventory DB에서 현재 재고 로드 → **업로드 파일 약품만 필터링**
6. 데이터 병합 및 런웨이 계산
7. HTML/CSV 보고서 생성 (런웨이 오름차순 정렬)

**출력 파일:**
- `order_calc_reports/order_calculator_report_YYYYMMDD_HHMMSS.html`: 주문 권장 보고서
- `order_calc_reports/order_calculator_report_YYYYMMDD_HHMMSS.csv`: 주문 권장 데이터

**보고서 특징:**
- 🚨 런웨이 < 1개월 또는 3-MA 런웨이 < 1개월 약품은 빨간색으로 강조
- 📋 오늘 나간 약품만 표시 (업로드된 파일 기준)
- 📊 긴급도 순서로 자동 정렬
- 📈 1년 이동평균 및 3개월 이동평균 기반 이중 런웨이 제공

### 🔄 재고 업데이트 (선택 사항)

today 파일을 업데이트한 후 DB만 갱신하고 싶을 때:

```bash
python inventory_updater.py
```

**동작:**
- today 파일(csv/xls/xlsx)의 재고 정보를 `recent_inventory.sqlite3`에 반영
- UPSERT 방식으로 안전하게 업데이트 (중복 실행해도 안전)
- 워크플로우 2를 실행하면 자동으로 실행되므로 선택 사항

## 📁 프로젝트 구조

```
yak-jaego/
├── data/                          # 입력 데이터 폴더 (CSV, XLS, XLSX)
│   ├── 2023-09.csv                # 2023년 9월 데이터
│   ├── 2023-10.xlsx               # 2023년 10월 데이터
│   ├── 2024-01.xls                # 2024년 1월 데이터
│   └── ...                        # 기타 월별 데이터
├── templates/                     # 웹 UI HTML 템플릿 폴더
│   ├── index.html                 # 랜딩 페이지
│   ├── workflow_simple.html       # 단순 재고 관리 워크플로우 페이지 (v3.6)
│   ├── workflow_timeseries.html   # 상세 재고 관리 워크플로우 페이지
│   ├── workflow_order.html        # 주문 계산 워크플로우 페이지
│   └── error.html                 # 에러 페이지
├── inventory_reports/             # 재고 관리 보고서 폴더 (자동 생성)
│   ├── simple_report_YYYYMMDD_HHMMSS.html      # 단순 보고서 (N-MA) (v3.6)
│   └── inventory_report_YYYYMMDD_HHMMSS.html   # 상세 보고서 (12-MA + 3-MA)
├── order_calc_reports/            # 주문 수량 산출 보고서 폴더 (자동 생성)
│   ├── order_calculator_report_YYYYMMDD_HHMMSS.html
│   └── order_calculator_report_YYYYMMDD_HHMMSS.csv
├── init_db.py                     # 🔧 DB 초기화 스크립트 (관리자용)
├── web_app.py                     # 🌐 웹 UI 메인 애플리케이션 (사용자용)
├── read_csv.py                    # CSV 데이터 읽기 및 시계열 통합 모듈
├── generate_report.py             # 상세 재고 관리 HTML 보고서 생성 모듈 (12-MA + 3-MA)
├── generate_single_ma_report.py   # 단순 재고 관리 HTML 보고서 생성 모듈 (N-MA) (v3.6)
├── drug_order_calculator.py       # 주문 수량 산출 모듈
├── inventory_db.py                # recent_inventory.sqlite3 관리 모듈
├── processed_inventory_db.py      # processed_inventory.sqlite3 관리 모듈
├── checked_items_db.py            # checked_items.sqlite3 관리 모듈 (체크 상태 저장)
├── inventory_updater.py           # 재고 업데이트 모듈 (today 파일 → DB)
├── utils.py                       # 공통 유틸리티 함수 (Excel 파일 읽기 포함)
├── requirements.txt               # Python 의존성 목록
├── today.csv/xls/xlsx             # 오늘 나간 약품의 재고 현황 (사용자 제공)
├── recent_inventory.sqlite3       # 최신 재고 DB (자동 생성)
├── processed_inventory.sqlite3    # 시계열 통계 DB (자동 생성)
├── checked_items.sqlite3          # 체크 상태 DB (자동 생성)
└── README.md                      # 프로젝트 문서
```

## 🔧 상세 기능

### init_db.py - DB 초기화 (관리자용)

#### 주요 기능:
- **월별 데이터 통합**: data/ 폴더의 모든 데이터 파일(CSV, XLS, XLSX) 로드 및 통합
- **전문약/일반약 처리**: 두 가지 약품 유형을 모두 처리하여 DB에 저장
- **최신 재고 채택**: 각 약품별로 가장 최근 월의 재고를 자동 선택
- **통계 계산**: 1년 이동평균 (12개월), 3개월 이동평균, 런웨이 자동 계산
- **DB 생성**: recent_inventory.sqlite3 및 processed_inventory.sqlite3 생성

#### 실행 시점:
- 최초 설치 후 1회
- 새로운 월별 데이터가 추가되었을 때
- DB 재구축이 필요할 때

### web_app.py - 웹 UI 메인 애플리케이션 (사용자용)

#### 주요 특징:
- **Flask 기반 웹 인터페이스**: 브라우저에서 직관적으로 사용
- **DB 준비 상태 확인**: 두 개의 DB 존재, 데이터 개수, 데이터 기간 표시
- **DB 재생성 버튼**: 웹 UI에서 직접 DB 재생성 가능 (터미널 명령어 불필요)
- **워크플로우 선택**: 랜딩 페이지에서 버튼 클릭으로 워크플로우 실행
- **새 탭 보고서**: 보고서가 새 탭에서 열려 메인 앱과 독립적으로 사용
- **오류 처리**: DB 없으면 init_db.py 실행 안내

### inventory_db.py - 최신 재고 DB 관리

#### 주요 기능:
- `recent_inventory.sqlite3` 관리
- 테이블 스키마:
  ```sql
  CREATE TABLE recent_inventory (
      약품코드 TEXT PRIMARY KEY,
      약품명 TEXT,
      제약회사 TEXT,
      약품유형 TEXT,  -- '전문약' 또는 '일반약'
      현재_재고수량 REAL,  -- 음수 가능
      최종_업데이트일시 TEXT
  )
  ```
- UPSERT 연산 지원 (INSERT OR REPLACE)

### processed_inventory_db.py - 시계열 통계 DB 관리

#### 주요 기능:
- `processed_inventory.sqlite3` 관리
- 테이블 스키마:
  ```sql
  CREATE TABLE processed_inventory (
      약품코드 TEXT PRIMARY KEY,
      약품명 TEXT,
      제약회사 TEXT,
      약품유형 TEXT,
      "1년_이동평균" REAL,
      최종_재고수량 REAL,
      런웨이 TEXT,
      월별_조제수량_리스트 TEXT,  -- JSON
      "3개월_이동평균_리스트" TEXT,  -- JSON
      최종_업데이트일시 TEXT
  )
  ```
- JSON 직렬화로 Python 리스트 저장
- numpy 타입 자동 변환

### read_csv.py - 데이터 처리 엔진

#### 주요 기능:

1. **월별 데이터 파일 자동 로드** (`load_multiple_csv_files`)
   - `data/` 폴더의 모든 데이터 파일(CSV, XLS, XLSX) 스캔
   - 파일명에서 날짜 정보 자동 추출 (정규표현식 사용)
   - CSV: 다중 인코딩 자동 감지 (UTF-8, CP949, EUC-KR)
   - Excel: calamine(xls) 및 openpyxl(xlsx) 엔진으로 자동 처리
   - 시간순 정렬

2. **약품코드 기준 시계열 통합** (`merge_by_drug_code`)
   - **전문약/일반약 모드 지원**: `mode='dispense'` (조제수량) 또는 `mode='sale'` (판매수량)
   - **약품코드 기준 lookup**: PRIMARY KEY로 안정적인 데이터 통합
   - **float 형태 자동 정규화**: `673400030.0` → `673400030` (중복 방지)
   - **최신 데이터 우선 채택**: 약품명/제약회사/재고수량 모두 역순 탐색으로 최신 월 우선
   - **약품명 변경 자동 반영**: 사용자가 약품명을 수정해도 약품코드 기준으로 자동 매칭 및 최신 값 채택
   - **음수 재고 지원**: 마이너스 재고도 정확히 반영
   - **자동 필터링**: 전체 기간 동안 소모량이 0인 약품 제외

3. **통계 계산** (`calculate_statistics`)
   - 1년 이동평균 산출 (최근 12개월 평균, 계절성 반영)
   - 3개월 이동평균 계산 (단기 추세 파악용)
   - 런웨이 계산 (재고 소진 예상 기간, 1년 이동평균 기반)

#### 데이터 무결성 보장:

```python
# 약품코드 정규화 예시
"673400030"   → "673400030"   # 이미 정수형
"673400030.0" → "673400030"   # float 형태 정규화
"ZP123456"    → "ZP123456"    # 문자 혼합 코드
```

#### 최신 데이터 채택 로직 (Robust Design):

```python
# 모든 메타데이터를 최신 월 우선으로 채택 (역순 탐색)
months_reversed = list(reversed(months))  # 2025-09 → 2025-08 → ...

# Step 1: 약품명/제약회사 채택 (최신 월 우선)
for month in months_reversed:
    if 약품이_해당_월에_존재 and 약품명이_유효함:
        약품명 = 해당_월의_약품명  # 사용자 변경 반영
        제약회사 = 해당_월의_제약회사
        break  # 최신 정보 발견

# Step 2: 월별 조제/판매 수량 수집 (시간순 정방향)
for month in months:  # 시계열 데이터는 정방향
    월별_수량_리스트.append(해당_월의_조제수량)

# Step 3: 재고수량 채택 (최신 월 우선)
for month in months_reversed:
    if 약품이_해당_월에_존재 and 재고수량이_유효함:
        재고수량 = 해당_월의_재고  # 음수 포함
        break  # 최신 재고 발견
```

**핵심 설계 원칙**:
- ✅ **약품코드**: PRIMARY KEY, 불변 식별자
- ✅ **약품명/제약회사**: 최신 월 우선 (사용자가 변경해도 자동 반영)
- ✅ **재고수량**: 최신 월 우선 (음수 포함)
- ✅ **월별 수량**: 시간순 (시계열 분석용)

### drug_order_calculator.py - 주문 수량 산출

#### 주요 기능:

1. **today.csv 기반 필터링**
   - today.csv에서 오늘 나간 약품 코드 추출
   - DB 데이터를 today.csv 약품만 필터링
   - 실용적인 주문 보고서 생성

2. **자동 재고 업데이트**
   - today.csv 발견 시 자동으로 inventory_updater 호출
   - recent_inventory.sqlite3 자동 업데이트

3. **런웨이 계산**
   - **1년 이동평균 런웨이**: 현재 재고수량 / 1년 이동평균 (기본)
   - **3-MA 런웨이**: 현재 재고수량 / 3개월 이동평균 (단기 추세)
   - 무한대 값 처리 (조제수량이 0인 경우 → 999로 표시)

4. **보고서 생성**
   - HTML 보고서: 색상 코딩 포함 인터랙티브 테이블
   - CSV 보고서: 엑셀 등에서 후처리 가능
   - 런웨이 오름차순 정렬 (긴급도 순서)

### inventory_updater.py - 재고 업데이트

#### 주요 기능:
- today 파일(csv/xls/xlsx) → recent_inventory.sqlite3 업데이트
- 다양한 Excel 형식 자동 감지 및 처리
- UPSERT 연산으로 안전한 업데이트
- 중복 실행해도 문제없음

### utils.py - 공통 유틸리티 함수

#### 주요 기능:
- **Excel 파일 읽기**: CSV, XLS, XLSX 형식 자동 감지
  - `calamine` 엔진: 윈도우에서 생성된 오래된 .xls 파일 지원
  - `openpyxl` 엔진: 최신 .xlsx 파일 지원
- 약품코드 정규화 및 데이터 검증
- 다중 인코딩 지원 (UTF-8, CP949, EUC-KR)

## 🎯 핵심 개선 사항

### v3.7 업데이트 (UI 통일성 및 사용자 경험 개선)

1. **모달 UI 통일**
   - 🎯 **일관된 테이블 구조**: 모든 탭(긴급/부족/충분/악성재고)에서 동일한 8개 컬럼 사용
   - ✅ **체크박스 + 메모 기능 확장**: 긴급 탭에서만 제공하던 기능을 모든 탭으로 확장
   - 📈 **스파크라인 추가**: 모든 모달 테이블에 트렌드 스파크라인 표시
   - 📊 **토글 뷰**: 부족/충분 탭에서 테이블 ↔ 막대 그래프 전환 가능

2. **랜딩 페이지 간소화**
   - 🧹 **깔끔한 랜딩**: 기본적으로 약품 목록 테이블 숨김 처리
   - 🔍 **스마트 검색**: 검색어 입력 시에만 일치하는 약품 행 표시
   - 📊 **핵심 정보 집중**: 재고 현황 분포 인디케이터 + 사이드바 책갈피로 빠른 탐색

3. **공통 테이블 컬럼 (8개)**
   | 컬럼 | 설명 |
   |------|------|
   | 확인 | 체크박스 + 메모 버튼 |
   | 약품명 | 약품 이름 (30자 제한) |
   | 약품코드 | 고유 코드 |
   | 제약회사 | 제조사 (12자 제한) |
   | 재고수량 | 현재 재고 |
   | N개월 이동평균 | 평균 사용량 |
   | 런웨이 | 재고 소진 예상 기간 |
   | 트렌드 | 스파크라인 (SVG) |

4. **탭별 특화 기능**
   - 🔴 **긴급 탭**: 공통 8개 + "마지막 조제월" 컬럼 추가
   - 🟡 **부족 탭**: 공통 8개 + [막대 그래프 보기] 버튼
   - 🟢 **충분 탭**: 공통 8개 + [막대 그래프 보기] 버튼
   - ⚪ **악성재고 탭**: 공통 8개 컬럼

### v3.6 업데이트 (단순 재고 관리 보고서 추가)

1. **사용자 정의 Single MA 보고서**
   - 🎯 **사용자 선택형 이동평균**: 1~12개월 중 자유롭게 선택 가능 (기본값 3개월)
   - 📊 **단일 런웨이 지표**: 하나의 이동평균만 사용하여 진입장벽 낮춤
   - ⬇️ **스마트 정렬**: N개월 이동평균 기준 내림차순 정렬로 많이 쓰는 약품 우선 표시
   - 🎨 **시각적 차별화**: 파란색 스파크라인으로 단순 보고서 명확히 구분

2. **워크플로우 분리 및 UI 개선**
   - 🆕 **단순 vs 상세 보고서**: 초보자용 단순 보고서와 고급 사용자용 상세 보고서 분리
   - 🏷️ **권장 배지**: 랜딩 페이지에서 단순 보고서에 "권장" 배지 표시
   - 📁 **통합 과거 보고서**: 단순/상세 보고서 모두 하나의 목록에서 확인 가능
   - 🎨 **일관된 UI**: 모든 workflow 페이지 종료 버튼 위치 통일 (좌측 상단)

3. **파일 구조 및 모듈화**
   - 📄 `generate_single_ma_report.py`: 단순 보고서 전용 모듈
   - 🌐 `/workflow/simple`: 단순 보고서 워크플로우 페이지
   - 🔗 `/generate/simple_report`: 단순 보고서 생성 API
   - 📊 `simple_report_*.html`: 단순 보고서 파일명 규칙

4. **사용 편의성 향상**
   - 🚀 **빠른 시작**: 복잡한 이중 이동평균 개념 없이 바로 사용 가능
   - 🎓 **학습 곡선 완화**: 단순 보고서로 시작하여 필요시 상세 보고서로 전환
   - 🔧 **유연한 분석**: 상황에 따라 단기(1~3개월) 또는 장기(6~12개월) 트렌드 선택

### v3.5 업데이트 (긴급 약품 확인 관리 기능)

1. **체크박스를 통한 확인 상태 관리**
   - ✅ **영구 저장**: 긴급 재고 소진 약품 확인 상태를 SQLite DB(`checked_items.sqlite3`)에 저장
   - 🔄 **스마트 자동 정리**: 약품이 긴급 목록에서 제거되면 체크 상태 자동 초기화 (재입고 감지)
   - 📋 **체크박스 UI**: 각 긴급 약품 row에 체크박스 추가로 직관적인 확인 관리
   - 🎨 **시각적 구분**: 체크된 약품은 회색 톤다운으로 표시 (opacity 0.6, 회색 배경)
   - ⬇️ **자동 정렬**: 체크된 약품은 테이블 하단으로 자동 이동하여 미확인 약품에 집중

2. **메모 기능으로 맥락 보존**
   - 📝 **약품별 메모**: 각 긴급 약품에 대해 메모 작성 가능 (모달 UI)
   - 💾 **영구 보존**: 메모는 약품이 긴급 목록에서 사라져도 DB에 영구 저장
   - 👁️ **마우스 오버 미리보기**: 메모 버튼에 마우스를 올리면 툴팁으로 내용 미리보기
   - 🎨 **시각적 구분**: 메모가 있는 약품은 주황색 테두리로 표시
   - 📜 **과거 맥락 참조**: 약품이 다시 긴급 목록에 등장할 때 과거 메모 자동 표시

3. **지능적인 데이터 관리**
   - **체크 상태**: 긴급 목록에서 약품이 사라지면 자동 초기화 (재입고 시 다시 확인 필요)
   - **메모 데이터**: 약품이 목록에서 사라져도 영구 보존 (과거 맥락 유지)
   - **재등장 시 동작**: 체크 해제 상태 + 과거 메모 표시로 신속한 상황 파악 가능

4. **사용자 경험 향상**
   - 반복적인 확인 작업에서 발생하는 피로감 감소
   - 이미 처리한 약품과 미처리 약품을 명확하게 구분
   - 체크 해제로 다시 미확인 상태로 변경 가능 (유연한 관리)
   - 실시간 서버 동기화로 안정적인 상태 관리
   - 약품별 특이사항을 메모로 기록하여 향후 참고

5. **기술 구현**
   - `checked_items_db.py`: 체크 상태 및 메모 저장/조회/삭제 기능 제공
   - Flask API:
     - `/api/toggle_checked_item`: 체크 상태 실시간 업데이트
     - `/api/update_memo`: 메모 저장
     - `/api/get_memo`: 메모 조회
   - JavaScript 기반 클라이언트 정렬, 스타일 적용, 메모 모달 관리
   - 약품코드와 카테고리를 PRIMARY KEY로 사용하여 데이터 무결성 보장
   - 보고서 생성 시 자동 정리 로직: 긴급 목록에 없는 약품의 체크 상태 삭제

### v3.4 업데이트 (특수 케이스 경고 및 데이터 무결성 개선)

1. **긴급 상황 및 악성 재고 자동 감지**
   - 🚨 **긴급: 재고 0인 약품 (1년 내 사용이력 있음)**: 1년 이동평균 > 0이면서 재고 = 0인 약품을 별도 섹션으로 표시
     - 현재 사용 중인데 재고가 없는 위급 상황 즉시 파악
     - 마지막 조제월 기준 최신순 정렬 (최근까지 사용한 약품 우선)
     - 기본 열림 상태로 즉시 확인 가능
   - 📦 **악성 재고 (1년간 미사용 약품)**: 1년 이동평균 = 0이면서 재고 > 0인 약품을 별도 섹션으로 표시
     - 1년간 사용되지 않은 비효율적 재고 식별
     - 재고 금액이 큰 순서대로 정렬 (정리 우선순위 파악)
     - 총 악성 재고 개수 표시
   - 약품 목록 테이블에서도 🚨, 📦 아이콘으로 시각적 표시

2. **약품코드 선행 0 보존**
   - CSV/Excel 파일 읽기 시 `dtype={'약품코드': str}` 명시
   - 약품코드 `'073100370'`이 `'73100370'`으로 변경되는 문제 해결
   - 중복 데이터 발생 방지
   - DB 재생성으로 깨끗한 데이터 유지 가능

3. **일관된 표시 형식**
   - 이동평균 값: 0이면 → `0` (숫자로 통일)
   - 런웨이 값: 계산 불가능하면 → `재고만 있음` (텍스트로 통일)
   - 모든 테이블에서 일관성 있는 표시

### v3.3 업데이트 (일관된 경고 기준 및 UI 개선)

1. **일관된 빨간색 경고 표시**
   - 재고 관리 보고서와 주문 수량 산출 보고서 모두 동일한 기준 적용
   - 런웨이 < 1개월 **또는** 3-MA 런웨이 < 1개월인 경우 빨간색 음영 처리
   - 단기 트렌드(3-MA 런웨이) 반영으로 더 정확한 긴급도 파악

2. **웹 UI 종료 버튼 추가**
   - 모든 페이지 우측 하단에 🛑 종료 버튼 배치
   - 터미널에서 Ctrl+C를 누를 필요 없이 웹 브라우저에서 직접 앱 종료 가능
   - 사용자 확인 다이얼로그 제공
   - 종료 후 안내 메시지 표시

### v3.2 업데이트 (Excel 파일 직접 지원)

1. **Excel 파일 직접 읽기**
   - today.xls, today.xlsx 파일을 수동 변환 없이 바로 사용 가능
   - 윈도우에서 생성된 오래된 .xls 파일도 완벽 지원 (calamine 엔진)
   - 매일 Excel → CSV 변환 작업 불필요
   - 파일 형식 자동 감지 및 최적 엔진 선택

2. **개선된 사용자 경험**
   - 원본 Excel 파일을 그대로 사용
   - 변환 과정에서 발생하는 인코딩 문제 제거
   - 워크플로우 간소화

### v3.1 업데이트 (Robust 데이터 통합)

1. **약품명 변경 자동 반영**
   - 약품코드는 불변, 약품명은 변경 가능
   - 최신 월의 약품명/제약회사를 자동 채택 (역순 탐색)
   - 사용자가 약품명을 변경해도 약품코드 기준으로 자동 매칭
   - 예: "타이레놀정" → "타이레놀500mg정" 변경 시 자동 반영

2. **통일된 데이터 채택 정책**
   - 약품명, 제약회사, 재고수량 모두 **최신 월 우선** (역순 탐색)
   - 시계열 데이터(월별 조제수량)는 시간순 유지 (정방향)
   - 3단계 분리 로직으로 명확성 향상

### v3.0 주요 업데이트 (SQLite 기반 아키텍처)

1. **SQLite 데이터베이스 도입**
   - CSV 파일 대신 SQLite DB로 데이터 관리
   - 두 개의 DB: recent_inventory (최신 재고), processed_inventory (시계열 통계)
   - 약품코드를 PRIMARY KEY로 사용하여 안정적인 데이터 무결성 보장
   - UPSERT 연산으로 안전한 업데이트

2. **관리자/사용자 워크플로우 분리**
   - `init_db.py`: DB 초기화 (관리자, 최초 1회)
   - `web_app.py`: 웹 기반 보고서 생성 및 주문 계산 (사용자, 일상적 사용)
   - 직관적인 웹 UI

3. **최신 재고 자동 채택**
   - 각 약품별로 가장 최근 월의 재고를 자동 선택
   - 월별 CSV에 일부 약품만 있어도 문제없음
   - 역순 탐색으로 정확한 최신 재고 파악

4. **음수 재고 지원**
   - 마이너스 재고도 정확히 반영
   - 실제 약국 운영 상황 정확히 표현

5. **today 파일 기반 필터링**
   - 주문 보고서에 오늘 나간 약품만 표시
   - 실용적인 주문 계산
   - 불필요한 정보 제거
   - CSV, XLS, XLSX 형식 모두 지원

### v2.0 업데이트 (시계열 분석)

1. **시계열 분석 기능 추가**
   - 단일 CSV → 여러 월별 CSV 통합 분석
   - 시간에 따른 조제수량 변화 추적
   - 1년 이동평균으로 계절성 반영 및 장기 트렌드 파악
   - 3개월 이동평균으로 단기 추세 파악

2. **성능 대폭 개선**
   - 1800+ 약품 로딩 시간: 10초+ → 1-2초
   - HTML 파일 크기: 수십 MB → 수 MB
   - 검색 반응 속도 유지

3. **데이터 무결성 강화**
   - 약품코드 float 형태 자동 정규화
   - 같은 약품의 중복 라인 자동 병합
   - string 타입 일관성 보장

## 🛠️ 고급 설정

### DB 재구축

**새로운 월별 데이터가 추가되었을 때** (예: 2025-10.xlsx 추가):

**방법 1: 웹 UI 버튼 사용 (권장)**

1. `data/` 폴더에 새 데이터 파일 추가
   ```bash
   cp ~/Downloads/2025-10.xlsx data/
   ```

2. 웹 브라우저에서:
   - 데이터베이스 정보 섹션 펼치기
   - **🔄 DB 재생성 (새 데이터 반영)** 버튼 클릭
   - 확인 후 자동으로 DB 재생성 완료
   - 업데이트된 데이터 기간 즉시 확인 가능

**방법 2: 터미널 명령어**

```bash
# 1. data/ 폴더에 새 데이터 파일 추가 (CSV, XLS, XLSX 모두 가능)
cp ~/Downloads/2025-10.xlsx data/

# 2. DB 재초기화 (기존 DB는 자동으로 덮어쓰기 확인)
python init_db.py
```

**참고**:
- 새 월별 데이터 추가 시 전체 DB 재구축이 필요합니다 (시계열 통계 재계산)
- CSV, XLS, XLSX 형식 모두 지원하며 수동 변환 불필요
- 약품명이 변경되어도 약품코드 기준으로 자동 매칭되어 최신 값이 반영됩니다
- 웹 UI 사용 시: 실시간 진행 상황 표시 및 완료 후 자동 업데이트
- 터미널 사용 시: 기존 DB 덮어쓰기 전 확인 메시지 표시

### 파일명 패턴 커스터마이징

`read_csv.py`의 `extract_month_from_file` 함수에서 정규표현식 수정:

```python
patterns = [
    r'(\d{4})[-_]?(\d{2})',  # 2025-01, 202501, 2025_01
    r'(\d{4})년\s*(\d{1,2})월',  # 2025년 1월
    # 추가 패턴...
]
```

### 알림 임계값 설정

런웨이 경고 기준 변경:

```python
# generate_report.py의 analyze_runway 함수에서
if months <= 3:  # 3개월 이하 → 부족 경고
    low_data.append((months, row['약품명']))
else:
    high_data.append((months, row['약품명']))
```

## 🔍 문제 해결

### 일반적인 오류 및 해결방법

1. **"DB가 없습니다" 오류**
   ```
   해결: python init_db.py 실행
   ```

2. **파일 읽기 오류**
   ```
   해결:
   - Excel 파일(.xls, .xlsx)을 직접 사용 가능 (변환 불필요)
   - CSV 파일 사용 시 'CSV(UTF-8)(*.csv)' 형식으로 저장
   ```

3. **파일명 날짜 인식 오류**
   ```
   해결: 파일명을 YYYY-MM.* 또는 YYYYMM.* 형식으로 변경 (확장자: csv, xls, xlsx)
   예: 2025-01.csv, 202501.xlsx, 2025_01.xls
   ```

4. **약품코드 중복 문제**
   ```
   해결: 자동으로 float 형태(.0) 제거 및 통합됨
   예: 673400030과 673400030.0이 자동으로 하나로 병합
   ```

5. **인코딩 오류**
   ```
   해결: UTF-8, CP949, EUC-KR 자동 감지 및 변환
   ```

6. **재고가 전부 0으로 표시됨**
   ```
   해결: v3.0에서 해결됨 - 각 약품별 최신 재고 자동 채택
   ```

7. **음수 재고가 양수로 표시됨**
   ```
   해결: v3.0에서 해결됨 - 음수 재고 정확히 반영
   ```

8. **주문 보고서에 모든 약품이 표시됨**
   ```
   해결: v3.0에서 해결됨 - today.csv 약품만 표시
   ```

9. **약품코드 선행 0 소실 및 중복 데이터**
   ```
   증상: '073100370'과 '73100370'이 중복으로 존재

   해결:
   1. v3.4에서 근본 원인 해결됨 - CSV/Excel 읽기 시 dtype={'약품코드': str} 명시
   2. DB 재생성 권장: 웹 UI에서 DB 재생성 버튼 클릭
   ```

## 📝 라이선스

이 프로젝트는 MIT 라이선스 하에 배포됩니다.