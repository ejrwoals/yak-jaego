{% extends "base.html" %}

{% block title %}데이터 파일 관리 - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.get('VERSION', '1') }}">
{% endblock %}

{% block page_styles %}
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background: var(--color-background);
        min-height: 100vh;
        padding: var(--space-5);
        overflow-y: scroll;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--color-surface);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-lg);
        padding: var(--space-8);
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Page Header */
    .page-header {
        display: block;
        text-align: center;
        padding-bottom: var(--space-3);
        margin-bottom: var(--space-6);
        border-bottom: 2px solid var(--color-border);
    }

    .page-header h1 {
        color: var(--color-text-primary);
        font-size: var(--text-2xl);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
    }

    .page-header h1 .icon {
        width: var(--icon-lg);
        height: var(--icon-lg);
        color: var(--brand-primary);
    }

    .page-header p {
        color: var(--color-text-muted);
        margin-top: var(--space-2);
    }

    .back-link {
        color: var(--brand-primary);
        text-decoration: none;
        font-size: var(--text-sm);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        margin-bottom: var(--space-5);
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .back-link .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    /* Data Status Card - Unified Timeline Comparison */
    .data-status-card {
        margin-bottom: var(--space-6);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-xl);
        background: var(--color-surface);
        overflow: visible; /* overflow: hidden 사용 금지 - 툴팁 잘림 방지 */
        transition: border-color var(--transition-normal);
    }

    .data-status-card.synced {
        border-color: var(--color-success);
    }

    .data-status-card.out-of-sync {
        border-color: var(--color-warning);
    }

    .data-status-card.no-db {
        border-color: var(--color-danger);
    }

    .status-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-4) var(--space-5);
        background: var(--color-surface-hover);
        border-bottom: 1px solid var(--color-border);
        border-radius: calc(var(--radius-xl) - 2px) calc(var(--radius-xl) - 2px) 0 0; /* 상단 모서리 */
    }

    .status-card-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
    }

    .status-card-title .icon {
        width: var(--icon-md);
        height: var(--icon-md);
        color: var(--brand-primary);
    }

    .status-card-body {
        padding: var(--space-5);
    }

    /* Tile Timeline Labels */
    .tile-timeline-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-3);
        padding: 0 50px 0 50px; /* label width + tiles start */
    }

    .tile-timeline-labels span {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        font-weight: var(--font-medium);
    }

    /* Tile Timeline Row */
    .tile-timeline-row {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-2);
    }

    .tile-timeline-label {
        width: 40px;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-text-secondary);
        flex-shrink: 0;
    }

    .tile-timeline-tiles {
        display: flex;
        flex-wrap: nowrap;
        gap: 2px;
        flex: 1;
        overflow: visible;
        padding: 20px 4px 4px 4px; /* top padding for tooltip text */
    }

    .tile-timeline-info {
        min-width: 60px;
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        text-align: right;
        flex-shrink: 0;
    }

    .tile-timeline-info strong {
        color: var(--color-text-primary);
        font-weight: var(--font-semibold);
    }

    /* Individual Tile */
    .timeline-tile {
        width: 20px;
        height: 20px;
        border-radius: var(--radius-sm);
        flex-shrink: 0;
        position: relative;
        cursor: pointer;
    }

    .timeline-tile:hover {
        outline: 2px solid var(--color-text-primary);
        outline-offset: 1px;
    }

    /* DB Tile Colors */
    .timeline-tile.db-present {
        background: var(--brand-primary);
    }

    .timeline-tile.db-missing {
        background: var(--color-border);
        opacity: 0.5;
    }

    /* File Tile Colors */
    .timeline-tile.file-present {
        background: var(--color-success);
    }

    .timeline-tile.file-missing {
        background: var(--color-border);
        opacity: 0.5;
    }

    /* Mismatch Highlight */
    .timeline-tile.mismatch {
        box-shadow: 0 0 0 2px var(--color-warning);
    }

    /* Tile Tooltip - 단순 텍스트 */
    .timeline-tile .tooltip {
        display: none;
        position: absolute;
        bottom: calc(100% + 4px);
        left: 50%;
        transform: translateX(-50%);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        color: var(--color-text-secondary);
        white-space: nowrap;
        z-index: 10;
        background: var(--color-surface);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
    }

    .timeline-tile:hover .tooltip {
        display: block;
    }

    /* Sync Indicator */
    .sync-indicator {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: var(--space-1);
        margin-top: var(--space-2);
        font-size: var(--text-xs);
        color: var(--color-warning-dark);
    }

    .sync-indicator .icon {
        width: 14px;
        height: 14px;
    }

    /* Rebuild Button (Compact - in footer) */
    .btn-rebuild-compact {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
        flex-shrink: 0;
    }

    .btn-rebuild-compact .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .btn-rebuild-compact.synced {
        background: var(--color-surface);
        color: var(--color-text-secondary);
        border: 1px solid var(--color-border);
    }

    .btn-rebuild-compact.synced:hover {
        background: var(--color-border);
        color: var(--color-text-primary);
    }

    .btn-rebuild-compact.out-of-sync {
        background: var(--color-warning);
        color: white;
    }

    .btn-rebuild-compact.out-of-sync:hover {
        background: var(--color-warning-dark);
    }

    .btn-rebuild-compact.no-db {
        background: var(--color-danger);
        color: white;
    }

    .btn-rebuild-compact.no-db:hover {
        background: var(--color-danger-dark);
    }

    .btn-rebuild-compact:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-rebuild-compact .icon-spin {
        animation: spin 1s linear infinite;
    }

    /* Status Card Footer */
    .status-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-4);
        padding: var(--space-3) var(--space-5);
        background: var(--color-surface-hover);
        border-top: 1px solid var(--color-border);
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        border-radius: 0 0 calc(var(--radius-xl) - 2px) calc(var(--radius-xl) - 2px); /* 하단 모서리 */
    }

    .footer-stats {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: var(--space-3);
    }

    .footer-stats span {
        display: flex;
        align-items: center;
        gap: var(--space-1);
    }

    .footer-stats strong {
        color: var(--color-text-primary);
        font-weight: var(--font-semibold);
    }

    .footer-stats .divider {
        color: var(--color-border);
    }

    /* Upload Area */
    .upload-section {
        margin-bottom: var(--space-6);
    }

    .upload-area {
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-8);
        text-align: center;
        cursor: pointer;
        transition: all var(--transition-normal);
        background: var(--color-surface);
    }

    .upload-area:hover {
        border-color: var(--brand-primary);
        background: var(--brand-primary-subtle);
    }

    .upload-area.drag-over {
        border-color: var(--brand-primary);
        background: var(--brand-primary-subtle);
        transform: scale(1.01);
    }

    .upload-area .icon {
        width: 48px;
        height: 48px;
        color: var(--brand-primary);
        margin-bottom: var(--space-3);
    }

    .upload-area h3 {
        color: var(--color-text-primary);
        font-size: var(--text-lg);
        margin-bottom: var(--space-2);
    }

    .upload-area p {
        color: var(--color-text-muted);
        font-size: var(--text-sm);
    }

    .upload-input {
        display: none;
    }

    .section-title {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-3);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .section-title .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        color: var(--brand-primary);
    }

    /* File List Section */
    .file-list-section {
        margin-bottom: var(--space-6);
    }

    .file-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }

    .btn-rebuild {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        background: var(--brand-primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-rebuild:hover {
        background: var(--brand-primary-dark);
    }

    .btn-rebuild:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-rebuild .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .btn-rebuild .icon-spin {
        animation: spin 1s linear infinite;
    }

    /* File List */
    .file-list {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .file-card {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .file-card:hover {
        border-color: var(--brand-primary);
        box-shadow: var(--shadow-sm);
    }

    .file-icon {
        width: 40px;
        height: 40px;
        background: var(--brand-primary-subtle);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .file-icon .icon {
        width: var(--icon-md);
        height: var(--icon-md);
        color: var(--brand-primary);
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        font-size: var(--text-sm);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-meta {
        display: flex;
        gap: var(--space-3);
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--space-1);
    }

    .file-badge {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    .file-badge.valid {
        background: var(--color-success-light);
        color: var(--color-success-dark);
    }

    .file-badge.invalid {
        background: var(--color-danger-light);
        color: var(--color-danger-dark);
    }

    .file-badge.pending {
        background: var(--color-surface-hover);
        color: var(--color-text-muted);
    }

    .file-actions {
        display: flex;
        gap: var(--space-2);
        flex-shrink: 0;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        background: transparent;
    }

    .btn-icon .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .btn-icon.btn-preview {
        color: var(--brand-primary);
    }

    .btn-icon.btn-preview:hover {
        background: var(--brand-primary-subtle);
    }

    .btn-icon.btn-delete {
        color: var(--color-danger);
    }

    .btn-icon.btn-delete:hover {
        background: var(--color-danger-light);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--space-10);
        color: var(--color-text-muted);
    }

    .empty-state .icon {
        width: 64px;
        height: 64px;
        margin-bottom: var(--space-4);
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: var(--text-lg);
        margin-bottom: var(--space-2);
        color: var(--color-text-secondary);
    }

    /* Preview Modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: var(--space-4);
    }

    .modal-backdrop.active {
        display: flex;
    }

    .modal {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        max-width: 900px;
        width: 100%;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4) var(--space-5);
        border-bottom: 1px solid var(--color-border);
    }

    .modal-header h2 {
        font-size: var(--text-lg);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .modal-header h2 .icon {
        width: var(--icon-md);
        height: var(--icon-md);
        color: var(--brand-primary);
    }

    .modal-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        background: transparent;
        color: var(--color-text-muted);
        transition: all var(--transition-fast);
    }

    .modal-close:hover {
        background: var(--color-surface-hover);
        color: var(--color-text-primary);
    }

    .modal-close .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .modal-body {
        flex: 1;
        overflow: auto;
        padding: var(--space-5);
    }

    .preview-info {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-4);
        flex-wrap: wrap;
    }

    .preview-info-item {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
    }

    .preview-info-item strong {
        color: var(--color-text-primary);
    }

    .preview-table-container {
        overflow-x: auto;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
    }

    .preview-table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--text-sm);
    }

    .preview-table th,
    .preview-table td {
        padding: var(--space-2) var(--space-3);
        text-align: left;
        border-bottom: 1px solid var(--color-border);
        white-space: nowrap;
    }

    .preview-table th {
        background: var(--color-surface-hover);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        position: sticky;
        top: 0;
    }

    .preview-table tr:last-child td {
        border-bottom: none;
    }

    .preview-table tr:hover td {
        background: var(--color-surface-hover);
    }

    /* Validation Info */
    .validation-info {
        margin-top: var(--space-4);
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface-hover);
        border-radius: var(--radius-md);
    }

    .validation-info h4 {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        margin-bottom: var(--space-2);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .validation-info h4 .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .validation-info.valid h4 {
        color: var(--color-success);
    }

    .validation-info.invalid h4 {
        color: var(--color-danger);
    }

    .validation-columns {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-1);
        margin-top: var(--space-2);
    }

    .column-tag {
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        font-size: var(--text-xs);
    }

    .column-tag.present {
        background: var(--color-success-light);
        color: var(--color-success-dark);
    }

    .column-tag.missing {
        background: var(--color-danger-light);
        color: var(--color-danger-dark);
    }

    /* Notice */
    .notice {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-4);
        background: var(--color-warning-light);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        color: var(--color-warning-dark);
        margin-top: var(--space-4);
    }

    .notice .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        flex-shrink: 0;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        z-index: 999;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-content {
        text-align: center;
    }

    .loading-content .icon {
        width: 48px;
        height: 48px;
        color: var(--brand-primary);
        animation: spin 1s linear infinite;
    }

    .loading-content p {
        margin-top: var(--space-3);
        color: var(--color-text-secondary);
        font-size: var(--text-sm);
    }

    /* Month Picker Modal */
    .month-picker-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-4);
        margin-bottom: var(--space-5);
    }

    .month-picker-field {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
    }

    .month-picker-field label {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-text-secondary);
    }

    .month-picker-select {
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--text-base);
        background: var(--color-surface);
        color: var(--color-text-primary);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 40px;
    }

    .month-picker-select:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .month-picker-actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
    }

    .btn-secondary {
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        color: var(--color-text-secondary);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-secondary:hover {
        background: var(--color-surface-hover);
        color: var(--color-text-primary);
    }

    .btn-primary {
        padding: var(--space-2) var(--space-4);
        border: none;
        border-radius: var(--radius-md);
        background: var(--brand-primary);
        color: white;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-primary:hover {
        background: var(--brand-primary-dark);
    }
</style>
{% endblock %}

{% block toast_container %}
{% include 'partials/_toast_container.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-link">
        <svg class="icon"><use href="#icon-arrow-left"></use></svg>
        홈으로 돌아가기
    </a>

    <div class="page-header">
        <h1>
            <svg class="icon"><use href="#icon-folder"></use></svg>
            데이터 파일 관리
        </h1>
        <p>월별 약품 사용량 데이터 파일을 관리합니다</p>
    </div>

    <!-- Data Status Card - Unified Timeline Comparison -->
    <div class="data-status-card" id="data-status-card">
        <!-- Card Header -->
        <div class="status-card-header">
            <div class="status-card-title">
                <svg class="icon"><use href="#icon-database"></use></svg>
                데이터 상태
            </div>
        </div>

        <!-- Card Body - Tile Timeline Comparison -->
        <div class="status-card-body">
            <!-- Timeline Period Labels -->
            <div class="tile-timeline-labels">
                <span id="timeline-start-label">-</span>
                <span id="timeline-end-label">-</span>
            </div>

            <!-- DB Tile Timeline Row -->
            <div class="tile-timeline-row">
                <span class="tile-timeline-label">DB</span>
                <div class="tile-timeline-tiles" id="db-tiles"></div>
                <span class="tile-timeline-info" id="db-tile-info">-</span>
            </div>

            <!-- File Tile Timeline Row -->
            <div class="tile-timeline-row">
                <span class="tile-timeline-label">파일</span>
                <div class="tile-timeline-tiles" id="file-tiles"></div>
                <span class="tile-timeline-info" id="file-tile-info">-</span>
            </div>

            <!-- Sync Indicator (shown only when mismatch) -->
            <div class="sync-indicator" id="sync-indicator" style="display: none;">
                <svg class="icon"><use href="#icon-alert-triangle"></use></svg>
                <span id="sync-indicator-message">불일치 발견</span>
            </div>
        </div>

        <!-- Card Footer - DB Details + Rebuild Button -->
        <div class="status-card-footer" id="db-details-footer">
            <div class="footer-stats">
                <span>일반약: <strong id="stat-general">-</strong></span>
                <span class="divider">|</span>
                <span>전문약: <strong id="stat-prescription">-</strong></span>
            </div>
            <button class="btn-rebuild-compact synced" id="btn-rebuild-main" onclick="rebuildDatabase()">
                <svg class="icon"><use href="#icon-refresh-cw"></use></svg>
                <span id="btn-rebuild-text">DB 재생성</span>
            </button>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <div class="upload-area" id="upload-area">
            <svg class="icon"><use href="#icon-upload"></use></svg>
            <h3>파일을 여기에 드래그하거나 클릭하세요</h3>
            <p>CSV, XLS, XLSX 형식 지원 (파일명 예: 2025-01.xls, 202501.csv)</p>
        </div>
        <input type="file" class="upload-input" id="upload-input" accept=".csv,.xls,.xlsx" multiple>
    </div>

    <!-- File List Section -->
    <div class="file-list-section">
        <div class="file-list-header">
            <div class="section-title">
                <svg class="icon"><use href="#icon-list"></use></svg>
                파일 목록
            </div>
        </div>

        <div class="file-list" id="file-list">
            <div class="empty-state">
                <svg class="icon"><use href="#icon-folder"></use></svg>
                <h3>데이터 파일이 없습니다</h3>
                <p>위의 업로드 영역을 사용하여 파일을 추가하세요</p>
            </div>
        </div>
    </div>

</div>

<!-- Preview Modal -->
<div class="modal-backdrop" id="preview-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>
                <svg class="icon"><use href="#icon-eye"></use></svg>
                <span id="preview-filename">파일 미리보기</span>
            </h2>
            <button class="modal-close" onclick="closePreviewModal()">
                <svg class="icon"><use href="#icon-x"></use></svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="preview-info" id="preview-info"></div>
            <div class="preview-table-container">
                <table class="preview-table" id="preview-table">
                    <thead id="preview-thead"></thead>
                    <tbody id="preview-tbody"></tbody>
                </table>
            </div>
            <div class="validation-info" id="validation-info"></div>
        </div>
    </div>
</div>

<!-- Month Picker Modal -->
<div class="modal-backdrop" id="month-picker-modal">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h2>
                <svg class="icon"><use href="#icon-calendar"></use></svg>
                데이터 월 선택
            </h2>
            <button class="modal-close" onclick="closeMonthPicker()">
                <svg class="icon"><use href="#icon-x"></use></svg>
            </button>
        </div>
        <div class="modal-body">
            <p id="month-picker-filename" style="margin-bottom: var(--space-4); color: var(--color-text-secondary);"></p>
            <div class="month-picker-grid">
                <div class="month-picker-field">
                    <label>년도</label>
                    <select id="month-picker-year" class="month-picker-select"></select>
                </div>
                <div class="month-picker-field">
                    <label>월</label>
                    <select id="month-picker-month" class="month-picker-select">
                        <option value="01">1월</option>
                        <option value="02">2월</option>
                        <option value="03">3월</option>
                        <option value="04">4월</option>
                        <option value="05">5월</option>
                        <option value="06">6월</option>
                        <option value="07">7월</option>
                        <option value="08">8월</option>
                        <option value="09">9월</option>
                        <option value="10">10월</option>
                        <option value="11">11월</option>
                        <option value="12">12월</option>
                    </select>
                </div>
            </div>
            <div class="month-picker-actions">
                <button class="btn-secondary" onclick="closeMonthPicker()">취소</button>
                <button class="btn-primary" onclick="confirmMonthPicker()">이 월로 업로드</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <svg class="icon"><use href="#icon-loader"></use></svg>
        <p id="loading-text">처리 중...</p>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    // 전역 변수
    var currentFiles = [];
    var validationCache = {};
    var monthPickerState = {
        file: null,
        callback: null
    };

    // DB 상태 정보 (서버에서 전달)
    var dbStats = {
        {% if db_stats %}
        recentCount: {{ db_stats.recent_count }},
        processedStats: {
            total: {{ db_stats.processed_stats.total }},
            byType: {
                {% if db_stats.processed_stats.by_type %}
                {% for drug_type, count in db_stats.processed_stats.by_type.items() %}
                '{{ drug_type }}': {{ count }}{% if not loop.last %},{% endif %}
                {% endfor %}
                {% endif %}
            }
        },
        newDrugCount: {{ db_stats.new_drug_count }},
        {% if db_stats.data_period %}
        period: {
            start: '{{ db_stats.data_period.start_month }}',
            end: '{{ db_stats.data_period.end_month }}',
            months: {{ db_stats.data_period.total_months }}
        }
        {% else %}
        period: null
        {% endif %}
        {% else %}
        recentCount: 0,
        processedStats: { total: 0, byType: {} },
        newDrugCount: 0,
        period: null
        {% endif %}
    };

    // 두 월 배열의 합집합 생성 및 정렬
    function mergeAndSortMonths(dbMonths, fileMonths) {
        var monthSet = {};
        dbMonths.forEach(function(m) { monthSet[m] = true; });
        fileMonths.forEach(function(m) { monthSet[m] = true; });
        return Object.keys(monthSet).sort();
    }

    // 다음 월 계산 (2025-12 → 2026-01)
    function nextMonth(month) {
        var parts = month.split('-');
        var year = parseInt(parts[0]);
        var m = parseInt(parts[1]);
        m++;
        if (m > 12) {
            m = 1;
            year++;
        }
        return year + '-' + (m < 10 ? '0' + m : m);
    }

    // 시작월~끝월 사이 모든 월 생성 (연속적인 타임라인)
    function generateContinuousMonths(dbMonths, fileMonths) {
        var allExisting = mergeAndSortMonths(dbMonths, fileMonths);
        if (allExisting.length === 0) return [];

        var startMonth = allExisting[0];
        var endMonth = allExisting[allExisting.length - 1];

        var result = [];
        var current = startMonth;
        while (current <= endMonth) {
            result.push(current);
            current = nextMonth(current);
        }
        return result;
    }

    // 데이터 상태 카드 렌더링 (타일 기반)
    function renderDataStatusCard(dbMonths, fileMonths) {
        var card = document.getElementById('data-status-card');
        var dbTilesEl = document.getElementById('db-tiles');
        var fileTilesEl = document.getElementById('file-tiles');
        var dbInfoEl = document.getElementById('db-tile-info');
        var fileInfoEl = document.getElementById('file-tile-info');
        var startLabel = document.getElementById('timeline-start-label');
        var endLabel = document.getElementById('timeline-end-label');
        var syncIndicator = document.getElementById('sync-indicator');
        var syncMessage = document.getElementById('sync-indicator-message');
        var rebuildBtn = document.getElementById('btn-rebuild-main');
        var rebuildText = document.getElementById('btn-rebuild-text');
        var footerEl = document.getElementById('db-details-footer');

        // DB와 파일 모두 없으면 초기 상태
        if (dbMonths.length === 0 && fileMonths.length === 0) {
            startLabel.textContent = '-';
            endLabel.textContent = '-';
            dbTilesEl.innerHTML = '<span style="color: var(--color-text-muted); font-size: var(--text-xs);">데이터 없음</span>';
            fileTilesEl.innerHTML = '<span style="color: var(--color-text-muted); font-size: var(--text-xs);">파일 없음</span>';
            dbInfoEl.textContent = '-';
            fileInfoEl.textContent = '-';
            card.className = 'data-status-card no-db';
            rebuildBtn.className = 'btn-rebuild-compact no-db';
            rebuildText.textContent = 'DB 초기화';
            syncIndicator.style.display = 'none';
            footerEl.style.display = 'none';
            return;
        }

        // 전체 월 목록 (합집합)
        var allMonths = generateContinuousMonths(dbMonths, fileMonths);

        // 최대 타일 수 제한 (컨테이너 너비 기준 약 35개)
        var MAX_TILES = 35;
        var omittedCount = 0;

        if (allMonths.length > MAX_TILES) {
            omittedCount = allMonths.length - MAX_TILES;
            allMonths = allMonths.slice(-MAX_TILES); // 최근 N개월만 유지
        }

        // 기간 라벨 설정
        if (omittedCount > 0) {
            startLabel.innerHTML = '<span title="이전 ' + omittedCount + '개월 생략됨">... ' + formatMonthKorean(allMonths[0]) + '</span>';
        } else {
            startLabel.textContent = formatMonthKorean(allMonths[0]);
        }
        endLabel.textContent = formatMonthKorean(allMonths[allMonths.length - 1]);

        // DB 월 목록을 Set으로 변환 (빠른 조회)
        var dbMonthSet = {};
        dbMonths.forEach(function(m) { dbMonthSet[m] = true; });

        // 파일 월 목록을 Set으로 변환
        var fileMonthSet = {};
        fileMonths.forEach(function(m) { fileMonthSet[m] = true; });

        // 불일치 목록
        var mismatches = [];

        // DB 타일 생성
        var dbTilesHtml = '';
        allMonths.forEach(function(month) {
            var hasDb = dbMonthSet[month] === true;
            var hasFile = fileMonthSet[month] === true;
            var isMismatch = hasDb !== hasFile;
            var isBothMissing = !hasDb && !hasFile;

            if (isMismatch) {
                mismatches.push({
                    month: month,
                    type: hasDb ? 'file-missing' : 'db-missing'
                });
            }

            var tooltipText = formatMonthKorean(month);
            if (isBothMissing) {
                tooltipText += ' (데이터 없음)';
            } else if (!hasDb) {
                tooltipText += ' (DB 없음)';
            }

            dbTilesHtml += '<div class="timeline-tile ' +
                (hasDb ? 'db-present' : 'db-missing') +
                (isMismatch || isBothMissing ? ' mismatch' : '') + '">' +
                '<span class="tooltip">' + tooltipText + '</span></div>';
        });
        dbTilesEl.innerHTML = dbTilesHtml;

        // 파일 타일 생성
        var fileTilesHtml = '';
        allMonths.forEach(function(month) {
            var hasDb = dbMonthSet[month] === true;
            var hasFile = fileMonthSet[month] === true;
            var isMismatch = hasDb !== hasFile;
            var isBothMissing = !hasDb && !hasFile;

            var tooltipText = formatMonthKorean(month);
            if (isBothMissing) {
                tooltipText += ' (데이터 없음)';
            } else if (!hasFile) {
                tooltipText += ' (파일 없음)';
            }

            fileTilesHtml += '<div class="timeline-tile ' +
                (hasFile ? 'file-present' : 'file-missing') +
                (isMismatch || isBothMissing ? ' mismatch' : '') + '">' +
                '<span class="tooltip">' + tooltipText + '</span></div>';
        });
        fileTilesEl.innerHTML = fileTilesHtml;

        // 정보 표시
        dbInfoEl.innerHTML = '<strong>' + dbMonths.length + '</strong>개월';
        fileInfoEl.innerHTML = '<strong>' + fileMonths.length + '</strong>개월';

        // 누락 월 감지 (DB도 없고 파일도 없는 월)
        var missingMonths = allMonths.filter(function(month) {
            return !dbMonthSet[month] && !fileMonthSet[month];
        });

        // 동기화 상태 판단
        var syncStatus = 'synced';
        var hasIssues = mismatches.length > 0 || missingMonths.length > 0;

        if (dbMonths.length === 0 && fileMonths.length > 0) {
            syncStatus = 'no-db';
            syncMessage.textContent = 'DB 초기화가 필요합니다';
            rebuildText.textContent = 'DB 초기화';
        } else if (hasIssues) {
            syncStatus = 'out-of-sync';
            // 불일치 메시지 생성
            var dbMissing = mismatches.filter(function(m) { return m.type === 'db-missing'; });
            var fileMissing = mismatches.filter(function(m) { return m.type === 'file-missing'; });

            var msgParts = [];
            if (missingMonths.length > 0) {
                msgParts.push('데이터 누락 ' + missingMonths.length + '개월');
            }
            if (dbMissing.length > 0) {
                msgParts.push('DB 미반영 ' + dbMissing.length + '개월');
            }
            if (fileMissing.length > 0) {
                msgParts.push('파일 누락 ' + fileMissing.length + '개월');
            }
            syncMessage.textContent = msgParts.join(', ');
            rebuildText.textContent = 'DB 재생성';
        } else {
            rebuildText.textContent = 'DB 재생성';
        }

        // 상태에 따른 스타일 적용
        card.className = 'data-status-card ' + syncStatus;
        rebuildBtn.className = 'btn-rebuild-compact ' + syncStatus;
        syncIndicator.style.display = hasIssues ? 'flex' : 'none';

        // Footer DB 상세 정보 업데이트
        if (dbStats.period) {
            footerEl.style.display = 'flex';
            document.getElementById('stat-general').textContent = dbStats.processedStats.byType['일반약'] || 0;
            document.getElementById('stat-prescription').textContent = dbStats.processedStats.byType['전문약'] || 0;
        } else {
            footerEl.style.display = 'none';
        }
    }

    // 월 포맷 변환 (2025-12 → 2025년 12월)
    function formatMonthKorean(month) {
        if (!month) return '날짜 없음';
        var parts = month.split('-');
        if (parts.length !== 2) return month;
        return parts[0] + '년 ' + parseInt(parts[1], 10) + '월';
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        loadDataFiles();
        initDragDrop();
        initMonthPicker();
    });

    // 월 선택기 초기화
    function initMonthPicker() {
        var yearSelect = document.getElementById('month-picker-year');
        var currentYear = new Date().getFullYear();
        // 5년 전부터 현재 년도까지
        for (var y = currentYear; y >= currentYear - 5; y--) {
            var option = document.createElement('option');
            option.value = y;
            option.textContent = y + '년';
            yearSelect.appendChild(option);
        }
    }

    // 월 선택 모달 열기
    function openMonthPicker(file, callback, suggestedMonth, dateExtractionFailed) {
        monthPickerState.file = file;
        monthPickerState.callback = callback;

        var filenameEl = document.getElementById('month-picker-filename');
        if (dateExtractionFailed) {
            filenameEl.innerHTML = '파일: <strong>' + file.name + '</strong><br><br>' +
                '<span style="color: var(--color-warning-dark);">⚠️ 파일명에서 날짜를 추출할 수 없었습니다. 데이터의 월을 직접 선택해주세요.</span>';
        } else {
            filenameEl.innerHTML = '파일: <strong>' + file.name + '</strong>';
        }

        // 추출된 월이 있으면 기본값으로 설정
        if (suggestedMonth) {
            var parts = suggestedMonth.split('-');
            if (parts.length === 2) {
                document.getElementById('month-picker-year').value = parts[0];
                document.getElementById('month-picker-month').value = parts[1];
            }
        } else {
            // 현재 날짜로 설정
            var now = new Date();
            document.getElementById('month-picker-year').value = now.getFullYear();
            document.getElementById('month-picker-month').value = String(now.getMonth() + 1).padStart(2, '0');
        }

        document.getElementById('month-picker-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // 월 선택 모달 닫기
    function closeMonthPicker() {
        document.getElementById('month-picker-modal').classList.remove('active');
        document.body.style.overflow = '';

        // 취소 시 callback 호출
        if (monthPickerState.callback) {
            showToast('업로드가 취소되었습니다.', 'info');
            monthPickerState.callback();
        }
        monthPickerState.file = null;
        monthPickerState.callback = null;
    }

    // 월 선택 확인
    function confirmMonthPicker() {
        var year = document.getElementById('month-picker-year').value;
        var month = document.getElementById('month-picker-month').value;
        var customMonth = year + '-' + month;

        document.getElementById('month-picker-modal').classList.remove('active');
        document.body.style.overflow = '';

        // 선택한 월로 업로드
        var file = monthPickerState.file;
        var callback = monthPickerState.callback;
        monthPickerState.file = null;
        monthPickerState.callback = null;

        uploadFile(file, callback, customMonth);
    }

    // 파일 목록 로드
    function loadDataFiles() {
        fetch('/api/data-files')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.error) {
                    showToast(data.error, 'error');
                    return;
                }

                currentFiles = data.files;
                // 타일 기반 상태 카드 렌더링 (db_months, file_months 사용)
                renderDataStatusCard(data.db_months || [], data.file_months || []);
                renderFileList(data.files);
            })
            .catch(function(error) {
                console.error('Error:', error);
                showToast('파일 목록을 불러오는데 실패했습니다.', 'error');
            });
    }

    // 파일 목록 렌더링
    function renderFileList(files) {
        var container = document.getElementById('file-list');

        if (files.length === 0) {
            container.innerHTML = '<div class="empty-state">' +
                '<svg class="icon"><use href="#icon-folder"></use></svg>' +
                '<h3>데이터 파일이 없습니다</h3>' +
                '<p>위의 업로드 영역을 사용하여 파일을 추가하세요</p>' +
                '</div>';
            return;
        }

        var html = '';
        files.forEach(function(file) {
            var badgeClass = validationCache[file.filename] !== undefined
                ? (validationCache[file.filename] ? 'valid' : 'invalid')
                : 'pending';
            var badgeText = validationCache[file.filename] !== undefined
                ? (validationCache[file.filename] ? '유효' : '오류')
                : '검증 필요';

            var monthDisplay = file.month ? formatMonthKorean(file.month) : '날짜 없음';

            var uploadedAtDisplay = file.uploaded_at ? file.uploaded_at : '-';

            html += '<div class="file-card" data-filename="' + file.filename + '">' +
                '<div class="file-icon">' +
                    '<svg class="icon"><use href="#icon-file-text"></use></svg>' +
                '</div>' +
                '<div class="file-info">' +
                    '<div class="file-name">' + file.filename + '</div>' +
                    '<div class="file-meta">' +
                        '<span style="color: var(--color-success); font-weight: var(--font-semibold);">' + monthDisplay + '</span>' +
                        '<span>파일 크기: ' + file.size_display + '</span>' +
                        '<span>파일 수정: ' + file.file_modified_at + '</span>' +
                        '<span>업로드: ' + uploadedAtDisplay + '</span>' +
                    '</div>' +
                '</div>' +
                '<span class="file-badge ' + badgeClass + '">' + badgeText + '</span>' +
                '<div class="file-actions">' +
                    '<button class="btn-icon btn-preview" onclick="previewFile(\'' + file.filename + '\')" title="미리보기">' +
                        '<svg class="icon"><use href="#icon-eye"></use></svg>' +
                    '</button>' +
                    '<button class="btn-icon btn-delete" onclick="deleteFile(\'' + file.filename + '\')" title="삭제">' +
                        '<svg class="icon"><use href="#icon-trash-2"></use></svg>' +
                    '</button>' +
                '</div>' +
            '</div>';
        });

        container.innerHTML = html;

        // 검증 상태 로드
        files.forEach(function(file) {
            if (validationCache[file.filename] === undefined) {
                validateFile(file.filename, true);
            }
        });
    }

    // 드래그앤드롭 초기화
    function initDragDrop() {
        var uploadArea = document.getElementById('upload-area');
        var uploadInput = document.getElementById('upload-input');

        uploadArea.addEventListener('click', function() {
            uploadInput.click();
        });

        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            var files = e.dataTransfer.files;
            handleFiles(files);
        });

        uploadInput.addEventListener('change', function(e) {
            handleFiles(e.target.files);
            uploadInput.value = ''; // 같은 파일 재선택 가능하도록
        });
    }

    // 파일 처리
    function handleFiles(files) {
        // 순차 처리 (각 파일에 대해 확인 후 업로드)
        processFilesSequentially(Array.from(files), 0);
    }

    // 파일 순차 처리
    function processFilesSequentially(files, index) {
        if (index >= files.length) {
            return;
        }
        checkAndUploadFile(files[index], function() {
            processFilesSequentially(files, index + 1);
        });
    }

    // 파일 확인 후 업로드
    async function checkAndUploadFile(file, callback) {
        // 먼저 파일 유효성 및 중복 확인
        try {
            var response = await fetch('/api/check-data-file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file.name })
            });
            var checkResult = await response.json();

            if (checkResult.error) {
                showToast(checkResult.error, 'error');
                if (callback) callback();
                return;
            }

            // 파일명에서 날짜 추출 불가한 경우 바로 월 선택 모달 열기
            if (!checkResult.valid) {
                openMonthPicker(file, callback, null, true);
                return;
            }

            // 1. 먼저 추출된 월이 맞는지 사용자에게 확인
            var monthDisplay = formatMonthKorean(checkResult.month);
            var confirmMonthMessage = '<strong>' + file.name + '</strong><br><br>' +
                '이 파일은 <strong style="color: var(--color-success); font-size: 1.2em;">' + monthDisplay + '</strong> 사용량 데이터가 맞습니까?';

            // 중복 파일 정보도 함께 표시
            if (checkResult.exists) {
                confirmMonthMessage += '<br><br><span style="color: var(--color-warning-dark);">⚠️ 동일 파일명이 이미 존재합니다. 기존 파일을 덮어씁니다.</span>';
            } else if (checkResult.same_month_files && checkResult.same_month_files.length > 0) {
                var sameMonthList = checkResult.same_month_files.join(', ');
                confirmMonthMessage += '<br><br><span style="color: var(--color-warning-dark);">⚠️ ' + monthDisplay + ' 데이터가 이미 존재합니다: ' + sameMonthList + '</span>';
            }

            confirmMonthMessage += '<br><br><span style="font-size: var(--text-sm); color: var(--color-text-muted);">' +
                '아니라면 취소 후 직접 월을 선택할 수 있습니다.</span>';

            var confirmed = await showConfirmModal({
                icon: 'info',
                title: '데이터 월 확인',
                message: confirmMonthMessage,
                confirmText: '맞습니다',
                cancelText: '아니요, 직접 선택',
                isDanger: false
            });

            if (!confirmed) {
                // 직접 월 선택 모달 열기
                openMonthPicker(file, callback, checkResult.month);
                return;
            }

            // 업로드 진행
            uploadFile(file, callback, null);

        } catch (error) {
            console.error('Check error:', error);
            showToast('파일 확인 중 오류가 발생했습니다.', 'error');
            if (callback) callback();
        }
    }

    // 파일 업로드 (실제 수행)
    function uploadFile(file, callback, customMonth) {
        showLoading('파일 업로드 중...');

        var formData = new FormData();
        formData.append('file', file);
        if (customMonth) {
            formData.append('month', customMonth);
        }

        fetch('/api/upload-data-file', {
            method: 'POST',
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            hideLoading();
            if (data.error) {
                showToast(data.error, 'error');
            } else {
                // 새 파일 vs 덮어쓰기 구분하여 메시지 표시
                var toastType = data.is_replacement ? 'info' : 'success';
                var monthDisplay = formatMonthKorean(data.month);
                var actionText = data.is_replacement ? '교체' : '추가';
                var manualNote = data.is_manual ? ' (수동 지정)' : '';
                showToast(monthDisplay + ' 데이터가 ' + actionText + '되었습니다.' + manualNote, toastType);
                loadDataFiles();
            }
            if (callback) callback();
        })
        .catch(function(error) {
            hideLoading();
            console.error('Error:', error);
            showToast('파일 업로드에 실패했습니다.', 'error');
            if (callback) callback();
        });
    }

    // 파일 삭제
    async function deleteFile(filename) {
        var confirmed = await showConfirmModal({
            icon: 'danger',
            title: '파일 삭제',
            message: '<strong>' + filename + '</strong> 파일을 삭제하시겠습니까?<br><br>삭제 후 DB 재생성이 필요합니다.',
            confirmText: '삭제',
            isDanger: true
        });

        if (!confirmed) return;

        showLoading('파일 삭제 중...');

        fetch('/api/delete-data-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: filename })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            hideLoading();
            if (data.error) {
                showToast(data.error, 'error');
            } else {
                showToast(data.message, 'success');
                delete validationCache[filename];
                loadDataFiles();
            }
        })
        .catch(function(error) {
            hideLoading();
            console.error('Error:', error);
            showToast('파일 삭제에 실패했습니다.', 'error');
        });
    }

    // 파일 미리보기
    function previewFile(filename) {
        showLoading('파일 로딩 중...');

        Promise.all([
            fetch('/api/preview-data-file/' + encodeURIComponent(filename)).then(function(r) { return r.json(); }),
            fetch('/api/validate-data-file/' + encodeURIComponent(filename)).then(function(r) { return r.json(); })
        ])
        .then(function(results) {
            hideLoading();
            var previewData = results[0];
            var validationData = results[1];

            if (previewData.error) {
                showToast(previewData.error, 'error');
                return;
            }

            openPreviewModal(filename, previewData, validationData);
        })
        .catch(function(error) {
            hideLoading();
            console.error('Error:', error);
            showToast('파일 미리보기에 실패했습니다.', 'error');
        });
    }

    // 파일 검증 (백그라운드)
    function validateFile(filename, silent) {
        fetch('/api/validate-data-file/' + encodeURIComponent(filename))
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (!data.error) {
                    validationCache[filename] = data.valid;
                    if (!silent) {
                        renderFileList(currentFiles);
                    } else {
                        // 배지만 업데이트
                        var card = document.querySelector('.file-card[data-filename="' + filename + '"]');
                        if (card) {
                            var badge = card.querySelector('.file-badge');
                            if (badge) {
                                badge.className = 'file-badge ' + (data.valid ? 'valid' : 'invalid');
                                badge.textContent = data.valid ? '유효' : '오류';
                            }
                        }
                    }
                }
            })
            .catch(function(error) {
                console.error('Validation error:', error);
            });
    }

    // 미리보기 모달 열기
    function openPreviewModal(filename, previewData, validationData) {
        document.getElementById('preview-filename').textContent = filename;

        // 미리보기 정보
        var infoHtml = '<div class="preview-info-item">총 행 수: <strong>' + previewData.total_rows + '행</strong></div>' +
            '<div class="preview-info-item">미리보기: <strong>' + previewData.preview_rows + '행</strong></div>';
        document.getElementById('preview-info').innerHTML = infoHtml;

        // 테이블 헤더
        var theadHtml = '<tr>';
        previewData.columns.forEach(function(col) {
            theadHtml += '<th>' + col + '</th>';
        });
        theadHtml += '</tr>';
        document.getElementById('preview-thead').innerHTML = theadHtml;

        // 테이블 바디
        var tbodyHtml = '';
        previewData.rows.forEach(function(row) {
            tbodyHtml += '<tr>';
            row.forEach(function(cell) {
                tbodyHtml += '<td>' + (cell !== null && cell !== '' ? cell : '-') + '</td>';
            });
            tbodyHtml += '</tr>';
        });
        document.getElementById('preview-tbody').innerHTML = tbodyHtml;

        // 검증 정보
        var validationHtml = '';
        if (validationData && !validationData.error) {
            var isValid = validationData.valid;
            validationHtml = '<div class="validation-info ' + (isValid ? 'valid' : 'invalid') + '">' +
                '<h4>' +
                    '<svg class="icon"><use href="#icon-' + (isValid ? 'check-circle' : 'alert-circle') + '"></use></svg>' +
                    (isValid ? '유효한 파일입니다' : '파일에 문제가 있습니다') +
                '</h4>';

            if (validationData.warnings && validationData.warnings.length > 0) {
                validationHtml += '<p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-2);">' +
                    validationData.warnings.join(', ') + '</p>';
            }

            validationHtml += '<div class="validation-columns">';
            validationData.required_columns.forEach(function(col) {
                var isPresent = validationData.present_columns.indexOf(col) !== -1;
                validationHtml += '<span class="column-tag ' + (isPresent ? 'present' : 'missing') + '">' +
                    col + (isPresent ? '' : ' (누락)') + '</span>';
            });
            validationHtml += '</div></div>';
        }
        document.getElementById('validation-info').innerHTML = validationHtml;

        // 모달 표시
        document.getElementById('preview-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // 미리보기 모달 닫기
    function closePreviewModal() {
        document.getElementById('preview-modal').classList.remove('active');
        document.body.style.overflow = '';
    }

    // 모달 바깥 클릭 시 닫기
    document.getElementById('preview-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreviewModal();
        }
    });

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePreviewModal();
        }
    });

    // DB 재생성
    async function rebuildDatabase() {
        var isInitialize = !dbStats.period;
        var title = isInitialize ? 'DB 초기화' : 'DB 재생성';
        var message = isInitialize
            ? 'data/ 폴더의 모든 파일을 기반으로 새로운 DB가 생성됩니다.<br><br>계속하시겠습니까?'
            : '기존 DB가 삭제되고 data/ 폴더의 모든 파일을 기반으로 새로운 DB가 생성됩니다.<br><br>계속하시겠습니까?';

        var confirmed = await showConfirmModal({
            icon: 'warning',
            title: title,
            message: message,
            confirmText: isInitialize ? '초기화' : '재생성',
            isDanger: true
        });

        if (!confirmed) return;

        var btn = document.getElementById('btn-rebuild-main');
        var btnText = document.getElementById('btn-rebuild-text');
        btn.disabled = true;
        btnText.textContent = isInitialize ? 'DB 초기화 중...' : 'DB 재생성 중...';
        btn.querySelector('.icon').innerHTML = '<use href="#icon-loader"></use>';
        btn.querySelector('.icon').classList.add('icon-spin');

        showLoading('DB 처리 중... (시간이 걸릴 수 있습니다)');

        fetch('/api/rebuild-db', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            hideLoading();
            btn.disabled = false;
            btn.querySelector('.icon').innerHTML = '<use href="#icon-refresh-cw"></use>';
            btn.querySelector('.icon').classList.remove('icon-spin');

            if (data.error) {
                showToast(data.error, 'error');
                btnText.textContent = 'DB 재생성';
            } else if (data.success) {
                showToast('DB 처리가 완료되었습니다.', 'success');

                // dbStats 전체 업데이트
                if (data.stats) {
                    dbStats.recentCount = data.stats.recent_count;
                    dbStats.processedStats = {
                        total: data.stats.processed_stats.total,
                        byType: data.stats.processed_stats.by_type || {}
                    };
                    dbStats.newDrugCount = data.stats.new_drug_count;

                    if (data.stats.data_period) {
                        dbStats.period = {
                            start: data.stats.data_period.start_month,
                            end: data.stats.data_period.end_month,
                            months: data.stats.data_period.total_months
                        };
                    }
                }

                // 검증 캐시 초기화 및 새로고침
                validationCache = {};
                loadDataFiles();
            }
        })
        .catch(function(error) {
            hideLoading();
            btn.disabled = false;
            btn.querySelector('.icon').innerHTML = '<use href="#icon-refresh-cw"></use>';
            btn.querySelector('.icon').classList.remove('icon-spin');
            btnText.textContent = 'DB 재생성';
            console.error('Error:', error);
            showToast('DB 처리에 실패했습니다.', 'error');
        });
    }

    // 로딩 표시
    function showLoading(text) {
        document.getElementById('loading-text').textContent = text || '처리 중...';
        document.getElementById('loading-overlay').classList.add('active');
    }

    // 로딩 숨기기
    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }
</script>
{% endblock %}
