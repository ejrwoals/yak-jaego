{% extends "base.html" %}

{% block title %}약품 개별 관리 - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.get('VERSION', '1') }}">
{% endblock %}

{% block page_styles %}
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background: var(--color-background);
        min-height: 100vh;
        padding: var(--space-5);
        overflow-y: scroll;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--color-surface);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-lg);
        padding: var(--space-8);
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes highlight {
        0% { background-color: transparent; }
        30% { background-color: var(--brand-primary-subtle); }
        100% { background-color: transparent; }
    }

    /* Page Header */
    .page-header {
        display: block;
        text-align: center;
        padding-bottom: var(--space-3);
        margin-bottom: var(--space-8);
        border-bottom: 2px solid var(--color-border);
    }

    .page-header h1 {
        color: var(--color-text-primary);
        font-size: var(--text-2xl);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
    }

    .page-header h1 .icon {
        width: var(--icon-lg);
        height: var(--icon-lg);
        color: var(--brand-primary);
    }

    .page-header p {
        color: var(--color-text-muted);
        margin-top: var(--space-2);
    }

    .back-link {
        color: var(--brand-primary);
        text-decoration: none;
        font-size: var(--text-sm);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        margin-bottom: var(--space-5);
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .back-link .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    /* Header Row (Stats + Actions) */
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-4);
        margin-bottom: var(--space-5);
        flex-wrap: wrap;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface-hover);
        border-radius: var(--radius-lg);
        flex-wrap: wrap;
        border: 1px solid var(--color-border);
        flex: 1;
    }

    .header-actions {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        flex-shrink: 0;
    }

    .stat-item {
        color: var(--color-text-secondary);
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .stat-item .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .stat-value {
        font-weight: var(--font-bold);
        font-size: var(--text-base);
        color: var(--color-text-primary);
    }

    /* Search & Filter */
    .search-filter-bar {
        display: flex;
        gap: var(--space-4);
        align-items: center;
        margin-bottom: var(--space-5);
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 250px;
        padding: var(--space-4);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: var(--text-base);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .filter-buttons {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-full);
        background: var(--color-surface-hover);
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-text-muted);
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
    }

    .filter-btn .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    .filter-btn:hover {
        background: var(--color-surface);
        border-color: var(--color-border-hover);
        color: var(--color-text-secondary);
    }

    .filter-btn.active {
        background: var(--brand-primary-subtle);
        border-color: var(--brand-primary);
        color: var(--brand-primary-dark);
    }

    .sort-buttons {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
        padding-left: var(--space-3);
        border-left: 1px solid var(--color-border);
    }

    .sort-btn {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        cursor: pointer;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        transition: all var(--transition-fast);
    }

    .sort-btn:hover {
        color: var(--color-text-secondary);
        border-color: var(--color-border-hover);
    }

    .sort-btn.active {
        background: var(--color-surface-hover);
        border-color: var(--color-border-hover);
        color: var(--color-text-secondary);
    }

    /* Drug Card List */
    .drug-list {
        max-height: 420px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
    }

    .drug-list::-webkit-scrollbar {
        width: 8px;
    }

    .drug-list::-webkit-scrollbar-track {
        background: var(--color-surface-hover);
        border-radius: var(--radius-sm);
    }

    .drug-list::-webkit-scrollbar-thumb {
        background: var(--color-border-hover);
        border-radius: var(--radius-sm);
    }

    .drug-card {
        background: var(--color-surface-hover);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        transition: all var(--transition-fast);
        min-width: 0;
        overflow: hidden;
    }

    .drug-card:hover {
        border-color: var(--color-border-hover);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }

    .drug-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-3);
    }

    .drug-card-title {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        flex: 1;
        min-width: 0;
    }

    .star-flag {
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .star-flag .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    .star-flag.off {
        color: var(--color-border-hover);
    }

    .star-flag.off:hover {
        color: var(--color-text-muted);
    }

    .star-flag.on {
        color: var(--color-warning);
    }

    .star-flag.on:hover {
        color: var(--color-warning-dark);
    }

    .drug-name {
        font-size: var(--text-base);
        font-weight: var(--font-bold);
        color: var(--color-text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .drug-meta {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--space-1);
    }

    .drug-code {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    .drug-meta-separator {
        color: var(--color-border-hover);
    }

    .drug-company {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    .drug-stock {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        background: var(--brand-primary-subtle);
        color: var(--brand-primary-dark);
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        margin-bottom: var(--space-3);
    }

    .drug-stock-label {
        font-weight: var(--font-medium);
    }

    /* Tooltip */
    .help-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: var(--icon-sm);
        height: var(--icon-sm);
        min-width: var(--icon-sm);
        min-height: var(--icon-sm);
        background: var(--color-border);
        color: var(--color-text-muted);
        border-radius: var(--radius-full);
        font-size: 10px;
        font-weight: var(--font-semibold);
        cursor: help;
        margin-left: var(--space-2);
        position: relative;
        line-height: 1;
        vertical-align: middle;
    }

    .help-icon:hover {
        background: var(--color-border-hover);
        color: var(--color-text-secondary);
    }

    .help-icon .tooltip {
        display: none;
        position: absolute;
        bottom: calc(100% + 8px);
        left: 0;
        background: var(--color-text-primary);
        color: var(--color-surface);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        font-size: var(--text-xs);
        font-weight: var(--font-normal);
        white-space: normal;
        width: 280px;
        line-height: 1.5;
        box-shadow: var(--shadow-lg);
        z-index: var(--z-tooltip);
        overflow: visible;
        height: auto;
        min-height: fit-content;
    }

    .help-icon .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 12px;
        border: 6px solid transparent;
        border-top-color: var(--color-text-primary);
    }

    .help-icon:hover .tooltip {
        display: block;
    }

    .drug-badges {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
    }

    .badge .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    .badge-threshold {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .badge-memo {
        background: var(--color-warning-light);
        color: var(--color-warning-dark);
    }

    .badge-patient {
        background: var(--color-info-light);
        color: var(--color-info);
    }

    .btn {
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-lg);
        border: none;
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
    }

    .btn .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .btn-primary {
        background: var(--brand-primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--brand-primary-dark);
    }

    .btn-secondary {
        background: var(--color-border);
        color: var(--color-text-secondary);
    }

    .btn-secondary:hover {
        background: var(--color-border-hover);
    }

    .btn-danger {
        background: var(--color-danger);
        color: white;
    }

    .btn-danger:hover {
        background: var(--color-danger-dark);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: var(--z-modal);
        justify-content: center;
        align-items: center;
    }

    .modal.visible {
        display: flex;
    }

    .modal-content {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        padding: var(--space-5);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--color-surface);
        z-index: 10;
    }

    .modal-header h3 {
        font-size: var(--text-lg);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .modal-header h3 .icon {
        width: var(--icon-md);
        height: var(--icon-md);
        color: var(--brand-primary);
    }

    .modal-close {
        width: var(--icon-lg);
        height: var(--icon-lg);
        cursor: pointer;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .modal-close:hover {
        color: var(--color-text-secondary);
        background: var(--color-surface-hover);
    }

    .modal-close .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    .modal-body {
        padding: var(--space-5);
    }

    .modal-footer {
        padding: var(--space-5);
        border-top: 1px solid var(--color-border);
        display: flex;
        justify-content: flex-end;
        gap: var(--space-3);
        position: sticky;
        bottom: 0;
        background: var(--color-surface);
    }

    /* Form sections */
    .form-section {
        margin-bottom: var(--space-5);
        padding-bottom: var(--space-5);
        border-bottom: 1px solid var(--color-border);
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .form-section-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-3);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .form-section-title .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        color: var(--brand-primary);
    }

    .form-row {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-3);
    }

    .min-threshold-warning {
        display: flex;
        align-items: flex-start;
        gap: var(--space-2);
        padding: var(--space-3);
        background: var(--color-warning-light);
        border: 1px solid var(--color-warning);
        border-radius: var(--radius-lg);
        margin-top: var(--space-2);
    }

    .min-threshold-warning .warning-icon {
        flex-shrink: 0;
        color: var(--color-warning-dark);
    }

    .min-threshold-warning .warning-icon .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .min-threshold-warning .warning-text {
        font-size: var(--text-sm);
        color: var(--color-warning-dark);
        line-height: 1.4;
    }

    .min-threshold-warning .auto-fill-link {
        color: var(--color-warning-dark);
        font-weight: var(--font-semibold);
        cursor: pointer;
        text-decoration: underline;
    }

    .min-threshold-warning .auto-fill-link:hover {
        color: var(--color-warning);
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--space-2);
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }

    .current-value {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--space-2);
    }

    /* Patient tags */
    .patient-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
    }

    .patient-tag {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        background: var(--color-info-light);
        border: 1px solid var(--color-info);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        color: var(--color-info);
    }

    .patient-tag .tag-content {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
    }

    .patient-tag .tag-content:hover {
        color: var(--color-info-dark);
    }

    .patient-tag .tag-content:hover .patient-dosage-badge {
        background: var(--color-info-dark);
    }

    .patient-tag .remove-btn {
        cursor: pointer;
        color: var(--color-info);
        font-weight: var(--font-bold);
        margin-left: var(--space-1);
    }

    .patient-tag .remove-btn:hover {
        color: var(--color-danger);
    }

    .patient-dosage-badge {
        background: var(--color-info);
        color: white;
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
    }

    /* Buffer Calculation Section */
    .buffer-calc-container {
        padding: var(--space-4);
        background: var(--color-surface-hover);
        border-radius: var(--radius-lg);
    }

    .risk-level-chips {
        display: flex;
        gap: var(--space-2);
        justify-content: center;
        flex-wrap: wrap;
        margin-top: var(--space-2);
    }

    .risk-chip {
        padding: var(--space-2) var(--space-4);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-full);
        background: var(--color-surface);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
    }

    .risk-chip:hover {
        border-color: var(--brand-primary);
        background: var(--brand-primary-subtle);
    }

    .risk-chip.selected {
        border-color: var(--brand-primary);
        background: var(--brand-primary);
        color: white;
    }

    .risk-chip .chip-label {
        font-weight: var(--font-medium);
    }

    .buffer-result {
        margin-top: var(--space-4);
        padding: var(--space-4);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
    }

    .buffer-result-header {
        text-align: center;
        margin-bottom: var(--space-3);
    }

    .buffer-value {
        font-size: var(--text-4xl);
        font-weight: var(--font-bold);
        color: var(--brand-primary);
    }

    .buffer-unit {
        font-size: var(--text-base);
        color: var(--color-text-muted);
        margin-left: var(--space-1);
    }

    .buffer-explanation {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        text-align: center;
        margin-bottom: var(--space-3);
        line-height: 1.5;
    }

    .buffer-details {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        border-top: 1px solid var(--color-border);
        padding-top: var(--space-3);
        margin-top: var(--space-3);
    }

    .buffer-patient-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-2) 0;
        border-bottom: 1px solid var(--color-surface-hover);
    }

    .buffer-patient-item:last-child {
        border-bottom: none;
    }

    .buffer-patient-included {
        color: var(--color-info);
        font-weight: var(--font-medium);
    }

    .patient-search-container {
        position: relative;
    }

    .patient-search-input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
    }

    .patient-search-input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .patient-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-top: var(--space-1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: var(--z-dropdown);
        box-shadow: var(--shadow-md);
    }

    .patient-search-results.visible {
        display: block;
    }

    .patient-result-item {
        padding: var(--space-3);
        cursor: pointer;
        border-bottom: 1px solid var(--color-surface-hover);
    }

    .patient-result-item:hover {
        background: var(--color-surface-hover);
    }

    .patient-result-item:last-child {
        border-bottom: none;
    }

    /* Add patient button */
    .add-patient-btn {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-2) var(--space-3);
        background: var(--brand-primary);
        color: white;
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-size: var(--text-sm);
        transition: all var(--transition-fast);
    }

    .add-patient-btn .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .add-patient-btn:hover {
        background: var(--brand-primary-dark);
    }

    /* Status message */
    .status-message {
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-5);
        display: none;
    }

    .status-message.success {
        background: var(--color-success-light);
        color: var(--color-success-dark);
        display: block;
    }

    .status-message.error {
        background: var(--color-danger-light);
        color: var(--color-danger);
        display: block;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-16) var(--space-5);
        color: var(--color-text-muted);
        grid-column: 1 / -1;
    }

    .empty-state-icon {
        margin-bottom: var(--space-3);
        color: var(--color-border-hover);
    }

    .empty-state-icon .icon {
        width: var(--icon-xl);
        height: var(--icon-xl);
    }

    /* Drug search in modal */
    .drug-search-section {
        margin-bottom: var(--space-5);
    }

    .drug-search-results {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-top: var(--space-2);
        display: none;
    }

    .drug-search-results.visible {
        display: block;
    }

    .drug-result-item {
        padding: var(--space-3);
        cursor: pointer;
        border-bottom: 1px solid var(--color-surface-hover);
    }

    .drug-result-item:hover {
        background: var(--color-surface-hover);
    }

    .selected-drug {
        padding: var(--space-3);
        background: var(--brand-primary-subtle);
        border: 1px solid var(--brand-primary-light);
        border-radius: var(--radius-lg);
        margin-top: var(--space-3);
        display: none;
    }

    .selected-drug.visible {
        display: block;
    }

    .selected-drug-clear {
        background: none;
        border: none;
        color: var(--color-danger);
        cursor: pointer;
        font-size: var(--text-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-1);
    }

    .selected-drug-clear .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    /* Editable fields section - hidden until drug selected */
    .editable-fields-section {
        display: none;
    }

    .editable-fields-section.visible {
        display: block;
    }

    .unselected-hint {
        text-align: center;
        padding: var(--space-10) var(--space-5);
        color: var(--color-text-muted);
        font-size: var(--text-sm);
        border: 2px dashed var(--color-border);
        border-radius: var(--radius-lg);
        margin-top: var(--space-5);
    }

    .unselected-hint-icon {
        margin-bottom: var(--space-3);
        color: var(--color-border-hover);
    }

    .unselected-hint-icon .icon {
        width: var(--icon-xl);
        height: var(--icon-xl);
    }

    /* Changed field indicator */
    .form-section.changed {
        border-left: 3px solid var(--brand-primary);
        background: linear-gradient(90deg, var(--brand-primary-subtle) 0%, var(--color-surface) 100%);
    }

    .form-section.changed .form-section-title::after {
        content: ' (변경됨)';
        color: var(--brand-primary);
        font-size: var(--text-xs);
        font-weight: var(--font-normal);
    }

    /* Disabled save button */
    .btn-primary:disabled {
        background: var(--color-border-hover);
        cursor: not-allowed;
        opacity: 0.7;
    }

    .btn-primary:disabled:hover {
        background: var(--color-border-hover);
    }

    /* Modal shake animation */
    @keyframes modalShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .modal-content.shake {
        animation: modalShake 0.4s ease-in-out;
    }

    /* Current value display */
    .current-value-display {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        padding: var(--space-2) var(--space-3);
        background: var(--color-surface-hover);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-2);
    }

    .current-value-display strong {
        color: var(--color-text-primary);
    }

    /* New patient option in search results */
    .new-patient-option {
        background: var(--color-success-light) !important;
        color: var(--color-success-dark) !important;
        font-weight: var(--font-medium);
    }

    .new-patient-option:hover {
        background: var(--color-success-light) !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .drug-list {
            grid-template-columns: 1fr;
        }

        .header-row {
            flex-direction: column;
            align-items: stretch;
        }

        .stats-bar {
            justify-content: center;
        }

        .header-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <a href="/" class="back-link">
            <svg class="icon"><use href="#icon-arrow-left"></use></svg>
            홈으로 돌아가기
        </a>

        <div class="page-header">
            <h1>
                <svg class="icon"><use href="#icon-settings"></use></svg>
                약품 개별 관리
            </h1>
            <p>개별 약품의 상세 설정을 관리합니다</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="header-row">
            <div class="stats-bar" id="statsBar">
                <div class="stat-item">
                    <span>전체 관리:</span>
                    <span class="stat-value" id="statTotal">0</span>개
                </div>
                <div class="stat-item">
                    <svg class="icon" style="color: var(--color-warning);"><use href="#icon-star"></use></svg>
                    <span>특별관리:</span>
                    <span class="stat-value" id="statFlagged">0</span>개
                </div>
                <div class="stat-item">
                    <svg class="icon" style="color: var(--color-warning-dark);"><use href="#icon-file-text"></use></svg>
                    <span>메모:</span>
                    <span class="stat-value" id="statMemo">0</span>개
                </div>
                <div class="stat-item">
                    <svg class="icon" style="color: var(--color-danger);"><use href="#icon-sliders"></use></svg>
                    <span>임계값:</span>
                    <span class="stat-value" id="statThreshold">0</span>개
                </div>
                <div class="stat-item">
                    <svg class="icon" style="color: var(--color-info);"><use href="#icon-user"></use></svg>
                    <span>등록 환자:</span>
                    <span class="stat-value" id="statPatient">0</span>명
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddModal()">
                    <svg class="icon"><use href="#icon-plus"></use></svg>
                    새 약품 관리 추가
                </button>
            </div>
        </div>

        <div class="search-filter-bar">
            <input type="text" class="search-input" id="searchInput"
                   placeholder="약품명, 약품코드, 제약회사로 검색..."
                   oninput="filterDrugs()">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setDrugFilter('all')">전체</button>
                <button class="filter-btn" data-filter="flagged" onclick="setDrugFilter('flagged')">
                    <svg class="icon"><use href="#icon-star"></use></svg>
                    특별관리
                </button>
                <button class="filter-btn" data-filter="threshold" onclick="setDrugFilter('threshold')">
                    <svg class="icon"><use href="#icon-sliders"></use></svg>
                    임계값
                </button>
            </div>
            <div class="sort-buttons">
                <button class="sort-btn active" data-sort="recent" onclick="setDrugSort('recent')">최근순</button>
                <button class="sort-btn" data-sort="name" onclick="setDrugSort('name')">가나다순</button>
            </div>
        </div>

        <div class="drug-list" id="drugList">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg class="icon"><use href="#icon-settings"></use></svg>
                </div>
                <div>관리 중인 약품이 없습니다.</div>
                <div style="margin-top: var(--space-3); font-size: var(--text-sm);">검색하여 약품을 추가하거나, "새 약품 관리 추가" 버튼을 클릭하세요.</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Drug Modal -->
    <div id="drugModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">
                    <svg class="icon"><use href="#icon-settings"></use></svg>
                    <span id="modalTitleText">약품 상세 관리</span>
                </h3>
                <span class="modal-close" onclick="closeModal()">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </span>
            </div>
            <div class="modal-body">
                <!-- Drug Search (for new) -->
                <div class="drug-search-section" id="drugSearchSection">
                    <label style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2); display: block;">약품 검색</label>
                    <input type="text" class="search-input" id="modalDrugSearch"
                           placeholder="약품명 또는 약품코드로 검색..."
                           oninput="searchDrugsForModal()">
                    <div class="drug-search-results" id="modalDrugResults"></div>
                    <div class="selected-drug" id="selectedDrug">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                                <div class="star-flag off" id="addStarFlag" onclick="toggleModalFlag()" title="특별 관리 토글" style="margin-top: 2px;">
                                    <svg class="icon"><use href="#icon-star"></use></svg>
                                </div>
                                <div>
                                    <div style="font-weight: var(--font-semibold);" id="selectedDrugName">-</div>
                                    <div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1);">
                                        <span id="selectedDrugCode">-</span>
                                        <span id="selectedDrugCompanySeparator" style="color: var(--color-border-hover); margin: 0 var(--space-2); display: none;">·</span>
                                        <span id="selectedDrugCompany" style="color: var(--color-text-muted); display: none;"></span>
                                    </div>
                                </div>
                            </div>
                            <button class="selected-drug-clear" onclick="clearDrugSelection()">
                                <svg class="icon"><use href="#icon-x"></use></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Drug Info (for edit) -->
                <div class="form-section" id="drugInfoSection" style="display: none;">
                    <div style="display: flex; align-items: flex-start; gap: var(--space-3);">
                        <div class="star-flag off" id="editStarFlag" onclick="toggleModalFlag()" title="특별 관리 토글" style="margin-top: 2px;">
                            <svg class="icon"><use href="#icon-star"></use></svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: var(--text-lg); font-weight: var(--font-semibold);" id="editDrugName">-</div>
                            <div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1);">
                                <span id="editDrugCode">-</span>
                                <span style="color: var(--color-border-hover); margin: 0 var(--space-2);">·</span>
                                <span id="editDrugCompany" style="color: var(--color-text-muted);">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hint when no drug selected -->
                <div class="unselected-hint" id="unselectedHint">
                    <div class="unselected-hint-icon">
                        <svg class="icon"><use href="#icon-chevron-up"></use></svg>
                    </div>
                    <div>위에서 약품을 먼저 검색하여 선택해주세요</div>
                    <div style="margin-top: var(--space-1); font-size: var(--text-xs);">약품 선택 후 아래 편집 옵션이 표시됩니다</div>
                </div>

                <!-- Editable fields (hidden until drug selected) -->
                <div class="editable-fields-section" id="editableFieldsSection">
                    <!-- 1. Memo -->
                    <div class="form-section" id="sectionMemo">
                        <div class="form-section-title">
                            <svg class="icon"><use href="#icon-file-text"></use></svg>
                            메모
                        </div>
                        <div class="current-value-display" id="currentMemo">현재 메모: 없음</div>
                        <div class="form-group">
                            <textarea id="inputMemo" placeholder="메모를 입력하세요..." oninput="checkChanges()"></textarea>
                        </div>
                    </div>

                    <!-- 2. Drug Name Edit -->
                    <div class="form-section" id="sectionDrugName">
                        <div class="form-section-title">
                            <svg class="icon"><use href="#icon-package"></use></svg>
                            약품명 수정
                        </div>
                        <div class="current-value-display" id="currentDrugName">현재 약품명: -</div>
                        <div class="form-group">
                            <label>새 약품명 (변경 시에만 입력)</label>
                            <input type="text" id="inputDrugName" placeholder="변경할 약품명 입력..." oninput="checkChanges()">
                        </div>
                    </div>

                    <!-- 2. Stock Edit -->
                    <div class="form-section" id="sectionStock">
                        <div class="form-section-title">
                            <svg class="icon"><use href="#icon-hash"></use></svg>
                            재고 수정
                        </div>
                        <div class="current-value-display" id="currentStock">현재 재고: -</div>
                        <div class="form-group">
                            <label>새 재고수량 (변경 시에만 입력)</label>
                            <input type="number" id="inputStock" placeholder="변경할 재고수량 입력" oninput="checkChanges()">
                        </div>
                    </div>

                    <!-- 3. Threshold -->
                    <div class="form-section" id="sectionThreshold">
                        <div class="form-section-title">
                            <svg class="icon"><use href="#icon-sliders"></use></svg>
                            최소 안전 재고량 개별 설정
                            <span class="help-icon">?
                                <span class="tooltip">설정한 임계값 이하로 재고가 떨어지면 재고 현황 리포트에서 해당 약품이 강조 표시됩니다. 재고 임계값은 수량 기준, 런웨이 임계값은 현재 사용 속도 대비 남은 개월 수 기준입니다. 환자 등록 시 1회 최대 처방량으로 자동 설정됩니다.</span>
                            </span>
                        </div>
                        <div class="current-value-display" id="currentThreshold">현재 설정: 디폴트 기준값 사용</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>재고 임계값 (개)</label>
                                <input type="number" id="inputStockThreshold" placeholder="이 값 이하 시 강조" oninput="checkChanges(); checkMinThreshold();">
                            </div>
                            <div class="form-group">
                                <label>런웨이 임계값 (개월)</label>
                                <input type="number" step="0.1" id="inputRunwayThreshold" placeholder="이 값 미만 시 강조" oninput="checkChanges()">
                            </div>
                        </div>
                        <div id="minThresholdWarning" class="min-threshold-warning" style="display: none;">
                            <span class="warning-icon">
                                <svg class="icon"><use href="#icon-alert-triangle"></use></svg>
                            </span>
                            <span class="warning-text"></span>
                        </div>
                    </div>

                    <!-- 4. Patients -->
                    <div class="form-section" id="sectionPatients">
                        <div class="form-section-title">
                            <svg class="icon"><use href="#icon-user"></use></svg>
                            환자 태그
                            <span class="help-icon">?
                                <span class="tooltip">특정 환자에게만 처방되는 약품에 환자를 태그하세요. 환자 등록 시 1회 최대 처방량이 최소 안전 재고량으로 자동 설정됩니다. 방문 주기와 처방량을 입력하면 동시 방문 대비용 재고도 계산할 수 있습니다.</span>
                            </span>
                        </div>
                        <div class="patient-tags" id="patientTags">
                            <!-- Patient tags will be added here -->
                        </div>
                        <div class="patient-search-container">
                            <input type="text" class="patient-search-input" id="patientSearchInput"
                                   placeholder="환자명으로 검색하여 추가..."
                                   oninput="searchPatients()">
                            <div class="patient-search-results" id="patientSearchResults"></div>
                        </div>
                        <div style="margin-top: var(--space-3);">
                            <button class="add-patient-btn" onclick="openPatientModal()">
                                <svg class="icon"><use href="#icon-plus"></use></svg>
                                새 환자 등록
                            </button>
                        </div>
                    </div>

                    <!-- 5. Buffer Calculation -->
                    <div class="form-section" id="sectionBuffer">
                        <div class="form-section-title">
                            <svg class="icon"><use href="#icon-bar-chart-2"></use></svg>
                            동시 방문 대비용 재고 계산
                            <span class="help-icon">?
                                <span class="tooltip">연결된 환자들의 방문 주기와 처방량을 기반으로, 동시 방문 확률을 계산하여 필요한 안전 재고량을 산출합니다. 포아송 이항분포 모델을 사용합니다.</span>
                            </span>
                        </div>
                        <div class="buffer-calc-container">
                            <div class="form-group">
                                <label>허용 리스크 수준</label>
                                <div class="risk-level-chips">
                                    <button type="button" class="risk-chip" data-value="relaxed" onclick="selectRiskLevel('relaxed')">
                                        <span class="chip-label">절약</span>
                                    </button>
                                    <button type="button" class="risk-chip" data-value="normal" onclick="selectRiskLevel('normal')">
                                        <span class="chip-label">보통</span>
                                    </button>
                                    <button type="button" class="risk-chip selected" data-value="safe" onclick="selectRiskLevel('safe')">
                                        <span class="chip-label">안전</span>
                                    </button>
                                    <button type="button" class="risk-chip" data-value="very_safe" onclick="selectRiskLevel('very_safe')">
                                        <span class="chip-label">매우 안전</span>
                                    </button>
                                </div>
                                <div style="font-size: 12px; color: #718096; margin-top: 8px; text-align: center;" id="riskLevelDescription">
                                    드문 동시 방문까지 대비
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="calculateBuffer()" id="calcBufferBtn" disabled style="margin-top: 10px;">
                                계산하기
                            </button>
                            <div class="buffer-result" id="bufferResult" style="display: none;">
                                <div class="buffer-result-header">
                                    <span class="buffer-value" id="bufferValue">-</span>
                                    <span class="buffer-unit">개</span>
                                </div>
                                <div class="buffer-explanation" id="bufferExplanation"></div>
                                <div class="buffer-details" id="bufferDetails"></div>
                                <button class="btn btn-primary" onclick="applyBufferToThreshold()" id="applyBufferBtn" style="margin-top: 12px; width: 100%;">
                                    재고 임계값에 적용하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                <button class="btn btn-primary" id="saveBtn" onclick="saveDrugManagement()" disabled>저장</button>
            </div>
        </div>
    </div>

    <!-- Patient Registration Modal -->
    <div id="patientModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>
                    <svg class="icon"><use href="#icon-user-plus"></use></svg>
                    새 환자 등록
                </h3>
                <span class="modal-close" onclick="closePatientModal()">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>환자명 *</label>
                    <input type="text" id="newPatientName" placeholder="환자명">
                </div>
                <div class="form-group">
                    <label>주민등록번호 앞자리</label>
                    <input type="text" id="newPatientBirth" maxlength="6" placeholder="6자리 (예: 900101)">
                </div>
                <div class="form-group">
                    <label>방문 주기 (일)</label>
                    <input type="number" id="newPatientVisitCycle" placeholder="예: 30" min="1">
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                        환자가 평균적으로 몇 일마다 방문하는지 입력하세요
                    </div>
                </div>
                <div class="form-group">
                    <label>환자 메모</label>
                    <textarea id="newPatientMemo" placeholder="환자에 대한 메모..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePatientModal()">취소</button>
                <button class="btn btn-primary" onclick="saveNewPatient()">등록</button>
            </div>
        </div>
    </div>

    <!-- Dosage Input Modal -->
    <div id="dosageModal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3 id="dosageModalTitle">
                    <svg class="icon" id="dosageModalIcon"><use href="#icon-pill"></use></svg>
                    <span id="dosageModalTitleText">1회 처방량 입력</span>
                </h3>
                <span class="modal-close" onclick="closeDosageModal()">
                    <svg class="icon"><use href="#icon-x"></use></svg>
                </span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-hover); border-radius: var(--radius-lg);">
                    <span id="dosagePatientName" style="font-weight: var(--font-semibold); color: var(--color-text-primary);"></span>
                    <span id="dosagePatientInfo" style="color: var(--color-text-muted); font-size: var(--text-sm);"></span>
                </div>
                <div class="form-group">
                    <label>1회 처방량 *</label>
                    <input type="number" id="inputDosage" placeholder="예: 30" min="1" value="1" onfocus="this.select()">
                    <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">
                        이 환자에게 한 번 방문 시 처방하는 약품 수량
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDosageModal()">취소</button>
                <button class="btn btn-primary" onclick="confirmDosageModal()" id="dosageModalBtn">추가</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    var managedDrugs = [];
    var selectedDrugCode = null;
    var selectedPatientIds = [];
    var selectedPatientData = [];  // {patientId, name, birth, visitCycle, dosage}
    var modalFlag = false;
    var isEditMode = false;
    var currentDrugFilter = 'all';  // 필터: all, flagged, threshold
    var currentDrugSort = 'recent';  // 정렬: recent, name
    var searchTimeout = null;

    // Dosage modal state
    var pendingPatient = null;
    var isEditingDosage = false;  // true when editing existing patient's dosage

    // Buffer calculation state
    var lastCalculatedBuffer = null;

    // Original data for change tracking
    var originalData = {
        drugName: '',
        stock: '',
        stockThreshold: '',
        runwayThreshold: '',
        memo: '',
        patientIds: [],
        flag: false
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadManagedDrugs();

        // 환자 검색 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            var searchContainer = document.querySelector('.patient-search-container');
            var resultsDiv = document.getElementById('patientSearchResults');
            if (searchContainer && resultsDiv && !searchContainer.contains(e.target)) {
                resultsDiv.classList.remove('visible');
            }
        });

        // 환자 검색 드롭다운 스크롤 시 닫기
        document.addEventListener('scroll', function() {
            var resultsDiv = document.getElementById('patientSearchResults');
            if (resultsDiv) {
                resultsDiv.classList.remove('visible');
            }
        }, true);
    });

    function loadStats() {
        fetch('/api/managed-drugs/stats')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    var stats = data.data;
                    document.getElementById('statMemo').textContent = stats.memo_count;
                    document.getElementById('statThreshold').textContent = stats.threshold_count;
                    document.getElementById('statFlagged').textContent = stats.flagged_count;
                    document.getElementById('statPatient').textContent = stats.patient_count;
                }
            });
    }

    function loadManagedDrugs() {
        fetch('/api/managed-drugs')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    managedDrugs = data.data;
                    document.getElementById('statTotal').textContent = data.count;
                    filterDrugs();  // 정렬 적용 후 렌더링
                }
            })
            .catch(function(error) {
                showStatus('데이터 로드 실패: ' + error.message, 'error');
            });
    }

    function renderDrugs(drugs) {
        var listDiv = document.getElementById('drugList');

        if (drugs.length === 0) {
            listDiv.innerHTML = '\
                <div class="empty-state">\
                    <div class="empty-state-icon">\
                        <svg class="icon"><use href="#icon-settings"></use></svg>\
                    </div>\
                    <div>관리 중인 약품이 없습니다.</div>\
                    <div style="margin-top: var(--space-3); font-size: var(--text-sm);">검색하여 약품을 추가하거나, "새 약품 관리 추가" 버튼을 클릭하세요.</div>\
                </div>\
            ';
            return;
        }

        listDiv.innerHTML = drugs.map(function(drug) {
            var starClass = drug.special_flag ? 'on' : 'off';

            var badges = '';
            if (drug.has_threshold) {
                var thInfo = [];
                if (drug.threshold.stock) thInfo.push(drug.threshold.stock + '개이하');
                if (drug.threshold.runway) thInfo.push(drug.threshold.runway + '개월미만');
                badges += '<span class="badge badge-threshold"><svg class="icon"><use href="#icon-sliders"></use></svg> ' + thInfo.join(', ') + '</span>';
            }
            if (drug.has_memo) {
                badges += '<span class="badge badge-memo"><svg class="icon"><use href="#icon-file-text"></use></svg> 메모</span>';
            }
            if (drug.patients && drug.patients.length > 0) {
                var names = drug.patients.map(function(p) { return p['환자명']; }).join(', ');
                badges += '<span class="badge badge-patient"><svg class="icon"><use href="#icon-user"></use></svg> ' + names + '</span>';
            }

            return '\
                <div class="drug-card" data-code="' + drug.drug_code + '">\
                    <div class="drug-card-header">\
                        <div class="drug-card-title">\
                            <span class="star-flag ' + starClass + '" onclick="toggleFlag(\'' + drug.drug_code + '\')" title="특별 관리">\
                                <svg class="icon"><use href="#icon-star"></use></svg>\
                            </span>\
                            <div style="min-width: 0; flex: 1;">\
                                <div class="drug-name" title="' + drug.drug_name + '">' + drug.drug_name + '</div>\
                                <div class="drug-meta">\
                                    <span class="drug-code">' + drug.drug_code + '</span>\
                                    <span class="drug-meta-separator">·</span>\
                                    <span class="drug-company">' + drug.company + '</span>\
                                </div>\
                            </div>\
                        </div>\
                        <button class="btn btn-secondary" onclick="openEditModal(\'' + drug.drug_code + '\')" style="padding: var(--space-2) var(--space-3); font-size: var(--text-sm);">관리</button>\
                    </div>\
                    <div class="drug-stock">\
                        <span class="drug-stock-label">현재고 :</span>\
                        <span>' + drug.current_stock.toLocaleString() + '</span>\
                    </div>\
                    <div class="drug-badges">' + (badges || '') + '</div>\
                </div>\
            ';
        }).join('');
    }

    function setDrugFilter(filter) {
        currentDrugFilter = filter;

        // Update button states
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });

        filterDrugs();
    }

    function setDrugSort(sort) {
        currentDrugSort = sort;

        // Update button states
        document.querySelectorAll('.sort-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.sort === sort);
        });

        filterDrugs();
    }

    function filterDrugs() {
        var query = document.getElementById('searchInput').value.toLowerCase();

        var filtered = managedDrugs.slice();  // 복사본 사용

        // Apply filter
        if (currentDrugFilter === 'flagged') {
            filtered = filtered.filter(function(drug) { return drug.special_flag; });
        } else if (currentDrugFilter === 'threshold') {
            filtered = filtered.filter(function(drug) { return drug.has_threshold; });
        }

        // Apply search
        if (query) {
            filtered = filtered.filter(function(drug) {
                return drug.drug_name.toLowerCase().includes(query) ||
                    drug.drug_code.toLowerCase().includes(query) ||
                    (drug.company && drug.company.toLowerCase().includes(query));
            });
        }

        // Apply sort
        if (currentDrugSort === 'name') {
            filtered.sort(function(a, b) { return a.drug_name.localeCompare(b.drug_name, 'ko'); });
        } else if (currentDrugSort === 'recent') {
            filtered.sort(function(a, b) { return new Date(b.updated_at || 0) - new Date(a.updated_at || 0); });
        }

        renderDrugs(filtered);
    }

    function toggleFlag(drugCode) {
        fetch('/api/drug/' + drugCode + '/toggle-flag', { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    loadManagedDrugs();
                    loadStats();
                }
            });
    }

    // Modal Functions
    function openAddModal() {
        isEditMode = false;
        selectedDrugCode = null;
        selectedPatientIds = [];
        selectedPatientData = [];
        modalFlag = false;
        lastCalculatedBuffer = null;

        // Reset original data
        originalData = {
            drugName: '',
            stock: '',
            stockThreshold: '',
            runwayThreshold: '',
            memo: '',
            patientIds: [],
            flag: false
        };

        document.getElementById('modalTitleText').textContent = '새 약품 관리 추가';
        document.getElementById('drugSearchSection').style.display = 'block';
        document.getElementById('drugInfoSection').style.display = 'none';

        // Show hint, hide editable fields
        document.getElementById('unselectedHint').style.display = 'block';
        document.getElementById('editableFieldsSection').classList.remove('visible');

        // Clear inputs
        document.getElementById('modalDrugSearch').value = '';
        document.getElementById('modalDrugResults').innerHTML = '';
        document.getElementById('selectedDrug').classList.remove('visible');
        document.getElementById('inputDrugName').value = '';
        document.getElementById('inputStock').value = '';
        document.getElementById('inputStockThreshold').value = '';
        document.getElementById('inputRunwayThreshold').value = '';
        document.getElementById('inputMemo').value = '';
        document.getElementById('currentStock').textContent = '현재 재고: -';
        document.getElementById('currentDrugName').textContent = '현재 약품명: -';
        document.getElementById('currentThreshold').textContent = '현재 설정: 디폴트 기준값 사용';
        document.getElementById('currentMemo').textContent = '현재 메모: 없음';
        updateFlagUI();
        renderPatientTagsWithDosage();

        // Reset buffer calculation
        document.getElementById('bufferResult').style.display = 'none';
        updateBufferCalcButton();

        // Hide min threshold warning
        document.getElementById('minThresholdWarning').style.display = 'none';

        // Disable save button
        document.getElementById('saveBtn').disabled = true;
        clearAllChangedMarkers();

        document.getElementById('drugModal').classList.add('visible');
    }

    function openEditModal(drugCode) {
        isEditMode = true;
        selectedDrugCode = drugCode;

        fetch('/api/drug-management/' + drugCode)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    var d = data.data;

                    document.getElementById('modalTitleText').textContent = '약품 상세 관리';
                    document.getElementById('drugSearchSection').style.display = 'none';
                    document.getElementById('drugInfoSection').style.display = 'block';

                    // Hide hint, show editable fields
                    document.getElementById('unselectedHint').style.display = 'none';
                    document.getElementById('editableFieldsSection').classList.add('visible');

                    document.getElementById('editDrugName').textContent = d.drug_name;
                    document.getElementById('editDrugCode').textContent = d.drug_code;
                    document.getElementById('editDrugCompany').textContent = d.company;

                    // Store original data for change tracking
                    var stockTh = d.threshold ? (d.threshold.stock !== null ? String(d.threshold.stock) : '') : '';
                    var runwayTh = d.threshold ? (d.threshold.runway !== null ? String(d.threshold.runway) : '') : '';

                    originalData = {
                        drugName: d.drug_name,
                        stock: String(d.current_stock),
                        stockThreshold: stockTh,
                        runwayThreshold: runwayTh,
                        memo: (d.memo || '').trim(),
                        patientIds: d.patients.map(function(p) { return p['환자ID']; }).sort(),
                        flag: d.special_flag
                    };

                    // Display current values
                    document.getElementById('currentDrugName').innerHTML = '현재 약품명: <strong>' + d.drug_name + '</strong>';
                    document.getElementById('currentStock').innerHTML = '현재 재고: <strong>' + d.current_stock + '개</strong>';

                    if (d.threshold && (d.threshold.stock !== null || d.threshold.runway !== null)) {
                        var thText = [];
                        if (d.threshold.stock !== null) thText.push('재고 ' + d.threshold.stock + '개 이하');
                        if (d.threshold.runway !== null) thText.push('런웨이 ' + d.threshold.runway + '개월 미만');
                        document.getElementById('currentThreshold').innerHTML = '현재 설정: <strong>' + thText.join(', ') + '</strong>';
                    } else {
                        document.getElementById('currentThreshold').textContent = '현재 설정: 디폴트 기준값 사용';
                    }

                    if (d.memo) {
                        var memoPreview = d.memo.length > 30 ? d.memo.substring(0, 30) + '...' : d.memo;
                        document.getElementById('currentMemo').innerHTML = '현재 메모: <strong>' + escapeHtml(memoPreview) + '</strong>';
                    } else {
                        document.getElementById('currentMemo').textContent = '현재 메모: 없음';
                    }

                    // Set form values (pre-fill for easy editing)
                    document.getElementById('inputDrugName').value = d.drug_name;
                    document.getElementById('inputStock').value = '';
                    document.getElementById('inputStockThreshold').value = stockTh;
                    document.getElementById('inputRunwayThreshold').value = runwayTh;
                    document.getElementById('inputMemo').value = d.memo || '';

                    modalFlag = d.special_flag;
                    updateFlagUI();

                    // Patients - load with dosage info
                    selectedPatientIds = d.patients.map(function(p) { return p['환자ID']; });
                    selectedPatientData = d.patients.map(function(p) {
                        return {
                            patientId: p['환자ID'],
                            name: p['환자명'],
                            birth: p['주민번호_앞자리'] || '',
                            visitCycle: p['방문주기_일'] || 30,
                            dosage: p['1회_처방량'] || 1
                        };
                    });
                    renderPatientTagsWithDosage();

                    // Reset buffer calculation
                    lastCalculatedBuffer = null;
                    document.getElementById('bufferResult').style.display = 'none';
                    updateBufferCalcButton();

                    // Disable save button initially (checkMinThreshold 전에 실행해야 자동 설정 시 활성화됨)
                    document.getElementById('saveBtn').disabled = true;
                    clearAllChangedMarkers();

                    checkMinThreshold();  // 최소 임계값 체크 (자동 설정 시 저장 버튼 활성화)

                    document.getElementById('drugModal').classList.add('visible');
                }
            });
    }

    function closeModal() {
        document.getElementById('drugModal').classList.remove('visible');
    }

    function searchDrugsForModal() {
        clearTimeout(searchTimeout);
        var query = document.getElementById('modalDrugSearch').value.trim();
        var resultsDiv = document.getElementById('modalDrugResults');

        if (query.length < 2) {
            resultsDiv.classList.remove('visible');
            return;
        }

        searchTimeout = setTimeout(function() {
            fetch('/api/search-inventory?q=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'success' && data.results.length > 0) {
                        resultsDiv.innerHTML = data.results.slice(0, 10).map(function(item) {
                            return '\
                                <div class="drug-result-item" onclick="selectDrugForModal(\'' + item['약품코드'] + '\', \'' + escapeHtml(item['약품명']) + '\', \'' + escapeHtml(item['제약회사']) + '\', ' + item['현재_재고수량'] + ')">\
                                    <div style="font-weight: 500;">' + item['약품명'] + '</div>\
                                    <div style="font-size: 13px; color: #718096;">' + item['약품코드'] + ' | ' + item['제약회사'] + ' | 재고: ' + item['현재_재고수량'] + '</div>\
                                </div>\
                            ';
                        }).join('');
                        resultsDiv.classList.add('visible');
                    } else {
                        resultsDiv.innerHTML = '<div style="padding: 12px; color: #a0aec0;">검색 결과가 없습니다</div>';
                        resultsDiv.classList.add('visible');
                    }
                });
        }, 300);
    }

    function selectDrugForModal(code, name, company, stock) {
        selectedDrugCode = code;
        document.getElementById('selectedDrugName').textContent = name;
        document.getElementById('selectedDrugCode').textContent = code;
        document.getElementById('selectedDrugCompany').textContent = company;
        document.getElementById('selectedDrugCompany').style.display = 'inline';
        document.getElementById('selectedDrugCompanySeparator').style.display = 'inline';
        document.getElementById('selectedDrug').classList.add('visible');
        document.getElementById('modalDrugResults').classList.remove('visible');
        document.getElementById('modalDrugSearch').value = '';

        // Hide hint, show editable fields
        document.getElementById('unselectedHint').style.display = 'none';
        document.getElementById('editableFieldsSection').classList.add('visible');

        // Display current values
        document.getElementById('currentDrugName').innerHTML = '현재 약품명: <strong>' + escapeHtml(name) + '</strong>';
        document.getElementById('currentStock').innerHTML = '현재 재고: <strong>' + stock + '개</strong>';

        // Load existing data if any
        fetch('/api/drug-management/' + code)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    var d = data.data;
                    var stockTh = d.threshold ? (d.threshold.stock !== null ? String(d.threshold.stock) : '') : '';
                    var runwayTh = d.threshold ? (d.threshold.runway !== null ? String(d.threshold.runway) : '') : '';

                    // Store original data
                    originalData = {
                        drugName: name,
                        stock: String(stock),
                        stockThreshold: stockTh,
                        runwayThreshold: runwayTh,
                        memo: (d.memo || '').trim(),
                        patientIds: d.patients.map(function(p) { return p['환자ID']; }).sort(),
                        flag: d.special_flag
                    };

                    // Display current threshold
                    if (d.threshold && (d.threshold.stock !== null || d.threshold.runway !== null)) {
                        var thText = [];
                        if (d.threshold.stock !== null) thText.push('재고 ' + d.threshold.stock + '개 이하');
                        if (d.threshold.runway !== null) thText.push('런웨이 ' + d.threshold.runway + '개월 미만');
                        document.getElementById('currentThreshold').innerHTML = '현재 설정: <strong>' + thText.join(', ') + '</strong>';
                    } else {
                        document.getElementById('currentThreshold').textContent = '현재 설정: 디폴트 기준값 사용';
                    }

                    // Display current memo
                    if (d.memo) {
                        var memoPreview = d.memo.length > 30 ? d.memo.substring(0, 30) + '...' : d.memo;
                        document.getElementById('currentMemo').innerHTML = '현재 메모: <strong>' + escapeHtml(memoPreview) + '</strong>';
                    } else {
                        document.getElementById('currentMemo').textContent = '현재 메모: 없음';
                    }

                    // Set form values (pre-fill for easy editing)
                    document.getElementById('inputDrugName').value = name;
                    document.getElementById('inputStock').value = '';
                    document.getElementById('inputStockThreshold').value = stockTh;
                    document.getElementById('inputRunwayThreshold').value = runwayTh;
                    document.getElementById('inputMemo').value = d.memo || '';

                    modalFlag = d.special_flag;
                    updateFlagUI();
                    selectedPatientIds = d.patients.map(function(p) { return p['환자ID']; });
                    renderPatientTags(d.patients);

                    // Disable save button initially
                    document.getElementById('saveBtn').disabled = true;
                    clearAllChangedMarkers();
                }
            });
    }

    function clearDrugSelection() {
        selectedDrugCode = null;
        document.getElementById('selectedDrug').classList.remove('visible');
        document.getElementById('selectedDrugCompany').style.display = 'none';
        document.getElementById('selectedDrugCompanySeparator').style.display = 'none';

        // Show hint, hide editable fields
        document.getElementById('unselectedHint').style.display = 'block';
        document.getElementById('editableFieldsSection').classList.remove('visible');

        // Clear inputs
        document.getElementById('inputDrugName').value = '';
        document.getElementById('inputStock').value = '';
        document.getElementById('inputStockThreshold').value = '';
        document.getElementById('inputRunwayThreshold').value = '';
        document.getElementById('inputMemo').value = '';
        document.getElementById('currentStock').textContent = '현재 재고: -';
        document.getElementById('currentDrugName').textContent = '현재 약품명: -';
        document.getElementById('currentThreshold').textContent = '현재 설정: 디폴트 기준값 사용';
        document.getElementById('currentMemo').textContent = '현재 메모: 없음';
        modalFlag = false;
        updateFlagUI();
        selectedPatientIds = [];
        renderPatientTags();

        // Reset original data and disable save
        originalData = {
            drugName: '',
            stock: '',
            stockThreshold: '',
            runwayThreshold: '',
            memo: '',
            patientIds: [],
            flag: false
        };
        document.getElementById('saveBtn').disabled = true;
        clearAllChangedMarkers();
    }

    function toggleModalFlag() {
        modalFlag = !modalFlag;
        updateFlagUI();
        checkChanges();
    }

    function updateFlagUI() {
        var editStar = document.getElementById('editStarFlag');
        var addStar = document.getElementById('addStarFlag');

        if (modalFlag) {
            if (editStar) {
                editStar.classList.remove('off');
                editStar.classList.add('on');
            }
            if (addStar) {
                addStar.classList.remove('off');
                addStar.classList.add('on');
            }
        } else {
            if (editStar) {
                editStar.classList.remove('on');
                editStar.classList.add('off');
            }
            if (addStar) {
                addStar.classList.remove('on');
                addStar.classList.add('off');
            }
        }
    }

    // Patient functions
    function renderPatientTags(patients) {
        var container = document.getElementById('patientTags');
        if (!patients || patients.length === 0) {
            container.innerHTML = '<span style="color: #a0aec0; font-size: 13px;">연결된 환자가 없습니다</span>';
            return;
        }

        container.innerHTML = patients.map(function(p) {
            return '\
                <span class="patient-tag">\
                    ' + p['환자명'] + (p['주민번호_앞자리'] ? ' (' + p['주민번호_앞자리'] + ')' : '') + '\
                    <span class="remove-btn" onclick="removePatient(' + p['환자ID'] + ')">&times;</span>\
                </span>\
            ';
        }).join('');
    }

    function removePatient(patientId) {
        selectedPatientIds = selectedPatientIds.filter(function(id) { return id !== patientId; });
        // Re-render (need to fetch patient info again)
        var tags = document.querySelectorAll('.patient-tag');
        tags.forEach(function(tag) {
            if (tag.querySelector('.remove-btn').getAttribute('onclick').includes(patientId)) {
                tag.remove();
            }
        });
        if (selectedPatientIds.length === 0) {
            document.getElementById('patientTags').innerHTML = '<span style="color: #a0aec0; font-size: 13px;">연결된 환자가 없습니다</span>';
        }
        checkChanges();
    }

    function searchPatients() {
        clearTimeout(searchTimeout);
        var query = document.getElementById('patientSearchInput').value.trim();
        var resultsDiv = document.getElementById('patientSearchResults');

        if (!query) {
            resultsDiv.classList.remove('visible');
            return;
        }

        searchTimeout = setTimeout(function() {
            fetch('/api/search-patients?q=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var html = '';
                    if (data.status === 'success' && data.data.length > 0) {
                        var filtered = data.data.filter(function(p) { return !selectedPatientIds.includes(p['환자ID']); });
                        if (filtered.length > 0) {
                            html = filtered.map(function(p) {
                                return '\
                                    <div class="patient-result-item" onclick="openDosageModal(' + p['환자ID'] + ', \'' + escapeHtml(p['환자명']) + '\', \'' + (p['주민번호_앞자리'] || '') + '\', ' + (p['방문주기_일'] || 30) + ')">\
                                        ' + p['환자명'] + (p['주민번호_앞자리'] ? ' (' + p['주민번호_앞자리'] + ')' : '') + '\
                                        ' + (p['방문주기_일'] ? '<span style="color: #718096; font-size: 12px; margin-left: 8px;">' + p['방문주기_일'] + '일 주기</span>' : '') + '\
                                    </div>\
                                ';
                            }).join('');
                        } else {
                            html = '<div style="padding: 12px; color: #a0aec0;">이미 모두 추가됨</div>';
                        }
                    }

                    // 새 환자 등록 옵션 추가 (검색어가 있을 때)
                    if (query.length > 0) {
                        html += '\
                            <div class="patient-result-item new-patient-option" onclick="openPatientModal(\'' + escapeHtml(query) + '\')" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #16a34a; font-weight: 500;">\
                                + "' + escapeHtml(query) + '" 새로 등록\
                            </div>\
                        ';
                    }

                    resultsDiv.innerHTML = html;
                    resultsDiv.classList.add('visible');
                });
        }, 300);
    }

    function addPatient(patientId, name, birth) {
        if (!selectedPatientIds.includes(patientId)) {
            selectedPatientIds.push(patientId);

            var container = document.getElementById('patientTags');
            if (container.querySelector('span[style]')) {
                container.innerHTML = '';
            }
            container.innerHTML += '\
                <span class="patient-tag">\
                    ' + name + (birth ? ' (' + birth + ')' : '') + '\
                    <span class="remove-btn" onclick="removePatient(' + patientId + ')">&times;</span>\
                </span>\
            ';
        }

        document.getElementById('patientSearchInput').value = '';
        document.getElementById('patientSearchResults').classList.remove('visible');
        checkChanges();
    }

    // Patient Modal
    function openPatientModal(preFillName) {
        preFillName = preFillName || '';
        document.getElementById('newPatientName').value = preFillName;
        document.getElementById('newPatientBirth').value = '';
        document.getElementById('newPatientVisitCycle').value = '';
        document.getElementById('newPatientMemo').value = '';
        document.getElementById('patientModal').classList.add('visible');
        // 검색 결과 숨기기
        document.getElementById('patientSearchResults').classList.remove('visible');
    }

    function closePatientModal() {
        document.getElementById('patientModal').classList.remove('visible');
    }

    // Dosage Modal Functions
    function openDosageModal(patientId, name, birth, visitCycle, currentDosage, editMode) {
        currentDosage = currentDosage || 1;
        editMode = editMode || false;
        pendingPatient = { patientId: patientId, name: name, birth: birth, visitCycle: visitCycle || 30 };
        isEditingDosage = editMode;

        document.getElementById('dosagePatientName').textContent = name;
        document.getElementById('dosagePatientInfo').textContent = birth ? ' (' + birth + ')' : '';
        document.getElementById('inputDosage').value = currentDosage;

        // Update modal title and button based on mode
        if (editMode) {
            document.getElementById('dosageModalIcon').querySelector('use').setAttribute('href', '#icon-edit-2');
            document.getElementById('dosageModalTitleText').textContent = '처방량 수정';
            document.getElementById('dosageModalBtn').textContent = '수정';
        } else {
            document.getElementById('dosageModalIcon').querySelector('use').setAttribute('href', '#icon-pill');
            document.getElementById('dosageModalTitleText').textContent = '1회 처방량 입력';
            document.getElementById('dosageModalBtn').textContent = '추가';
        }

        document.getElementById('dosageModal').classList.add('visible');
    }

    function openEditDosageModal(patientId) {
        var patient = selectedPatientData.find(function(p) { return p.patientId === patientId; });
        if (!patient) return;

        openDosageModal(
            patient.patientId,
            patient.name,
            patient.birth,
            patient.visitCycle,
            patient.dosage,
            true  // editMode = true
        );
    }

    function closeDosageModal() {
        document.getElementById('dosageModal').classList.remove('visible');
        pendingPatient = null;
        isEditingDosage = false;
    }

    function confirmDosageModal() {
        if (!pendingPatient) return;

        var dosage = parseInt(document.getElementById('inputDosage').value) || 1;

        if (isEditingDosage) {
            // Update existing patient's dosage
            var patient = selectedPatientData.find(function(p) { return p.patientId === pendingPatient.patientId; });
            if (patient) {
                patient.dosage = dosage;
                renderPatientTagsWithDosage();
                checkMinThreshold();  // 최소 임계값 체크
                // Hide buffer result when dosage changes
                document.getElementById('bufferResult').style.display = 'none';
                lastCalculatedBuffer = null;
                checkChanges();
            }
        } else {
            // Add new patient
            addPatientWithDosage(
                pendingPatient.patientId,
                pendingPatient.name,
                pendingPatient.birth,
                pendingPatient.visitCycle,
                dosage
            );
        }

        closeDosageModal();
    }

    // Keep old function name for backward compatibility
    function confirmAddPatientWithDosage() {
        confirmDosageModal();
    }

    function addPatientWithDosage(patientId, name, birth, visitCycle, dosage) {
        if (selectedPatientIds.includes(patientId)) return;

        selectedPatientIds.push(patientId);
        selectedPatientData.push({
            patientId: patientId, name: name, birth: birth,
            visitCycle: visitCycle || 30,
            dosage: dosage || 1
        });

        renderPatientTagsWithDosage();
        updateBufferCalcButton();
        checkMinThreshold();  // 최소 임계값 체크
        checkChanges();
    }

    function renderPatientTagsWithDosage() {
        var container = document.getElementById('patientTags');
        if (selectedPatientData.length === 0) {
            container.innerHTML = '<span style="color: #a0aec0; font-size: 13px;">연결된 환자가 없습니다</span>';
            return;
        }

        container.innerHTML = selectedPatientData.map(function(p) {
            return '\
                <span class="patient-tag">\
                    <span class="tag-content" onclick="openEditDosageModal(' + p.patientId + ')" title="클릭하여 처방량 수정">\
                        ' + escapeHtml(p.name) + (p.birth ? ' (' + p.birth + ')' : '') + '\
                        <span class="patient-dosage-badge">' + p.dosage + '개/회</span>\
                    </span>\
                    <span class="remove-btn" onclick="removePatientWithData(' + p.patientId + ')">&times;</span>\
                </span>\
            ';
        }).join('');
    }

    function removePatientWithData(patientId) {
        selectedPatientIds = selectedPatientIds.filter(function(id) { return id !== patientId; });
        selectedPatientData = selectedPatientData.filter(function(p) { return p.patientId !== patientId; });
        renderPatientTagsWithDosage();
        updateBufferCalcButton();
        checkMinThreshold();  // 최소 임계값 체크
        // Hide buffer result when patients change
        document.getElementById('bufferResult').style.display = 'none';
        lastCalculatedBuffer = null;
        checkChanges();
    }

    function updateBufferCalcButton() {
        var hasPatients = selectedPatientData.length > 0;
        document.getElementById('calcBufferBtn').disabled = !hasPatients;
        if (!hasPatients) {
            document.getElementById('bufferResult').style.display = 'none';
        }
    }

    // 최소 재고 임계값 체크 및 자동 설정
    function checkMinThreshold() {
        var warningDiv = document.getElementById('minThresholdWarning');
        var warningText = warningDiv.querySelector('.warning-text');
        var thresholdInput = document.getElementById('inputStockThreshold');

        // 환자가 없으면 경고 숨기기
        if (selectedPatientData.length === 0) {
            warningDiv.style.display = 'none';
            return;
        }

        // max(처방량) 계산
        var maxDosage = Math.max.apply(null, selectedPatientData.map(function(p) { return p.dosage || 1; }));
        var maxPatient = selectedPatientData.find(function(p) { return p.dosage === maxDosage; });
        var patientInfo = maxPatient ? maxPatient.name : '';

        var currentThreshold = thresholdInput.value ? parseInt(thresholdInput.value) : null;

        // Case 1: 임계값이 비어있음 → 자동 채움
        if (currentThreshold === null || currentThreshold === 0) {
            thresholdInput.value = maxDosage;
            warningDiv.style.display = 'flex';
            warningText.innerHTML = '환자 1회 최대 처방량(' + patientInfo + ': ' + maxDosage + '개)을 기준으로 재고 임계값이 자동 설정되었습니다.';
            checkChanges();
            return;
        }

        // Case 2: 임계값이 max(처방량)보다 낮음 → 경고
        if (currentThreshold < maxDosage) {
            warningDiv.style.display = 'flex';
            warningText.innerHTML = '현재 임계값(' + currentThreshold + '개)이 최대 처방량(' + patientInfo + ': ' + maxDosage + '개)보다 낮습니다. <span class="auto-fill-link" onclick="applyMinDosageThreshold(' + maxDosage + ')">' + maxDosage + '개로 설정</span>';
            return;
        }

        // Case 3: 정상 → 경고 숨기기
        warningDiv.style.display = 'none';
    }

    // 최소 처방량 임계값 적용
    function applyMinDosageThreshold(value) {
        document.getElementById('inputStockThreshold').value = value;
        checkMinThreshold();
        checkChanges();
    }

    // Buffer Calculation Functions
    var selectedRiskLevel = 'safe';  // Default value

    function selectRiskLevel(level) {
        selectedRiskLevel = level;

        // Update UI
        document.querySelectorAll('.risk-chip').forEach(function(chip) {
            chip.classList.remove('selected');
            if (chip.dataset.value === level) {
                chip.classList.add('selected');
            }
        });

        // Update description
        var descriptions = {
            'relaxed': '흔한 동시 방문만 대비',
            'normal': '일반적인 동시 방문 대비',
            'safe': '드문 동시 방문까지 대비',
            'very_safe': '매우 드문 동시 방문까지 대비'
        };
        document.getElementById('riskLevelDescription').textContent = descriptions[level] || '';
    }

    function calculateBuffer() {
        if (!selectedDrugCode || selectedPatientData.length === 0) return;

        var riskLevel = selectedRiskLevel;
        var calcBtn = document.getElementById('calcBufferBtn');
        calcBtn.disabled = true;
        calcBtn.textContent = '계산 중...';

        // Send current UI patient data (may not be saved yet)
        var patientsForCalc = selectedPatientData.map(function(p) {
            return {
                patient_id: p.patientId,
                visit_cycle: p.visitCycle,
                dosage: p.dosage
            };
        });

        fetch('/api/drug/' + selectedDrugCode + '/calculate-buffer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ risk_level: riskLevel, patients: patientsForCalc })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            calcBtn.disabled = false;
            calcBtn.textContent = '계산하기';

            if (data.status === 'success') {
                displayBufferResult(data.data);
            } else {
                showToast(data.message || '계산 실패', 'error');
            }
        })
        .catch(function(error) {
            calcBtn.disabled = false;
            calcBtn.textContent = '계산하기';
            showToast('계산 오류: ' + error.message, 'error');
        });
    }

    function displayBufferResult(result) {
        lastCalculatedBuffer = result.min_buffer;

        document.getElementById('bufferValue').textContent = result.min_buffer;
        document.getElementById('bufferExplanation').textContent = result.explanation;

        // Show patient details
        if (result.all_patients && result.all_patients.length > 0) {
            var detailsHtml = '<div style="font-weight: var(--font-semibold); margin-bottom: var(--space-2);">환자별 정보:</div>';
            result.all_patients.forEach(function(p) {
                var includedClass = p['버퍼포함'] ? 'buffer-patient-included' : '';
                var includedIcon = p['버퍼포함'] ? '<svg class="icon" style="width: var(--icon-xs); height: var(--icon-xs); vertical-align: middle; margin-right: var(--space-1);"><use href="#icon-check"></use></svg>' : '';
                detailsHtml += '\
                    <div class="buffer-patient-item ' + includedClass + '">\
                        <span>' + includedIcon + p['환자명'] + ' (' + p['방문주기_일'] + '일 주기)</span>\
                        <span>' + p['1회_처방량'] + '개/회</span>\
                    </div>\
                ';
            });
            document.getElementById('bufferDetails').innerHTML = detailsHtml;
        } else {
            document.getElementById('bufferDetails').innerHTML = '';
        }

        document.getElementById('bufferResult').style.display = 'block';
    }

    function applyBufferToThreshold() {
        if (lastCalculatedBuffer === null) return;

        document.getElementById('inputStockThreshold').value = lastCalculatedBuffer;
        checkChanges();

        // Visual feedback
        var thresholdSection = document.getElementById('sectionThreshold');
        thresholdSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        thresholdSection.style.animation = 'highlight 1s ease';
        setTimeout(function() {
            thresholdSection.style.animation = '';
        }, 1000);
    }

    function saveNewPatient() {
        var name = document.getElementById('newPatientName').value.trim();
        var birth = document.getElementById('newPatientBirth').value.trim();
        var visitCycle = document.getElementById('newPatientVisitCycle').value;
        var memo = document.getElementById('newPatientMemo').value.trim();

        if (!name) {
            showToast('환자명은 필수입니다.', 'error');
            return;
        }

        fetch('/api/patient', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name, birth: birth, memo: memo, visit_cycle: visitCycle })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                closePatientModal();
                // Open dosage modal for the newly created patient
                openDosageModal(data.patient_id, name, birth, parseInt(visitCycle) || 30);
                loadStats();
            } else {
                showToast(data.message, 'error');
            }
        });
    }

    // Save Drug Management
    function saveDrugManagement() {
        if (!selectedDrugCode) {
            showStatus('약품을 선택해주세요.', 'error');
            return;
        }

        var payload = {};

        var drugName = document.getElementById('inputDrugName').value.trim();
        if (drugName) payload.drug_name = drugName;

        var stock = document.getElementById('inputStock').value;
        if (stock !== '') payload.stock = parseFloat(stock);

        var stockTh = document.getElementById('inputStockThreshold').value;
        var runwayTh = document.getElementById('inputRunwayThreshold').value;
        payload.threshold = {
            stock: stockTh !== '' ? parseInt(stockTh) : null,
            runway: runwayTh !== '' ? parseFloat(runwayTh) : null
        };

        payload.memo = document.getElementById('inputMemo').value.trim();
        payload.special_flag = modalFlag;
        // Send patients with dosage info
        payload.patients = selectedPatientData.map(function(p) {
            return {
                patient_id: p.patientId,
                dosage: p.dosage
            };
        });
        // Keep patient_ids for backward compatibility
        payload.patient_ids = selectedPatientIds;

        fetch('/api/drug-management/' + selectedDrugCode, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success' || data.status === 'partial') {
                closeModal();
                loadManagedDrugs();
                loadStats();
                showStatus('저장되었습니다.', 'success');
            } else {
                showStatus(data.message, 'error');
            }
        })
        .catch(function(error) {
            showStatus('저장 실패: ' + error.message, 'error');
        });
    }

    // Change Tracking Functions
    function checkChanges() {
        if (!selectedDrugCode) {
            document.getElementById('saveBtn').disabled = true;
            return;
        }

        var currentDrugName = document.getElementById('inputDrugName').value.trim();
        var currentStock = document.getElementById('inputStock').value;
        var currentStockTh = document.getElementById('inputStockThreshold').value;
        var currentRunwayTh = document.getElementById('inputRunwayThreshold').value;
        var currentMemo = document.getElementById('inputMemo').value.trim();
        var currentPatientIds = selectedPatientIds.slice().sort();

        // Check each section for changes
        var changes = {
            drugName: currentDrugName !== originalData.drugName,
            stock: currentStock !== '' && currentStock !== originalData.stock,
            threshold: currentStockTh !== originalData.stockThreshold ||
                       currentRunwayTh !== originalData.runwayThreshold,
            memo: currentMemo !== originalData.memo,
            patients: JSON.stringify(currentPatientIds) !== JSON.stringify(originalData.patientIds),
            flag: modalFlag !== originalData.flag
        };

        // Update section styling
        updateSectionStyle('sectionDrugName', changes.drugName);
        updateSectionStyle('sectionStock', changes.stock);
        updateSectionStyle('sectionThreshold', changes.threshold);
        updateSectionStyle('sectionMemo', changes.memo);
        updateSectionStyle('sectionPatients', changes.patients);

        // Enable/disable save button
        var hasChanges = Object.values(changes).some(function(v) { return v; });
        document.getElementById('saveBtn').disabled = !hasChanges;
    }

    function updateSectionStyle(sectionId, hasChanges) {
        var section = document.getElementById(sectionId);
        if (section) {
            if (hasChanges) {
                section.classList.add('changed');
            } else {
                section.classList.remove('changed');
            }
        }
    }

    function clearAllChangedMarkers() {
        var sections = ['sectionDrugName', 'sectionStock', 'sectionThreshold', 'sectionMemo', 'sectionPatients'];
        sections.forEach(function(id) {
            var section = document.getElementById(id);
            if (section) section.classList.remove('changed');
        });
    }

    // Utility
    function showStatus(message, type) {
        var statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message ' + type;
        setTimeout(function() {
            statusDiv.className = 'status-message';
        }, 3000);
    }

    function escapeHtml(text) {
        if (!text) return '';
        var map = {
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Modal content check functions
    function hasDrugModalContent() {
        // 약품이 선택되었는지 확인
        if (!selectedDrugCode) return false;

        // 새로 추가 모드에서만 체크 (수정 모드에서는 항상 내용이 있음)
        if (isEditMode) return true;

        // 폼에 입력된 내용이 있는지 확인
        var hasMemo = document.getElementById('inputMemo').value.trim() !== '';
        var hasStock = document.getElementById('inputStock').value !== '';
        var hasStockTh = document.getElementById('inputStockThreshold').value !== '';
        var hasRunwayTh = document.getElementById('inputRunwayThreshold').value !== '';
        var hasPatients = selectedPatientIds.length > 0;

        return hasMemo || hasStock || hasStockTh || hasRunwayTh || hasPatients;
    }

    function hasPatientModalContent() {
        var name = document.getElementById('newPatientName').value.trim();
        var birth = document.getElementById('newPatientBirth').value.trim();
        var visitCycle = document.getElementById('newPatientVisitCycle').value;
        var memo = document.getElementById('newPatientMemo').value.trim();

        return name !== '' || birth !== '' || visitCycle !== '' || memo !== '';
    }

    function hasDosageModalContent() {
        var dosage = document.getElementById('inputDosage').value;
        return dosage !== '' && dosage !== '1';  // 기본값 1이 아닌 경우에만 내용 있음으로 판단
    }

    // Shake modal animation
    function shakeModal(modalId) {
        var modal = document.getElementById(modalId);
        var content = modal.querySelector('.modal-content');
        content.classList.add('shake');
        setTimeout(function() {
            content.classList.remove('shake');
        }, 400);
    }

    // Try close modal with confirmation using shared showConfirmModal
    async function tryCloseDrugModal() {
        if (hasDrugModalContent()) {
            shakeModal('drugModal');
            var confirmed = await showConfirmModal({
                icon: 'warning',
                title: '작성 중인 내용이 있습니다',
                message: '정말 닫으시겠습니까?<br>입력한 내용은 저장되지 않습니다.',
                confirmText: '닫기',
                isDanger: true
            });
            if (confirmed) {
                closeModal();
            }
        } else {
            closeModal();
        }
    }

    async function tryClosePatientModal() {
        if (hasPatientModalContent()) {
            shakeModal('patientModal');
            var confirmed = await showConfirmModal({
                icon: 'warning',
                title: '작성 중인 내용이 있습니다',
                message: '정말 닫으시겠습니까?<br>입력한 내용은 저장되지 않습니다.',
                confirmText: '닫기',
                isDanger: true
            });
            if (confirmed) {
                closePatientModal();
            }
        } else {
            closePatientModal();
        }
    }

    async function tryCloseDosageModal() {
        if (hasDosageModalContent()) {
            shakeModal('dosageModal');
            var confirmed = await showConfirmModal({
                icon: 'warning',
                title: '작성 중인 내용이 있습니다',
                message: '정말 닫으시겠습니까?<br>입력한 내용은 저장되지 않습니다.',
                confirmText: '닫기',
                isDanger: true
            });
            if (confirmed) {
                closeDosageModal();
            }
        } else {
            closeDosageModal();
        }
    }

    // Close modal on outside click
    document.getElementById('drugModal').addEventListener('click', function(e) {
        if (e.target === this) tryCloseDrugModal();
    });

    document.getElementById('patientModal').addEventListener('click', function(e) {
        if (e.target === this) tryClosePatientModal();
    });

    document.getElementById('dosageModal').addEventListener('click', function(e) {
        if (e.target === this) tryCloseDosageModal();
    });

    // ESC to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // 커스텀 확인 모달이 열려있으면 취소 (shared component handles its own ESC)
            var confirmModal = document.getElementById('confirmModal');
            if (confirmModal && confirmModal.classList.contains('visible')) {
                return;  // Let the shared component handle it
            }

            var drugModal = document.getElementById('drugModal');
            var patientModal = document.getElementById('patientModal');
            var dosageModal = document.getElementById('dosageModal');

            if (dosageModal.classList.contains('visible')) {
                tryCloseDosageModal();
            } else if (patientModal.classList.contains('visible')) {
                tryClosePatientModal();
            } else if (drugModal.classList.contains('visible')) {
                tryCloseDrugModal();
            }
        }
    });
</script>
{% endblock %}
