<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•½í’ˆ ê°œë³„ ê´€ë¦¬ - Jaego</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            overflow-y: scroll;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes highlight {
            0% { background-color: transparent; }
            30% { background-color: #bee3f8; }
            100% { background-color: transparent; }
        }

        .back-link {
            color: #4299e1;
            text-decoration: none;
            font-size: 14px;
            display: inline-block;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .btn-shutdown {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .btn-shutdown:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        .btn-shutdown:active {
            transform: translateY(0);
        }

        /* Header Row (Stats + Actions) */
        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 15px;
            padding: 12px 16px;
            background: #f1f5f9;
            border-radius: 10px;
            flex-wrap: wrap;
            border: 1px solid #e2e8f0;
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .stat-item {
            color: #475569;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-value {
            font-weight: bold;
            font-size: 16px;
            color: #1e293b;
        }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: #4299e1;
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 14px;
            border: 1px solid #d1d5db;
            border-radius: 20px;
            background: #f9fafb;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }

        .filter-btn.active {
            background: #eff6ff;
            border-color: #60a5fa;
            color: #2563eb;
        }

        .sort-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            padding-left: 10px;
            border-left: 1px solid #e2e8f0;
        }

        .sort-btn {
            padding: 5px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            color: #9ca3af;
            transition: all 0.2s;
        }

        .sort-btn:hover {
            color: #6b7280;
            border-color: #d1d5db;
        }

        .sort-btn.active {
            background: #f9fafb;
            border-color: #9ca3af;
            color: #374151;
        }

        /* Drug Card List */
        .drug-list {
            max-height: 600px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .drug-list::-webkit-scrollbar {
            width: 8px;
        }

        .drug-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .drug-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .drug-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px;
            transition: all 0.2s;
            min-width: 0;
            overflow: hidden;
        }

        .drug-card:hover {
            border-color: #cbd5e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .drug-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .drug-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .star-flag {
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .star-flag.off {
            color: #cbd5e0;
        }

        .star-flag.off:hover {
            color: #a0aec0;
        }

        .star-flag.on {
            color: #f6e05e;
            text-shadow: 0 0 8px rgba(246, 224, 94, 0.5);
        }

        .star-flag.on:hover {
            color: #ecc94b;
        }

        .drug-name {
            font-size: 15px;
            font-weight: 700;
            color: #1a202c;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .drug-code {
            font-size: 12px;
            color: #718096;
        }

        .drug-company {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        .drug-stock {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #4a5568;
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .drug-stock-label {
            font-weight: 400;
            opacity: 0.85;
        }

        /* Tooltip */
        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #e2e8f0;
            color: #718096;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            cursor: help;
            margin-left: 6px;
            position: relative;
        }

        .help-icon:hover {
            background: #cbd5e0;
            color: #4a5568;
        }

        .help-icon .tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            background: #2d3748;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 400;
            white-space: normal;
            width: 280px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .help-icon .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 12px;
            border: 6px solid transparent;
            border-top-color: #2d3748;
        }

        .help-icon:hover .tooltip {
            display: block;
        }

        .drug-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .badge-threshold {
            background: #fed7d7;
            color: #c53030;
        }

        .badge-memo {
            background: #feebc8;
            color: #c05621;
        }

        .badge-patient {
            background: #e8f4fd;
            color: #2b6cb0;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #48bb78;
            color: white;
        }

        .btn-primary:hover {
            background: #38a169;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #fc8181;
            color: white;
        }

        .btn-danger:hover {
            background: #f56565;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #2d3748;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #a0aec0;
        }

        .modal-close:hover {
            color: #718096;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: white;
        }

        /* Form sections */
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 12px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }

        .min-threshold-warning {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            margin-top: 8px;
        }

        .min-threshold-warning .warning-icon {
            flex-shrink: 0;
        }

        .min-threshold-warning .warning-text {
            font-size: 13px;
            color: #92400e;
            line-height: 1.4;
        }

        .min-threshold-warning .auto-fill-link {
            color: #d97706;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .min-threshold-warning .auto-fill-link:hover {
            color: #b45309;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #718096;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4299e1;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .current-value {
            font-size: 13px;
            color: #718096;
            margin-bottom: 6px;
        }

        /* Patient tags */
        .patient-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .patient-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #e8f4fd;
            border: 1px solid #90cdf4;
            border-radius: 20px;
            font-size: 13px;
            color: #2b6cb0;
        }

        .patient-tag .tag-content {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .patient-tag .tag-content:hover {
            color: #2c5282;
        }

        .patient-tag .tag-content:hover .patient-dosage-badge {
            background: #2b6cb0;
        }

        .patient-tag .remove-btn {
            cursor: pointer;
            color: #4299e1;
            font-weight: bold;
            margin-left: 2px;
        }

        .patient-tag .remove-btn:hover {
            color: #e53e3e;
        }

        .patient-dosage-badge {
            background: #4299e1;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Buffer Calculation Section */
        .buffer-calc-container {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .risk-level-chips {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .risk-chip {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #4a5568;
        }

        .risk-chip:hover {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .risk-chip.selected {
            border-color: #4299e1;
            background: #4299e1;
            color: #fff;
        }

        .risk-chip .chip-label {
            font-weight: 500;
        }

        .buffer-result {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .buffer-result-header {
            text-align: center;
            margin-bottom: 10px;
        }

        .buffer-value {
            font-size: 36px;
            font-weight: 700;
            color: #4299e1;
        }

        .buffer-unit {
            font-size: 16px;
            color: #718096;
            margin-left: 5px;
        }

        .buffer-explanation {
            font-size: 14px;
            color: #4a5568;
            text-align: center;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .buffer-details {
            font-size: 13px;
            color: #718096;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
            margin-top: 10px;
        }

        .buffer-patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .buffer-patient-item:last-child {
            border-bottom: none;
        }

        .buffer-patient-included {
            color: #2b6cb0;
            font-weight: 500;
        }

        .patient-search-container {
            position: relative;
        }

        .patient-search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .patient-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .patient-search-results.visible {
            display: block;
        }

        .patient-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .patient-result-item:hover {
            background: #f7fafc;
        }

        .patient-result-item:last-child {
            border-bottom: none;
        }

        /* Add patient modal */
        .add-patient-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .add-patient-btn:hover {
            background: #38a169;
        }

        /* Status message */
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status-message.success {
            background: #c6f6d5;
            color: #276749;
            display: block;
        }

        .status-message.error {
            background: #fed7d7;
            color: #c53030;
            display: block;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0aec0;
            grid-column: 1 / -1;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        /* Drug search in modal */
        .drug-search-section {
            margin-bottom: 20px;
        }

        .drug-search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 8px;
            display: none;
        }

        .drug-search-results.visible {
            display: block;
        }

        .drug-result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .drug-result-item:hover {
            background: #f7fafc;
        }

        .selected-drug {
            padding: 12px;
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            border-radius: 8px;
            margin-top: 12px;
            display: none;
        }

        .selected-drug.visible {
            display: block;
        }

        .selected-drug-clear {
            background: none;
            border: none;
            color: #e53e3e;
            cursor: pointer;
            font-size: 18px;
        }

        /* Editable fields section - hidden until drug selected */
        .editable-fields-section {
            display: none;
        }

        .editable-fields-section.visible {
            display: block;
        }

        .unselected-hint {
            text-align: center;
            padding: 40px 20px;
            color: #a0aec0;
            font-size: 14px;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            margin-top: 20px;
        }

        .unselected-hint-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        /* Changed field indicator */
        .form-section.changed {
            border-left: 3px solid #4299e1;
            background: linear-gradient(90deg, #ebf8ff 0%, white 100%);
        }

        .form-section.changed .form-section-title::after {
            content: ' (ë³€ê²½ë¨)';
            color: #4299e1;
            font-size: 12px;
            font-weight: normal;
        }

        /* Disabled save button */
        .btn-primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .btn-primary:disabled:hover {
            background: #cbd5e0;
        }

        /* Modal shake animation */
        @keyframes modalShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .modal-content.shake {
            animation: modalShake 0.4s ease-in-out;
        }

        /* Custom Confirm Modal */
        .confirm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease;
        }

        .confirm-modal-overlay.visible {
            display: flex;
        }

        .confirm-modal-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.2s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .confirm-modal-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .confirm-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .confirm-modal-message {
            font-size: 14px;
            color: #718096;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .confirm-modal-buttons .btn {
            min-width: 100px;
        }

        /* Current value display */
        .current-value-display {
            font-size: 13px;
            color: #4a5568;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .current-value-display strong {
            color: #2d3748;
        }
    </style>
</head>
<body>
    <button class="btn-shutdown" onclick="shutdownServer()">â» ì¢…ë£Œ</button>

    <div class="container">
        <a href="/" class="back-link" style="margin-bottom: 20px;">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

        <div style="display: block; text-align: center; padding-bottom: 10px; margin-bottom: 30px; border-bottom: 2px solid #e2e8f0;">
            <h1 style="color: #2d3748; font-size: 1.8em; display: flex; align-items: center; justify-content: center; gap: 10px;">
                <span>âš™ï¸</span>
                ì•½í’ˆ ê°œë³„ ê´€ë¦¬
            </h1>
            <p style="color: #718096; margin-top: 8px;">ì•½í’ˆë³„ ëª¨ë“  ì„¤ì •ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="header-row">
            <div class="stats-bar" id="statsBar">
                <div class="stat-item">
                    <span>ì „ì²´ ê´€ë¦¬:</span>
                    <span class="stat-value" id="statTotal">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <span>â­ íŠ¹ë³„ê´€ë¦¬:</span>
                    <span class="stat-value" id="statFlagged">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <span>ğŸ“ ë©”ëª¨:</span>
                    <span class="stat-value" id="statMemo">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <span>âš™ï¸ ì„ê³„ê°’:</span>
                    <span class="stat-value" id="statThreshold">0</span>ê°œ
                </div>
                <div class="stat-item">
                    <span>ğŸ‘¤ ë“±ë¡ í™˜ì:</span>
                    <span class="stat-value" id="statPatient">0</span>ëª…
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddModal()">+ ìƒˆ ì•½í’ˆ ê´€ë¦¬ ì¶”ê°€</button>
            </div>
        </div>

        <div class="search-filter-bar">
            <input type="text" class="search-input" id="searchInput"
                   placeholder="ì•½í’ˆëª…, ì•½í’ˆì½”ë“œ, ì œì•½íšŒì‚¬ë¡œ ê²€ìƒ‰..."
                   oninput="filterDrugs()">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all" onclick="setDrugFilter('all')">ì „ì²´</button>
                <button class="filter-btn" data-filter="flagged" onclick="setDrugFilter('flagged')">â­ íŠ¹ë³„ê´€ë¦¬</button>
                <button class="filter-btn" data-filter="threshold" onclick="setDrugFilter('threshold')">âš™ï¸ ì„ê³„ê°’</button>
            </div>
            <div class="sort-buttons">
                <button class="sort-btn active" data-sort="recent" onclick="setDrugSort('recent')">ìµœê·¼ìˆœ</button>
                <button class="sort-btn" data-sort="name" onclick="setDrugSort('name')">ê°€ë‚˜ë‹¤ìˆœ</button>
            </div>
        </div>

        <div class="drug-list" id="drugList">
            <div class="empty-state">
                <div class="empty-state-icon">âš™ï¸</div>
                <div>ê´€ë¦¬ ì¤‘ì¸ ì•½í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
                <div style="margin-top: 10px; font-size: 14px;">ê²€ìƒ‰í•˜ì—¬ ì•½í’ˆì„ ì¶”ê°€í•˜ê±°ë‚˜, "ìƒˆ ì•½í’ˆ ê´€ë¦¬ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Drug Modal -->
    <div id="drugModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">âš™ï¸ ì•½í’ˆ ìƒì„¸ ê´€ë¦¬</h3>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Drug Search (for new) -->
                <div class="drug-search-section" id="drugSearchSection">
                    <label style="font-size: 14px; color: #4a5568; margin-bottom: 8px; display: block;">ì•½í’ˆ ê²€ìƒ‰</label>
                    <input type="text" class="search-input" id="modalDrugSearch"
                           placeholder="ì•½í’ˆëª… ë˜ëŠ” ì•½í’ˆì½”ë“œë¡œ ê²€ìƒ‰..."
                           oninput="searchDrugsForModal()">
                    <div class="drug-search-results" id="modalDrugResults"></div>
                    <div class="selected-drug" id="selectedDrug">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="star-flag" id="addStarFlag" onclick="toggleModalFlag()" title="íŠ¹ë³„ ê´€ë¦¬ í† ê¸€">â˜†</div>
                                <div>
                                    <div style="font-weight: 600;" id="selectedDrugName">-</div>
                                    <div style="font-size: 13px; color: #718096;" id="selectedDrugCode">-</div>
                                </div>
                            </div>
                            <button class="selected-drug-clear" onclick="clearDrugSelection()">&times;</button>
                        </div>
                    </div>
                </div>

                <!-- Drug Info (for edit) -->
                <div class="form-section" id="drugInfoSection" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 18px; font-weight: 600;" id="editDrugName">-</div>
                            <div style="font-size: 14px; color: #718096;" id="editDrugCode">-</div>
                            <div style="font-size: 13px; color: #a0aec0;" id="editDrugCompany">-</div>
                        </div>
                        <div class="star-flag" id="editStarFlag" onclick="toggleModalFlag()" title="íŠ¹ë³„ ê´€ë¦¬ í† ê¸€">â˜†</div>
                    </div>
                </div>

                <!-- Hint when no drug selected -->
                <div class="unselected-hint" id="unselectedHint">
                    <div class="unselected-hint-icon">ğŸ‘†</div>
                    <div>ìœ„ì—ì„œ ì•½í’ˆì„ ë¨¼ì € ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                    <div style="margin-top: 5px; font-size: 12px;">ì•½í’ˆ ì„ íƒ í›„ ì•„ë˜ í¸ì§‘ ì˜µì…˜ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
                </div>

                <!-- Editable fields (hidden until drug selected) -->
                <div class="editable-fields-section" id="editableFieldsSection">
                    <!-- 1. Memo -->
                    <div class="form-section" id="sectionMemo">
                        <div class="form-section-title">ğŸ“ ë©”ëª¨</div>
                        <div class="current-value-display" id="currentMemo">í˜„ì¬ ë©”ëª¨: ì—†ìŒ</div>
                        <div class="form-group">
                            <textarea id="inputMemo" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="checkChanges()"></textarea>
                        </div>
                    </div>

                    <!-- 2. Drug Name Edit -->
                    <div class="form-section" id="sectionDrugName">
                        <div class="form-section-title">ğŸ“¦ ì•½í’ˆëª… ìˆ˜ì •</div>
                        <div class="current-value-display" id="currentDrugName">í˜„ì¬ ì•½í’ˆëª…: -</div>
                        <div class="form-group">
                            <label>ìƒˆ ì•½í’ˆëª… (ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</label>
                            <input type="text" id="inputDrugName" placeholder="ë³€ê²½í•  ì•½í’ˆëª… ì…ë ¥..." oninput="checkChanges()">
                        </div>
                    </div>

                    <!-- 2. Stock Edit -->
                    <div class="form-section" id="sectionStock">
                        <div class="form-section-title">ğŸ”¢ ì¬ê³  ìˆ˜ì •</div>
                        <div class="current-value-display" id="currentStock">í˜„ì¬ ì¬ê³ : -</div>
                        <div class="form-group">
                            <label>ìƒˆ ì¬ê³ ìˆ˜ëŸ‰ (ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</label>
                            <input type="number" id="inputStock" placeholder="ë³€ê²½í•  ì¬ê³ ìˆ˜ëŸ‰ ì…ë ¥" oninput="checkChanges()">
                        </div>
                    </div>

                    <!-- 3. Threshold -->
                    <div class="form-section" id="sectionThreshold">
                        <div class="form-section-title">
                            âš™ï¸ ì¬ê³  ë¶€ì¡± ê°ì§€ ì„ê³„ê°’ ì„¤ì •
                            <span class="help-icon">?
                                <span class="tooltip">ì„¤ì •í•œ ì„ê³„ê°’ ì´í•˜ë¡œ ì¬ê³ ê°€ ë–¨ì–´ì§€ë©´ ì¬ê³  í˜„í™© ë¦¬í¬íŠ¸ì—ì„œ í•´ë‹¹ ì•½í’ˆì´ ê°•ì¡° í‘œì‹œë©ë‹ˆë‹¤. ì¬ê³  ì„ê³„ê°’ì€ ìˆ˜ëŸ‰ ê¸°ì¤€, ëŸ°ì›¨ì´ ì„ê³„ê°’ì€ í˜„ì¬ ì‚¬ìš© ì†ë„ ëŒ€ë¹„ ë‚¨ì€ ê°œì›” ìˆ˜ ê¸°ì¤€ì…ë‹ˆë‹¤.</span>
                            </span>
                        </div>
                        <div class="current-value-display" id="currentThreshold">í˜„ì¬ ì„¤ì •: ë””í´íŠ¸ ê¸°ì¤€ê°’ ì‚¬ìš©</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ì¬ê³  ì„ê³„ê°’ (ê°œ)</label>
                                <input type="number" id="inputStockThreshold" placeholder="ì´ ê°’ ì´í•˜ ì‹œ ê°•ì¡°" oninput="checkChanges(); checkMinThreshold();">
                            </div>
                            <div class="form-group">
                                <label>ëŸ°ì›¨ì´ ì„ê³„ê°’ (ê°œì›”)</label>
                                <input type="number" step="0.1" id="inputRunwayThreshold" placeholder="ì´ ê°’ ë¯¸ë§Œ ì‹œ ê°•ì¡°" oninput="checkChanges()">
                            </div>
                        </div>
                        <div id="minThresholdWarning" class="min-threshold-warning" style="display: none;">
                            <span class="warning-icon">âš ï¸</span>
                            <span class="warning-text"></span>
                        </div>
                    </div>

                    <!-- 4. Patients -->
                    <div class="form-section" id="sectionPatients">
                        <div class="form-section-title">
                            ğŸ‘¤ í™˜ì íƒœê·¸
                            <span class="help-icon">?
                                <span class="tooltip">íŠ¹ì • í™˜ìì—ê²Œë§Œ ì²˜ë°©ë˜ëŠ” ì•½í’ˆì— í™˜ìë¥¼ íƒœê·¸í•˜ê³  ë°©ë¬¸ ì£¼ê¸°ì™€ 1íšŒ ì²˜ë°©ëŸ‰ì„ ì…ë ¥í•˜ë©´, ìµœì†Œ ì¬ê³  ë²„í¼ë¥¼ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                            </span>
                        </div>
                        <div class="patient-tags" id="patientTags">
                            <!-- Patient tags will be added here -->
                        </div>
                        <div class="patient-search-container">
                            <input type="text" class="patient-search-input" id="patientSearchInput"
                                   placeholder="í™˜ìëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€..."
                                   oninput="searchPatients()">
                            <div class="patient-search-results" id="patientSearchResults"></div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="add-patient-btn" onclick="openPatientModal()">+ ìƒˆ í™˜ì ë“±ë¡</button>
                        </div>
                    </div>

                    <!-- 5. Buffer Calculation -->
                    <div class="form-section" id="sectionBuffer">
                        <div class="form-section-title">
                            ğŸ“Š ìµœì†Œ ì¬ê³  ë²„í¼ ê³„ì‚°
                            <span class="help-icon">?
                                <span class="tooltip">ì—°ê²°ëœ í™˜ìë“¤ì˜ ë°©ë¬¸ ì£¼ê¸°ì™€ ì²˜ë°©ëŸ‰ì„ ê¸°ë°˜ìœ¼ë¡œ, ë™ì‹œ ë°©ë¬¸ í™•ë¥ ì„ ê³„ì‚°í•˜ì—¬ í•„ìš”í•œ ìµœì†Œ ì¬ê³  ë²„í¼ë¥¼ ì‚°ì¶œí•©ë‹ˆë‹¤. í¬ì•„ì†¡ ì´í•­ë¶„í¬ ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</span>
                            </span>
                        </div>
                        <div class="buffer-calc-container">
                            <div class="form-group">
                                <label>í—ˆìš© ë¦¬ìŠ¤í¬ ìˆ˜ì¤€</label>
                                <div class="risk-level-chips">
                                    <button type="button" class="risk-chip" data-value="relaxed" onclick="selectRiskLevel('relaxed')">
                                        <span class="chip-label">ì ˆì•½</span>
                                    </button>
                                    <button type="button" class="risk-chip" data-value="normal" onclick="selectRiskLevel('normal')">
                                        <span class="chip-label">ë³´í†µ</span>
                                    </button>
                                    <button type="button" class="risk-chip selected" data-value="safe" onclick="selectRiskLevel('safe')">
                                        <span class="chip-label">ì•ˆì „</span>
                                    </button>
                                    <button type="button" class="risk-chip" data-value="very_safe" onclick="selectRiskLevel('very_safe')">
                                        <span class="chip-label">ë§¤ìš° ì•ˆì „</span>
                                    </button>
                                </div>
                                <div style="font-size: 12px; color: #718096; margin-top: 8px; text-align: center;" id="riskLevelDescription">
                                    ë“œë¬¸ ë™ì‹œ ë°©ë¬¸ê¹Œì§€ ëŒ€ë¹„
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="calculateBuffer()" id="calcBufferBtn" disabled style="margin-top: 10px;">
                                ê³„ì‚°í•˜ê¸°
                            </button>
                            <div class="buffer-result" id="bufferResult" style="display: none;">
                                <div class="buffer-result-header">
                                    <span class="buffer-value" id="bufferValue">-</span>
                                    <span class="buffer-unit">ê°œ</span>
                                </div>
                                <div class="buffer-explanation" id="bufferExplanation"></div>
                                <div class="buffer-details" id="bufferDetails"></div>
                                <button class="btn btn-primary" onclick="applyBufferToThreshold()" id="applyBufferBtn" style="margin-top: 12px; width: 100%;">
                                    ì¬ê³  ì„ê³„ê°’ì— ì ìš©í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="saveBtn" onclick="saveDrugManagement()" disabled>ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Patient Registration Modal -->
    <div id="patientModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>ğŸ‘¤ ìƒˆ í™˜ì ë“±ë¡</h3>
                <span class="modal-close" onclick="closePatientModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>í™˜ìëª… *</label>
                    <input type="text" id="newPatientName" placeholder="í™˜ìëª…">
                </div>
                <div class="form-group">
                    <label>ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ì•ìë¦¬</label>
                    <input type="text" id="newPatientBirth" maxlength="6" placeholder="6ìë¦¬ (ì˜ˆ: 900101)">
                </div>
                <div class="form-group">
                    <label>ë°©ë¬¸ ì£¼ê¸° (ì¼)</label>
                    <input type="number" id="newPatientVisitCycle" placeholder="ì˜ˆ: 30" min="1">
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                        í™˜ìê°€ í‰ê· ì ìœ¼ë¡œ ëª‡ ì¼ë§ˆë‹¤ ë°©ë¬¸í•˜ëŠ”ì§€ ì…ë ¥í•˜ì„¸ìš”
                    </div>
                </div>
                <div class="form-group">
                    <label>í™˜ì ë©”ëª¨</label>
                    <textarea id="newPatientMemo" placeholder="í™˜ìì— ëŒ€í•œ ë©”ëª¨..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePatientModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveNewPatient()">ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmCloseModal" class="confirm-modal-overlay">
        <div class="confirm-modal-box">
            <div class="confirm-modal-icon">âš ï¸</div>
            <div class="confirm-modal-title">ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤</div>
            <div class="confirm-modal-message">ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì…ë ¥í•œ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
            <div class="confirm-modal-buttons">
                <button class="btn btn-secondary" onclick="cancelCloseConfirm()">ê³„ì† ì‘ì„±</button>
                <button class="btn btn-danger" onclick="confirmClose()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Dosage Input Modal -->
    <div id="dosageModal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3 id="dosageModalTitle">ğŸ’Š 1íšŒ ì²˜ë°©ëŸ‰ ì…ë ¥</h3>
                <span class="modal-close" onclick="closeDosageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; padding: 12px; background: #f7fafc; border-radius: 8px;">
                    <span id="dosagePatientName" style="font-weight: 600; color: #2d3748;"></span>
                    <span id="dosagePatientInfo" style="color: #718096; font-size: 13px;"></span>
                </div>
                <div class="form-group">
                    <label>1íšŒ ì²˜ë°©ëŸ‰ *</label>
                    <input type="number" id="inputDosage" placeholder="ì˜ˆ: 30" min="1" value="1">
                    <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                        ì´ í™˜ìì—ê²Œ í•œ ë²ˆ ë°©ë¬¸ ì‹œ ì²˜ë°©í•˜ëŠ” ì•½í’ˆ ìˆ˜ëŸ‰
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDosageModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmDosageModal()" id="dosageModalBtn">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <script>
        let managedDrugs = [];
        let selectedDrugCode = null;
        let selectedPatientIds = [];
        let selectedPatientData = [];  // {patientId, name, birth, visitCycle, dosage}
        let modalFlag = false;
        let isEditMode = false;
        let currentDrugFilter = 'all';  // í•„í„°: all, flagged, threshold
        let currentDrugSort = 'recent';  // ì •ë ¬: recent, name
        let searchTimeout = null;

        // Dosage modal state
        let pendingPatient = null;
        let isEditingDosage = false;  // true when editing existing patient's dosage

        // Buffer calculation state
        let lastCalculatedBuffer = null;

        // Original data for change tracking
        let originalData = {
            drugName: '',
            stock: '',
            stockThreshold: '',
            runwayThreshold: '',
            memo: '',
            patientIds: [],
            flag: false
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadManagedDrugs();
        });

        function loadStats() {
            fetch('/api/managed-drugs/stats')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const stats = data.data;
                        document.getElementById('statMemo').textContent = stats.memo_count;
                        document.getElementById('statThreshold').textContent = stats.threshold_count;
                        document.getElementById('statFlagged').textContent = stats.flagged_count;
                        document.getElementById('statPatient').textContent = stats.patient_count;
                    }
                });
        }

        function loadManagedDrugs() {
            fetch('/api/managed-drugs')
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        managedDrugs = data.data;
                        document.getElementById('statTotal').textContent = data.count;
                        filterDrugs();  // ì •ë ¬ ì ìš© í›„ ë Œë”ë§
                    }
                })
                .catch(error => {
                    showStatus('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
                });
        }

        function renderDrugs(drugs) {
            const listDiv = document.getElementById('drugList');

            if (drugs.length === 0) {
                listDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš™ï¸</div>
                        <div>ê´€ë¦¬ ì¤‘ì¸ ì•½í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        <div style="margin-top: 10px; font-size: 14px;">ê²€ìƒ‰í•˜ì—¬ ì•½í’ˆì„ ì¶”ê°€í•˜ê±°ë‚˜, "ìƒˆ ì•½í’ˆ ê´€ë¦¬ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = drugs.map(drug => {
                const starClass = drug.special_flag ? 'on' : 'off';
                const starIcon = drug.special_flag ? 'â˜…' : 'â˜†';

                let badges = '';
                if (drug.has_threshold) {
                    let thInfo = [];
                    if (drug.threshold.stock) thInfo.push(drug.threshold.stock + 'ê°œì´í•˜');
                    if (drug.threshold.runway) thInfo.push(drug.threshold.runway + 'ê°œì›”ë¯¸ë§Œ');
                    badges += `<span class="badge badge-threshold">âš™ï¸ ${thInfo.join(', ')}</span>`;
                }
                if (drug.has_memo) {
                    badges += `<span class="badge badge-memo">ğŸ“ ë©”ëª¨</span>`;
                }
                if (drug.patients && drug.patients.length > 0) {
                    const names = drug.patients.map(p => p['í™˜ìëª…']).join(', ');
                    badges += `<span class="badge badge-patient">ğŸ‘¤ ${names}</span>`;
                }

                return `
                    <div class="drug-card" data-code="${drug.drug_code}">
                        <div class="drug-card-header">
                            <div class="drug-card-title">
                                <span class="star-flag ${starClass}" onclick="toggleFlag('${drug.drug_code}')" title="íŠ¹ë³„ ê´€ë¦¬">${starIcon}</span>
                                <div style="min-width: 0; flex: 1;">
                                    <div class="drug-name" title="${drug.drug_name}">${drug.drug_name}</div>
                                    <div class="drug-code">${drug.drug_code}</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="openEditModal('${drug.drug_code}')" style="padding: 6px 12px; font-size: 13px;">ê´€ë¦¬</button>
                        </div>
                        <div class="drug-company">${drug.company}</div>
                        <div class="drug-stock">
                            <span class="drug-stock-label">í˜„ì¬ê³  :</span>
                            <span>${drug.current_stock.toLocaleString()}</span>
                        </div>
                        <div class="drug-badges">${badges || ''}</div>
                    </div>
                `;
            }).join('');
        }

        function setDrugFilter(filter) {
            currentDrugFilter = filter;

            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            filterDrugs();
        }

        function setDrugSort(sort) {
            currentDrugSort = sort;

            // Update button states
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sort === sort);
            });

            filterDrugs();
        }

        function filterDrugs() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            let filtered = [...managedDrugs];  // ë³µì‚¬ë³¸ ì‚¬ìš©

            // Apply filter
            if (currentDrugFilter === 'flagged') {
                filtered = filtered.filter(drug => drug.special_flag);
            } else if (currentDrugFilter === 'threshold') {
                filtered = filtered.filter(drug => drug.has_threshold);
            }

            // Apply search
            if (query) {
                filtered = filtered.filter(drug =>
                    drug.drug_name.toLowerCase().includes(query) ||
                    drug.drug_code.toLowerCase().includes(query) ||
                    (drug.company && drug.company.toLowerCase().includes(query))
                );
            }

            // Apply sort
            if (currentDrugSort === 'name') {
                filtered.sort((a, b) => a.drug_name.localeCompare(b.drug_name, 'ko'));
            } else if (currentDrugSort === 'recent') {
                filtered.sort((a, b) => new Date(b.updated_at || 0) - new Date(a.updated_at || 0));
            }

            renderDrugs(filtered);
        }

        function toggleFlag(drugCode) {
            fetch(`/api/drug/${drugCode}/toggle-flag`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        loadManagedDrugs();
                        loadStats();
                    }
                });
        }

        // Modal Functions
        function openAddModal() {
            isEditMode = false;
            selectedDrugCode = null;
            selectedPatientIds = [];
            selectedPatientData = [];
            modalFlag = false;
            lastCalculatedBuffer = null;

            // Reset original data
            originalData = {
                drugName: '',
                stock: '',
                stockThreshold: '',
                runwayThreshold: '',
                memo: '',
                patientIds: [],
                flag: false
            };

            document.getElementById('modalTitle').textContent = 'âš™ï¸ ìƒˆ ì•½í’ˆ ê´€ë¦¬ ì¶”ê°€';
            document.getElementById('drugSearchSection').style.display = 'block';
            document.getElementById('drugInfoSection').style.display = 'none';

            // Show hint, hide editable fields
            document.getElementById('unselectedHint').style.display = 'block';
            document.getElementById('editableFieldsSection').classList.remove('visible');

            // Clear inputs
            document.getElementById('modalDrugSearch').value = '';
            document.getElementById('modalDrugResults').innerHTML = '';
            document.getElementById('selectedDrug').classList.remove('visible');
            document.getElementById('inputDrugName').value = '';
            document.getElementById('inputStock').value = '';
            document.getElementById('inputStockThreshold').value = '';
            document.getElementById('inputRunwayThreshold').value = '';
            document.getElementById('inputMemo').value = '';
            document.getElementById('currentStock').textContent = 'í˜„ì¬ ì¬ê³ : -';
            document.getElementById('currentDrugName').textContent = 'í˜„ì¬ ì•½í’ˆëª…: -';
            document.getElementById('currentThreshold').textContent = 'í˜„ì¬ ì„¤ì •: ë””í´íŠ¸ ê¸°ì¤€ê°’ ì‚¬ìš©';
            document.getElementById('currentMemo').textContent = 'í˜„ì¬ ë©”ëª¨: ì—†ìŒ';
            updateFlagUI();
            renderPatientTagsWithDosage();

            // Reset buffer calculation
            document.getElementById('bufferResult').style.display = 'none';
            updateBufferCalcButton();

            // Hide min threshold warning
            document.getElementById('minThresholdWarning').style.display = 'none';

            // Disable save button
            document.getElementById('saveBtn').disabled = true;
            clearAllChangedMarkers();

            document.getElementById('drugModal').classList.add('visible');
        }

        function openEditModal(drugCode) {
            isEditMode = true;
            selectedDrugCode = drugCode;

            fetch(`/api/drug-management/${drugCode}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const d = data.data;

                        document.getElementById('modalTitle').textContent = 'âš™ï¸ ì•½í’ˆ ìƒì„¸ ê´€ë¦¬';
                        document.getElementById('drugSearchSection').style.display = 'none';
                        document.getElementById('drugInfoSection').style.display = 'block';

                        // Hide hint, show editable fields
                        document.getElementById('unselectedHint').style.display = 'none';
                        document.getElementById('editableFieldsSection').classList.add('visible');

                        document.getElementById('editDrugName').textContent = d.drug_name;
                        document.getElementById('editDrugCode').textContent = d.drug_code;
                        document.getElementById('editDrugCompany').textContent = d.company;

                        // Store original data for change tracking
                        const stockTh = d.threshold ? (d.threshold.stock !== null ? String(d.threshold.stock) : '') : '';
                        const runwayTh = d.threshold ? (d.threshold.runway !== null ? String(d.threshold.runway) : '') : '';

                        originalData = {
                            drugName: d.drug_name,
                            stock: String(d.current_stock),
                            stockThreshold: stockTh,
                            runwayThreshold: runwayTh,
                            memo: (d.memo || '').trim(),
                            patientIds: d.patients.map(p => p['í™˜ìID']).sort(),
                            flag: d.special_flag
                        };

                        // Display current values
                        document.getElementById('currentDrugName').innerHTML = `í˜„ì¬ ì•½í’ˆëª…: <strong>${d.drug_name}</strong>`;
                        document.getElementById('currentStock').innerHTML = `í˜„ì¬ ì¬ê³ : <strong>${d.current_stock}ê°œ</strong>`;

                        if (d.threshold && (d.threshold.stock !== null || d.threshold.runway !== null)) {
                            let thText = [];
                            if (d.threshold.stock !== null) thText.push(`ì¬ê³  ${d.threshold.stock}ê°œ ì´í•˜`);
                            if (d.threshold.runway !== null) thText.push(`ëŸ°ì›¨ì´ ${d.threshold.runway}ê°œì›” ë¯¸ë§Œ`);
                            document.getElementById('currentThreshold').innerHTML = `í˜„ì¬ ì„¤ì •: <strong>${thText.join(', ')}</strong>`;
                        } else {
                            document.getElementById('currentThreshold').textContent = 'í˜„ì¬ ì„¤ì •: ë””í´íŠ¸ ê¸°ì¤€ê°’ ì‚¬ìš©';
                        }

                        if (d.memo) {
                            const memoPreview = d.memo.length > 30 ? d.memo.substring(0, 30) + '...' : d.memo;
                            document.getElementById('currentMemo').innerHTML = `í˜„ì¬ ë©”ëª¨: <strong>${escapeHtml(memoPreview)}</strong>`;
                        } else {
                            document.getElementById('currentMemo').textContent = 'í˜„ì¬ ë©”ëª¨: ì—†ìŒ';
                        }

                        // Set form values (pre-fill for easy editing)
                        document.getElementById('inputDrugName').value = d.drug_name;
                        document.getElementById('inputStock').value = '';
                        document.getElementById('inputStockThreshold').value = stockTh;
                        document.getElementById('inputRunwayThreshold').value = runwayTh;
                        document.getElementById('inputMemo').value = d.memo || '';

                        modalFlag = d.special_flag;
                        updateFlagUI();

                        // Patients - load with dosage info
                        selectedPatientIds = d.patients.map(p => p['í™˜ìID']);
                        selectedPatientData = d.patients.map(p => ({
                            patientId: p['í™˜ìID'],
                            name: p['í™˜ìëª…'],
                            birth: p['ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬'] || '',
                            visitCycle: p['ë°©ë¬¸ì£¼ê¸°_ì¼'] || 30,
                            dosage: p['1íšŒ_ì²˜ë°©ëŸ‰'] || 1
                        }));
                        renderPatientTagsWithDosage();

                        // Reset buffer calculation
                        lastCalculatedBuffer = null;
                        document.getElementById('bufferResult').style.display = 'none';
                        updateBufferCalcButton();
                        checkMinThreshold();  // ìµœì†Œ ì„ê³„ê°’ ì²´í¬

                        // Disable save button initially
                        document.getElementById('saveBtn').disabled = true;
                        clearAllChangedMarkers();

                        document.getElementById('drugModal').classList.add('visible');
                    }
                });
        }

        function closeModal() {
            document.getElementById('drugModal').classList.remove('visible');
        }

        function searchDrugsForModal() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('modalDrugSearch').value.trim();
            const resultsDiv = document.getElementById('modalDrugResults');

            if (query.length < 2) {
                resultsDiv.classList.remove('visible');
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/api/search-inventory?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'success' && data.results.length > 0) {
                            resultsDiv.innerHTML = data.results.slice(0, 10).map(item => `
                                <div class="drug-result-item" onclick="selectDrugForModal('${item['ì•½í’ˆì½”ë“œ']}', '${escapeHtml(item['ì•½í’ˆëª…'])}', '${escapeHtml(item['ì œì•½íšŒì‚¬'])}', ${item['í˜„ì¬_ì¬ê³ ìˆ˜ëŸ‰']})">
                                    <div style="font-weight: 500;">${item['ì•½í’ˆëª…']}</div>
                                    <div style="font-size: 13px; color: #718096;">${item['ì•½í’ˆì½”ë“œ']} | ${item['ì œì•½íšŒì‚¬']} | ì¬ê³ : ${item['í˜„ì¬_ì¬ê³ ìˆ˜ëŸ‰']}</div>
                                </div>
                            `).join('');
                            resultsDiv.classList.add('visible');
                        } else {
                            resultsDiv.innerHTML = '<div style="padding: 12px; color: #a0aec0;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                            resultsDiv.classList.add('visible');
                        }
                    });
            }, 300);
        }

        function selectDrugForModal(code, name, company, stock) {
            selectedDrugCode = code;
            document.getElementById('selectedDrugName').textContent = name;
            document.getElementById('selectedDrugCode').textContent = code + ' | ' + company;
            document.getElementById('selectedDrug').classList.add('visible');
            document.getElementById('modalDrugResults').classList.remove('visible');
            document.getElementById('modalDrugSearch').value = '';

            // Hide hint, show editable fields
            document.getElementById('unselectedHint').style.display = 'none';
            document.getElementById('editableFieldsSection').classList.add('visible');

            // Display current values
            document.getElementById('currentDrugName').innerHTML = `í˜„ì¬ ì•½í’ˆëª…: <strong>${escapeHtml(name)}</strong>`;
            document.getElementById('currentStock').innerHTML = `í˜„ì¬ ì¬ê³ : <strong>${stock}ê°œ</strong>`;

            // Load existing data if any
            fetch(`/api/drug-management/${code}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const d = data.data;
                        const stockTh = d.threshold ? (d.threshold.stock !== null ? String(d.threshold.stock) : '') : '';
                        const runwayTh = d.threshold ? (d.threshold.runway !== null ? String(d.threshold.runway) : '') : '';

                        // Store original data
                        originalData = {
                            drugName: name,
                            stock: String(stock),
                            stockThreshold: stockTh,
                            runwayThreshold: runwayTh,
                            memo: (d.memo || '').trim(),
                            patientIds: d.patients.map(p => p['í™˜ìID']).sort(),
                            flag: d.special_flag
                        };

                        // Display current threshold
                        if (d.threshold && (d.threshold.stock !== null || d.threshold.runway !== null)) {
                            let thText = [];
                            if (d.threshold.stock !== null) thText.push(`ì¬ê³  ${d.threshold.stock}ê°œ ì´í•˜`);
                            if (d.threshold.runway !== null) thText.push(`ëŸ°ì›¨ì´ ${d.threshold.runway}ê°œì›” ë¯¸ë§Œ`);
                            document.getElementById('currentThreshold').innerHTML = `í˜„ì¬ ì„¤ì •: <strong>${thText.join(', ')}</strong>`;
                        } else {
                            document.getElementById('currentThreshold').textContent = 'í˜„ì¬ ì„¤ì •: ë””í´íŠ¸ ê¸°ì¤€ê°’ ì‚¬ìš©';
                        }

                        // Display current memo
                        if (d.memo) {
                            const memoPreview = d.memo.length > 30 ? d.memo.substring(0, 30) + '...' : d.memo;
                            document.getElementById('currentMemo').innerHTML = `í˜„ì¬ ë©”ëª¨: <strong>${escapeHtml(memoPreview)}</strong>`;
                        } else {
                            document.getElementById('currentMemo').textContent = 'í˜„ì¬ ë©”ëª¨: ì—†ìŒ';
                        }

                        // Set form values (pre-fill for easy editing)
                        document.getElementById('inputDrugName').value = name;
                        document.getElementById('inputStock').value = '';
                        document.getElementById('inputStockThreshold').value = stockTh;
                        document.getElementById('inputRunwayThreshold').value = runwayTh;
                        document.getElementById('inputMemo').value = d.memo || '';

                        modalFlag = d.special_flag;
                        updateFlagUI();
                        selectedPatientIds = d.patients.map(p => p['í™˜ìID']);
                        renderPatientTags(d.patients);

                        // Disable save button initially
                        document.getElementById('saveBtn').disabled = true;
                        clearAllChangedMarkers();
                    }
                });
        }

        function clearDrugSelection() {
            selectedDrugCode = null;
            document.getElementById('selectedDrug').classList.remove('visible');

            // Show hint, hide editable fields
            document.getElementById('unselectedHint').style.display = 'block';
            document.getElementById('editableFieldsSection').classList.remove('visible');

            // Clear inputs
            document.getElementById('inputDrugName').value = '';
            document.getElementById('inputStock').value = '';
            document.getElementById('inputStockThreshold').value = '';
            document.getElementById('inputRunwayThreshold').value = '';
            document.getElementById('inputMemo').value = '';
            document.getElementById('currentStock').textContent = 'í˜„ì¬ ì¬ê³ : -';
            document.getElementById('currentDrugName').textContent = 'í˜„ì¬ ì•½í’ˆëª…: -';
            document.getElementById('currentThreshold').textContent = 'í˜„ì¬ ì„¤ì •: ë””í´íŠ¸ ê¸°ì¤€ê°’ ì‚¬ìš©';
            document.getElementById('currentMemo').textContent = 'í˜„ì¬ ë©”ëª¨: ì—†ìŒ';
            modalFlag = false;
            updateFlagUI();
            selectedPatientIds = [];
            renderPatientTags();

            // Reset original data and disable save
            originalData = {
                drugName: '',
                stock: '',
                stockThreshold: '',
                runwayThreshold: '',
                memo: '',
                patientIds: [],
                flag: false
            };
            document.getElementById('saveBtn').disabled = true;
            clearAllChangedMarkers();
        }

        function toggleModalFlag() {
            modalFlag = !modalFlag;
            updateFlagUI();
            checkChanges();
        }

        function updateFlagUI() {
            const editStar = document.getElementById('editStarFlag');
            const addStar = document.getElementById('addStarFlag');

            if (modalFlag) {
                if (editStar) {
                    editStar.textContent = 'â˜…';
                    editStar.classList.remove('off');
                    editStar.classList.add('on');
                }
                if (addStar) {
                    addStar.textContent = 'â˜…';
                    addStar.classList.remove('off');
                    addStar.classList.add('on');
                }
            } else {
                if (editStar) {
                    editStar.textContent = 'â˜†';
                    editStar.classList.remove('on');
                    editStar.classList.add('off');
                }
                if (addStar) {
                    addStar.textContent = 'â˜†';
                    addStar.classList.remove('on');
                    addStar.classList.add('off');
                }
            }
        }

        // Patient functions
        function renderPatientTags(patients) {
            const container = document.getElementById('patientTags');
            if (!patients || patients.length === 0) {
                container.innerHTML = '<span style="color: #a0aec0; font-size: 13px;">ì—°ê²°ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</span>';
                return;
            }

            container.innerHTML = patients.map(p => `
                <span class="patient-tag">
                    ${p['í™˜ìëª…']}${p['ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬'] ? ' (' + p['ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬'] + ')' : ''}
                    <span class="remove-btn" onclick="removePatient(${p['í™˜ìID']})">&times;</span>
                </span>
            `).join('');
        }

        function removePatient(patientId) {
            selectedPatientIds = selectedPatientIds.filter(id => id !== patientId);
            // Re-render (need to fetch patient info again)
            const tags = document.querySelectorAll('.patient-tag');
            tags.forEach(tag => {
                if (tag.querySelector('.remove-btn').getAttribute('onclick').includes(patientId)) {
                    tag.remove();
                }
            });
            if (selectedPatientIds.length === 0) {
                document.getElementById('patientTags').innerHTML = '<span style="color: #a0aec0; font-size: 13px;">ì—°ê²°ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</span>';
            }
            checkChanges();
        }

        function searchPatients() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('patientSearchInput').value.trim();
            const resultsDiv = document.getElementById('patientSearchResults');

            if (!query) {
                resultsDiv.classList.remove('visible');
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/api/search-patients?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        let html = '';
                        if (data.status === 'success' && data.data.length > 0) {
                            const filtered = data.data.filter(p => !selectedPatientIds.includes(p['í™˜ìID']));
                            if (filtered.length > 0) {
                                html = filtered.map(p => `
                                    <div class="patient-result-item" onclick="openDosageModal(${p['í™˜ìID']}, '${escapeHtml(p['í™˜ìëª…'])}', '${p['ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬'] || ''}', ${p['ë°©ë¬¸ì£¼ê¸°_ì¼'] || 30})">
                                        ${p['í™˜ìëª…']}${p['ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬'] ? ' (' + p['ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬'] + ')' : ''}
                                        ${p['ë°©ë¬¸ì£¼ê¸°_ì¼'] ? '<span style="color: #718096; font-size: 12px; margin-left: 8px;">' + p['ë°©ë¬¸ì£¼ê¸°_ì¼'] + 'ì¼ ì£¼ê¸°</span>' : ''}
                                    </div>
                                `).join('');
                            } else {
                                html = '<div style="padding: 12px; color: #a0aec0;">ì´ë¯¸ ëª¨ë‘ ì¶”ê°€ë¨</div>';
                            }
                        }

                        // ìƒˆ í™˜ì ë“±ë¡ ì˜µì…˜ ì¶”ê°€ (ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œ)
                        if (query.length > 0) {
                            html += `
                                <div class="patient-result-item new-patient-option" onclick="openPatientModal('${escapeHtml(query)}')" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #16a34a; font-weight: 500;">
                                    + "${escapeHtml(query)}" ìƒˆë¡œ ë“±ë¡
                                </div>
                            `;
                        }

                        resultsDiv.innerHTML = html;
                        resultsDiv.classList.add('visible');
                    });
            }, 300);
        }

        function addPatient(patientId, name, birth) {
            if (!selectedPatientIds.includes(patientId)) {
                selectedPatientIds.push(patientId);

                const container = document.getElementById('patientTags');
                if (container.querySelector('span[style]')) {
                    container.innerHTML = '';
                }
                container.innerHTML += `
                    <span class="patient-tag">
                        ${name}${birth ? ' (' + birth + ')' : ''}
                        <span class="remove-btn" onclick="removePatient(${patientId})">&times;</span>
                    </span>
                `;
            }

            document.getElementById('patientSearchInput').value = '';
            document.getElementById('patientSearchResults').classList.remove('visible');
            checkChanges();
        }

        // Patient Modal
        function openPatientModal(preFillName = '') {
            document.getElementById('newPatientName').value = preFillName;
            document.getElementById('newPatientBirth').value = '';
            document.getElementById('newPatientVisitCycle').value = '';
            document.getElementById('newPatientMemo').value = '';
            document.getElementById('patientModal').classList.add('visible');
            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('patientSearchResults').classList.remove('visible');
        }

        function closePatientModal() {
            document.getElementById('patientModal').classList.remove('visible');
        }

        // Dosage Modal Functions
        function openDosageModal(patientId, name, birth, visitCycle, currentDosage = 1, editMode = false) {
            pendingPatient = { patientId, name, birth, visitCycle: visitCycle || 30 };
            isEditingDosage = editMode;

            document.getElementById('dosagePatientName').textContent = name;
            document.getElementById('dosagePatientInfo').textContent = birth ? ` (${birth})` : '';
            document.getElementById('inputDosage').value = currentDosage;

            // Update modal title and button based on mode
            if (editMode) {
                document.getElementById('dosageModalTitle').textContent = 'âœï¸ ì²˜ë°©ëŸ‰ ìˆ˜ì •';
                document.getElementById('dosageModalBtn').textContent = 'ìˆ˜ì •';
            } else {
                document.getElementById('dosageModalTitle').textContent = 'ğŸ’Š 1íšŒ ì²˜ë°©ëŸ‰ ì…ë ¥';
                document.getElementById('dosageModalBtn').textContent = 'ì¶”ê°€';
            }

            document.getElementById('dosageModal').classList.add('visible');
        }

        function openEditDosageModal(patientId) {
            const patient = selectedPatientData.find(p => p.patientId === patientId);
            if (!patient) return;

            openDosageModal(
                patient.patientId,
                patient.name,
                patient.birth,
                patient.visitCycle,
                patient.dosage,
                true  // editMode = true
            );
        }

        function closeDosageModal() {
            document.getElementById('dosageModal').classList.remove('visible');
            pendingPatient = null;
            isEditingDosage = false;
        }

        function confirmDosageModal() {
            if (!pendingPatient) return;

            const dosage = parseInt(document.getElementById('inputDosage').value) || 1;

            if (isEditingDosage) {
                // Update existing patient's dosage
                const patient = selectedPatientData.find(p => p.patientId === pendingPatient.patientId);
                if (patient) {
                    patient.dosage = dosage;
                    renderPatientTagsWithDosage();
                    checkMinThreshold();  // ìµœì†Œ ì„ê³„ê°’ ì²´í¬
                    // Hide buffer result when dosage changes
                    document.getElementById('bufferResult').style.display = 'none';
                    lastCalculatedBuffer = null;
                    checkChanges();
                }
            } else {
                // Add new patient
                addPatientWithDosage(
                    pendingPatient.patientId,
                    pendingPatient.name,
                    pendingPatient.birth,
                    pendingPatient.visitCycle,
                    dosage
                );
            }

            closeDosageModal();
        }

        // Keep old function name for backward compatibility
        function confirmAddPatientWithDosage() {
            confirmDosageModal();
        }

        function addPatientWithDosage(patientId, name, birth, visitCycle, dosage) {
            if (selectedPatientIds.includes(patientId)) return;

            selectedPatientIds.push(patientId);
            selectedPatientData.push({
                patientId, name, birth,
                visitCycle: visitCycle || 30,
                dosage: dosage || 1
            });

            renderPatientTagsWithDosage();
            updateBufferCalcButton();
            checkMinThreshold();  // ìµœì†Œ ì„ê³„ê°’ ì²´í¬
            checkChanges();
        }

        function renderPatientTagsWithDosage() {
            const container = document.getElementById('patientTags');
            if (selectedPatientData.length === 0) {
                container.innerHTML = '<span style="color: #a0aec0; font-size: 13px;">ì—°ê²°ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</span>';
                return;
            }

            container.innerHTML = selectedPatientData.map(p => `
                <span class="patient-tag">
                    <span class="tag-content" onclick="openEditDosageModal(${p.patientId})" title="í´ë¦­í•˜ì—¬ ì²˜ë°©ëŸ‰ ìˆ˜ì •">
                        ${escapeHtml(p.name)}${p.birth ? ' (' + p.birth + ')' : ''}
                        <span class="patient-dosage-badge">${p.dosage}ê°œ/íšŒ</span>
                    </span>
                    <span class="remove-btn" onclick="removePatientWithData(${p.patientId})">&times;</span>
                </span>
            `).join('');
        }

        function removePatientWithData(patientId) {
            selectedPatientIds = selectedPatientIds.filter(id => id !== patientId);
            selectedPatientData = selectedPatientData.filter(p => p.patientId !== patientId);
            renderPatientTagsWithDosage();
            updateBufferCalcButton();
            checkMinThreshold();  // ìµœì†Œ ì„ê³„ê°’ ì²´í¬
            // Hide buffer result when patients change
            document.getElementById('bufferResult').style.display = 'none';
            lastCalculatedBuffer = null;
            checkChanges();
        }

        function updateBufferCalcButton() {
            const hasPatients = selectedPatientData.length > 0;
            document.getElementById('calcBufferBtn').disabled = !hasPatients;
            if (!hasPatients) {
                document.getElementById('bufferResult').style.display = 'none';
            }
        }

        // ìµœì†Œ ì¬ê³  ì„ê³„ê°’ ì²´í¬ ë° ìë™ ì„¤ì •
        function checkMinThreshold() {
            const warningDiv = document.getElementById('minThresholdWarning');
            const warningText = warningDiv.querySelector('.warning-text');
            const thresholdInput = document.getElementById('inputStockThreshold');

            // í™˜ìê°€ ì—†ìœ¼ë©´ ê²½ê³  ìˆ¨ê¸°ê¸°
            if (selectedPatientData.length === 0) {
                warningDiv.style.display = 'none';
                return;
            }

            // max(ì²˜ë°©ëŸ‰) ê³„ì‚°
            const maxDosage = Math.max(...selectedPatientData.map(p => p.dosage || 1));
            const maxPatient = selectedPatientData.find(p => p.dosage === maxDosage);
            const patientInfo = maxPatient ? `${maxPatient.name}` : '';

            const currentThreshold = thresholdInput.value ? parseInt(thresholdInput.value) : null;

            // Case 1: ì„ê³„ê°’ì´ ë¹„ì–´ìˆìŒ â†’ ìë™ ì±„ì›€
            if (currentThreshold === null || currentThreshold === 0) {
                thresholdInput.value = maxDosage;
                warningDiv.style.display = 'flex';
                warningText.innerHTML = `í™˜ì 1íšŒ ìµœëŒ€ ì²˜ë°©ëŸ‰(${patientInfo}: ${maxDosage}ê°œ)ì„ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³  ì„ê³„ê°’ì´ ìë™ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                checkChanges();
                return;
            }

            // Case 2: ì„ê³„ê°’ì´ max(ì²˜ë°©ëŸ‰)ë³´ë‹¤ ë‚®ìŒ â†’ ê²½ê³ 
            if (currentThreshold < maxDosage) {
                warningDiv.style.display = 'flex';
                warningText.innerHTML = `í˜„ì¬ ì„ê³„ê°’(${currentThreshold}ê°œ)ì´ ìµœëŒ€ ì²˜ë°©ëŸ‰(${patientInfo}: ${maxDosage}ê°œ)ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤. <span class="auto-fill-link" onclick="applyMinDosageThreshold(${maxDosage})">${maxDosage}ê°œë¡œ ì„¤ì •</span>`;
                return;
            }

            // Case 3: ì •ìƒ â†’ ê²½ê³  ìˆ¨ê¸°ê¸°
            warningDiv.style.display = 'none';
        }

        // ìµœì†Œ ì²˜ë°©ëŸ‰ ì„ê³„ê°’ ì ìš©
        function applyMinDosageThreshold(value) {
            document.getElementById('inputStockThreshold').value = value;
            checkMinThreshold();
            checkChanges();
        }

        // Buffer Calculation Functions
        let selectedRiskLevel = 'safe';  // Default value

        function selectRiskLevel(level) {
            selectedRiskLevel = level;

            // Update UI
            document.querySelectorAll('.risk-chip').forEach(chip => {
                chip.classList.remove('selected');
                if (chip.dataset.value === level) {
                    chip.classList.add('selected');
                }
            });

            // Update description
            const descriptions = {
                'relaxed': 'í”í•œ ë™ì‹œ ë°©ë¬¸ë§Œ ëŒ€ë¹„',
                'normal': 'ì¼ë°˜ì ì¸ ë™ì‹œ ë°©ë¬¸ ëŒ€ë¹„',
                'safe': 'ë“œë¬¸ ë™ì‹œ ë°©ë¬¸ê¹Œì§€ ëŒ€ë¹„',
                'very_safe': 'ë§¤ìš° ë“œë¬¸ ë™ì‹œ ë°©ë¬¸ê¹Œì§€ ëŒ€ë¹„'
            };
            document.getElementById('riskLevelDescription').textContent = descriptions[level] || '';
        }

        function calculateBuffer() {
            if (!selectedDrugCode || selectedPatientData.length === 0) return;

            const riskLevel = selectedRiskLevel;
            const calcBtn = document.getElementById('calcBufferBtn');
            calcBtn.disabled = true;
            calcBtn.textContent = 'ê³„ì‚° ì¤‘...';

            // Send current UI patient data (may not be saved yet)
            const patientsForCalc = selectedPatientData.map(p => ({
                patient_id: p.patientId,
                visit_cycle: p.visitCycle,
                dosage: p.dosage
            }));

            fetch(`/api/drug/${selectedDrugCode}/calculate-buffer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ risk_level: riskLevel, patients: patientsForCalc })
            })
            .then(r => r.json())
            .then(data => {
                calcBtn.disabled = false;
                calcBtn.textContent = 'ê³„ì‚°í•˜ê¸°';

                if (data.status === 'success') {
                    displayBufferResult(data.data);
                } else {
                    alert(data.message || 'ê³„ì‚° ì‹¤íŒ¨');
                }
            })
            .catch(error => {
                calcBtn.disabled = false;
                calcBtn.textContent = 'ê³„ì‚°í•˜ê¸°';
                alert('ê³„ì‚° ì˜¤ë¥˜: ' + error.message);
            });
        }

        function displayBufferResult(result) {
            lastCalculatedBuffer = result.min_buffer;

            document.getElementById('bufferValue').textContent = result.min_buffer;
            document.getElementById('bufferExplanation').textContent = result.explanation;

            // Show patient details
            if (result.all_patients && result.all_patients.length > 0) {
                let detailsHtml = '<div style="font-weight: 600; margin-bottom: 8px;">í™˜ìë³„ ì •ë³´:</div>';
                result.all_patients.forEach(p => {
                    const includedClass = p['ë²„í¼í¬í•¨'] ? 'buffer-patient-included' : '';
                    const includedIcon = p['ë²„í¼í¬í•¨'] ? 'âœ“ ' : '';
                    detailsHtml += `
                        <div class="buffer-patient-item ${includedClass}">
                            <span>${includedIcon}${p['í™˜ìëª…']} (${p['ë°©ë¬¸ì£¼ê¸°_ì¼']}ì¼ ì£¼ê¸°)</span>
                            <span>${p['1íšŒ_ì²˜ë°©ëŸ‰']}ê°œ/íšŒ</span>
                        </div>
                    `;
                });
                document.getElementById('bufferDetails').innerHTML = detailsHtml;
            } else {
                document.getElementById('bufferDetails').innerHTML = '';
            }

            document.getElementById('bufferResult').style.display = 'block';
        }

        function applyBufferToThreshold() {
            if (lastCalculatedBuffer === null) return;

            document.getElementById('inputStockThreshold').value = lastCalculatedBuffer;
            checkChanges();

            // Visual feedback
            const thresholdSection = document.getElementById('sectionThreshold');
            thresholdSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            thresholdSection.style.animation = 'highlight 1s ease';
            setTimeout(() => {
                thresholdSection.style.animation = '';
            }, 1000);
        }

        function saveNewPatient() {
            const name = document.getElementById('newPatientName').value.trim();
            const birth = document.getElementById('newPatientBirth').value.trim();
            const visitCycle = document.getElementById('newPatientVisitCycle').value;
            const memo = document.getElementById('newPatientMemo').value.trim();

            if (!name) {
                alert('í™˜ìëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            fetch('/api/patient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, birth, memo, visit_cycle: visitCycle })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    closePatientModal();
                    // Open dosage modal for the newly created patient
                    openDosageModal(data.patient_id, name, birth, parseInt(visitCycle) || 30);
                    loadStats();
                } else {
                    alert(data.message);
                }
            });
        }

        // Save Drug Management
        function saveDrugManagement() {
            if (!selectedDrugCode) {
                showStatus('ì•½í’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const payload = {};

            const drugName = document.getElementById('inputDrugName').value.trim();
            if (drugName) payload.drug_name = drugName;

            const stock = document.getElementById('inputStock').value;
            if (stock !== '') payload.stock = parseFloat(stock);

            const stockTh = document.getElementById('inputStockThreshold').value;
            const runwayTh = document.getElementById('inputRunwayThreshold').value;
            payload.threshold = {
                stock: stockTh !== '' ? parseInt(stockTh) : null,
                runway: runwayTh !== '' ? parseFloat(runwayTh) : null
            };

            payload.memo = document.getElementById('inputMemo').value.trim();
            payload.special_flag = modalFlag;
            // Send patients with dosage info
            payload.patients = selectedPatientData.map(p => ({
                patient_id: p.patientId,
                dosage: p.dosage
            }));
            // Keep patient_ids for backward compatibility
            payload.patient_ids = selectedPatientIds;

            fetch(`/api/drug-management/${selectedDrugCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success' || data.status === 'partial') {
                    closeModal();
                    loadManagedDrugs();
                    loadStats();
                    showStatus('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('ì €ì¥ ì‹¤íŒ¨: ' + error.message, 'error');
            });
        }

        // Change Tracking Functions
        function checkChanges() {
            if (!selectedDrugCode) {
                document.getElementById('saveBtn').disabled = true;
                return;
            }

            const currentDrugName = document.getElementById('inputDrugName').value.trim();
            const currentStock = document.getElementById('inputStock').value;
            const currentStockTh = document.getElementById('inputStockThreshold').value;
            const currentRunwayTh = document.getElementById('inputRunwayThreshold').value;
            const currentMemo = document.getElementById('inputMemo').value.trim();
            const currentPatientIds = [...selectedPatientIds].sort();

            // Check each section for changes
            const changes = {
                drugName: currentDrugName !== originalData.drugName,
                stock: currentStock !== '' && currentStock !== originalData.stock,
                threshold: currentStockTh !== originalData.stockThreshold ||
                           currentRunwayTh !== originalData.runwayThreshold,
                memo: currentMemo !== originalData.memo,
                patients: JSON.stringify(currentPatientIds) !== JSON.stringify(originalData.patientIds),
                flag: modalFlag !== originalData.flag
            };

            // Update section styling
            updateSectionStyle('sectionDrugName', changes.drugName);
            updateSectionStyle('sectionStock', changes.stock);
            updateSectionStyle('sectionThreshold', changes.threshold);
            updateSectionStyle('sectionMemo', changes.memo);
            updateSectionStyle('sectionPatients', changes.patients);

            // Enable/disable save button
            const hasChanges = Object.values(changes).some(v => v);
            document.getElementById('saveBtn').disabled = !hasChanges;
        }

        function updateSectionStyle(sectionId, hasChanges) {
            const section = document.getElementById(sectionId);
            if (section) {
                if (hasChanges) {
                    section.classList.add('changed');
                } else {
                    section.classList.remove('changed');
                }
            }
        }

        function clearAllChangedMarkers() {
            const sections = ['sectionDrugName', 'sectionStock', 'sectionThreshold', 'sectionMemo', 'sectionPatients'];
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) section.classList.remove('changed');
            });
        }

        // Utility
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message ' + type;
            setTimeout(() => {
                statusDiv.className = 'status-message';
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        function shutdownServer() {
            if (!confirm('ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            fetch('/api/shutdown', { method: 'POST' })
                .then(() => {
                    document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5em; color: #2c3e50;">âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½ì„ ë‹«ì•„ì£¼ì„¸ìš”.</div>';
                })
                .catch(() => {
                    document.body.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5em; color: #2c3e50;">âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½ì„ ë‹«ì•„ì£¼ì„¸ìš”.</div>';
                });
        }

        // Modal content check functions
        function hasDrugModalContent() {
            // ì•½í’ˆì´ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!selectedDrugCode) return false;

            // ìƒˆë¡œ ì¶”ê°€ ëª¨ë“œì—ì„œë§Œ ì²´í¬ (ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” í•­ìƒ ë‚´ìš©ì´ ìˆìŒ)
            if (isEditMode) return true;

            // í¼ì— ì…ë ¥ëœ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸
            const hasMemo = document.getElementById('inputMemo').value.trim() !== '';
            const hasStock = document.getElementById('inputStock').value !== '';
            const hasStockTh = document.getElementById('inputStockThreshold').value !== '';
            const hasRunwayTh = document.getElementById('inputRunwayThreshold').value !== '';
            const hasPatients = selectedPatientIds.length > 0;

            return hasMemo || hasStock || hasStockTh || hasRunwayTh || hasPatients;
        }

        function hasPatientModalContent() {
            const name = document.getElementById('newPatientName').value.trim();
            const birth = document.getElementById('newPatientBirth').value.trim();
            const visitCycle = document.getElementById('newPatientVisitCycle').value;
            const memo = document.getElementById('newPatientMemo').value.trim();

            return name !== '' || birth !== '' || visitCycle !== '' || memo !== '';
        }

        function hasDosageModalContent() {
            const dosage = document.getElementById('inputDosage').value;
            return dosage !== '' && dosage !== '1';  // ê¸°ë³¸ê°’ 1ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë‚´ìš© ìˆìŒìœ¼ë¡œ íŒë‹¨
        }

        // Shake modal animation
        function shakeModal(modalId) {
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('.modal-content');
            content.classList.add('shake');
            setTimeout(() => {
                content.classList.remove('shake');
            }, 400);
        }

        // Custom confirm modal state
        let pendingCloseAction = null;

        function showCloseConfirm(closeCallback) {
            pendingCloseAction = closeCallback;
            document.getElementById('confirmCloseModal').classList.add('visible');
        }

        function cancelCloseConfirm() {
            document.getElementById('confirmCloseModal').classList.remove('visible');
            pendingCloseAction = null;
        }

        function confirmClose() {
            document.getElementById('confirmCloseModal').classList.remove('visible');
            if (pendingCloseAction) {
                pendingCloseAction();
                pendingCloseAction = null;
            }
        }

        // Try close modal with confirmation
        function tryCloseDrugModal() {
            if (hasDrugModalContent()) {
                shakeModal('drugModal');
                showCloseConfirm(closeModal);
            } else {
                closeModal();
            }
        }

        function tryClosePatientModal() {
            if (hasPatientModalContent()) {
                shakeModal('patientModal');
                showCloseConfirm(closePatientModal);
            } else {
                closePatientModal();
            }
        }

        function tryCloseDosageModal() {
            if (hasDosageModalContent()) {
                shakeModal('dosageModal');
                showCloseConfirm(closeDosageModal);
            } else {
                closeDosageModal();
            }
        }

        // Close modal on outside click
        document.getElementById('drugModal').addEventListener('click', function(e) {
            if (e.target === this) tryCloseDrugModal();
        });

        document.getElementById('patientModal').addEventListener('click', function(e) {
            if (e.target === this) tryClosePatientModal();
        });

        document.getElementById('dosageModal').addEventListener('click', function(e) {
            if (e.target === this) tryCloseDosageModal();
        });

        // ESC to close modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // í™•ì¸ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ì·¨ì†Œ
                const confirmModal = document.getElementById('confirmCloseModal');
                if (confirmModal.classList.contains('visible')) {
                    cancelCloseConfirm();
                    return;
                }

                const drugModal = document.getElementById('drugModal');
                const patientModal = document.getElementById('patientModal');
                const dosageModal = document.getElementById('dosageModal');

                if (dosageModal.classList.contains('visible')) {
                    tryCloseDosageModal();
                } else if (patientModal.classList.contains('visible')) {
                    tryClosePatientModal();
                } else if (drugModal.classList.contains('visible')) {
                    tryCloseDrugModal();
                }
            }
        });
    </script>
</body>
</html>
