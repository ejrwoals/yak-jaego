{% extends "base.html" %}

{% block title %}약국 적정 재고 솔루션{% endblock %}

{% block body_class %}{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.get('VERSION', '1') }}">
{% endblock %}

{% block page_styles %}
<style>
    body {
        font-family: var(--font-family);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: var(--space-5);
        overflow-y: scroll;
        padding: var(--space-5);
    }

    .title-container {
        background: var(--brand-primary);
        border-radius: var(--radius-2xl);
        padding: var(--space-6) var(--space-10);
        max-width: 800px;
        width: 100%;
        text-align: center;
        box-shadow: var(--shadow-lg);
    }

    .page-title {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        color: white;
        letter-spacing: -0.5px;
        margin: 0;
    }

    .container {
        max-width: 800px;
        animation: fadeIn 0.5s ease-in;
    }

    .header {
        text-align: center;
        margin-bottom: var(--space-6);
    }

    .header-toolbar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        flex-wrap: wrap;
    }

    .toolbar-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-full);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        text-decoration: none;
        transition: all var(--transition-fast);
        cursor: pointer;
        border: none;
        background: none;
    }

    .toolbar-item .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .toolbar-item.db-status {
        background: var(--color-success-light);
        color: var(--color-success-dark);
        border: 1px solid var(--color-success);
    }

    .toolbar-item.db-status:hover {
        background: var(--color-success);
        color: white;
    }

    .toolbar-item.util-link {
        background: var(--color-surface-hover);
        color: var(--color-text-secondary);
        border: 1px solid var(--color-border);
    }

    .toolbar-item.util-link:hover {
        background: var(--color-surface-active);
        color: var(--color-text-primary);
        border-color: var(--color-border-hover);
    }

    .tabs-container {
        margin-bottom: var(--space-6);
    }

    .tabs {
        display: flex;
        gap: var(--space-3);
        justify-content: center;
        margin-bottom: var(--space-6);
    }

    .tab-button {
        background: var(--color-surface);
        border: 2px solid var(--color-border);
        color: var(--color-text-muted);
        padding: var(--space-4) var(--space-8);
        border-radius: var(--radius-xl);
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-normal);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        box-shadow: var(--shadow-xs);
    }

    .tab-button .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    .tab-button:hover {
        border-color: var(--color-border-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
        color: var(--color-text-secondary);
    }

    .tab-button.active {
        background: var(--brand-primary);
        color: white;
        border-color: transparent;
        box-shadow: var(--shadow-md);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.4s ease-in;
    }

    .workflow-content {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-border);
    }

    .workflow-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-6);
    }

    .workflow-section {
        border-radius: var(--radius-lg);
        padding: var(--space-5);
    }

    .workflow-section h3 {
        font-size: var(--text-lg);
        margin-bottom: var(--space-5);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-weight: var(--font-semibold);
    }

    .workflow-section h3 .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    .section-new {
        background: var(--brand-primary-subtle);
        border: 1px solid rgba(13, 148, 136, 0.2);
    }

    .section-new h3 {
        color: var(--brand-primary-dark);
    }

    .section-new h3 .icon {
        color: var(--brand-primary);
    }

    .section-history {
        background: var(--color-surface-hover);
        border: 1px solid var(--color-border);
    }

    .section-history h3 .icon {
        color: var(--color-text-muted);
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .btn-new {
        background: var(--brand-primary);
        color: white;
        border: none;
        padding: var(--space-4) var(--space-5);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-normal);
        box-shadow: var(--shadow-sm);
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
    }

    .btn-new .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .btn-new:hover {
        background: var(--brand-primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    .report-list {
        max-height: 180px;
        overflow-y: auto;
        padding-right: var(--space-1);
    }

    .report-list::-webkit-scrollbar {
        width: 6px;
    }

    .report-list::-webkit-scrollbar-track {
        background: var(--color-surface-hover);
        border-radius: var(--radius-full);
    }

    .report-list::-webkit-scrollbar-thumb {
        background: var(--color-border-hover);
        border-radius: var(--radius-full);
    }

    .report-item {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-3) var(--space-4);
        margin-bottom: var(--space-2);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-3);
    }

    .report-item:hover {
        border-color: var(--color-border-hover);
        box-shadow: var(--shadow-xs);
    }

    .report-item-link {
        flex: 1;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        transition: transform var(--transition-fast);
    }

    .report-item-link:hover {
        transform: translateX(4px);
    }

    .btn-delete-report {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        padding: var(--space-2);
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .btn-delete-report:hover {
        background-color: var(--color-danger-light);
        color: var(--color-danger);
    }

    .btn-delete-report .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .btn-delete-all {
        background: none;
        color: var(--color-text-muted);
        border: none;
        padding: var(--space-2) var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-1);
        margin-top: var(--space-3);
    }

    .btn-delete-all:hover {
        color: var(--color-danger);
        background-color: var(--color-danger-light);
    }

    .btn-delete-all:disabled {
        color: var(--color-text-disabled);
        cursor: not-allowed;
    }

    .report-item-time {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-bottom: var(--space-1);
        display: flex;
        align-items: center;
        gap: var(--space-1);
    }

    .report-item-time .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    .report-item-type {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .report-item-type .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .report-item-type.dispense .icon {
        color: var(--brand-primary);
    }

    .report-item-type.sale .icon {
        color: var(--brand-accent);
    }

    .report-item-type.order .icon {
        color: var(--color-info);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-10) var(--space-5);
        color: var(--color-text-muted);
    }

    .empty-state-icon {
        margin-bottom: var(--space-3);
        color: var(--color-text-disabled);
    }

    .empty-state-icon .icon {
        width: var(--icon-xl);
        height: var(--icon-xl);
    }

    .loading-state {
        text-align: center;
        padding: var(--space-6);
        color: var(--color-text-muted);
    }

    .footer {
        text-align: center;
        margin-top: var(--space-8);
        color: var(--color-text-muted);
        font-size: var(--text-sm);
    }

    @media (max-width: 768px) {
        .container {
            padding: var(--space-6) var(--space-4);
        }

        .tabs {
            flex-direction: column;
        }

        .tab-button {
            width: 100%;
            justify-content: center;
        }

        .workflow-grid {
            grid-template-columns: 1fr;
        }

        .workflow-content {
            padding: var(--space-4);
        }

        .header-toolbar {
            flex-direction: column;
            gap: var(--space-2);
        }

        .toolbar-item {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="title-container">
    <h1 class="page-title">약국 적정 재고 솔루션</h1>
</div>

<div class="container">
    <div class="header">
        <div class="header-toolbar">
            <a href="/data/manage" class="toolbar-item db-status">
                <svg class="icon"><use href="#icon-folder"></use></svg>
                <span>데이터 파일 관리</span>
            </a>
            <a href="/drug/manage" class="toolbar-item util-link">
                <svg class="icon"><use href="#icon-settings"></use></svg>
                <span>약품 개별 관리</span>
            </a>
            <a href="/patient/manage" class="toolbar-item util-link">
                <svg class="icon"><use href="#icon-user"></use></svg>
                <span>환자 관리</span>
            </a>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-button order-tab" onclick="switchTab('order')">
                <svg class="icon"><use href="#icon-package"></use></svg>
                <span>주문 수량 산출</span>
            </button>
            <button class="tab-button active" onclick="switchTab('timeseries')">
                <svg class="icon"><use href="#icon-bar-chart-2"></use></svg>
                <span>분석 보고서</span>
            </button>
        </div>

        <div id="tab-timeseries" class="tab-content active">
            <div class="workflow-content">
                <div class="workflow-grid">
                    <div class="workflow-section section-new">
                        <h3>
                            <svg class="icon"><use href="#icon-sparkles"></use></svg>
                            새로 생성하기
                        </h3>
                        <div class="action-buttons">
                            <a href="/workflow/simple" class="btn-new">
                                <svg class="icon"><use href="#icon-bar-chart-2"></use></svg>
                                재고 관리 보고서
                            </a>
                            {% if dev_mode %}
                            <a href="/workflow/volatility" class="btn-new">
                                <svg class="icon"><use href="#icon-trending-up"></use></svg>
                                고변동성 약품 보고서 <span style="font-size: 0.75em; opacity: 0.7;">(개발중)</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    <div class="workflow-section section-history">
                        <h3>
                            <svg class="icon"><use href="#icon-folder"></use></svg>
                            과거 보고서
                        </h3>
                        <div id="timeseries-reports" class="report-list">
                            <div class="loading-state">로딩 중...</div>
                        </div>
                        <button class="btn-delete-all" id="btn-delete-all-timeseries" onclick="deleteAllReports('timeseries')" style="display: none;">
                            <span>전체 삭제</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-order" class="tab-content">
            <div class="workflow-content">
                <div class="workflow-grid">
                    <div class="workflow-section section-new">
                        <h3>
                            <svg class="icon"><use href="#icon-sparkles"></use></svg>
                            새로 생성하기
                        </h3>
                        <div class="action-buttons">
                            <a href="/workflow/order" class="btn-new order">
                                <svg class="icon"><use href="#icon-package"></use></svg>
                                주문 수량 산출
                            </a>
                        </div>
                    </div>

                    <div class="workflow-section section-history">
                        <h3>
                            <svg class="icon"><use href="#icon-folder"></use></svg>
                            과거 보고서
                        </h3>
                        <div id="order-reports" class="report-list">
                            <div class="loading-state">로딩 중...</div>
                        </div>
                        <button class="btn-delete-all" id="btn-delete-all-order" onclick="deleteAllReports('order')" style="display: none;">
                            <span>전체 삭제</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>약국 적정 재고 솔루션 v3.0</p>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    function switchTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(function(btn) {
            btn.classList.remove('active');
        });

        document.querySelectorAll('.tab-content').forEach(function(content) {
            content.classList.remove('active');
        });

        var tabButton = event.target.closest('.tab-button');
        if (tabButton) {
            tabButton.classList.add('active');
        }

        var tabContent = document.getElementById('tab-' + tabName);
        if (tabContent) {
            tabContent.classList.add('active');
        }

        if (!reportsLoaded[tabName]) {
            loadReports(tabName);
            reportsLoaded[tabName] = true;
        }
    }

    var reportsLoaded = {
        timeseries: false,
        order: false
    };

    function getReportIcon(typeClass) {
        if (typeClass === 'dispense') {
            return '<svg class="icon"><use href="#icon-pill"></use></svg>';
        } else if (typeClass === 'sale') {
            return '<svg class="icon"><use href="#icon-shopping-cart"></use></svg>';
        } else {
            return '<svg class="icon"><use href="#icon-package"></use></svg>';
        }
    }

    async function loadReports(type) {
        var container = document.getElementById(type + '-reports');

        try {
            var response = await fetch('/api/list-reports/' + type);
            var data = await response.json();

            if (data.error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg class="icon"><use href="#icon-alert-triangle"></use></svg></div><div>\uC624\uB958: ' + data.error + '</div></div>';
                return;
            }

            if (!data.reports || data.reports.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg class="icon"><use href="#icon-folder-open"></use></svg></div><div>\uC0DD\uC131\uB41C \uBCF4\uACE0\uC11C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4</div></div>';
                return;
            }

            var html = '';
            data.reports.forEach(function(report) {
                var typeClass = '';
                var typeText = '';
                var styleText = '';

                if (type === 'timeseries') {
                    typeText = report.drug_type;
                    typeClass = report.drug_type === '\uC804\uBB38\uC57D' ? 'dispense' : 'sale';

                    if (report.report_style) {
                        styleText = '<span style="font-size: 0.85em; opacity: 0.8;">[' + report.report_style + ']</span> ';
                        if (report.ma_months) {
                            styleText += '<span style="font-size: 0.75em; opacity: 0.7;">(' + report.ma_months + ')</span>';
                        }
                    }
                } else {
                    typeText = '\uC8FC\uBB38 \uC218\uB7C9 \uC0B0\uCD9C';
                    typeClass = 'order';
                }

                html += '<div class="report-item" data-filename="' + report.filename + '" data-type="' + type + '">' +
                    '<a href="/reports/' + report.filename + '" target="_blank" class="report-item-link">' +
                    '<div class="report-item-time"><svg class="icon"><use href="#icon-clock"></use></svg> ' + report.created_at + '</div>' +
                    '<div class="report-item-type ' + typeClass + '">' + getReportIcon(typeClass) + styleText + typeText + '</div>' +
                    '</a>' +
                    '<button class="btn-delete-report" onclick="deleteReport(\'' + report.filename + '\', \'' + type + '\')" title="\uBCF4\uACE0\uC11C \uC0AD\uC81C">' +
                    '<svg class="icon"><use href="#icon-trash-2"></use></svg></button></div>';
            });

            container.innerHTML = html;

            var deleteAllBtn = document.getElementById('btn-delete-all-' + type);
            if (deleteAllBtn) {
                deleteAllBtn.style.display = 'flex';
            }
        } catch (error) {
            console.error('\uBCF4\uACE0\uC11C \uB85C\uB4DC \uC2E4\uD328:', error);
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg class="icon"><use href="#icon-x-circle"></use></svg></div><div>\uBCF4\uACE0\uC11C\uB97C \uBD88\uB7EC\uC624\uB294\uB370 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4</div></div>';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadReports('timeseries');
        reportsLoaded.timeseries = true;
    });

    async function deleteAllReports(reportType) {
        var container = document.getElementById(reportType + '-reports');
        var reportItems = container.querySelectorAll('.report-item');
        var count = reportItems.length;

        if (count === 0) {
            showToast('\uC0AD\uC81C\uD560 \uBCF4\uACE0\uC11C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.', 'info');
            return;
        }

        var confirmed = await showConfirmModal({
            icon: 'danger',
            title: '\uC804\uCCB4 \uBCF4\uACE0\uC11C \uC0AD\uC81C',
            message: '\uC815\uB9D0 <strong>' + count + '\uAC1C</strong>\uC758 \uBCF4\uACE0\uC11C\uB97C \uBAA8\uB450 \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?<br><br>\uC0AD\uC81C\uB41C \uBCF4\uACE0\uC11C\uB294 \uBCF5\uAD6C\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.',
            confirmText: '\uC804\uCCB4 \uC0AD\uC81C',
            isDanger: true
        });
        if (!confirmed) return;

        var deleteAllBtn = document.getElementById('btn-delete-all-' + reportType);
        deleteAllBtn.disabled = true;
        deleteAllBtn.innerHTML = '<svg class="icon icon-spin"><use href="#icon-loader"></use></svg><span>\uC0AD\uC81C \uC911...</span>';

        var successCount = 0;
        var failCount = 0;

        for (var i = 0; i < reportItems.length; i++) {
            var item = reportItems[i];
            var filename = item.dataset.filename;
            try {
                var response = await fetch('/api/delete-report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename, report_type: reportType })
                });

                if (response.ok) {
                    successCount++;
                    item.remove();
                } else {
                    failCount++;
                }
            } catch (error) {
                failCount++;
            }
        }

        if (failCount === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg class="icon"><use href="#icon-folder-open"></use></svg></div><div>\uC0DD\uC131\uB41C \uBCF4\uACE0\uC11C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4</div></div>';
            deleteAllBtn.style.display = 'none';
        } else {
            showToast(successCount + '\uAC1C \uC0AD\uC81C \uC644\uB8CC, ' + failCount + '\uAC1C \uC2E4\uD328', 'warning');
            deleteAllBtn.disabled = false;
            deleteAllBtn.innerHTML = '<span>\uC804\uCCB4 \uC0AD\uC81C</span>';
        }
    }

    async function deleteReport(filename, reportType) {
        var confirmed = await showConfirmModal({
            icon: 'danger',
            title: '\uBCF4\uACE0\uC11C \uC0AD\uC81C',
            message: '\uC774 \uBCF4\uACE0\uC11C\uB97C \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?<br><br>\uC0AD\uC81C\uB41C \uBCF4\uACE0\uC11C\uB294 \uBCF5\uAD6C\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.',
            confirmText: '\uC0AD\uC81C',
            isDanger: true
        });
        if (!confirmed) return;

        try {
            var response = await fetch('/api/delete-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename, report_type: reportType })
            });

            var data = await response.json();

            if (response.ok && data.success) {
                var reportItem = document.querySelector('.report-item[data-filename="' + filename + '"]');
                if (reportItem) {
                    reportItem.style.transition = 'all 0.3s ease';
                    reportItem.style.opacity = '0';
                    reportItem.style.transform = 'translateX(-20px)';
                    setTimeout(function() {
                        reportItem.remove();

                        var container = document.getElementById(reportType + '-reports');
                        if (container && container.querySelectorAll('.report-item').length === 0) {
                            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg class="icon"><use href="#icon-folder-open"></use></svg></div><div>\uC0DD\uC131\uB41C \uBCF4\uACE0\uC11C\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4</div></div>';
                        }
                    }, 300);
                }
            } else {
                showToast('\uC0AD\uC81C \uC2E4\uD328: ' + (data.error || '\uC54C \uC218 \uC5C6\uB294 \uC624\uB958'), 'error');
            }
        } catch (error) {
            console.error('\uBCF4\uACE0\uC11C \uC0AD\uC81C \uC2E4\uD328:', error);
            showToast('\uBCF4\uACE0\uC11C \uC0AD\uC81C \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.', 'error');
        }
    }
</script>
{% endblock %}
