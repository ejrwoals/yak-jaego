{% extends "base.html" %}

{% block title %}환자 관리 - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block page_styles %}
<style>
    body {
        font-family: var(--font-family);
        background: var(--color-background);
        min-height: 100vh;
        padding: var(--space-5);
        overflow-y: scroll;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: var(--color-surface);
        border-radius: var(--radius-2xl);
        box-shadow: var(--shadow-lg);
        padding: var(--space-8);
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Page Header */
    .page-header {
        display: block;
        text-align: center;
        padding-bottom: var(--space-3);
        margin-bottom: var(--space-8);
        border-bottom: 2px solid var(--color-border);
    }

    .page-header h1 {
        color: var(--color-text-primary);
        font-size: var(--text-2xl);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-3);
    }

    .page-header h1 .icon {
        width: var(--icon-lg);
        height: var(--icon-lg);
        color: var(--brand-primary);
    }

    .page-header p {
        color: var(--color-text-muted);
        margin-top: var(--space-2);
    }

    .back-link {
        color: var(--brand-primary);
        text-decoration: none;
        font-size: var(--text-sm);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        margin-bottom: var(--space-5);
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .back-link .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    /* Header Row (Stats + Actions) */
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-4);
        margin-bottom: var(--space-5);
        flex-wrap: wrap;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-3) var(--space-4);
        background: var(--color-surface-hover);
        border-radius: var(--radius-lg);
        flex-wrap: wrap;
        border: 1px solid var(--color-border);
        flex: 1;
    }

    .header-actions {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        flex-shrink: 0;
    }

    .stat-item {
        color: var(--color-text-secondary);
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .stat-item .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .stat-value {
        font-weight: var(--font-bold);
        font-size: var(--text-base);
        color: var(--color-text-primary);
    }

    /* Search & Filter */
    .search-filter-bar {
        display: flex;
        gap: var(--space-4);
        align-items: center;
        margin-bottom: var(--space-5);
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 250px;
        padding: var(--space-4);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: var(--text-base);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .filter-buttons {
        display: flex;
        gap: var(--space-2);
    }

    .filter-btn {
        padding: var(--space-2) var(--space-4);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-full);
        background: var(--color-surface-hover);
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--color-text-muted);
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
    }

    .filter-btn .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    .filter-btn:hover {
        background: var(--color-surface);
        border-color: var(--color-border-hover);
        color: var(--color-text-secondary);
    }

    .filter-btn.active {
        background: var(--brand-primary-subtle);
        border-color: var(--brand-primary);
        color: var(--brand-primary-dark);
    }

    .sort-buttons {
        display: flex;
        gap: var(--space-2);
        flex-wrap: wrap;
        padding-left: var(--space-3);
        border-left: 1px solid var(--color-border);
    }

    .sort-btn {
        padding: var(--space-2) var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        cursor: pointer;
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        transition: all var(--transition-fast);
    }

    .sort-btn:hover {
        color: var(--color-text-secondary);
        border-color: var(--color-border-hover);
    }

    .sort-btn.active {
        background: var(--color-surface-hover);
        border-color: var(--color-border-hover);
        color: var(--color-text-secondary);
    }

    /* Patient Card List */
    .patient-list {
        max-height: 600px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
    }

    .patient-card {
        background: var(--color-surface-hover);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        transition: all var(--transition-fast);
    }

    .patient-card:hover {
        border-color: var(--color-border-hover);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
    }

    .patient-card.has-shortage {
        border-left: 4px solid var(--color-danger);
    }

    .patient-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-3);
    }

    .patient-card-title {
        flex: 1;
        min-width: 0;
    }

    .patient-name {
        font-size: var(--text-base);
        font-weight: var(--font-bold);
        color: var(--color-text-primary);
    }

    .patient-meta {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--space-1);
    }

    .patient-meta-separator {
        color: var(--color-border-hover);
    }

    .patient-info {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    .patient-badges {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        margin-top: var(--space-3);
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
    }

    .badge .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    .badge-drug {
        background: var(--color-info-light);
        color: var(--color-info);
    }

    .badge-shortage {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .badge-exact {
        background: var(--color-warning-light);
        color: var(--color-warning-dark);
    }

    .badge-normal {
        background: var(--color-surface-hover);
        color: var(--color-text-muted);
    }

    .btn {
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-lg);
        border: none;
        cursor: pointer;
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
    }

    .btn .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .btn-primary {
        background: var(--brand-primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--brand-primary-dark);
    }

    .btn-secondary {
        background: var(--color-border);
        color: var(--color-text-secondary);
    }

    .btn-secondary:hover {
        background: var(--color-border-hover);
    }

    .btn-danger {
        background: var(--color-danger);
        color: white;
    }

    .btn-danger:hover {
        background: var(--color-danger-dark);
    }

    .btn-suggest {
        background: var(--color-warning);
        color: white;
    }

    .btn-suggest:hover {
        background: var(--color-warning-dark);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: var(--z-modal);
        justify-content: center;
        align-items: center;
    }

    .modal.visible {
        display: flex;
    }

    .modal-content {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        width: 90%;
        max-width: 650px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }

    .modal-header {
        padding: var(--space-5);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--color-surface);
        z-index: 10;
    }

    .modal-header h3 {
        font-size: var(--text-lg);
        color: var(--color-text-primary);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .modal-header h3 .icon {
        width: var(--icon-md);
        height: var(--icon-md);
        color: var(--brand-primary);
    }

    .modal-close {
        width: var(--icon-lg);
        height: var(--icon-lg);
        cursor: pointer;
        color: var(--color-text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        transition: all var(--transition-fast);
    }

    .modal-close:hover {
        color: var(--color-text-secondary);
        background: var(--color-surface-hover);
    }

    .modal-close .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    .modal-body {
        padding: var(--space-5);
    }

    .modal-footer {
        padding: var(--space-5);
        border-top: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        gap: var(--space-3);
        position: sticky;
        bottom: 0;
        background: var(--color-surface);
    }

    .modal-footer-left {
        display: flex;
        gap: var(--space-3);
    }

    .modal-footer-right {
        display: flex;
        gap: var(--space-3);
    }

    /* Form sections */
    .form-section {
        margin-bottom: var(--space-5);
        padding-bottom: var(--space-5);
        border-bottom: 1px solid var(--color-border);
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .form-section-title {
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--color-text-secondary);
        margin-bottom: var(--space-3);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .form-section-title .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        color: var(--brand-primary);
    }

    .form-row {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-3);
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--space-2);
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .form-group textarea {
        min-height: 60px;
        resize: vertical;
    }

    /* Drug list in modal */
    .drug-list-section {
        margin-top: var(--space-4);
    }

    .drug-table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--text-sm);
    }

    .drug-table th {
        text-align: left;
        padding: var(--space-3) var(--space-2);
        background: var(--color-surface-hover);
        border-bottom: 2px solid var(--color-border);
        color: var(--color-text-secondary);
        font-weight: var(--font-semibold);
    }

    .drug-table td {
        padding: var(--space-3) var(--space-2);
        border-bottom: 1px solid var(--color-border);
        vertical-align: middle;
    }

    .drug-table tr:hover {
        background: var(--color-surface-hover);
    }

    .drug-table .status-icon {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drug-table .status-icon .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .drug-table .shortage .icon {
        color: var(--color-danger);
    }

    .drug-table .exact .icon {
        color: var(--color-warning);
    }

    .drug-table .sufficient .icon {
        color: var(--color-success);
    }

    .drug-table input[type="number"] {
        width: 70px;
        padding: var(--space-2);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        text-align: center;
    }

    .drug-table .remove-drug-btn {
        color: var(--color-text-muted);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drug-table .remove-drug-btn .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .drug-table .remove-drug-btn:hover {
        color: var(--color-danger);
    }

    .drug-table .empty-row td {
        text-align: center;
        color: var(--color-text-muted);
        padding: var(--space-5);
    }

    /* Drug search in modal */
    .drug-search-container {
        position: relative;
        margin-top: var(--space-3);
    }

    .drug-search-input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
    }

    .drug-search-input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .drug-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        margin-top: var(--space-1);
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: var(--z-dropdown);
        box-shadow: var(--shadow-md);
    }

    .drug-search-results.visible {
        display: block;
    }

    .drug-result-item {
        padding: var(--space-3);
        cursor: pointer;
        border-bottom: 1px solid var(--color-surface-hover);
    }

    .drug-result-item:hover {
        background: var(--color-surface-hover);
    }

    .drug-result-item:last-child {
        border-bottom: none;
    }

    /* Status message */
    .status-message {
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-5);
        display: none;
    }

    .status-message.success {
        background: var(--color-success-light);
        color: var(--color-success-dark);
        display: block;
    }

    .status-message.error {
        background: var(--color-danger-light);
        color: var(--color-danger);
        display: block;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: var(--space-16) var(--space-5);
        color: var(--color-text-muted);
        grid-column: 1 / -1;
    }

    .empty-state-icon {
        margin-bottom: var(--space-3);
        color: var(--color-border-hover);
    }

    .empty-state-icon .icon {
        width: var(--icon-xl);
        height: var(--icon-xl);
    }

    /* Tooltip */
    .help-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: var(--icon-sm);
        height: var(--icon-sm);
        min-width: var(--icon-sm);
        min-height: var(--icon-sm);
        background: var(--color-border);
        color: var(--color-text-muted);
        border-radius: var(--radius-full);
        font-size: 10px;
        font-weight: var(--font-semibold);
        cursor: help;
        margin-left: var(--space-2);
        position: relative;
        line-height: 1;
        vertical-align: middle;
    }

    .help-icon:hover {
        background: var(--color-border-hover);
        color: var(--color-text-secondary);
    }

    .help-icon .tooltip {
        display: none;
        position: absolute;
        bottom: calc(100% + 8px);
        left: 0;
        background: var(--color-text-primary);
        color: var(--color-surface);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        font-size: var(--text-xs);
        font-weight: var(--font-normal);
        white-space: normal;
        width: 280px;
        line-height: 1.5;
        box-shadow: var(--shadow-lg);
        z-index: var(--z-tooltip);
        overflow: visible;
        height: auto;
        min-height: fit-content;
    }

    .help-icon .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 12px;
        border: 6px solid transparent;
        border-top-color: var(--color-text-primary);
    }

    .help-icon:hover .tooltip {
        display: block;
    }

    /* Modal error message */
    .modal-error-message {
        background: var(--color-danger-light);
        color: var(--color-danger);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-4);
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--space-2);
        border: 1px solid var(--color-danger);
        animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Modal shake animation for close protection */
    @keyframes modalShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .modal-content.shake {
        animation: modalShake 0.4s ease-in-out;
    }

    .modal-error-message .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .patient-list {
            grid-template-columns: 1fr;
        }

        .header-row {
            flex-direction: column;
            align-items: stretch;
        }

        .stats-bar {
            justify-content: center;
        }

        .header-actions {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-link">
        <svg class="icon"><use href="#icon-arrow-left"></use></svg>
        홈으로 돌아가기
    </a>

    <div class="page-header">
        <h1>
            <svg class="icon"><use href="#icon-user"></use></svg>
            환자 관리
        </h1>
        <p>환자별 약품 재고 상태를 확인합니다</p>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div class="header-row">
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span>전체 환자:</span>
                <span class="stat-value" id="statTotal">0</span>명
            </div>
            <div class="stat-item">
                <svg class="icon" style="color: var(--color-danger);"><use href="#icon-alert-triangle"></use></svg>
                <span>부족 있음:</span>
                <span class="stat-value" id="statShortage">0</span>명
            </div>
            <div class="stat-item">
                <svg class="icon" style="color: var(--color-success);"><use href="#icon-check-circle"></use></svg>
                <span>정상:</span>
                <span class="stat-value" id="statNormal">0</span>명
            </div>
        </div>
        <div class="header-actions">
            <a href="/patient/suggest" class="btn btn-suggest" id="suggestLink" style="display: none; text-decoration: none;">
                <svg class="icon"><use href="#icon-sparkles"></use></svg>
                약품 추천
            </a>
            <button class="btn btn-primary" onclick="openPatientModal()">
                <svg class="icon"><use href="#icon-plus"></use></svg>
                새 환자
            </button>
        </div>
    </div>

    <div class="search-filter-bar">
        <input type="text" class="search-input" id="searchInput"
               placeholder="환자명, 주민번호로 검색..."
               oninput="filterPatients()">
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">전체</button>
            <button class="filter-btn" data-filter="shortage" onclick="setFilter('shortage')">
                <svg class="icon"><use href="#icon-alert-triangle"></use></svg>
                부족
            </button>
            <button class="filter-btn" data-filter="normal" onclick="setFilter('normal')">
                <svg class="icon"><use href="#icon-check"></use></svg>
                정상
            </button>
        </div>
        <div class="sort-buttons">
            <button class="sort-btn active" data-sort="recent" onclick="setSort('recent')">최근순</button>
            <button class="sort-btn" data-sort="name" onclick="setSort('name')">가나다순</button>
        </div>
    </div>

    <div class="patient-list" id="patientList">
        <div class="empty-state">
            <div class="empty-state-icon">
                <svg class="icon"><use href="#icon-user"></use></svg>
            </div>
            <div>등록된 환자가 없습니다.</div>
            <div style="margin-top: var(--space-3); font-size: var(--text-sm);">"새 환자" 버튼을 클릭하여 환자를 등록하세요.</div>
        </div>
    </div>
</div>

<!-- Patient Modal (Create/Edit) -->
<div id="patientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">
                <svg class="icon"><use href="#icon-user-plus"></use></svg>
                <span id="modalTitleText">새 환자 등록</span>
            </h3>
            <span class="modal-close" onclick="closePatientModal()">
                <svg class="icon"><use href="#icon-x"></use></svg>
            </span>
        </div>
        <div class="modal-body">
            <!-- In-modal error message -->
            <div id="modalErrorMessage" class="modal-error-message" style="display: none;">
                <svg class="icon"><use href="#icon-alert-triangle"></use></svg>
                <span id="modalErrorText"></span>
            </div>

            <!-- Basic Info -->
            <div class="form-section">
                <div class="form-section-title">
                    <svg class="icon"><use href="#icon-clipboard"></use></svg>
                    기본 정보
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>환자명 *</label>
                        <input type="text" id="inputPatientName" placeholder="환자명">
                    </div>
                    <div class="form-group">
                        <label>주민번호 앞자리 *</label>
                        <input type="text" id="inputPatientBirth" maxlength="6" placeholder="예: 900101" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>방문 주기 (일)
                            <span class="help-icon">?
                                <span class="tooltip">환자가 평균적으로 몇 일마다 방문하는지 입력하세요. 최소 재고 버퍼 계산에 사용됩니다.</span>
                            </span>
                        </label>
                        <input type="number" id="inputVisitCycle" placeholder="예: 30" min="1">
                    </div>
                    <div class="form-group">
                        <label>메모</label>
                        <input type="text" id="inputPatientMemo" placeholder="환자 메모">
                    </div>
                </div>
            </div>

            <!-- Drug List (only shown in edit mode) -->
            <div class="form-section" id="drugListSection" style="display: none;">
                <div class="form-section-title">
                    <svg class="icon"><use href="#icon-pill"></use></svg>
                    처방 약품 목록
                    <span class="help-icon">?
                        <span class="tooltip">이 환자에게 처방되는 약품 목록입니다. 현재 재고가 1회 처방량 이하이면 부족으로 표시됩니다.</span>
                    </span>
                </div>
                <div class="drug-list-section">
                    <table class="drug-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>약품명</th>
                                <th style="width: 80px;">1회처방량</th>
                                <th style="width: 80px;">현재재고</th>
                                <th style="width: 60px;">상태</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="drugTableBody">
                            <tr class="empty-row">
                                <td colspan="6">연결된 약품이 없습니다</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="drug-search-container">
                        <input type="text" class="drug-search-input" id="drugSearchInput"
                               placeholder="약품명 또는 약품코드로 검색하여 추가..."
                               oninput="searchDrugs()">
                        <div class="drug-search-results" id="drugSearchResults"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-left">
                <button class="btn btn-danger" id="deletePatientBtn" onclick="deletePatient()" style="display: none;">
                    <svg class="icon"><use href="#icon-trash-2"></use></svg>
                    삭제
                </button>
            </div>
            <div class="modal-footer-right">
                <button class="btn btn-secondary" onclick="closePatientModal()">취소</button>
                <button class="btn btn-primary" onclick="savePatient()">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Drug Registration Modal -->
<div id="confirmDrugModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>
                <svg class="icon"><use href="#icon-pill"></use></svg>
                약품 등록
            </h3>
            <span class="modal-close" onclick="closeConfirmDrugModal(false)">
                <svg class="icon"><use href="#icon-x"></use></svg>
            </span>
        </div>
        <div class="modal-body" style="text-align: center; padding: var(--space-8) var(--space-5);">
            <div style="margin-bottom: var(--space-4); color: var(--brand-primary);">
                <svg class="icon" style="width: var(--icon-xl); height: var(--icon-xl);"><use href="#icon-pill"></use></svg>
            </div>
            <div style="font-size: var(--text-base); color: var(--color-text-primary); line-height: 1.6;">
                등록한 <strong id="confirmPatientName"></strong> 환자의<br>
                사용 약품을 등록하시겠습니까?
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center; gap: var(--space-3);">
            <button class="btn btn-secondary" onclick="closeConfirmDrugModal(false)" style="min-width: 100px;">나중에</button>
            <button class="btn btn-primary" onclick="closeConfirmDrugModal(true)" style="min-width: 100px;">등록하기</button>
        </div>
    </div>
</div>

<!-- Dosage Modal -->
<div id="dosageModal" class="modal">
    <div class="modal-content" style="max-width: 380px;">
        <div class="modal-header">
            <h3>
                <svg class="icon"><use href="#icon-pill"></use></svg>
                1회 처방량 입력
            </h3>
            <span class="modal-close" onclick="closeDosageModal()">
                <svg class="icon"><use href="#icon-x"></use></svg>
            </span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-surface-hover); border-radius: var(--radius-lg);">
                <div style="font-weight: var(--font-semibold); color: var(--color-text-primary);" id="dosageDrugName">-</div>
                <div style="color: var(--color-text-muted); font-size: var(--text-sm);" id="dosageDrugInfo">-</div>
            </div>
            <div class="form-group">
                <label>1회 처방량 *</label>
                <input type="number" id="inputDosage" placeholder="예: 30" min="1" value="1">
                <div style="font-size: var(--text-xs); color: var(--color-text-muted); margin-top: var(--space-1);">
                    이 환자에게 한 번 방문 시 처방하는 약품 수량
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div></div>
            <div class="modal-footer-right">
                <button class="btn btn-secondary" onclick="closeDosageModal()">취소</button>
                <button class="btn btn-primary" onclick="confirmDosage()">추가</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/jaego-core.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/confirm-modal.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.VERSION }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    var allPatients = [];
    var currentFilter = 'all';
    var currentSort = 'recent';
    var currentPatientId = null;
    var isEditMode = false;
    var patientDrugs = [];
    var searchTimeout = null;
    var pendingDrug = null;
    var pendingNewPatient = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadPatients();
        checkSuggestionStatus();
    });

    // Check if suggestion feature is active
    function checkSuggestionStatus() {
        fetch('/api/suggestion/status')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success' && data.data.active) {
                    document.getElementById('suggestLink').style.display = 'inline-flex';
                }
            })
            .catch(function(error) {
                console.log('Suggestion status check failed:', error);
            });
    }

    function loadPatients() {
        fetch('/api/patients-with-drugs')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    allPatients = data.data;
                    updateStats();
                    filterPatients();
                }
            })
            .catch(function(error) {
                showStatus('데이터 로드 실패: ' + error.message, 'error');
            });
    }

    function updateStats() {
        var total = allPatients.length;
        var shortage = allPatients.filter(function(p) { return p.has_shortage; }).length;
        var normal = total - shortage;

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statShortage').textContent = shortage;
        document.getElementById('statNormal').textContent = normal;
    }

    function renderPatients(patients) {
        var listDiv = document.getElementById('patientList');

        if (patients.length === 0) {
            listDiv.innerHTML =
                '<div class="empty-state">' +
                    '<div class="empty-state-icon">' +
                        '<svg class="icon"><use href="#icon-user"></use></svg>' +
                    '</div>' +
                    '<div>등록된 환자가 없습니다.</div>' +
                    '<div style="margin-top: var(--space-3); font-size: var(--text-sm);">"새 환자" 버튼을 클릭하여 환자를 등록하세요.</div>' +
                '</div>';
            return;
        }

        listDiv.innerHTML = patients.map(function(patient) {
            var shortageClass = patient.has_shortage ? 'has-shortage' : '';
            var statusBadges = '';
            if (patient.has_shortage) {
                statusBadges += '<span class="badge badge-shortage"><svg class="icon"><use href="#icon-alert-triangle"></use></svg> 부족 ' + patient.shortage_count + '개</span>';
            }
            if (patient.has_exact) {
                statusBadges += '<span class="badge badge-exact"><svg class="icon"><use href="#icon-target"></use></svg> 딱맞음 ' + patient.exact_count + '개</span>';
            }
            if (!patient.has_shortage && !patient.has_exact && patient.drug_count > 0) {
                statusBadges = '<span class="badge badge-normal"><svg class="icon"><use href="#icon-check"></use></svg> 정상</span>';
            }

            // 메타 정보 구성 (생년월일, 방문주기)
            var metaParts = [];
            if (patient.birth) metaParts.push(patient.birth);
            if (patient.visit_cycle) metaParts.push('방문주기 ' + patient.visit_cycle + '일');
            var metaHtml = metaParts.length > 0
                ? '<div class="patient-meta">' + metaParts.join('<span class="patient-meta-separator">·</span>') + '</div>'
                : '';

            return '<div class="patient-card ' + shortageClass + '" data-id="' + patient.patient_id + '">' +
                '<div class="patient-card-header">' +
                    '<div class="patient-card-title">' +
                        '<div class="patient-name">' + escapeHtml(patient.patient_name) + '</div>' +
                        metaHtml +
                    '</div>' +
                    '<button class="btn btn-secondary" onclick="openEditModal(' + patient.patient_id + ')" style="padding: var(--space-2) var(--space-3); font-size: var(--text-sm);">관리</button>' +
                '</div>' +
                (patient.memo ? '<div class="patient-info">' + escapeHtml(patient.memo.substring(0, 30)) + (patient.memo.length > 30 ? '...' : '') + '</div>' : '') +
                '<div class="patient-badges">' +
                    '<span class="badge badge-drug"><svg class="icon"><use href="#icon-pill"></use></svg> 약품 ' + patient.drug_count + '개</span>' +
                    statusBadges +
                '</div>' +
            '</div>';
        }).join('');
    }

    function filterPatients() {
        var query = document.getElementById('searchInput').value.toLowerCase();
        var filtered = allPatients.slice();

        if (query) {
            filtered = filtered.filter(function(p) {
                return p.patient_name.toLowerCase().includes(query) ||
                    (p.birth && p.birth.includes(query));
            });
        }

        if (currentFilter === 'shortage') {
            filtered = filtered.filter(function(p) { return p.has_shortage; });
        } else if (currentFilter === 'normal') {
            filtered = filtered.filter(function(p) { return !p.has_shortage || p.drug_count === 0; });
        }

        if (currentSort === 'name') {
            filtered.sort(function(a, b) { return a.patient_name.localeCompare(b.patient_name, 'ko'); });
        } else if (currentSort === 'recent') {
            filtered.sort(function(a, b) { return new Date(b.updated_at || 0) - new Date(a.updated_at || 0); });
        }

        renderPatients(filtered);
    }

    function setFilter(filter) {
        currentFilter = filter;

        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });

        filterPatients();
    }

    function setSort(sort) {
        currentSort = sort;

        document.querySelectorAll('.sort-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.sort === sort);
        });

        filterPatients();
    }

    // Modal Functions
    function openPatientModal() {
        isEditMode = false;
        currentPatientId = null;
        patientDrugs = [];

        hideModalError();
        document.getElementById('modalTitleText').textContent = '새 환자 등록';
        document.getElementById('inputPatientName').value = '';
        document.getElementById('inputPatientBirth').value = '';
        document.getElementById('inputVisitCycle').value = '';
        document.getElementById('inputPatientMemo').value = '';

        document.getElementById('drugListSection').style.display = 'none';
        document.getElementById('deletePatientBtn').style.display = 'none';

        document.getElementById('patientModal').classList.add('visible');
    }

    function openEditModal(patientId) {
        isEditMode = true;
        currentPatientId = patientId;

        hideModalError();
        document.getElementById('modalTitleText').textContent = '환자 관리';
        document.getElementById('drugListSection').style.display = 'block';
        document.getElementById('deletePatientBtn').style.display = 'inline-flex';

        fetch('/api/patient/' + patientId + '/drugs-with-stock')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    var patient = data.patient;
                    patientDrugs = data.drugs;

                    document.getElementById('inputPatientName').value = patient.name || '';
                    document.getElementById('inputPatientBirth').value = patient.birth || '';
                    document.getElementById('inputVisitCycle').value = patient.visit_cycle || '';
                    document.getElementById('inputPatientMemo').value = patient.memo || '';

                    renderDrugTable();
                    document.getElementById('patientModal').classList.add('visible');
                }
            })
            .catch(function(error) {
                showStatus('환자 정보 로드 실패: ' + error.message, 'error');
            });
    }

    function closePatientModal() {
        document.getElementById('patientModal').classList.remove('visible');
        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchResults').classList.remove('visible');
    }

    function renderDrugTable() {
        var tbody = document.getElementById('drugTableBody');

        if (patientDrugs.length === 0) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6">연결된 약품이 없습니다</td></tr>';
            return;
        }

        tbody.innerHTML = patientDrugs.map(function(drug, index) {
            var statusIcon, statusText, statusClass;
            if (drug.status === 'shortage') {
                statusIcon = '<span class="status-icon shortage"><svg class="icon"><use href="#icon-alert-circle"></use></svg></span>';
                statusText = '부족';
                statusClass = 'shortage';
            } else if (drug.status === 'exact') {
                statusIcon = '<span class="status-icon exact"><svg class="icon"><use href="#icon-target"></use></svg></span>';
                statusText = '딱맞음';
                statusClass = 'exact';
            } else {
                statusIcon = '<span class="status-icon sufficient"><svg class="icon"><use href="#icon-check-circle"></use></svg></span>';
                statusText = '충분';
                statusClass = 'sufficient';
            }

            return '<tr data-code="' + drug.drug_code + '">' +
                '<td>' + statusIcon + '</td>' +
                '<td>' +
                    '<div style="font-weight: var(--font-medium);">' + escapeHtml(drug.drug_name) + '</div>' +
                    '<div style="font-size: var(--text-xs); color: var(--color-text-muted);">' + drug.drug_code + '</div>' +
                '</td>' +
                '<td>' +
                    '<input type="number" value="' + drug.dosage + '" min="1" onchange="updateDosage(' + index + ', this.value)">' +
                '</td>' +
                '<td style="text-align: center;">' + drug.current_stock + '</td>' +
                '<td class="' + statusClass + '">' + statusText + '</td>' +
                '<td>' +
                    '<span class="remove-drug-btn" onclick="removeDrug(' + index + ')"><svg class="icon"><use href="#icon-x"></use></svg></span>' +
                '</td>' +
            '</tr>';
        }).join('');
    }

    function updateDosage(index, value) {
        patientDrugs[index].dosage = parseInt(value) || 1;
        var drug = patientDrugs[index];
        if (drug.current_stock < drug.dosage) {
            drug.status = 'shortage';
        } else if (drug.current_stock === drug.dosage) {
            drug.status = 'exact';
        } else {
            drug.status = 'sufficient';
        }
        renderDrugTable();
    }

    function removeDrug(index) {
        patientDrugs.splice(index, 1);
        renderDrugTable();
    }

    function searchDrugs() {
        clearTimeout(searchTimeout);
        var query = document.getElementById('drugSearchInput').value.trim();
        var resultsDiv = document.getElementById('drugSearchResults');

        if (query.length < 2) {
            resultsDiv.classList.remove('visible');
            return;
        }

        searchTimeout = setTimeout(function() {
            fetch('/api/search-inventory?q=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'success' && data.results.length > 0) {
                        var existingCodes = patientDrugs.map(function(d) { return d.drug_code; });
                        var filtered = data.results.filter(function(d) {
                            return !existingCodes.includes(d['약품코드']);
                        });

                        if (filtered.length > 0) {
                            resultsDiv.innerHTML = filtered.slice(0, 10).map(function(item) {
                                return '<div class="drug-result-item" onclick="openDosageModal(\'' + item['약품코드'] + '\', \'' + escapeHtml(item['약품명']) + '\', \'' + escapeHtml(item['제약회사']) + '\', ' + item['현재_재고수량'] + ')">' +
                                    '<div style="font-weight: var(--font-medium);">' + item['약품명'] + '</div>' +
                                    '<div style="font-size: var(--text-sm); color: var(--color-text-muted);">' + item['약품코드'] + ' | 재고: ' + item['현재_재고수량'] + '</div>' +
                                '</div>';
                            }).join('');
                        } else {
                            resultsDiv.innerHTML = '<div style="padding: var(--space-3); color: var(--color-text-muted);">이미 모두 추가됨</div>';
                        }
                        resultsDiv.classList.add('visible');
                    } else {
                        resultsDiv.innerHTML = '<div style="padding: var(--space-3); color: var(--color-text-muted);">검색 결과가 없습니다</div>';
                        resultsDiv.classList.add('visible');
                    }
                });
        }, 300);
    }

    function openDosageModal(drugCode, drugName, company, currentStock) {
        pendingDrug = { drugCode: drugCode, drugName: drugName, company: company, currentStock: currentStock };

        document.getElementById('dosageDrugName').textContent = drugName;
        document.getElementById('dosageDrugInfo').textContent = drugCode + ' | 현재 재고: ' + currentStock;
        document.getElementById('inputDosage').value = 1;

        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchResults').classList.remove('visible');

        document.getElementById('dosageModal').classList.add('visible');
    }

    function closeDosageModal() {
        document.getElementById('dosageModal').classList.remove('visible');
        pendingDrug = null;
    }

    function openConfirmDrugModal(patientId, patientName) {
        pendingNewPatient = { id: patientId, name: patientName };
        document.getElementById('confirmPatientName').textContent = patientName;
        document.getElementById('confirmDrugModal').classList.add('visible');
    }

    function closeConfirmDrugModal(shouldRegister) {
        document.getElementById('confirmDrugModal').classList.remove('visible');

        if (shouldRegister && pendingNewPatient) {
            var patientId = pendingNewPatient.id;
            pendingNewPatient = null;
            setTimeout(function() {
                openEditModal(patientId);
            }, 100);
        } else {
            pendingNewPatient = null;
            showStatus('저장되었습니다.', 'success');
        }
    }

    function confirmDosage() {
        if (!pendingDrug) return;

        var dosage = parseInt(document.getElementById('inputDosage').value) || 1;
        var status;
        if (pendingDrug.currentStock < dosage) {
            status = 'shortage';
        } else if (pendingDrug.currentStock === dosage) {
            status = 'exact';
        } else {
            status = 'sufficient';
        }

        patientDrugs.push({
            drug_code: pendingDrug.drugCode,
            drug_name: pendingDrug.drugName,
            company: pendingDrug.company,
            dosage: dosage,
            current_stock: pendingDrug.currentStock,
            status: status
        });

        renderDrugTable();
        closeDosageModal();
    }

    function showModalError(message) {
        var errorDiv = document.getElementById('modalErrorMessage');
        document.getElementById('modalErrorText').textContent = message;
        errorDiv.style.display = 'flex';
        errorDiv.style.animation = 'none';
        errorDiv.offsetHeight;
        errorDiv.style.animation = 'shake 0.3s ease-in-out';
    }

    function hideModalError() {
        document.getElementById('modalErrorMessage').style.display = 'none';
    }

    async function savePatient() {
        hideModalError();

        var name = document.getElementById('inputPatientName').value.trim();
        var birth = document.getElementById('inputPatientBirth').value.trim();
        var visitCycle = document.getElementById('inputVisitCycle').value;
        var memo = document.getElementById('inputPatientMemo').value.trim();

        if (!name) {
            showModalError('환자명은 필수입니다.');
            document.getElementById('inputPatientName').focus();
            return;
        }

        if (!birth) {
            showModalError('주민번호 앞자리는 필수입니다.');
            document.getElementById('inputPatientBirth').focus();
            return;
        }

        if (birth.length !== 6 || !/^\d{6}$/.test(birth)) {
            showModalError('주민번호 앞자리는 6자리 숫자여야 합니다.');
            document.getElementById('inputPatientBirth').focus();
            return;
        }

        try {
            var patientData = {
                name: name,
                birth: birth || null,
                memo: memo || null,
                visit_cycle: visitCycle || null
            };

            var patientId = currentPatientId;

            if (isEditMode) {
                var response = await fetch('/api/patient/' + currentPatientId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patientData)
                });
                var data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message);
                }
            } else {
                var response = await fetch('/api/patient', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patientData)
                });
                var data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message);
                }
                patientId = data.patient_id;
            }

            if (isEditMode && patientId) {
                var currentDrugsResponse = await fetch('/api/patient/' + patientId + '/drugs-with-stock');
                var currentDrugsData = await currentDrugsResponse.json();
                var currentDrugCodes = currentDrugsData.status === 'success'
                    ? currentDrugsData.drugs.map(function(d) { return d.drug_code; })
                    : [];

                var newDrugCodes = patientDrugs.map(function(d) { return d.drug_code; });

                for (var i = 0; i < currentDrugCodes.length; i++) {
                    var code = currentDrugCodes[i];
                    if (newDrugCodes.indexOf(code) === -1) {
                        await fetch('/api/patient/' + patientId + '/unlink-drug/' + code, {
                            method: 'DELETE'
                        });
                    }
                }

                for (var j = 0; j < patientDrugs.length; j++) {
                    var drug = patientDrugs[j];
                    await fetch('/api/patient/' + patientId + '/link-drug', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            drug_code: drug.drug_code,
                            dosage: drug.dosage
                        })
                    });
                }
            }

            closePatientModal();
            loadPatients();

            if (!isEditMode && patientId) {
                openConfirmDrugModal(patientId, name);
            } else {
                showStatus('저장되었습니다.', 'success');
            }

        } catch (error) {
            showModalError('저장 실패: ' + error.message);
        }
    }

    async function deletePatient() {
        if (!currentPatientId) return;

        var confirmed = await showConfirmModal({
            icon: 'danger',
            title: '환자 삭제',
            message: '이 환자를 삭제하시겠습니까?<br><br>연결된 모든 약품 정보도 함께 삭제됩니다.',
            confirmText: '삭제',
            isDanger: true
        });

        if (!confirmed) return;

        try {
            var response = await fetch('/api/patient/' + currentPatientId, {
                method: 'DELETE'
            });
            var data = await response.json();

            if (data.status === 'success') {
                closePatientModal();
                loadPatients();
                showStatus('환자가 삭제되었습니다.', 'success');
            } else {
                showStatus(data.message, 'error');
            }
        } catch (error) {
            showStatus('삭제 실패: ' + error.message, 'error');
        }
    }

    function showStatus(message, type) {
        var statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message ' + type;
        setTimeout(function() {
            statusDiv.className = 'status-message';
        }, 3000);
    }

    function escapeHtml(text) {
        if (!text) return '';
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Modal content check functions
    function hasPatientModalContent() {
        var name = document.getElementById('inputPatientName').value.trim();
        var birth = document.getElementById('inputPatientBirth').value.trim();
        var visitCycle = document.getElementById('inputVisitCycle').value;
        var memo = document.getElementById('inputPatientMemo').value.trim();

        if (isEditMode) {
            return true;
        }

        return name !== '' || birth !== '' || visitCycle !== '' || memo !== '';
    }

    function hasDosageModalContent() {
        var dosage = document.getElementById('inputDosage').value;
        return dosage !== '' && dosage !== '1';
    }

    function shakeModal(modalId) {
        var modal = document.getElementById(modalId);
        var content = modal.querySelector('.modal-content');
        content.classList.add('shake');
        setTimeout(function() {
            content.classList.remove('shake');
        }, 400);
    }

    async function tryClosePatientModal() {
        if (hasPatientModalContent()) {
            shakeModal('patientModal');
            var confirmed = await showConfirmModal({
                icon: 'warning',
                title: '작성 중인 내용이 있습니다',
                message: '정말 닫으시겠습니까?<br>입력한 내용은 저장되지 않습니다.',
                confirmText: '닫기',
                isDanger: true
            });
            if (confirmed) {
                closePatientModal();
            }
        } else {
            closePatientModal();
        }
    }

    async function tryCloseDosageModal() {
        if (hasDosageModalContent()) {
            shakeModal('dosageModal');
            var confirmed = await showConfirmModal({
                icon: 'warning',
                title: '작성 중인 내용이 있습니다',
                message: '정말 닫으시겠습니까?<br>입력한 내용은 저장되지 않습니다.',
                confirmText: '닫기',
                isDanger: true
            });
            if (confirmed) {
                closeDosageModal();
            }
        } else {
            closeDosageModal();
        }
    }

    // Close modal on outside click
    document.getElementById('patientModal').addEventListener('click', function(e) {
        if (e.target === this) tryClosePatientModal();
    });

    document.getElementById('dosageModal').addEventListener('click', function(e) {
        if (e.target === this) tryCloseDosageModal();
    });

    // ESC to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var customConfirmModal = document.getElementById('confirmModal');
            if (customConfirmModal && customConfirmModal.classList.contains('visible')) {
                closeConfirmModal(false);
                return;
            }

            var patientModal = document.getElementById('patientModal');
            var dosageModal = document.getElementById('dosageModal');
            var confirmDrugModal = document.getElementById('confirmDrugModal');

            if (confirmDrugModal.classList.contains('visible')) {
                closeConfirmDrugModal(false);
            } else if (dosageModal.classList.contains('visible')) {
                tryCloseDosageModal();
            } else if (patientModal.classList.contains('visible')) {
                tryClosePatientModal();
            }
        }
    });

    document.getElementById('confirmDrugModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfirmDrugModal(false);
    });
</script>
{% endblock %}
