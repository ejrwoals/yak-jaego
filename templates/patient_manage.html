{% extends "base.html" %}

{% block title %}í™˜ì ê´€ë¦¬ - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block page_styles %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f5;
        min-height: 100vh;
        padding: 20px;
        overflow-y: scroll;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        padding: 30px;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .back-link {
        color: #4299e1;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    /* Header Row (Stats + Actions) */
    .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    /* Stats Bar */
    .stats-bar {
        display: flex;
        gap: 15px;
        padding: 12px 16px;
        background: #f1f5f9;
        border-radius: 10px;
        flex-wrap: wrap;
        border: 1px solid #e2e8f0;
        flex: 1;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        flex-shrink: 0;
    }

    .stat-item {
        color: #475569;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .stat-value {
        font-weight: bold;
        font-size: 16px;
        color: #1e293b;
    }

    /* Search & Filter */
    .search-section {
        margin-bottom: 20px;
    }

    .search-filter-bar {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 14px 18px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
    }

    .search-input:focus {
        outline: none;
        border-color: #48bb78;
    }

    .filter-buttons {
        display: flex;
        gap: 8px;
    }

    .filter-btn {
        padding: 6px 14px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        background: #f9fafb;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.2s;
    }

    .filter-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #374151;
    }

    .filter-btn.active {
        background: #ecfdf5;
        border-color: #34d399;
        color: #059669;
    }

    .sort-buttons {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        padding-left: 10px;
        border-left: 1px solid #e2e8f0;
    }

    .sort-btn {
        padding: 5px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        color: #9ca3af;
        transition: all 0.2s;
    }

    .sort-btn:hover {
        color: #6b7280;
        border-color: #d1d5db;
    }

    .sort-btn.active {
        background: #f9fafb;
        border-color: #9ca3af;
        color: #374151;
    }

    /* Patient Card List */
    .patient-list {
        max-height: 600px;
        overflow-y: auto;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .patient-card {
        background: #f7fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px;
        transition: all 0.2s;
    }

    .patient-card:hover {
        border-color: #cbd5e0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-1px);
    }

    .patient-card.has-shortage {
        border-left: 4px solid #e53e3e;
    }

    .patient-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    .patient-card-title {
        flex: 1;
        min-width: 0;
    }

    .patient-name {
        font-size: 15px;
        font-weight: 700;
        color: #1a202c;
    }

    .patient-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #718096;
        margin-top: 2px;
    }

    .patient-meta-separator {
        color: #cbd5e0;
    }

    .patient-info {
        font-size: 12px;
        color: #a0aec0;
    }

    .patient-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
    }

    .badge-drug {
        background: #e8f4fd;
        color: #2b6cb0;
    }

    .badge-shortage {
        background: #fed7d7;
        color: #c53030;
    }

    .badge-exact {
        background: #fef3c7;
        color: #d97706;
    }

    .badge-normal {
        background: #f1f5f9;
        color: #94a3b8;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #48bb78;
        color: white;
    }

    .btn-primary:hover {
        background: #38a169;
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-secondary:hover {
        background: #cbd5e0;
    }

    .btn-danger {
        background: #fc8181;
        color: white;
    }

    .btn-danger:hover {
        background: #f56565;
    }

    .btn-suggest {
        background: linear-gradient(135deg, #f6e05e 0%, #ecc94b 100%);
        color: #744210;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .btn-suggest:hover {
        background: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(236, 201, 75, 0.4);
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .modal.visible {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 650px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
    }

    .modal-header h3 {
        font-size: 18px;
        color: #2d3748;
    }

    .modal-close {
        font-size: 24px;
        cursor: pointer;
        color: #a0aec0;
    }

    .modal-close:hover {
        color: #718096;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        position: sticky;
        bottom: 0;
        background: white;
    }

    .modal-footer-left {
        display: flex;
        gap: 10px;
    }

    .modal-footer-right {
        display: flex;
        gap: 10px;
    }

    /* Form sections */
    .form-section {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e2e8f0;
    }

    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .form-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 12px;
    }

    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 12px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        color: #718096;
        margin-bottom: 6px;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #48bb78;
    }

    .form-group textarea {
        min-height: 60px;
        resize: vertical;
    }

    /* Drug list in modal */
    .drug-list-section {
        margin-top: 15px;
    }

    .drug-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .drug-table th {
        text-align: left;
        padding: 10px 8px;
        background: #f7fafc;
        border-bottom: 2px solid #e2e8f0;
        color: #4a5568;
        font-weight: 600;
    }

    .drug-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
    }

    .drug-table tr:hover {
        background: #f7fafc;
    }

    .drug-table .status-icon {
        font-size: 16px;
    }

    .drug-table .shortage {
        color: #e53e3e;
    }

    .drug-table .exact {
        color: #d97706;
    }

    .drug-table .sufficient {
        color: #38a169;
    }

    .drug-table input[type="number"] {
        width: 70px;
        padding: 6px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        text-align: center;
    }

    .drug-table .remove-drug-btn {
        color: #a0aec0;
        cursor: pointer;
        font-size: 18px;
    }

    .drug-table .remove-drug-btn:hover {
        color: #e53e3e;
    }

    .drug-table .empty-row td {
        text-align: center;
        color: #a0aec0;
        padding: 20px;
    }

    /* Drug search in modal */
    .drug-search-container {
        position: relative;
        margin-top: 10px;
    }

    .drug-search-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
    }

    .drug-search-input:focus {
        outline: none;
        border-color: #48bb78;
    }

    .drug-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .drug-search-results.visible {
        display: block;
    }

    .drug-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }

    .drug-result-item:hover {
        background: #f7fafc;
    }

    .drug-result-item:last-child {
        border-bottom: none;
    }

    /* Status message */
    .status-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .status-message.success {
        background: #c6f6d5;
        color: #276749;
        display: block;
    }

    .status-message.error {
        background: #fed7d7;
        color: #c53030;
        display: block;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #a0aec0;
        grid-column: 1 / -1;
    }

    .empty-state-icon {
        font-size: 3em;
        margin-bottom: 10px;
    }

    /* Tooltip */
    .help-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        min-width: 16px;
        min-height: 16px;
        background: #e2e8f0;
        color: #718096;
        border-radius: 50%;
        font-size: 10px;
        font-weight: 600;
        cursor: help;
        margin-left: 6px;
        position: relative;
        line-height: 1;
        vertical-align: middle;
    }

    .help-icon:hover {
        background: #cbd5e0;
        color: #4a5568;
    }

    .help-icon .tooltip {
        display: none;
        position: absolute;
        bottom: calc(100% + 8px);
        left: 0;
        background: #2d3748;
        color: white;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 400;
        white-space: normal;
        width: 280px;
        line-height: 1.5;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        overflow: visible;
        height: auto;
        min-height: fit-content;
    }

    .help-icon .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 12px;
        border: 6px solid transparent;
        border-top-color: #2d3748;
    }

    .help-icon:hover .tooltip {
        display: block;
    }

    /* Modal error message */
    .modal-error-message {
        background: #fed7d7;
        color: #c53030;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 1px solid #fc8181;
        animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Modal shake animation for close protection */
    @keyframes modalShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .modal-content.shake {
        animation: modalShake 0.4s ease-in-out;
    }

    .modal-error-message::before {
        content: 'âš ï¸';
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-link" style="margin-bottom: 20px;">&#8592; í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <div style="display: block; text-align: center; padding-bottom: 10px; margin-bottom: 30px; border-bottom: 2px solid #e2e8f0;">
        <h1 style="color: #2d3748; font-size: 1.8em; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span>&#128100;</span>
            í™˜ì ê´€ë¦¬
        </h1>
        <p style="color: #718096; margin-top: 8px;">í™˜ìë³„ ì•½í’ˆ ì¬ê³  ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤</p>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div class="header-row">
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <span>ì „ì²´ í™˜ì:</span>
                <span class="stat-value" id="statTotal">0</span>ëª…
            </div>
            <div class="stat-item">
                <span>&#9888;&#65039; ë¶€ì¡± ìˆìŒ:</span>
                <span class="stat-value" id="statShortage">0</span>ëª…
            </div>
            <div class="stat-item">
                <span>&#10003; ì •ìƒ:</span>
                <span class="stat-value" id="statNormal">0</span>ëª…
            </div>
        </div>
        <div class="header-actions">
            <a href="/patient/suggest" class="btn btn-suggest" id="suggestLink" style="display: none; text-decoration: none;">&#128161; ì•½í’ˆ ì¶”ì²œ</a>
            <button class="btn btn-primary" onclick="openPatientModal()">+ ìƒˆ í™˜ì</button>
        </div>
    </div>

    <div class="search-filter-bar" style="margin-bottom: 20px;">
        <input type="text" class="search-input" id="searchInput"
               placeholder="í™˜ìëª…, ì£¼ë¯¼ë²ˆí˜¸ë¡œ ê²€ìƒ‰..."
               oninput="filterPatients()">
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">ì „ì²´</button>
            <button class="filter-btn" data-filter="shortage" onclick="setFilter('shortage')">âš ï¸ ë¶€ì¡±</button>
            <button class="filter-btn" data-filter="normal" onclick="setFilter('normal')">&#10003; ì •ìƒ</button>
        </div>
        <div class="sort-buttons">
            <button class="sort-btn active" data-sort="recent" onclick="setSort('recent')">ìµœê·¼ìˆœ</button>
            <button class="sort-btn" data-sort="name" onclick="setSort('name')">ê°€ë‚˜ë‹¤ìˆœ</button>
        </div>
    </div>

    <div class="patient-list" id="patientList">
        <div class="empty-state">
            <div class="empty-state-icon">&#128100;</div>
            <div>ë“±ë¡ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div style="margin-top: 10px; font-size: 14px;">"ìƒˆ í™˜ì" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™˜ìë¥¼ ë“±ë¡í•˜ì„¸ìš”.</div>
        </div>
    </div>
</div>

<!-- Patient Modal (Create/Edit) -->
<div id="patientModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">&#128100; ìƒˆ í™˜ì ë“±ë¡</h3>
            <span class="modal-close" onclick="closePatientModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- In-modal error message -->
            <div id="modalErrorMessage" class="modal-error-message" style="display: none;"></div>

            <!-- Basic Info -->
            <div class="form-section">
                <div class="form-section-title">&#128203; ê¸°ë³¸ ì •ë³´</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>í™˜ìëª… *</label>
                        <input type="text" id="inputPatientName" placeholder="í™˜ìëª…">
                    </div>
                    <div class="form-group">
                        <label>ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ *</label>
                        <input type="text" id="inputPatientBirth" maxlength="6" placeholder="ì˜ˆ: 900101" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë°©ë¬¸ ì£¼ê¸° (ì¼)
                            <span class="help-icon">?
                                <span class="tooltip">í™˜ìê°€ í‰ê· ì ìœ¼ë¡œ ëª‡ ì¼ë§ˆë‹¤ ë°©ë¬¸í•˜ëŠ”ì§€ ì…ë ¥í•˜ì„¸ìš”. ìµœì†Œ ì¬ê³  ë²„í¼ ê³„ì‚°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</span>
                            </span>
                        </label>
                        <input type="number" id="inputVisitCycle" placeholder="ì˜ˆ: 30" min="1">
                    </div>
                    <div class="form-group">
                        <label>ë©”ëª¨</label>
                        <input type="text" id="inputPatientMemo" placeholder="í™˜ì ë©”ëª¨">
                    </div>
                </div>
            </div>

            <!-- Drug List (only shown in edit mode) -->
            <div class="form-section" id="drugListSection" style="display: none;">
                <div class="form-section-title">
                    &#128138; ì²˜ë°© ì•½í’ˆ ëª©ë¡
                    <span class="help-icon">?
                        <span class="tooltip">ì´ í™˜ìì—ê²Œ ì²˜ë°©ë˜ëŠ” ì•½í’ˆ ëª©ë¡ì…ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ ê°€ 1íšŒ ì²˜ë°©ëŸ‰ ì´í•˜ì´ë©´ ë¶€ì¡±ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</span>
                    </span>
                </div>
                <div class="drug-list-section">
                    <table class="drug-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>ì•½í’ˆëª…</th>
                                <th style="width: 80px;">1íšŒì²˜ë°©ëŸ‰</th>
                                <th style="width: 80px;">í˜„ì¬ì¬ê³ </th>
                                <th style="width: 60px;">ìƒíƒœ</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="drugTableBody">
                            <tr class="empty-row">
                                <td colspan="6">ì—°ê²°ëœ ì•½í’ˆì´ ì—†ìŠµë‹ˆë‹¤</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="drug-search-container">
                        <input type="text" class="drug-search-input" id="drugSearchInput"
                               placeholder="ì•½í’ˆëª… ë˜ëŠ” ì•½í’ˆì½”ë“œë¡œ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€..."
                               oninput="searchDrugs()">
                        <div class="drug-search-results" id="drugSearchResults"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="modal-footer-left">
                <button class="btn btn-danger" id="deletePatientBtn" onclick="deletePatient()" style="display: none;">ì‚­ì œ</button>
            </div>
            <div class="modal-footer-right">
                <button class="btn btn-secondary" onclick="closePatientModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="savePatient()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Drug Registration Modal -->
<div id="confirmDrugModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>ğŸ’Š ì•½í’ˆ ë“±ë¡</h3>
            <span class="modal-close" onclick="closeConfirmDrugModal(false)">&times;</span>
        </div>
        <div class="modal-body" style="text-align: center; padding: 30px 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’Š</div>
            <div style="font-size: 16px; color: #2d3748; line-height: 1.6;">
                ë“±ë¡í•œ <strong id="confirmPatientName"></strong> í™˜ìì˜<br>
                ì‚¬ìš© ì•½í’ˆì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeConfirmDrugModal(false)" style="min-width: 100px;">ë‚˜ì¤‘ì—</button>
            <button class="btn btn-primary" onclick="closeConfirmDrugModal(true)" style="min-width: 100px;">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- Dosage Modal -->
<div id="dosageModal" class="modal">
    <div class="modal-content" style="max-width: 380px;">
        <div class="modal-header">
            <h3>&#128138; 1íšŒ ì²˜ë°©ëŸ‰ ì…ë ¥</h3>
            <span class="modal-close" onclick="closeDosageModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 15px; padding: 12px; background: #f7fafc; border-radius: 8px;">
                <div style="font-weight: 600; color: #2d3748;" id="dosageDrugName">-</div>
                <div style="color: #718096; font-size: 13px;" id="dosageDrugInfo">-</div>
            </div>
            <div class="form-group">
                <label>1íšŒ ì²˜ë°©ëŸ‰ *</label>
                <input type="number" id="inputDosage" placeholder="ì˜ˆ: 30" min="1" value="1">
                <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                    ì´ í™˜ìì—ê²Œ í•œ ë²ˆ ë°©ë¬¸ ì‹œ ì²˜ë°©í•˜ëŠ” ì•½í’ˆ ìˆ˜ëŸ‰
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div></div>
            <div class="modal-footer-right">
                <button class="btn btn-secondary" onclick="closeDosageModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmDosage()">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/jaego-core.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/confirm-modal.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.VERSION }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    var allPatients = [];
    var currentFilter = 'all';
    var currentSort = 'recent';
    var currentPatientId = null;
    var isEditMode = false;
    var patientDrugs = [];
    var searchTimeout = null;
    var pendingDrug = null;
    var pendingNewPatient = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadPatients();
        checkSuggestionStatus();
    });

    // Check if suggestion feature is active
    function checkSuggestionStatus() {
        fetch('/api/suggestion/status')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success' && data.data.active) {
                    document.getElementById('suggestLink').style.display = 'inline-flex';
                }
            })
            .catch(function(error) {
                console.log('Suggestion status check failed:', error);
            });
    }

    function loadPatients() {
        fetch('/api/patients-with-drugs')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    allPatients = data.data;
                    updateStats();
                    filterPatients();
                }
            })
            .catch(function(error) {
                showStatus('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            });
    }

    function updateStats() {
        var total = allPatients.length;
        var shortage = allPatients.filter(function(p) { return p.has_shortage; }).length;
        var normal = total - shortage;

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statShortage').textContent = shortage;
        document.getElementById('statNormal').textContent = normal;
    }

    function renderPatients(patients) {
        var listDiv = document.getElementById('patientList');

        if (patients.length === 0) {
            listDiv.innerHTML =
                '<div class="empty-state">' +
                    '<div class="empty-state-icon">&#128100;</div>' +
                    '<div>ë“±ë¡ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>' +
                    '<div style="margin-top: 10px; font-size: 14px;">"ìƒˆ í™˜ì" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í™˜ìë¥¼ ë“±ë¡í•˜ì„¸ìš”.</div>' +
                '</div>';
            return;
        }

        listDiv.innerHTML = patients.map(function(patient) {
            var shortageClass = patient.has_shortage ? 'has-shortage' : '';
            var statusBadges = '';
            if (patient.has_shortage) {
                statusBadges += '<span class="badge badge-shortage">&#9888;&#65039; ë¶€ì¡± ' + patient.shortage_count + 'ê°œ</span>';
            }
            if (patient.has_exact) {
                statusBadges += '<span class="badge badge-exact">&#127919; ë”±ë§ìŒ ' + patient.exact_count + 'ê°œ</span>';
            }
            if (!patient.has_shortage && !patient.has_exact && patient.drug_count > 0) {
                statusBadges = '<span class="badge badge-normal">&#10003; ì •ìƒ</span>';
            }

            // ë©”íƒ€ ì •ë³´ êµ¬ì„± (ìƒë…„ì›”ì¼, ë°©ë¬¸ì£¼ê¸°)
            var metaParts = [];
            if (patient.birth) metaParts.push(patient.birth);
            if (patient.visit_cycle) metaParts.push('ë°©ë¬¸ì£¼ê¸° ' + patient.visit_cycle + 'ì¼');
            var metaHtml = metaParts.length > 0
                ? '<div class="patient-meta">' + metaParts.join('<span class="patient-meta-separator">Â·</span>') + '</div>'
                : '';

            return '<div class="patient-card ' + shortageClass + '" data-id="' + patient.patient_id + '">' +
                '<div class="patient-card-header">' +
                    '<div class="patient-card-title">' +
                        '<div class="patient-name">' + escapeHtml(patient.patient_name) + '</div>' +
                        metaHtml +
                    '</div>' +
                    '<button class="btn btn-secondary" onclick="openEditModal(' + patient.patient_id + ')" style="padding: 6px 12px; font-size: 13px;">ê´€ë¦¬</button>' +
                '</div>' +
                (patient.memo ? '<div class="patient-info">' + escapeHtml(patient.memo.substring(0, 30)) + (patient.memo.length > 30 ? '...' : '') + '</div>' : '') +
                '<div class="patient-badges">' +
                    '<span class="badge badge-drug">&#128138; ì•½í’ˆ ' + patient.drug_count + 'ê°œ</span>' +
                    statusBadges +
                '</div>' +
            '</div>';
        }).join('');
    }

    function filterPatients() {
        var query = document.getElementById('searchInput').value.toLowerCase();
        var filtered = allPatients.slice();

        if (query) {
            filtered = filtered.filter(function(p) {
                return p.patient_name.toLowerCase().includes(query) ||
                    (p.birth && p.birth.includes(query));
            });
        }

        if (currentFilter === 'shortage') {
            filtered = filtered.filter(function(p) { return p.has_shortage; });
        } else if (currentFilter === 'normal') {
            filtered = filtered.filter(function(p) { return !p.has_shortage || p.drug_count === 0; });
        }

        if (currentSort === 'name') {
            filtered.sort(function(a, b) { return a.patient_name.localeCompare(b.patient_name, 'ko'); });
        } else if (currentSort === 'recent') {
            filtered.sort(function(a, b) { return new Date(b.updated_at || 0) - new Date(a.updated_at || 0); });
        }

        renderPatients(filtered);
    }

    function setFilter(filter) {
        currentFilter = filter;

        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.filter === filter);
        });

        filterPatients();
    }

    function setSort(sort) {
        currentSort = sort;

        document.querySelectorAll('.sort-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.sort === sort);
        });

        filterPatients();
    }

    // Modal Functions
    function openPatientModal() {
        isEditMode = false;
        currentPatientId = null;
        patientDrugs = [];

        hideModalError();
        document.getElementById('modalTitle').textContent = 'ğŸ‘¤ ìƒˆ í™˜ì ë“±ë¡';
        document.getElementById('inputPatientName').value = '';
        document.getElementById('inputPatientBirth').value = '';
        document.getElementById('inputVisitCycle').value = '';
        document.getElementById('inputPatientMemo').value = '';

        document.getElementById('drugListSection').style.display = 'none';
        document.getElementById('deletePatientBtn').style.display = 'none';

        document.getElementById('patientModal').classList.add('visible');
    }

    function openEditModal(patientId) {
        isEditMode = true;
        currentPatientId = patientId;

        hideModalError();
        document.getElementById('modalTitle').textContent = 'ğŸ‘¤ í™˜ì ê´€ë¦¬';
        document.getElementById('drugListSection').style.display = 'block';
        document.getElementById('deletePatientBtn').style.display = 'block';

        fetch('/api/patient/' + patientId + '/drugs-with-stock')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    var patient = data.patient;
                    patientDrugs = data.drugs;

                    document.getElementById('inputPatientName').value = patient.name || '';
                    document.getElementById('inputPatientBirth').value = patient.birth || '';
                    document.getElementById('inputVisitCycle').value = patient.visit_cycle || '';
                    document.getElementById('inputPatientMemo').value = patient.memo || '';

                    renderDrugTable();
                    document.getElementById('patientModal').classList.add('visible');
                }
            })
            .catch(function(error) {
                showStatus('í™˜ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            });
    }

    function closePatientModal() {
        document.getElementById('patientModal').classList.remove('visible');
        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchResults').classList.remove('visible');
    }

    function renderDrugTable() {
        var tbody = document.getElementById('drugTableBody');

        if (patientDrugs.length === 0) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6">ì—°ê²°ëœ ì•½í’ˆì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }

        tbody.innerHTML = patientDrugs.map(function(drug, index) {
            var statusIcon, statusText;
            if (drug.status === 'shortage') {
                statusIcon = '<span class="status-icon shortage">&#128308;</span>';
                statusText = 'ë¶€ì¡±';
            } else if (drug.status === 'exact') {
                statusIcon = '<span class="status-icon exact">&#127919;</span>';
                statusText = 'ë”±ë§ìŒ';
            } else {
                statusIcon = '<span class="status-icon sufficient">&#128994;</span>';
                statusText = 'ì¶©ë¶„';
            }

            return '<tr data-code="' + drug.drug_code + '">' +
                '<td>' + statusIcon + '</td>' +
                '<td>' +
                    '<div style="font-weight: 500;">' + escapeHtml(drug.drug_name) + '</div>' +
                    '<div style="font-size: 12px; color: #a0aec0;">' + drug.drug_code + '</div>' +
                '</td>' +
                '<td>' +
                    '<input type="number" value="' + drug.dosage + '" min="1" onchange="updateDosage(' + index + ', this.value)">' +
                '</td>' +
                '<td style="text-align: center;">' + drug.current_stock + '</td>' +
                '<td class="' + drug.status + '">' + statusText + '</td>' +
                '<td>' +
                    '<span class="remove-drug-btn" onclick="removeDrug(' + index + ')">&times;</span>' +
                '</td>' +
            '</tr>';
        }).join('');
    }

    function updateDosage(index, value) {
        patientDrugs[index].dosage = parseInt(value) || 1;
        var drug = patientDrugs[index];
        if (drug.current_stock < drug.dosage) {
            drug.status = 'shortage';
        } else if (drug.current_stock === drug.dosage) {
            drug.status = 'exact';
        } else {
            drug.status = 'sufficient';
        }
        renderDrugTable();
    }

    function removeDrug(index) {
        patientDrugs.splice(index, 1);
        renderDrugTable();
    }

    function searchDrugs() {
        clearTimeout(searchTimeout);
        var query = document.getElementById('drugSearchInput').value.trim();
        var resultsDiv = document.getElementById('drugSearchResults');

        if (query.length < 2) {
            resultsDiv.classList.remove('visible');
            return;
        }

        searchTimeout = setTimeout(function() {
            fetch('/api/search-inventory?q=' + encodeURIComponent(query))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'success' && data.results.length > 0) {
                        var existingCodes = patientDrugs.map(function(d) { return d.drug_code; });
                        var filtered = data.results.filter(function(d) {
                            return !existingCodes.includes(d['ì•½í’ˆì½”ë“œ']);
                        });

                        if (filtered.length > 0) {
                            resultsDiv.innerHTML = filtered.slice(0, 10).map(function(item) {
                                return '<div class="drug-result-item" onclick="openDosageModal(\'' + item['ì•½í’ˆì½”ë“œ'] + '\', \'' + escapeHtml(item['ì•½í’ˆëª…']) + '\', \'' + escapeHtml(item['ì œì•½íšŒì‚¬']) + '\', ' + item['í˜„ì¬_ì¬ê³ ìˆ˜ëŸ‰'] + ')">' +
                                    '<div style="font-weight: 500;">' + item['ì•½í’ˆëª…'] + '</div>' +
                                    '<div style="font-size: 13px; color: #718096;">' + item['ì•½í’ˆì½”ë“œ'] + ' | ì¬ê³ : ' + item['í˜„ì¬_ì¬ê³ ìˆ˜ëŸ‰'] + '</div>' +
                                '</div>';
                            }).join('');
                        } else {
                            resultsDiv.innerHTML = '<div style="padding: 12px; color: #a0aec0;">ì´ë¯¸ ëª¨ë‘ ì¶”ê°€ë¨</div>';
                        }
                        resultsDiv.classList.add('visible');
                    } else {
                        resultsDiv.innerHTML = '<div style="padding: 12px; color: #a0aec0;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                        resultsDiv.classList.add('visible');
                    }
                });
        }, 300);
    }

    function openDosageModal(drugCode, drugName, company, currentStock) {
        pendingDrug = { drugCode: drugCode, drugName: drugName, company: company, currentStock: currentStock };

        document.getElementById('dosageDrugName').textContent = drugName;
        document.getElementById('dosageDrugInfo').textContent = drugCode + ' | í˜„ì¬ ì¬ê³ : ' + currentStock;
        document.getElementById('inputDosage').value = 1;

        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchResults').classList.remove('visible');

        document.getElementById('dosageModal').classList.add('visible');
    }

    function closeDosageModal() {
        document.getElementById('dosageModal').classList.remove('visible');
        pendingDrug = null;
    }

    function openConfirmDrugModal(patientId, patientName) {
        pendingNewPatient = { id: patientId, name: patientName };
        document.getElementById('confirmPatientName').textContent = patientName;
        document.getElementById('confirmDrugModal').classList.add('visible');
    }

    function closeConfirmDrugModal(shouldRegister) {
        document.getElementById('confirmDrugModal').classList.remove('visible');

        if (shouldRegister && pendingNewPatient) {
            var patientId = pendingNewPatient.id;
            pendingNewPatient = null;
            setTimeout(function() {
                openEditModal(patientId);
            }, 100);
        } else {
            pendingNewPatient = null;
            showStatus('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }
    }

    function confirmDosage() {
        if (!pendingDrug) return;

        var dosage = parseInt(document.getElementById('inputDosage').value) || 1;
        var status;
        if (pendingDrug.currentStock < dosage) {
            status = 'shortage';
        } else if (pendingDrug.currentStock === dosage) {
            status = 'exact';
        } else {
            status = 'sufficient';
        }

        patientDrugs.push({
            drug_code: pendingDrug.drugCode,
            drug_name: pendingDrug.drugName,
            company: pendingDrug.company,
            dosage: dosage,
            current_stock: pendingDrug.currentStock,
            status: status
        });

        renderDrugTable();
        closeDosageModal();
    }

    function showModalError(message) {
        var errorDiv = document.getElementById('modalErrorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'flex';
        errorDiv.style.animation = 'none';
        errorDiv.offsetHeight;
        errorDiv.style.animation = 'shake 0.3s ease-in-out';
    }

    function hideModalError() {
        document.getElementById('modalErrorMessage').style.display = 'none';
    }

    async function savePatient() {
        hideModalError();

        var name = document.getElementById('inputPatientName').value.trim();
        var birth = document.getElementById('inputPatientBirth').value.trim();
        var visitCycle = document.getElementById('inputVisitCycle').value;
        var memo = document.getElementById('inputPatientMemo').value.trim();

        if (!name) {
            showModalError('í™˜ìëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
            document.getElementById('inputPatientName').focus();
            return;
        }

        if (!birth) {
            showModalError('ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
            document.getElementById('inputPatientBirth').focus();
            return;
        }

        if (birth.length !== 6 || !/^\d{6}$/.test(birth)) {
            showModalError('ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
            document.getElementById('inputPatientBirth').focus();
            return;
        }

        try {
            var patientData = {
                name: name,
                birth: birth || null,
                memo: memo || null,
                visit_cycle: visitCycle || null
            };

            var patientId = currentPatientId;

            if (isEditMode) {
                var response = await fetch('/api/patient/' + currentPatientId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patientData)
                });
                var data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message);
                }
            } else {
                var response = await fetch('/api/patient', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(patientData)
                });
                var data = await response.json();
                if (data.status !== 'success') {
                    throw new Error(data.message);
                }
                patientId = data.patient_id;
            }

            if (isEditMode && patientId) {
                var currentDrugsResponse = await fetch('/api/patient/' + patientId + '/drugs-with-stock');
                var currentDrugsData = await currentDrugsResponse.json();
                var currentDrugCodes = currentDrugsData.status === 'success'
                    ? currentDrugsData.drugs.map(function(d) { return d.drug_code; })
                    : [];

                var newDrugCodes = patientDrugs.map(function(d) { return d.drug_code; });

                for (var i = 0; i < currentDrugCodes.length; i++) {
                    var code = currentDrugCodes[i];
                    if (newDrugCodes.indexOf(code) === -1) {
                        await fetch('/api/patient/' + patientId + '/unlink-drug/' + code, {
                            method: 'DELETE'
                        });
                    }
                }

                for (var j = 0; j < patientDrugs.length; j++) {
                    var drug = patientDrugs[j];
                    await fetch('/api/patient/' + patientId + '/link-drug', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            drug_code: drug.drug_code,
                            dosage: drug.dosage
                        })
                    });
                }
            }

            closePatientModal();
            loadPatients();

            if (!isEditMode && patientId) {
                openConfirmDrugModal(patientId, name);
            } else {
                showStatus('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

        } catch (error) {
            showModalError('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        }
    }

    async function deletePatient() {
        if (!currentPatientId) return;

        var confirmed = await showConfirmModal({
            icon: 'ğŸ—‘ï¸',
            title: 'í™˜ì ì‚­ì œ',
            message: 'ì´ í™˜ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><br>ì—°ê²°ëœ ëª¨ë“  ì•½í’ˆ ì •ë³´ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.',
            confirmText: 'ì‚­ì œ',
            isDanger: true
        });

        if (!confirmed) return;

        try {
            var response = await fetch('/api/patient/' + currentPatientId, {
                method: 'DELETE'
            });
            var data = await response.json();

            if (data.status === 'success') {
                closePatientModal();
                loadPatients();
                showStatus('í™˜ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showStatus(data.message, 'error');
            }
        } catch (error) {
            showStatus('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
        }
    }

    function showStatus(message, type) {
        var statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = message;
        statusDiv.className = 'status-message ' + type;
        setTimeout(function() {
            statusDiv.className = 'status-message';
        }, 3000);
    }

    function escapeHtml(text) {
        if (!text) return '';
        var map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // Modal content check functions
    function hasPatientModalContent() {
        var name = document.getElementById('inputPatientName').value.trim();
        var birth = document.getElementById('inputPatientBirth').value.trim();
        var visitCycle = document.getElementById('inputVisitCycle').value;
        var memo = document.getElementById('inputPatientMemo').value.trim();

        if (isEditMode) {
            return true;
        }

        return name !== '' || birth !== '' || visitCycle !== '' || memo !== '';
    }

    function hasDosageModalContent() {
        var dosage = document.getElementById('inputDosage').value;
        return dosage !== '' && dosage !== '1';
    }

    function shakeModal(modalId) {
        var modal = document.getElementById(modalId);
        var content = modal.querySelector('.modal-content');
        content.classList.add('shake');
        setTimeout(function() {
            content.classList.remove('shake');
        }, 400);
    }

    async function tryClosePatientModal() {
        if (hasPatientModalContent()) {
            shakeModal('patientModal');
            var confirmed = await showConfirmModal({
                icon: 'âš ï¸',
                title: 'ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤',
                message: 'ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì…ë ¥í•œ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                confirmText: 'ë‹«ê¸°',
                isDanger: true
            });
            if (confirmed) {
                closePatientModal();
            }
        } else {
            closePatientModal();
        }
    }

    async function tryCloseDosageModal() {
        if (hasDosageModalContent()) {
            shakeModal('dosageModal');
            var confirmed = await showConfirmModal({
                icon: 'âš ï¸',
                title: 'ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤',
                message: 'ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì…ë ¥í•œ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                confirmText: 'ë‹«ê¸°',
                isDanger: true
            });
            if (confirmed) {
                closeDosageModal();
            }
        } else {
            closeDosageModal();
        }
    }

    // Close modal on outside click
    document.getElementById('patientModal').addEventListener('click', function(e) {
        if (e.target === this) tryClosePatientModal();
    });

    document.getElementById('dosageModal').addEventListener('click', function(e) {
        if (e.target === this) tryCloseDosageModal();
    });

    // ESC to close modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            var customConfirmModal = document.getElementById('confirmModal');
            if (customConfirmModal && customConfirmModal.classList.contains('visible')) {
                closeConfirmModal(false);
                return;
            }

            var patientModal = document.getElementById('patientModal');
            var dosageModal = document.getElementById('dosageModal');
            var confirmDrugModal = document.getElementById('confirmDrugModal');

            if (confirmDrugModal.classList.contains('visible')) {
                closeConfirmDrugModal(false);
            } else if (dosageModal.classList.contains('visible')) {
                tryCloseDosageModal();
            } else if (patientModal.classList.contains('visible')) {
                tryClosePatientModal();
            }
        }
    });

    document.getElementById('confirmDrugModal').addEventListener('click', function(e) {
        if (e.target === this) closeConfirmDrugModal(false);
    });
</script>
{% endblock %}
