{% extends "base.html" %}

{% block title %}약품 추천 - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block page_styles %}
<style>
    body {
        font-family: var(--font-family);
        background: var(--gray-100);
        min-height: 100vh;
        padding: var(--space-5);
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        padding: var(--space-6);
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        color: var(--brand-primary);
        text-decoration: none;
        margin-bottom: var(--space-5);
        font-size: var(--text-sm);
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .back-link .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .header {
        text-align: center;
        margin-bottom: var(--space-6);
    }

    .header h1 {
        font-size: var(--text-2xl);
        color: var(--gray-900);
        margin-bottom: var(--space-2);
    }

    .header p {
        color: var(--gray-500);
        font-size: var(--text-sm);
    }

    /* 진행 바 */
    .progress-section {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-6);
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
    }

    .progress-label {
        font-size: var(--text-sm);
        color: var(--gray-600);
    }

    .progress-count {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--brand-primary);
    }

    .progress-bar {
        height: 8px;
        background: var(--gray-200);
        border-radius: var(--radius-sm);
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: var(--brand-primary);
        border-radius: var(--radius-sm);
        transition: width 0.3s ease;
    }

    /* 비활성 상태 */
    .inactive-state {
        text-align: center;
        padding: var(--space-12) var(--space-5);
    }

    .inactive-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-5);
        color: var(--gray-400);
    }

    .inactive-title {
        font-size: var(--text-xl);
        color: var(--gray-900);
        margin-bottom: var(--space-3);
    }

    .inactive-message {
        color: var(--gray-500);
        margin-bottom: var(--space-6);
        line-height: 1.6;
    }

    /* 제안 카드 */
    .suggestion-card {
        background: var(--gray-50);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        margin-bottom: var(--space-6);
        animation: fadeIn 0.3s ease;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-4);
    }

    .drug-info h2 {
        font-size: var(--text-lg);
        color: var(--gray-900);
        margin-bottom: var(--space-1);
    }

    .drug-meta {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    .similarity-badge {
        background: var(--brand-primary);
        color: white;
        padding: var(--space-2) var(--space-4);
        border-radius: var(--radius-full);
        font-weight: 600;
        font-size: var(--text-sm);
    }

    /* 메트릭 카드 */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--space-3);
        margin-bottom: var(--space-4);
    }

    .metric-card {
        background: white;
        border-radius: var(--radius-md);
        padding: var(--space-3);
        text-align: center;
    }

    .metric-value {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
    }

    .metric-label {
        font-size: var(--text-xs);
        color: var(--gray-500);
        margin-top: var(--space-1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-1);
    }

    /* 도움말 아이콘 툴팁 */
    .help-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        min-width: 16px;
        min-height: 16px;
        font-size: 10px;
        font-weight: 600;
        color: var(--gray-500);
        background: var(--gray-200);
        border-radius: 50%;
        cursor: help;
        position: relative;
        flex-shrink: 0;
        line-height: 1;
        vertical-align: middle;
    }

    .help-icon:hover {
        background: var(--gray-300);
        color: var(--gray-600);
    }

    .help-icon .help-tip {
        display: none;
        position: fixed;
        background: var(--gray-800);
        color: white;
        padding: var(--space-3);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: 400;
        width: 250px;
        white-space: normal;
        text-align: left;
        line-height: 1.5;
        z-index: var(--z-tooltip);
        box-shadow: var(--shadow-lg);
        pointer-events: none;
        box-sizing: border-box;
        overflow: visible;
        height: auto;
        min-height: fit-content;
    }

    .help-icon:hover .help-tip {
        display: block;
    }

    /* 스파크라인 */
    .sparkline-container {
        background: white;
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-5);
    }

    .sparkline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
    }

    .sparkline-title {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    .sparkline-stock {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    .sparkline-stock strong {
        color: var(--gray-700);
    }

    .chart-container {
        position: relative;
    }

    .chart-container svg {
        display: block;
    }

    /* 유사 약품 섹션 */
    .similar-drugs-container {
        background: white;
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-5);
    }

    .similar-drugs-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .similar-drugs-header:hover {
        opacity: 0.8;
    }

    .similar-drugs-title {
        font-size: var(--text-xs);
        color: var(--gray-500);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .similar-drugs-title .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        color: var(--brand-primary);
    }

    .similar-drugs-toggle {
        font-size: 10px;
        color: var(--gray-400);
        transition: transform 0.2s;
    }

    .similar-drugs-list {
        margin-top: var(--space-3);
    }

    .similar-drug-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3);
        background: var(--gray-50);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-2);
        border-left: 3px solid var(--brand-primary);
    }

    .similar-drug-item:last-child {
        margin-bottom: 0;
    }

    .similar-drug-info {
        flex: 1;
        min-width: 0;
    }

    .similar-drug-name {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--gray-900);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 280px;
    }

    .similar-drug-interval {
        font-size: var(--text-xs);
        color: var(--gray-500);
        margin-top: 2px;
    }

    .similar-drug-badge {
        flex-shrink: 0;
        background: var(--brand-primary-subtle);
        color: var(--brand-primary-dark);
        font-size: var(--text-xs);
        font-weight: 500;
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-sm);
        margin-left: var(--space-3);
    }

    /* 등록 폼 */
    .register-form {
        background: white;
        border-radius: var(--radius-lg);
        padding: var(--space-5);
    }

    .form-title {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--space-4);
    }

    .form-row {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: var(--text-sm);
        color: var(--gray-600);
        margin-bottom: var(--space-2);
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    /* Patient Combobox */
    .patient-combobox {
        position: relative;
    }

    .patient-combobox input {
        padding-right: 36px;
    }

    .patient-combobox .clear-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        display: none;
    }

    .patient-combobox .clear-btn:hover {
        color: var(--gray-500);
    }

    .patient-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        margin-top: var(--space-1);
        max-height: 240px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: var(--shadow-lg);
        display: none;
    }

    .patient-dropdown.visible {
        display: block;
    }

    .patient-option {
        padding: var(--space-3);
        cursor: pointer;
        border-bottom: 1px solid var(--gray-100);
    }

    .patient-option:last-child {
        border-bottom: none;
    }

    .patient-option:hover {
        background: var(--gray-50);
    }

    .patient-option.selected {
        background: var(--brand-primary-subtle);
    }

    .patient-option .name {
        font-weight: 500;
        color: var(--gray-900);
    }

    .patient-option .birth {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    .patient-option.new-patient {
        background: var(--warning-subtle);
        color: var(--warning-dark);
        font-weight: 500;
    }

    .patient-option.new-patient:hover {
        background: var(--warning-light);
    }

    .no-results {
        padding: var(--space-3);
        text-align: center;
        color: var(--gray-400);
        font-size: var(--text-sm);
    }

    /* New Patient Mini Modal */
    .mini-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 200;
        justify-content: center;
        align-items: center;
    }

    .mini-modal.visible {
        display: flex;
    }

    .mini-modal-content {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        width: 90%;
        max-width: 360px;
        box-shadow: var(--shadow-xl);
    }

    /* Modal shake animation */
    @keyframes modalShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .mini-modal-content.shake {
        animation: modalShake 0.4s ease-in-out;
    }

    .mini-modal-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--space-2);
    }

    .mini-modal-subtitle {
        font-size: var(--text-sm);
        color: var(--gray-500);
        margin-bottom: var(--space-5);
    }

    .mini-modal .form-group {
        margin-bottom: var(--space-4);
    }

    .mini-modal-buttons {
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
    }

    .button-row {
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
    }

    .btn {
        padding: var(--space-3) var(--space-6);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-primary {
        background: var(--brand-primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--brand-primary-dark);
    }

    .btn-secondary {
        background: var(--gray-200);
        color: var(--gray-600);
    }

    .btn-secondary:hover {
        background: var(--gray-300);
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .skip-count {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    /* 신규 약품 섹션 */
    .new-drugs-section {
        margin-top: var(--space-6);
        border-top: 1px solid var(--gray-200);
        padding-top: var(--space-6);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: var(--space-3);
        background: var(--gray-50);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-3);
    }

    .section-header:hover {
        background: var(--gray-100);
    }

    .section-title {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--gray-600);
    }

    .section-count {
        background: var(--gray-200);
        color: var(--gray-600);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
    }

    .new-drugs-list {
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }

    .new-drugs-list.visible {
        display: block;
    }

    .new-drug-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3);
        border-bottom: 1px solid var(--gray-100);
    }

    .new-drug-item:last-child {
        border-bottom: none;
    }

    .new-drug-name {
        font-size: var(--text-sm);
        color: var(--gray-900);
    }

    .new-drug-peaks {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    /* 건너뛴 약품 섹션 */
    .skipped-drugs-section {
        margin-top: var(--space-6);
        border-top: 1px solid var(--gray-200);
        padding-top: var(--space-6);
    }

    .skipped-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3);
        background: var(--warning-subtle);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-3);
    }

    .skipped-header-left {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        cursor: pointer;
        flex: 1;
    }

    .skipped-header-left:hover {
        opacity: 0.8;
    }

    .skipped-section-title {
        font-size: var(--text-sm);
        font-weight: 600;
        color: var(--warning-dark);
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .skipped-section-title .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
    }

    .skipped-section-count {
        background: var(--warning);
        color: var(--warning-darker);
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .reset-skipped-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        background: var(--warning);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s;
        margin-left: var(--space-3);
    }

    .reset-skipped-btn:hover {
        background: var(--warning-dark);
        transform: scale(1.05);
    }

    .reset-skipped-btn .icon {
        width: 18px;
        height: 18px;
        color: white;
    }

    .skipped-drugs-list {
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }

    .skipped-drugs-list.visible {
        display: block;
    }

    .skipped-drug-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3);
        border-bottom: 1px solid var(--gray-100);
        cursor: pointer;
        transition: background 0.2s;
    }

    .skipped-drug-item:last-child {
        border-bottom: none;
    }

    .skipped-drug-item:hover {
        background: var(--warning-subtle);
    }

    .skipped-drug-info {
        flex: 1;
    }

    .skipped-drug-name {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--gray-900);
    }

    .skipped-drug-code {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    .skipped-drug-badge {
        background: var(--warning);
        color: var(--warning-darker);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: 500;
    }

    /* 완료 상태 */
    .complete-state {
        text-align: center;
        padding: var(--space-12) var(--space-5);
    }

    .complete-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto var(--space-5);
        color: var(--success);
    }

    .complete-title {
        font-size: var(--text-xl);
        color: var(--gray-900);
        margin-bottom: var(--space-3);
    }

    .complete-message {
        color: var(--gray-500);
        margin-bottom: var(--space-6);
        line-height: 1.6;
    }

    /* Info Box */
    .info-box {
        background: var(--brand-primary-subtle);
        border-left: 4px solid var(--brand-primary);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-6);
        font-size: var(--text-sm);
        color: var(--brand-primary-dark);
        overflow: hidden;
    }

    .info-box-header {
        padding: var(--space-3) var(--space-4);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }

    .info-box-header:hover {
        background: rgba(13, 148, 136, 0.1);
    }

    .info-box-title {
        color: var(--brand-primary-dark);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }

    .info-box-title .icon {
        width: var(--icon-md);
        height: var(--icon-md);
    }

    .info-box-arrow {
        color: var(--brand-primary);
        font-size: 0.8em;
        transition: transform 0.3s ease;
    }

    .info-box-arrow.open {
        transform: rotate(180deg);
    }

    .info-box-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .info-box-content.open {
        max-height: 300px;
    }

    .info-box-body {
        padding: 0 var(--space-4) var(--space-4) var(--space-4);
        line-height: 1.6;
    }

    /* 로딩 */
    .loading {
        text-align: center;
        padding: var(--space-8);
        color: var(--gray-500);
    }

    /* 등록 완료 모달 */
    .success-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 300;
        justify-content: center;
        align-items: center;
    }

    .success-modal.visible {
        display: flex;
    }

    .success-modal-content {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        width: 90%;
        max-width: 420px;
        box-shadow: var(--shadow-xl);
        animation: modalPop 0.3s ease;
    }

    @keyframes modalPop {
        from { opacity: 0; transform: scale(0.95) translateY(-10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .success-header {
        text-align: center;
        margin-bottom: var(--space-5);
    }

    .success-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto var(--space-3);
        color: var(--success);
    }

    .success-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--space-1);
    }

    .success-subtitle {
        font-size: var(--text-sm);
        color: var(--gray-500);
    }

    .success-info {
        background: var(--brand-primary-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-6);
    }

    .success-info-row {
        display: flex;
        justify-content: space-between;
        font-size: var(--text-sm);
    }

    .success-info-row:not(:last-child) {
        margin-bottom: var(--space-2);
    }

    .success-info-label {
        color: var(--gray-500);
    }

    .success-info-value {
        color: var(--gray-900);
        font-weight: 500;
    }

    .success-options {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }

    .success-option-btn {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-4);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }

    .success-option-btn:hover {
        border-color: var(--brand-primary);
        background: var(--brand-primary-subtle);
    }

    .success-option-btn.primary {
        border-color: var(--brand-primary);
        background: var(--brand-primary-subtle);
    }

    .success-option-icon {
        width: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .success-option-icon .icon {
        width: var(--icon-lg);
        height: var(--icon-lg);
        color: var(--brand-primary);
    }

    .success-option-text {
        flex: 1;
    }

    .success-option-title {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--gray-900);
        margin-bottom: 2px;
    }

    .success-option-desc {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    /* 환자 약품 목록 모달 */
    .patient-drugs-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 350;
        justify-content: center;
        align-items: center;
    }

    .patient-drugs-modal.visible {
        display: flex;
    }

    .patient-drugs-content {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-xl);
    }

    .patient-drugs-header {
        margin-bottom: var(--space-4);
    }

    .patient-drugs-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--space-1);
    }

    .patient-drugs-subtitle {
        font-size: var(--text-sm);
        color: var(--gray-500);
    }

    .patient-drugs-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: var(--space-4);
    }

    .patient-drug-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-2);
        cursor: pointer;
        transition: all 0.2s;
    }

    .patient-drug-item:hover {
        border-color: var(--brand-primary);
        background: var(--brand-primary-subtle);
    }

    .patient-drug-info {
        flex: 1;
    }

    .patient-drug-name {
        font-size: var(--text-sm);
        font-weight: 500;
        color: var(--gray-900);
    }

    .patient-drug-meta {
        font-size: var(--text-xs);
        color: var(--gray-500);
        margin-top: 2px;
    }

    .patient-drug-score {
        background: var(--brand-primary);
        color: white;
        padding: var(--space-1) var(--space-3);
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .patient-drugs-empty {
        text-align: center;
        padding: var(--space-8) var(--space-5);
        color: var(--gray-400);
    }

    .patient-drugs-footer {
        display: flex;
        justify-content: flex-end;
    }

    /* 약품 검색 박스 */
    .drug-search-box {
        position: relative;
        margin-bottom: var(--space-4);
    }

    .drug-search-box input {
        width: 100%;
        padding: var(--space-3) var(--space-8) var(--space-3) var(--space-4);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        transition: border-color 0.2s;
    }

    .drug-search-box input:focus {
        outline: none;
        border-color: var(--brand-primary);
    }

    .drug-search-clear {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--gray-400);
        font-size: 20px;
        cursor: pointer;
        display: none;
    }

    .drug-search-clear.visible {
        display: block;
    }

    .drug-search-clear:hover {
        color: var(--gray-500);
    }

    /* 처방량 입력 영역 */
    .dosage-input-area {
        background: var(--brand-primary-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
        border: 2px solid var(--brand-primary);
    }

    .selected-drug-info {
        margin-bottom: var(--space-3);
    }

    .selected-drug-name {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--gray-900);
    }

    .selected-drug-meta {
        font-size: var(--text-xs);
        color: var(--gray-500);
        margin-top: 2px;
    }

    .dosage-form-row {
        margin-bottom: var(--space-3);
    }

    .dosage-form-row label {
        display: block;
        font-size: var(--text-sm);
        color: var(--gray-600);
        margin-bottom: var(--space-1);
    }

    .dosage-form-row input {
        width: 100%;
        padding: var(--space-3);
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }

    .dosage-form-row input:focus {
        outline: none;
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px var(--brand-primary-subtle);
    }

    .dosage-buttons {
        display: flex;
        gap: var(--space-2);
        justify-content: flex-end;
    }

    .dosage-buttons .btn {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
    }

    /* 등록된 약품 섹션 */
    .registered-drugs-section {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: var(--space-3);
        margin-bottom: var(--space-4);
        border: 1px solid var(--gray-200);
    }

    .registered-drugs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
    }

    .registered-drugs-label {
        font-size: var(--text-xs);
        font-weight: 600;
        color: var(--gray-500);
    }

    .registered-drugs-count {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    .registered-drugs-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        max-height: 80px;
        overflow-y: auto;
    }

    .registered-drug-tag {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        background: var(--info-subtle);
        color: var(--info-dark);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .registered-drug-tag .check {
        color: var(--info);
    }

    .registered-drugs-empty {
        font-size: var(--text-xs);
        color: var(--gray-400);
        font-style: italic;
    }

    /* 검색 결과에서 이미 등록된 약품 표시 */
    .patient-drug-item.already-registered {
        opacity: 0.6;
        background: var(--gray-100);
        cursor: not-allowed;
    }

    .patient-drug-item.already-registered:hover {
        border-color: var(--gray-200);
        background: var(--gray-100);
    }

    .patient-drug-item.already-registered .patient-drug-name::after {
        content: ' (등록됨)';
        color: var(--gray-400);
        font-size: var(--text-xs);
    }

    /* 약품에 환자 추가 모달 */
    .drug-patients-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 350;
        justify-content: center;
        align-items: center;
    }

    .drug-patients-modal.visible {
        display: flex;
    }

    .drug-patients-content {
        background: white;
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        width: 90%;
        max-width: 500px;
        overflow: visible;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-xl);
    }

    .drug-patients-header {
        margin-bottom: var(--space-4);
    }

    .drug-patients-title {
        font-size: var(--text-lg);
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--space-1);
    }

    .drug-patients-subtitle {
        font-size: var(--text-sm);
        color: var(--gray-500);
    }

    /* 등록된 환자 섹션 */
    .registered-patients-section {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: var(--space-3);
        margin-bottom: var(--space-4);
        border: 1px solid var(--gray-200);
    }

    .registered-patients-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-2);
    }

    .registered-patients-label {
        font-size: var(--text-xs);
        font-weight: 600;
        color: var(--gray-500);
    }

    .registered-patients-count {
        font-size: var(--text-xs);
        color: var(--gray-400);
    }

    .registered-patients-list {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        max-height: 80px;
        overflow-y: auto;
    }

    .registered-patient-tag {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        background: var(--warning-subtle);
        color: var(--warning-dark);
        padding: var(--space-1) var(--space-2);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .registered-patient-tag .check {
        color: var(--warning);
    }

    .registered-patients-empty {
        font-size: var(--text-xs);
        color: var(--gray-400);
        font-style: italic;
    }

    /* 환자 검색 박스 */
    .patient-search-box {
        position: relative;
        margin-bottom: var(--space-4);
    }

    .patient-search-box input {
        width: 100%;
        padding: var(--space-3) var(--space-4);
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        transition: border-color 0.2s;
    }

    .patient-search-box input:focus {
        outline: none;
        border-color: var(--brand-primary);
    }

    .patient-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        margin-top: var(--space-1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: var(--shadow-lg);
        display: none;
    }

    .patient-search-results.visible {
        display: block;
    }

    .patient-search-item {
        padding: var(--space-3) var(--space-4);
        cursor: pointer;
        border-bottom: 1px solid var(--gray-100);
        transition: background 0.2s;
    }

    .patient-search-item:last-child {
        border-bottom: none;
    }

    .patient-search-item:hover {
        background: var(--brand-primary-subtle);
    }

    .patient-search-item.already-registered {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--gray-50);
    }

    .patient-search-item.already-registered:hover {
        background: var(--gray-50);
    }

    .patient-search-item .name {
        font-weight: 500;
        color: var(--gray-900);
    }

    .patient-search-item .birth {
        font-size: var(--text-xs);
        color: var(--gray-500);
    }

    .patient-search-item.new-patient {
        background: var(--warning-subtle);
        color: var(--warning-dark);
        font-weight: 500;
    }

    .patient-search-item.new-patient:hover {
        background: var(--warning-light);
    }

    /* 환자 처방량 입력 영역 */
    .patient-dosage-area {
        background: var(--brand-primary-subtle);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
        margin-bottom: var(--space-4);
        border: 2px solid var(--brand-primary);
    }

    .selected-patient-info {
        margin-bottom: var(--space-3);
    }

    .selected-patient-name {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--gray-900);
    }

    .selected-patient-birth {
        font-size: var(--text-xs);
        color: var(--gray-500);
        margin-top: 2px;
    }

    .drug-patients-footer {
        display: flex;
        justify-content: flex-end;
    }

    /* 반응형 */
    @media (max-width: 600px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-row {
            flex-direction: column;
        }

        .button-row {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .success-modal-content {
            margin: var(--space-5);
        }

        .patient-drugs-content {
            margin: var(--space-5);
            max-height: 90vh;
        }
    }
</style>
{% endblock %}

{% block toast_container %}
{% include 'partials/_toast_container.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <a href="/patient/manage" class="back-link">
        <svg class="icon"><use href="#icon-arrow-left"></use></svg>
        환자 관리로 돌아가기
    </a>

    <div class="header">
        <h1>약품 추천</h1>
        <p>이 약품을 사용하는 환자는 누구입니까?</p>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        <div class="info-box-header" onclick="toggleInfoBox()">
            <span class="info-box-title">
                <svg class="icon"><use href="#icon-info"></use></svg>
                이 기능은?
            </span>
            <span class="info-box-arrow" id="info-box-arrow">▼</span>
        </div>
        <div class="info-box-content" id="info-box-content">
            <div class="info-box-body">
                약품의 월별 사용량 패턴을 분석하여 <strong>주기적으로 사용되는 약품</strong>을 추천합니다.<br><br>
                주기적 패턴은 특정 환자가 정기적으로 복용하는 약품일 가능성이 높습니다.
                추천된 약품이 어떤 환자의 것인지 확인하여 등록하면, 향후 해당 환자의 약품 재고 관리에 도움이 됩니다.<br><br>
                <strong>유사도</strong>: 이미 등록된 약품들의 패턴과 얼마나 비슷한지 나타냅니다.
            </div>
        </div>
    </div>

    <!-- 진행 바 -->
    <div class="progress-section" id="progressSection" style="display: none;">
        <div class="progress-header">
            <span class="progress-label">진행 상황</span>
            <span class="progress-count" id="progressCount">0 / 0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- 메인 컨텐츠 영역 -->
    <div id="mainContent">
        <div class="loading">로딩 중...</div>
    </div>

    <!-- 건너뛴 약품 섹션 -->
    <div class="skipped-drugs-section" id="skippedDrugsSection" style="display: none;">
        <div class="skipped-section-header">
            <div class="skipped-header-left" onclick="toggleSkippedDrugs()">
                <span class="skipped-section-title">
                    <svg class="icon"><use href="#icon-file-text"></use></svg>
                    건너뛴 약품
                </span>
                <span class="skipped-section-count" id="skippedDrugsCount">0개</span>
            </div>
            <button class="reset-skipped-btn" onclick="resetAllSkippedDrugs()" title="전체 되돌리기">
                <svg class="icon"><use href="#icon-refresh-cw"></use></svg>
            </button>
        </div>
        <div class="skipped-drugs-list" id="skippedDrugsList"></div>
    </div>

    <!-- 데이터 부족 약품 섹션 -->
    <div class="new-drugs-section" id="newDrugsSection" style="display: none;">
        <div class="section-header" onclick="toggleNewDrugs()">
            <span class="section-title">데이터 부족 약품</span>
            <span class="section-count" id="newDrugsCount">0개</span>
        </div>
        <div class="new-drugs-list" id="newDrugsList"></div>
    </div>
</div>

<!-- 신규 환자 등록 모달 -->
<div class="mini-modal" id="newPatientModal">
    <div class="mini-modal-content">
        <div class="mini-modal-title">새 환자 등록</div>
        <div class="mini-modal-subtitle" id="newPatientName">홍길동</div>
        <div class="form-group">
            <label for="newPatientBirth">주민번호 앞자리 *</label>
            <input type="text" id="newPatientBirth" placeholder="예: 900101" maxlength="6">
        </div>
        <div class="mini-modal-buttons">
            <button class="btn btn-secondary" onclick="closeNewPatientModal()">취소</button>
            <button class="btn btn-primary" onclick="createNewPatient()">등록</button>
        </div>
    </div>
</div>

<!-- 등록 완료 모달 -->
<div class="success-modal" id="successModal">
    <div class="success-modal-content">
        <div class="success-header">
            <svg class="success-icon"><use href="#icon-check-circle"></use></svg>
            <div class="success-title">등록 완료</div>
            <div class="success-subtitle" id="successSubtitle">약품이 환자에게 등록되었습니다</div>
        </div>
        <div class="success-info">
            <div class="success-info-row">
                <span class="success-info-label">약품</span>
                <span class="success-info-value" id="successDrugName">-</span>
            </div>
            <div class="success-info-row">
                <span class="success-info-label">환자</span>
                <span class="success-info-value" id="successPatientName">-</span>
            </div>
            <div class="success-info-row">
                <span class="success-info-label">처방량</span>
                <span class="success-info-value" id="successDosage">-</span>
            </div>
        </div>
        <div class="success-options">
            <button class="success-option-btn" onclick="addAnotherPatient()">
                <span class="success-option-icon">
                    <svg class="icon"><use href="#icon-users"></use></svg>
                </span>
                <div class="success-option-text">
                    <div class="success-option-title">이 약품에 환자 추가</div>
                    <div class="success-option-desc">같은 약품을 사용하는 다른 환자 등록</div>
                </div>
            </button>
            <button class="success-option-btn" onclick="showPatientDrugs()">
                <span class="success-option-icon">
                    <svg class="icon"><use href="#icon-pill"></use></svg>
                </span>
                <div class="success-option-text">
                    <div class="success-option-title" id="patientDrugsTitle">환자의 다른 약품</div>
                    <div class="success-option-desc">이 환자가 사용할 수 있는 다른 약품 확인</div>
                </div>
            </button>
            <button class="success-option-btn" onclick="goToNextSuggestion()">
                <span class="success-option-icon">
                    <svg class="icon"><use href="#icon-arrow-right"></use></svg>
                </span>
                <div class="success-option-text">
                    <div class="success-option-title">다음 추천으로</div>
                    <div class="success-option-desc">다음 약품 추천 보기</div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- 환자 약품 등록 모달 (검색 기반) -->
<div class="patient-drugs-modal" id="patientDrugsModal">
    <div class="patient-drugs-content">
        <div class="patient-drugs-header">
            <div class="patient-drugs-title" id="patientDrugsModalTitle">환자의 다른 약품</div>
            <div class="patient-drugs-subtitle" id="patientDrugsModalSubtitle">약품을 검색하여 등록하세요</div>
        </div>

        <!-- 이미 등록된 약품 목록 -->
        <div class="registered-drugs-section" id="registeredDrugsSection">
            <div class="registered-drugs-header">
                <span class="registered-drugs-label">등록된 약품</span>
                <span class="registered-drugs-count" id="registeredDrugsCount">0개</span>
            </div>
            <div class="registered-drugs-list" id="registeredDrugsList">
                <!-- 등록된 약품 태그들 -->
            </div>
        </div>

        <!-- 검색 입력 -->
        <div class="drug-search-box">
            <input type="text" id="drugSearchInput" placeholder="약품명 또는 약품코드로 검색..." autocomplete="off" oninput="onDrugSearchInput()">
            <button class="drug-search-clear" id="drugSearchClear" onclick="clearDrugSearch()">&times;</button>
        </div>

        <!-- 검색 결과 목록 -->
        <div class="patient-drugs-list" id="patientDrugsList">
            <div class="patient-drugs-empty">약품명을 입력하여 검색하세요</div>
        </div>

        <!-- 처방량 입력 영역 (선택 후 표시) -->
        <div class="dosage-input-area" id="dosageInputArea" style="display: none;">
            <div class="selected-drug-info" id="selectedDrugInfo">
                <div class="selected-drug-name" id="selectedDrugName">-</div>
                <div class="selected-drug-meta" id="selectedDrugMeta">-</div>
            </div>
            <div class="dosage-form-row">
                <label for="patientDrugDosage">1회 처방량</label>
                <input type="number" id="patientDrugDosage" value="1" min="1">
            </div>
            <div class="dosage-buttons">
                <button class="btn btn-secondary" onclick="cancelDrugSelection()">취소</button>
                <button class="btn btn-primary" onclick="registerPatientDrug()">등록</button>
            </div>
        </div>

        <div class="patient-drugs-footer">
            <button class="btn btn-secondary" onclick="closePatientDrugsModal()">닫기</button>
        </div>
    </div>
</div>

<!-- 약품에 환자 추가 모달 -->
<div class="drug-patients-modal" id="drugPatientsModal">
    <div class="drug-patients-content">
        <div class="drug-patients-header">
            <div class="drug-patients-title" id="drugPatientsModalTitle">약품에 환자 추가</div>
            <div class="drug-patients-subtitle" id="drugPatientsModalSubtitle">환자를 검색하여 등록하세요</div>
        </div>

        <!-- 이미 등록된 환자 목록 -->
        <div class="registered-patients-section" id="registeredPatientsSection">
            <div class="registered-patients-header">
                <span class="registered-patients-label">등록된 환자</span>
                <span class="registered-patients-count" id="registeredPatientsCount">0명</span>
            </div>
            <div class="registered-patients-list" id="registeredPatientsList">
                <!-- 등록된 환자 태그들 -->
            </div>
        </div>

        <!-- 환자 검색 입력 -->
        <div class="patient-search-box">
            <input type="text" id="modalPatientSearchInput" placeholder="환자명으로 검색..." autocomplete="off" oninput="onModalPatientSearchInput()" onfocus="showModalPatientResults()">
            <div class="patient-search-results" id="modalPatientSearchResults"></div>
        </div>

        <!-- 처방량 입력 영역 (선택 후 표시) -->
        <div class="patient-dosage-area" id="patientDosageArea" style="display: none;">
            <div class="selected-patient-info" id="selectedPatientInfo">
                <div class="selected-patient-name" id="selectedPatientName">-</div>
                <div class="selected-patient-birth" id="selectedPatientBirth">-</div>
            </div>
            <div class="dosage-form-row">
                <label for="modalPatientDosage">1회 처방량</label>
                <input type="number" id="modalPatientDosage" value="1" min="1">
            </div>
            <div class="dosage-buttons">
                <button class="btn btn-secondary" onclick="cancelPatientSelection()">취소</button>
                <button class="btn btn-primary" onclick="registerDrugPatient()">등록</button>
            </div>
        </div>

        <div class="drug-patients-footer">
            <button class="btn btn-secondary" onclick="closeDrugPatientsModal()">닫기</button>
        </div>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/jaego-core.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/confirm-modal.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.VERSION }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    // 전역 변수
    var currentSuggestion = null;
    var patients = [];
    var stats = null;
    var selectedPatient = null;
    var pendingNewPatientName = null;
    var lastRegistration = null;
    var selectedDrugForPatient = null;
    var drugSearchTimeout = null;
    var patientRegisteredDrugs = [];
    var drugRegisteredPatients = [];
    var selectedPatientForDrug = null;

    // 페이지 로드 시
    document.addEventListener('DOMContentLoaded', async function() {
        await loadPatients();
        await checkActivation();
    });

    // 툴팁 위치 동적 계산 (이벤트 위임)
    document.addEventListener('mouseover', function(e) {
        var helpIcon = e.target.closest('.help-icon');
        if (!helpIcon) return;

        var tooltip = helpIcon.querySelector('.help-tip');
        if (!tooltip) return;

        var rect = helpIcon.getBoundingClientRect();
        var tooltipWidth = 250;
        var padding = 10;

        // 기본: 아이콘 아래에 표시
        var top = rect.bottom + 8;
        var left = rect.left + (rect.width / 2) - (tooltipWidth / 2);

        // 화면 왼쪽을 벗어나면 조정
        if (left < padding) {
            left = padding;
        }
        // 화면 오른쪽을 벗어나면 조정
        if (left + tooltipWidth > window.innerWidth - padding) {
            left = window.innerWidth - tooltipWidth - padding;
        }

        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
    });

    // 환자 목록 로드
    async function loadPatients() {
        try {
            var response = await fetch('/api/patients');
            var data = await response.json();
            if (data.status === 'success') {
                patients = data.data;
            }
        } catch (error) {
            console.error('환자 목록 로드 실패:', error);
        }
    }

    // 활성화 상태 확인
    async function checkActivation() {
        try {
            var response = await fetch('/api/suggestion/status');
            var data = await response.json();

            if (data.status === 'success') {
                if (data.data.active) {
                    await loadStats();
                    await loadNextSuggestion();
                    await loadNewDrugs();
                    await loadSkippedDrugs();
                } else {
                    showInactiveState(data.data);
                }
            }
        } catch (error) {
            console.error('활성화 상태 확인 실패:', error);
            document.getElementById('mainContent').innerHTML =
                '<div class="inactive-state">' +
                    '<svg class="inactive-icon"><use href="#icon-alert-triangle"></use></svg>' +
                    '<div class="inactive-title">오류가 발생했습니다</div>' +
                    '<div class="inactive-message">' + error.message + '</div>' +
                '</div>';
        }
    }

    // 통계 로드
    async function loadStats() {
        try {
            var response = await fetch('/api/suggestion/stats');
            var data = await response.json();
            if (data.status === 'success') {
                stats = data.data;
                updateProgress();
            }
        } catch (error) {
            console.error('통계 로드 실패:', error);
        }
    }

    // 진행 바 업데이트
    function updateProgress() {
        if (!stats) return;

        var total = stats.total_periodic;
        var done = stats.already_registered;
        var percent = total > 0 ? (done / total) * 100 : 0;

        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('progressCount').textContent = done + ' / ' + total;
        document.getElementById('progressFill').style.width = percent + '%';
    }

    // 비활성 상태 표시
    function showInactiveState(status) {
        document.getElementById('mainContent').innerHTML =
            '<div class="inactive-state">' +
                '<svg class="inactive-icon"><use href="#icon-users"></use></svg>' +
                '<div class="inactive-title">약품 추천 기능을 사용하려면</div>' +
                '<div class="inactive-message">' +
                    '약품 추천을 위해 더 많은 데이터가 필요합니다.<br><br>' +
                    '<strong>현재:</strong> 환자 ' + status.patients_with_drugs + '명, 약품 ' + status.drugs_with_patients + '종<br>' +
                    '<strong>권장:</strong> 환자 ' + status.required_count + '명 이상, 약품 ' + status.required_drugs + '종 이상' +
                '</div>' +
                '<a href="/patient/manage" class="btn btn-primary">환자 관리로 이동</a>' +
            '</div>';
    }

    // 다음 제안 로드
    async function loadNextSuggestion() {
        try {
            var response = await fetch('/api/suggestion/next');
            var data = await response.json();

            if (data.status === 'success') {
                if (data.data) {
                    currentSuggestion = data.data;
                    renderSuggestionCard(data.data);
                } else {
                    showCompleteState();
                }
            }
        } catch (error) {
            console.error('제안 로드 실패:', error);
        }
    }

    // 제안 카드 렌더링
    function renderSuggestionCard(suggestion) {
        selectedPatient = null;

        // 평균 간격 범위 (min ~ max)
        var avgInterval = suggestion.avg_interval || 0;
        var intervalStd = (suggestion.avg_interval && suggestion.interval_cv)
            ? suggestion.avg_interval * suggestion.interval_cv
            : 0;
        var intervalMin = Math.max(0, avgInterval - intervalStd).toFixed(1);
        var intervalMax = (avgInterval + intervalStd).toFixed(1);
        var intervalDisplay = intervalStd > 0 ? intervalMin + '~' + intervalMax : avgInterval.toFixed(1);

        // 평균 사용량 범위 (min ~ max)
        var avgPeakHeight = suggestion.avg_peak_height || 0;
        var heightStd = (suggestion.avg_peak_height && suggestion.height_cv)
            ? suggestion.avg_peak_height * suggestion.height_cv
            : 0;
        var usageMin = Math.max(0, avgPeakHeight - heightStd).toFixed(0);
        var usageMax = (avgPeakHeight + heightStd).toFixed(0);
        var usageDisplay = heightStd > 0 ? usageMin + '~' + usageMax : avgPeakHeight.toFixed(0);

        // 활동률 (퍼센트)
        var activeMonths = suggestion.active_months || 0;
        var totalMonths = suggestion.total_months || 1;
        var activityPercent = Math.round((activeMonths / totalMonths) * 100);
        var activityDisplay = activityPercent + '%';

        // 런웨이
        var runway = (suggestion.monthly_avg && suggestion.monthly_avg > 0)
            ? Math.round(suggestion.current_stock / suggestion.monthly_avg) + '개월'
            : '-';

        var skipText = suggestion.skip_count > 0 ? ' (' + suggestion.skip_count + '회 건너뜀)' : '';

        // 차트 생성 (현재 재고는 별도 표시)
        var sparklineSvg = generateSparklineSVG(suggestion.monthly_usage || []);

        var registeredWarning = suggestion.registered_count > 0 ?
            '<div style="text-align: center; color: var(--warning); font-size: var(--text-sm); margin-top: calc(-1 * var(--space-3)); margin-bottom: var(--space-3); display: flex; align-items: center; justify-content: center; gap: var(--space-2);">' +
                '<svg class="icon" style="width: var(--icon-sm); height: var(--icon-sm);"><use href="#icon-alert-triangle"></use></svg>' +
                '이미 ' + suggestion.registered_count + '명의 환자가 등록되어 있습니다' +
            '</div>' : '';

        document.getElementById('mainContent').innerHTML =
            '<div class="suggestion-card">' +
                '<div class="card-header">' +
                    '<div class="drug-info">' +
                        '<h2>' + escapeHtml(suggestion.drug_name) + '</h2>' +
                        '<div class="drug-meta">' + escapeHtml(suggestion.drug_code) + ' | ' + escapeHtml(suggestion.company) + ' | ' + escapeHtml(suggestion.drug_type) + '</div>' +
                    '</div>' +
                    '<div class="similarity-badge">유사도 ' + suggestion.similarity + '%</div>' +
                '</div>' +
                '<div class="metrics-grid">' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + intervalDisplay + '</div>' +
                        '<div class="metric-label">평균 간격 (개월) <span class="help-icon">?<span class="help-tip">사용량이 발생한 월 사이의 평균 간격입니다. 범위는 ±1σ(표준편차)로, 약 68%의 데이터가 이 범위 내에 있습니다.</span></span></div>' +
                    '</div>' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + usageDisplay + '</div>' +
                        '<div class="metric-label">평균 사용량 (개) <span class="help-icon">?<span class="help-tip">사용이 발생한 월의 평균 사용량입니다. 범위는 ±1σ(표준편차)로, 약 68%의 데이터가 이 범위 내에 있습니다.</span></span></div>' +
                    '</div>' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + activityDisplay + '</div>' +
                        '<div class="metric-label">활동률 <span class="help-icon">?<span class="help-tip">전체 데이터 기간 중 실제로 사용이 발생한 월의 비율입니다. 높을수록 꾸준히 사용되는 약품입니다.</span></span></div>' +
                    '</div>' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + runway + '</div>' +
                        '<div class="metric-label">런웨이 <span class="help-icon">?<span class="help-tip">현재 재고로 버틸 수 있는 예상 개월 수입니다. (현재 재고 ÷ 월평균 사용량)</span></span></div>' +
                    '</div>' +
                '</div>' +
                '<div class="sparkline-container">' +
                    '<div class="sparkline-header">' +
                        '<div class="sparkline-title">월별 사용량 추이</div>' +
                        '<div class="sparkline-stock">현재 재고: <strong>' + suggestion.current_stock + '</strong>개</div>' +
                    '</div>' +
                    sparklineSvg +
                '</div>' +
                buildSimilarDrugsSection(suggestion.nearest_k_drugs) +
                '<div class="register-form">' +
                    '<div class="form-title">환자 등록</div>' +
                    '<div class="form-row">' +
                        '<div class="form-group">' +
                            '<label for="patientInput">환자 검색</label>' +
                            '<div class="patient-combobox">' +
                                '<input type="text" id="patientInput" placeholder="환자명으로 검색..." autocomplete="off" oninput="filterPatients()" onfocus="showPatientDropdown()">' +
                                '<button class="clear-btn" id="clearPatientBtn" onclick="clearPatientSelection()">&times;</button>' +
                                '<div class="patient-dropdown" id="patientDropdown"></div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label for="dosageInput">1회 처방량</label>' +
                            '<input type="number" id="dosageInput" value="1" min="1">' +
                        '</div>' +
                    '</div>' +
                    '<div class="button-row">' +
                        '<button class="btn btn-secondary" onclick="skipDrug()">' +
                            '건너뛰기 <span class="skip-count">' + skipText + '</span>' +
                        '</button>' +
                        '<button class="btn btn-primary" onclick="registerDrug()" id="registerBtn">등록하기</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            registeredWarning +
            '<div style="text-align: center; color: #9ca3af; font-size: 13px;">' +
                '남은 제안: ' + suggestion.remaining_count + '개' +
            '</div>';

        document.addEventListener('click', handleClickOutside);
    }

    // 환자 검색/필터링
    function filterPatients() {
        var input = document.getElementById('patientInput');
        var query = input.value.trim().toLowerCase();
        var dropdown = document.getElementById('patientDropdown');

        if (query.length === 0) {
            renderPatientOptions(patients, '');
        } else {
            var filtered = patients.filter(function(p) {
                return p.환자명.toLowerCase().includes(query) ||
                    (p.주민번호_앞자리 && p.주민번호_앞자리.includes(query));
            });
            renderPatientOptions(filtered, query);
        }

        dropdown.classList.add('visible');
    }

    // 환자 옵션 렌더링
    function renderPatientOptions(filteredPatients, query) {
        var dropdown = document.getElementById('patientDropdown');
        var html = '';

        if (filteredPatients.length > 0) {
            html = filteredPatients.map(function(p) {
                return '<div class="patient-option" onclick="selectPatient(' + p.환자ID + ', \'' + escapeHtml(p.환자명) + '\', \'' + (p.주민번호_앞자리 || '') + '\')">' +
                    '<div class="name">' + escapeHtml(p.환자명) + '</div>' +
                    '<div class="birth">' + (p.주민번호_앞자리 || '') + '</div>' +
                '</div>';
            }).join('');
        }

        if (query.length > 0) {
            html += '<div class="patient-option new-patient" onclick="openNewPatientModal(\'' + escapeHtml(query) + '\')">' +
                '+ "' + escapeHtml(query) + '" 새로 등록' +
            '</div>';
        }

        if (!html) {
            html = '<div class="no-results">환자명을 입력하세요</div>';
        }

        dropdown.innerHTML = html;
    }

    // 환자 드롭다운 표시
    function showPatientDropdown() {
        var input = document.getElementById('patientInput');
        if (!selectedPatient) {
            filterPatients();
        }
    }

    // 환자 선택
    function selectPatient(id, name, birth) {
        selectedPatient = { id: id, name: name, birth: birth };

        var input = document.getElementById('patientInput');
        input.value = name + ' (' + birth + ')';
        input.readOnly = true;

        var clearBtn = document.getElementById('clearPatientBtn');
        clearBtn.style.display = 'block';

        var dropdown = document.getElementById('patientDropdown');
        dropdown.classList.remove('visible');
    }

    // 환자 선택 초기화
    function clearPatientSelection() {
        selectedPatient = null;

        var input = document.getElementById('patientInput');
        input.value = '';
        input.readOnly = false;
        input.focus();

        var clearBtn = document.getElementById('clearPatientBtn');
        clearBtn.style.display = 'none';
    }

    // 드롭다운 외부 클릭 처리
    function handleClickOutside(e) {
        var combobox = document.querySelector('.patient-combobox');
        var dropdown = document.getElementById('patientDropdown');

        if (combobox && !combobox.contains(e.target)) {
            dropdown.classList.remove('visible');
        }
    }

    // 신규 환자 모달 열기
    function openNewPatientModal(name) {
        pendingNewPatientName = name;
        document.getElementById('newPatientName').textContent = name;
        document.getElementById('newPatientBirth').value = '';
        document.getElementById('newPatientModal').classList.add('visible');

        document.getElementById('patientDropdown').classList.remove('visible');

        setTimeout(function() {
            document.getElementById('newPatientBirth').focus();
        }, 100);
    }

    // 신규 환자 모달 닫기
    function closeNewPatientModal() {
        document.getElementById('newPatientModal').classList.remove('visible');
        document.getElementById('newPatientBirth').value = '';
        pendingNewPatientName = null;
    }

    // 모달 내용 확인 함수
    function hasNewPatientModalContent() {
        var birth = document.getElementById('newPatientBirth').value.trim();
        return birth !== '';
    }

    // 모달 흔들림 애니메이션
    function shakeModal(modalId) {
        var modal = document.getElementById(modalId);
        var content = modal.querySelector('.mini-modal-content');
        if (content) {
            content.classList.add('shake');
            setTimeout(function() {
                content.classList.remove('shake');
            }, 400);
        }
    }

    // 확인 후 모달 닫기
    async function tryCloseNewPatientModal() {
        if (hasNewPatientModalContent()) {
            shakeModal('newPatientModal');
            var confirmed = await showConfirmModal({
                icon: 'warning',
                title: '작성 중인 내용이 있습니다',
                message: '정말 닫으시겠습니까?<br>입력한 내용은 저장되지 않습니다.',
                confirmText: '닫기',
                isDanger: true
            });
            if (confirmed) {
                closeNewPatientModal();
            }
        } else {
            closeNewPatientModal();
        }
    }

    // 신규 환자 생성
    async function createNewPatient() {
        var birth = document.getElementById('newPatientBirth').value.trim();

        if (!birth) {
            showToast('주민번호 앞자리를 입력해주세요.', 'error');
            return;
        }

        if (birth.length !== 6 || !/^\d{6}$/.test(birth)) {
            showToast('주민번호 앞자리는 6자리 숫자여야 합니다.', 'error');
            return;
        }

        try {
            var response = await fetch('/api/patient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: pendingNewPatientName,
                    birth: birth
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                var newPatient = {
                    환자ID: data.patient_id,
                    환자명: pendingNewPatientName,
                    주민번호_앞자리: birth
                };
                patients.push(newPatient);

                selectPatient(data.patient_id, pendingNewPatientName, birth);
                closeNewPatientModal();
            } else {
                showToast(data.message || '환자 등록에 실패했습니다.', 'error');
            }
        } catch (error) {
            console.error('환자 등록 실패:', error);
            showToast('환자 등록 중 오류가 발생했습니다.', 'error');
        }
    }

    // 유사 약품 섹션 생성
    function buildSimilarDrugsSection(nearestDrugs) {
        if (!nearestDrugs || nearestDrugs.length === 0) {
            return '';
        }

        var html = '<div class="similar-drugs-container">' +
            '<div class="similar-drugs-header" onclick="toggleSimilarDrugs()">' +
                '<div class="similar-drugs-title">' +
                    '<svg class="icon"><use href="#icon-link"></use></svg>' +
                    '유사한 패턴의 등록 약품 (KNN K=' + nearestDrugs.length + ')' +
                '</div>' +
                '<span class="similar-drugs-toggle">▶</span>' +
            '</div>' +
            '<div class="similar-drugs-list" style="display: none;">';

        for (var i = 0; i < nearestDrugs.length; i++) {
            var drug = nearestDrugs[i];
            var intervalText = drug.avg_interval ? drug.avg_interval.toFixed(1) + '개월 주기' : '-';
            var rankBadge = (i + 1) + '위';

            html += '<div class="similar-drug-item">' +
                '<div class="similar-drug-info">' +
                    '<div class="similar-drug-name">' + drug.drug_name + '</div>' +
                    '<div class="similar-drug-interval">' + intervalText + '</div>' +
                '</div>' +
                '<div class="similar-drug-badge">' + rankBadge + '</div>' +
            '</div>';
        }

        html += '</div></div>';
        return html;
    }

    // 유사 약품 섹션 토글
    function toggleSimilarDrugs() {
        var list = document.querySelector('.similar-drugs-list');
        var toggle = document.querySelector('.similar-drugs-toggle');
        if (list && toggle) {
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.textContent = '▼';
            } else {
                list.style.display = 'none';
                toggle.textContent = '▶';
            }
        }
    }

    // 스파크라인 SVG 생성
    function generateSparklineSVG(data) {
        if (!data || data.length === 0) {
            return '<div class="chart-container"><svg width="100%" height="80"></svg></div>';
        }

        var width = 700;
        var height = 80;
        var paddingLeft = 35;
        var paddingRight = 40;
        var paddingTop = 10;
        var paddingBottom = 5;
        var chartWidth = width - paddingLeft - paddingRight;
        var chartHeight = height - paddingTop - paddingBottom;

        var maxVal = Math.max.apply(null, data) || 1;
        var minVal = Math.min.apply(null, data.filter(function(v) { return v > 0; })) || 0;
        var avgVal = data.reduce(function(a, b) { return a + b; }, 0) / data.length;
        var lastVal = data[data.length - 1];
        var n = data.length;

        // Y 좌표 계산 함수 (0~maxVal 범위)
        function getY(v) {
            return paddingTop + chartHeight - (v / maxVal) * chartHeight;
        }

        // X 좌표 계산 함수
        function getX(i) {
            return paddingLeft + (i / (n - 1)) * chartWidth;
        }

        var points = data.map(function(v, i) {
            return getX(i) + ',' + getY(v);
        });

        var path = 'M' + points.join(' L');

        // 평균선
        var avgY = getY(avgVal);
        var avgLine = '<line x1="' + paddingLeft + '" y1="' + avgY + '" x2="' + (width - paddingRight) + '" y2="' + avgY + '" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4,4"/>';

        // 데이터 포인트 (원)
        var circles = data.map(function(v, i) {
            if (v > 0) {
                return '<circle cx="' + getX(i) + '" cy="' + getY(v) + '" r="3" fill="#48bb78"/>';
            }
            return '';
        }).join('');

        // 최대값 레이블 (좌측)
        var maxLabel = '<text x="' + (paddingLeft - 5) + '" y="' + (paddingTop + 4) + '" text-anchor="end" font-size="10" fill="#6b7280">' + maxVal + '</text>';

        // 평균값 레이블 (좌측)
        var avgLabel = '<text x="' + (paddingLeft - 5) + '" y="' + (avgY + 3) + '" text-anchor="end" font-size="9" fill="#94a3b8">' + Math.round(avgVal) + '</text>';

        // 0 라인 (0인 값이 있을 때만 표시)
        var hasZero = data.some(function(v) { return v === 0; });
        var zeroLine = '';
        var zeroLabel = '';
        if (hasZero) {
            var zeroY = getY(0);
            zeroLine = '<line x1="' + paddingLeft + '" y1="' + zeroY + '" x2="' + (width - paddingRight) + '" y2="' + zeroY + '" stroke="#cbd5e0" stroke-width="1"/>';
            zeroLabel = '<text x="' + (paddingLeft - 5) + '" y="' + (zeroY + 3) + '" text-anchor="end" font-size="9" fill="#cbd5e0">0</text>';
        }

        // 최근 값 강조 (우측 끝)
        var lastX = getX(n - 1);
        var lastY = getY(lastVal);
        var lastCircle = '<circle cx="' + lastX + '" cy="' + lastY + '" r="5" fill="#48bb78"/>';
        var lastLabel = '<text x="' + (lastX + 8) + '" y="' + (lastY + 4) + '" font-size="11" font-weight="600" fill="#48bb78">' + lastVal + '</text>';

        return '<div class="chart-container">' +
            '<svg width="100%" height="' + height + '" viewBox="0 0 ' + width + ' ' + height + '" preserveAspectRatio="none">' +
                zeroLine +
                avgLine +
                '<path d="' + path + '" fill="none" stroke="#48bb78" stroke-width="2"/>' +
                circles +
                lastCircle +
                maxLabel +
                avgLabel +
                zeroLabel +
                lastLabel +
            '</svg>' +
        '</div>';
    }

    // 약품 등록
    async function registerDrug() {
        if (!selectedPatient) {
            showToast('환자를 선택해주세요.', 'error');
            document.getElementById('patientInput').focus();
            return;
        }

        var dosage = document.getElementById('dosageInput').value;

        if (!currentSuggestion) return;

        var btn = document.getElementById('registerBtn');
        btn.disabled = true;
        btn.textContent = '등록 중...';

        try {
            var response = await fetch('/api/suggestion/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: currentSuggestion.drug_code,
                    patient_id: selectedPatient.id,
                    dosage: parseInt(dosage) || 1
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                lastRegistration = {
                    drug: Object.assign({}, currentSuggestion),
                    patient: Object.assign({}, selectedPatient),
                    dosage: parseInt(dosage) || 1
                };

                await loadStats();
                await loadSkippedDrugs();

                showSuccessModal();
            } else {
                showToast(data.message || '등록에 실패했습니다.', 'error');
                btn.disabled = false;
                btn.textContent = '등록하기';
            }
        } catch (error) {
            console.error('등록 실패:', error);
            showToast('등록 중 오류가 발생했습니다.', 'error');
            btn.disabled = false;
            btn.textContent = '등록하기';
        }
    }

    // 등록 완료 모달 표시
    function showSuccessModal() {
        if (!lastRegistration) return;

        document.getElementById('successDrugName').textContent = lastRegistration.drug.drug_name;
        document.getElementById('successPatientName').textContent =
            lastRegistration.patient.name + ' (' + lastRegistration.patient.birth + ')';
        document.getElementById('successDosage').textContent = lastRegistration.dosage + '정';

        document.getElementById('patientDrugsTitle').textContent =
            lastRegistration.patient.name + '의 다른 약품';

        document.getElementById('successModal').classList.add('visible');
    }

    // 등록 완료 모달 닫기
    function closeSuccessModal() {
        document.getElementById('successModal').classList.remove('visible');
    }

    // 이 약품에 다른 환자 추가 (모달 열기)
    async function addAnotherPatient() {
        if (!lastRegistration) return;

        closeSuccessModal();

        var drugName = lastRegistration.drug.drug_name;
        var drugCode = lastRegistration.drug.drug_code;

        document.getElementById('drugPatientsModalTitle').textContent = '약품에 환자 추가';
        document.getElementById('drugPatientsModalSubtitle').textContent = drugName;

        document.getElementById('modalPatientSearchInput').value = '';
        document.getElementById('modalPatientSearchResults').classList.remove('visible');
        document.getElementById('patientDosageArea').style.display = 'none';
        selectedPatientForDrug = null;

        document.getElementById('registeredPatientsList').innerHTML =
            '<span class="registered-patients-empty">로딩 중...</span>';
        document.getElementById('registeredPatientsCount').textContent = '-';

        document.getElementById('drugPatientsModal').classList.add('visible');

        await loadDrugRegisteredPatients(drugCode);

        setTimeout(function() {
            document.getElementById('modalPatientSearchInput').focus();
        }, 100);
    }

    // 약품에 등록된 환자 목록 로드
    async function loadDrugRegisteredPatients(drugCode) {
        try {
            var response = await fetch('/api/drug/' + drugCode + '/patients');
            var data = await response.json();

            if (data.status === 'success' && data.data) {
                drugRegisteredPatients = data.data.map(function(p) { return p.환자ID; });
                renderRegisteredPatients(data.data);
            } else {
                drugRegisteredPatients = [];
                renderRegisteredPatients([]);
            }
        } catch (error) {
            console.error('등록된 환자 로드 실패:', error);
            drugRegisteredPatients = [];
            renderRegisteredPatients([]);
        }
    }

    // 등록된 환자 태그 렌더링
    function renderRegisteredPatients(patientsList) {
        var list = document.getElementById('registeredPatientsList');
        var countEl = document.getElementById('registeredPatientsCount');

        if (!patientsList || patientsList.length === 0) {
            list.innerHTML = '<span class="registered-patients-empty">등록된 환자가 없습니다</span>';
            countEl.textContent = '0명';
            return;
        }

        countEl.textContent = patientsList.length + '명';
        list.innerHTML = patientsList.map(function(patient) {
            return '<span class="registered-patient-tag">' +
                '<svg class="icon" style="width: 12px; height: 12px;"><use href="#icon-check"></use></svg>' +
                escapeHtml(patient.환자명) +
            '</span>';
        }).join('');
    }

    // 모달 내 환자 검색 입력 핸들러
    function onModalPatientSearchInput() {
        filterModalPatients();
    }

    // 모달 환자 검색 결과 표시
    function showModalPatientResults() {
        filterModalPatients();
    }

    // 환자 필터링 및 결과 렌더링
    function filterModalPatients() {
        var input = document.getElementById('modalPatientSearchInput');
        var query = input.value.trim().toLowerCase();
        var resultsDiv = document.getElementById('modalPatientSearchResults');

        document.getElementById('patientDosageArea').style.display = 'none';
        selectedPatientForDrug = null;

        var filtered = patients;
        if (query.length > 0) {
            filtered = patients.filter(function(p) {
                return p.환자명.toLowerCase().includes(query) ||
                    (p.주민번호_앞자리 && p.주민번호_앞자리.includes(query));
            });
        }

        var html = '';

        if (filtered.length > 0) {
            html = filtered.map(function(p) {
                var isRegistered = drugRegisteredPatients.includes(p.환자ID);
                var registeredClass = isRegistered ? ' already-registered' : '';
                var onclick = isRegistered ? '' : 'onclick="selectPatientForDrug(' + p.환자ID + ', \'' + escapeHtml(p.환자명) + '\', \'' + (p.주민번호_앞자리 || '') + '\')"';

                return '<div class="patient-search-item' + registeredClass + '" ' + onclick + '>' +
                    '<div class="name">' + escapeHtml(p.환자명) + (isRegistered ? ' (등록됨)' : '') + '</div>' +
                    '<div class="birth">' + (p.주민번호_앞자리 || '') + '</div>' +
                '</div>';
            }).join('');
        }

        if (query.length > 0) {
            html += '<div class="patient-search-item new-patient" onclick="openNewPatientModalFromDrug(\'' + escapeHtml(query) + '\')">' +
                '+ "' + escapeHtml(query) + '" 새로 등록' +
            '</div>';
        }

        if (!html) {
            html = '<div class="patient-search-item" style="cursor: default; color: #9ca3af;">환자명을 입력하세요</div>';
        }

        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('visible');
    }

    // 약품에 등록할 환자 선택
    function selectPatientForDrug(patientId, name, birth) {
        selectedPatientForDrug = {
            id: patientId,
            name: name,
            birth: birth
        };

        document.getElementById('modalPatientSearchResults').classList.remove('visible');

        document.getElementById('selectedPatientName').textContent = name;
        document.getElementById('selectedPatientBirth').textContent = birth || '-';

        document.getElementById('modalPatientDosage').value = 1;

        document.getElementById('patientDosageArea').style.display = 'block';

        setTimeout(function() {
            document.getElementById('modalPatientDosage').focus();
            document.getElementById('modalPatientDosage').select();
        }, 100);
    }

    // 환자 선택 취소
    function cancelPatientSelection() {
        selectedPatientForDrug = null;
        document.getElementById('patientDosageArea').style.display = 'none';
        document.getElementById('modalPatientSearchInput').value = '';
        document.getElementById('modalPatientSearchInput').focus();
    }

    // 약품에 환자 등록
    async function registerDrugPatient() {
        if (!selectedPatientForDrug || !lastRegistration) return;

        var dosage = parseInt(document.getElementById('modalPatientDosage').value) || 1;
        var drugCode = lastRegistration.drug.drug_code;

        try {
            var response = await fetch('/api/patient/' + selectedPatientForDrug.id + '/link-drug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: drugCode,
                    dosage: dosage
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                showToast(selectedPatientForDrug.name + ' 등록 완료', 'success');

                document.getElementById('modalPatientSearchInput').value = '';
                document.getElementById('modalPatientSearchResults').classList.remove('visible');
                document.getElementById('patientDosageArea').style.display = 'none';
                selectedPatientForDrug = null;

                document.getElementById('modalPatientSearchInput').focus();

                await loadDrugRegisteredPatients(drugCode);
                await loadStats();
            } else {
                showToast(data.message || '등록에 실패했습니다.', 'error');
            }
        } catch (error) {
            console.error('환자 등록 실패:', error);
            showToast('등록 중 오류가 발생했습니다.', 'error');
        }
    }

    // 약품에서 신규 환자 등록 모달 열기
    function openNewPatientModalFromDrug(name) {
        pendingNewPatientName = name;
        document.getElementById('newPatientName').textContent = name;
        document.getElementById('newPatientBirth').value = '';
        document.getElementById('newPatientModal').classList.add('visible');

        document.getElementById('modalPatientSearchResults').classList.remove('visible');

        setTimeout(function() {
            document.getElementById('newPatientBirth').focus();
        }, 100);
    }

    // 약품 환자 모달 닫기 (다음 제안으로 이동)
    async function closeDrugPatientsModal() {
        document.getElementById('drugPatientsModal').classList.remove('visible');
        selectedPatientForDrug = null;
        drugRegisteredPatients = [];

        await loadNextSuggestion();
    }

    // 환자의 다른 약품 등록 모달 열기
    async function showPatientDrugs() {
        if (!lastRegistration) return;

        closeSuccessModal();

        var patientName = lastRegistration.patient.name;
        var patientId = lastRegistration.patient.id;

        document.getElementById('patientDrugsModalTitle').textContent =
            patientName + '의 다른 약품 등록';

        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchClear').classList.remove('visible');
        document.getElementById('patientDrugsList').innerHTML =
            '<div class="patient-drugs-empty">약품명을 입력하여 검색하세요</div>';
        document.getElementById('dosageInputArea').style.display = 'none';
        selectedDrugForPatient = null;

        document.getElementById('registeredDrugsList').innerHTML =
            '<span class="registered-drugs-empty">로딩 중...</span>';
        document.getElementById('registeredDrugsCount').textContent = '-';

        document.getElementById('patientDrugsModal').classList.add('visible');

        await loadPatientRegisteredDrugs(patientId);

        setTimeout(function() {
            document.getElementById('drugSearchInput').focus();
        }, 100);
    }

    // 약품 검색 (디바운스 적용)
    function onDrugSearchInput() {
        var input = document.getElementById('drugSearchInput');
        var query = input.value.trim();

        var clearBtn = document.getElementById('drugSearchClear');
        if (query.length > 0) {
            clearBtn.classList.add('visible');
        } else {
            clearBtn.classList.remove('visible');
        }

        document.getElementById('dosageInputArea').style.display = 'none';
        selectedDrugForPatient = null;

        if (drugSearchTimeout) {
            clearTimeout(drugSearchTimeout);
        }

        if (query.length < 2) {
            document.getElementById('patientDrugsList').innerHTML =
                '<div class="patient-drugs-empty">2글자 이상 입력하세요</div>';
            return;
        }

        document.getElementById('patientDrugsList').innerHTML =
            '<div class="patient-drugs-empty">검색 중...</div>';

        drugSearchTimeout = setTimeout(function() {
            searchDrugsForPatient(query);
        }, 300);
    }

    // 약품 검색 API 호출
    async function searchDrugsForPatient(query) {
        try {
            var response = await fetch('/api/search-inventory?q=' + encodeURIComponent(query));
            var data = await response.json();

            if (data.status === 'success') {
                renderDrugSearchResults(data.results);
            } else {
                document.getElementById('patientDrugsList').innerHTML =
                    '<div class="patient-drugs-empty">' + (data.message || '검색 실패') + '</div>';
            }
        } catch (error) {
            console.error('약품 검색 실패:', error);
            document.getElementById('patientDrugsList').innerHTML =
                '<div class="patient-drugs-empty">검색 중 오류가 발생했습니다</div>';
        }
    }

    // 검색 결과 렌더링
    function renderDrugSearchResults(drugs) {
        var list = document.getElementById('patientDrugsList');

        if (!drugs || drugs.length === 0) {
            list.innerHTML = '<div class="patient-drugs-empty">검색 결과가 없습니다</div>';
            return;
        }

        list.innerHTML = drugs.map(function(drug) {
            var isRegistered = patientRegisteredDrugs.includes(drug.약품코드);
            var registeredClass = isRegistered ? ' already-registered' : '';
            var onclick = isRegistered ? '' : 'onclick="selectDrugForPatient(\'' + escapeHtml(drug.약품코드) + '\', \'' + escapeHtml(drug.약품명) + '\', \'' + escapeHtml(drug.제약회사) + '\', ' + (drug.현재_재고수량 || 0) + ')"';

            return '<div class="patient-drug-item' + registeredClass + '" ' + onclick + '>' +
                '<div class="patient-drug-info">' +
                    '<div class="patient-drug-name">' + escapeHtml(drug.약품명) + '</div>' +
                    '<div class="patient-drug-meta">' + escapeHtml(drug.약품코드) + ' | ' + escapeHtml(drug.제약회사) + ' | 재고: ' + (drug.현재_재고수량 || 0) + '</div>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // 약품 선택 시 처방량 입력 영역 표시
    function selectDrugForPatient(drugCode, drugName, company, stock) {
        selectedDrugForPatient = {
            drug_code: drugCode,
            drug_name: drugName,
            company: company,
            stock: stock
        };

        document.getElementById('selectedDrugName').textContent = drugName;
        document.getElementById('selectedDrugMeta').textContent =
            drugCode + ' | ' + company + ' | 현재 재고: ' + stock;

        document.getElementById('patientDrugDosage').value = 1;

        document.getElementById('dosageInputArea').style.display = 'block';

        setTimeout(function() {
            document.getElementById('patientDrugDosage').focus();
            document.getElementById('patientDrugDosage').select();
        }, 100);
    }

    // 약품 선택 취소
    function cancelDrugSelection() {
        selectedDrugForPatient = null;
        document.getElementById('dosageInputArea').style.display = 'none';
    }

    // 환자에게 약품 등록
    async function registerPatientDrug() {
        if (!selectedDrugForPatient || !lastRegistration) return;

        var dosage = parseInt(document.getElementById('patientDrugDosage').value) || 1;
        var patientId = lastRegistration.patient.id;

        try {
            var response = await fetch('/api/patient/' + patientId + '/link-drug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: selectedDrugForPatient.drug_code,
                    dosage: dosage
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                showToast(selectedDrugForPatient.drug_name + ' 등록 완료', 'success');

                document.getElementById('drugSearchInput').value = '';
                document.getElementById('drugSearchClear').classList.remove('visible');
                document.getElementById('patientDrugsList').innerHTML =
                    '<div class="patient-drugs-empty">약품명을 입력하여 검색하세요</div>';
                document.getElementById('dosageInputArea').style.display = 'none';
                selectedDrugForPatient = null;

                document.getElementById('drugSearchInput').focus();

                await loadPatientRegisteredDrugs(lastRegistration.patient.id);
                await loadStats();
            } else {
                showToast(data.message || '등록에 실패했습니다.', 'error');
            }
        } catch (error) {
            console.error('약품 등록 실패:', error);
            showToast('등록 중 오류가 발생했습니다.', 'error');
        }
    }

    // 검색어 초기화
    function clearDrugSearch() {
        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchClear').classList.remove('visible');
        document.getElementById('patientDrugsList').innerHTML =
            '<div class="patient-drugs-empty">약품명을 입력하여 검색하세요</div>';
        document.getElementById('dosageInputArea').style.display = 'none';
        selectedDrugForPatient = null;
        document.getElementById('drugSearchInput').focus();
    }

    // 환자 약품 모달 닫기 (다음 제안으로 이동)
    async function closePatientDrugsModal() {
        document.getElementById('patientDrugsModal').classList.remove('visible');
        selectedDrugForPatient = null;
        patientRegisteredDrugs = [];

        await loadNextSuggestion();
    }

    // 환자의 등록된 약품 목록 로드
    async function loadPatientRegisteredDrugs(patientId) {
        try {
            var response = await fetch('/api/patient/' + patientId + '/drugs-with-stock');
            var data = await response.json();

            if (data.status === 'success' && data.drugs) {
                patientRegisteredDrugs = data.drugs.map(function(d) { return d.drug_code; });
                renderRegisteredDrugs(data.drugs);
            } else {
                patientRegisteredDrugs = [];
                renderRegisteredDrugs([]);
            }
        } catch (error) {
            console.error('등록된 약품 로드 실패:', error);
            patientRegisteredDrugs = [];
            renderRegisteredDrugs([]);
        }
    }

    // 등록된 약품 태그 렌더링
    function renderRegisteredDrugs(drugs) {
        var list = document.getElementById('registeredDrugsList');
        var countEl = document.getElementById('registeredDrugsCount');

        if (!drugs || drugs.length === 0) {
            list.innerHTML = '<span class="registered-drugs-empty">등록된 약품이 없습니다</span>';
            countEl.textContent = '0개';
            return;
        }

        countEl.textContent = drugs.length + '개';
        list.innerHTML = drugs.map(function(drug) {
            var displayName = drug.drug_name.length > 15 ? drug.drug_name.substring(0, 15) + '...' : drug.drug_name;
            return '<span class="registered-drug-tag">' +
                '<svg class="icon" style="width: 12px; height: 12px;"><use href="#icon-check"></use></svg>' +
                escapeHtml(displayName) +
            '</span>';
        }).join('');
    }

    // 다음 추천으로 이동
    async function goToNextSuggestion() {
        closeSuccessModal();
        await loadNextSuggestion();
    }

    // 건너뛰기
    async function skipDrug() {
        if (!currentSuggestion) return;

        try {
            var response = await fetch('/api/suggestion/skip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: currentSuggestion.drug_code
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                await loadStats();
                await loadNextSuggestion();
                await loadSkippedDrugs();
            } else {
                showToast(data.message || '건너뛰기에 실패했습니다.', 'error');
            }
        } catch (error) {
            console.error('건너뛰기 실패:', error);
        }
    }

    // 완료 상태 표시
    function showCompleteState() {
        document.getElementById('mainContent').innerHTML =
            '<div class="complete-state">' +
                '<svg class="complete-icon"><use href="#icon-check-circle"></use></svg>' +
                '<div class="complete-title">모든 제안을 확인했습니다!</div>' +
                '<div class="complete-message">' +
                    '주기적 패턴의 약품들을 모두 확인했습니다.<br>' +
                    '새로운 데이터가 추가되면 더 많은 제안이 생성됩니다.' +
                '</div>' +
                '<a href="/patient/manage" class="btn btn-primary">환자 관리로 이동</a>' +
            '</div>';
    }

    // 신규 약품 로드
    async function loadNewDrugs() {
        try {
            var response = await fetch('/api/suggestion/new-drugs');
            var data = await response.json();

            if (data.status === 'success' && data.data.length > 0) {
                document.getElementById('newDrugsSection').style.display = 'block';
                document.getElementById('newDrugsCount').textContent = data.count + '개';

                var list = document.getElementById('newDrugsList');
                list.innerHTML = data.data.map(function(drug) {
                    return '<div class="new-drug-item">' +
                        '<div>' +
                            '<div class="new-drug-name">' + escapeHtml(drug.drug_name) + '</div>' +
                            '<div class="new-drug-peaks">' + drug.drug_code + ' | ' + drug.company + '</div>' +
                        '</div>' +
                        '<div class="new-drug-peaks">피크 ' + drug.peak_count + '개</div>' +
                    '</div>';
                }).join('');
            }
        } catch (error) {
            console.error('신규 약품 로드 실패:', error);
        }
    }

    // 신규 약품 토글
    function toggleNewDrugs() {
        var list = document.getElementById('newDrugsList');
        list.classList.toggle('visible');
    }

    // 건너뛴 약품 로드
    async function loadSkippedDrugs() {
        try {
            var response = await fetch('/api/suggestion/skipped');
            var data = await response.json();

            if (data.status === 'success' && data.data.length > 0) {
                document.getElementById('skippedDrugsSection').style.display = 'block';
                document.getElementById('skippedDrugsCount').textContent = data.count + '개';

                var list = document.getElementById('skippedDrugsList');
                list.innerHTML = data.data.map(function(drug) {
                    return '<div class="skipped-drug-item" onclick="loadSkippedDrug(\'' + escapeHtml(drug.drug_code) + '\')">' +
                        '<div class="skipped-drug-info">' +
                            '<div class="skipped-drug-name">' + escapeHtml(drug.drug_name) + '</div>' +
                            '<div class="skipped-drug-code">' + escapeHtml(drug.drug_code) + ' | ' + escapeHtml(drug.company) + '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } else {
                document.getElementById('skippedDrugsSection').style.display = 'none';
            }
        } catch (error) {
            console.error('건너뛴 약품 로드 실패:', error);
        }
    }

    // 건너뛴 약품 토글
    function toggleSkippedDrugs() {
        var list = document.getElementById('skippedDrugsList');
        list.classList.toggle('visible');
    }

    // 건너뛴 약품 전체 되돌리기
    async function resetAllSkippedDrugs() {
        var countText = document.getElementById('skippedDrugsCount').textContent;
        var count = parseInt(countText) || 0;

        if (count === 0) {
            showToast('되돌릴 약품이 없습니다.', 'warning');
            return;
        }

        var confirmed = await showConfirmModal({
            icon: 'question',
            title: '건너뛴 약품 전체 되돌리기',
            message: '건너뛴 약품 ' + count + '개를 모두 되돌리시겠습니까?<br><br>되돌리면 처음부터 다시 제안을 검토할 수 있습니다.',
            confirmText: '전체 되돌리기',
            isDanger: false
        });

        if (!confirmed) {
            return;
        }

        try {
            var response = await fetch('/api/suggestion/skipped/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            var data = await response.json();

            if (data.status === 'success') {
                showToast(data.message || '건너뛴 약품이 모두 되돌려졌습니다.', 'success');
                // 건너뛴 약품 섹션 숨기기
                document.getElementById('skippedDrugsSection').style.display = 'none';
                document.getElementById('skippedDrugsList').innerHTML = '';
                document.getElementById('skippedDrugsCount').textContent = '0개';
                // 통계 및 제안 다시 로드
                await loadStats();
                await loadNextSuggestion();
            } else {
                showToast(data.message || '되돌리기에 실패했습니다.', 'error');
            }
        } catch (error) {
            console.error('건너뛴 약품 되돌리기 실패:', error);
            showToast('되돌리기 중 오류가 발생했습니다.', 'error');
        }
    }

    // 건너뛴 약품 선택 시 메인 카드로 표시
    async function loadSkippedDrug(drugCode) {
        try {
            var response = await fetch('/api/suggestion/drug/' + drugCode);
            var data = await response.json();

            if (data.status === 'success' && data.data) {
                currentSuggestion = data.data;
                renderSuggestionCard(data.data);

                document.getElementById('skippedDrugsList').classList.remove('visible');

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showToast('약품 정보를 불러올 수 없습니다.', 'error');
            }
        } catch (error) {
            console.error('약품 로드 실패:', error);
            showToast('약품 정보를 불러오는 중 오류가 발생했습니다.', 'error');
        }
    }

    // HTML 이스케이프
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Info Box 토글
    function toggleInfoBox() {
        var content = document.getElementById('info-box-content');
        var arrow = document.getElementById('info-box-arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
    }

    // 신규 환자 모달 외부 클릭 시 닫기
    document.getElementById('newPatientModal').addEventListener('click', function(e) {
        if (e.target === this) {
            tryCloseNewPatientModal();
        }
    });

    // 등록 완료 모달 외부 클릭 시 닫기
    document.getElementById('successModal').addEventListener('click', function(e) {
        if (e.target === this) {
            goToNextSuggestion();
        }
    });

    // 환자 약품 모달 외부 클릭 시 닫기
    document.getElementById('patientDrugsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePatientDrugsModal();
        }
    });

    // 약품 환자 모달 외부 클릭 시 닫기
    document.getElementById('drugPatientsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDrugPatientsModal();
        }
    });

    // 약품 환자 모달 내 검색 결과 외부 클릭 시 닫기
    document.getElementById('drugPatientsModal').addEventListener('click', function(e) {
        var searchBox = document.querySelector('.patient-search-box');
        var resultsDiv = document.getElementById('modalPatientSearchResults');
        if (searchBox && !searchBox.contains(e.target) && resultsDiv.classList.contains('visible')) {
            resultsDiv.classList.remove('visible');
        }
    });

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // 커스텀 확인 모달이 열려있으면 취소
            if (document.getElementById('confirmModal').classList.contains('visible')) {
                closeConfirmModal(false);
                return;
            }
            // 약품 환자 모달이 열려있으면 먼저 닫기
            if (document.getElementById('drugPatientsModal').classList.contains('visible')) {
                closeDrugPatientsModal();
            }
            // 환자 약품 모달이 열려있으면 닫기
            else if (document.getElementById('patientDrugsModal').classList.contains('visible')) {
                closePatientDrugsModal();
            }
            // 등록 완료 모달이 열려있으면 닫기
            else if (document.getElementById('successModal').classList.contains('visible')) {
                goToNextSuggestion();
            }
            // 신규 환자 모달이 열려있으면 닫기
            else if (document.getElementById('newPatientModal').classList.contains('visible')) {
                tryCloseNewPatientModal();
            }
        }
    });

    // 신규 환자 모달에서 Enter 키로 등록
    document.getElementById('newPatientBirth').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            createNewPatient();
        }
    });
</script>
{% endblock %}
