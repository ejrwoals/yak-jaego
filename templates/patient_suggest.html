{% extends "base.html" %}

{% block title %}ì•½í’ˆ ì¶”ì²œ - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.VERSION }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.VERSION }}">
{% endblock %}

{% block page_styles %}
<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        padding: 30px;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .back-link {
        display: inline-block;
        color: #48bb78;
        text-decoration: none;
        margin-bottom: 20px;
        font-size: 14px;
    }

    .back-link:hover {
        text-decoration: underline;
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
    }

    .header h1 {
        font-size: 28px;
        color: #1f2937;
        margin-bottom: 8px;
    }

    .header p {
        color: #6b7280;
        font-size: 14px;
    }

    /* ì§„í–‰ ë°” */
    .progress-section {
        background: #f7fafc;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .progress-label {
        font-size: 14px;
        color: #4b5563;
    }

    .progress-count {
        font-size: 14px;
        font-weight: 600;
        color: #48bb78;
    }

    .progress-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* ë¹„í™œì„± ìƒíƒœ */
    .inactive-state {
        text-align: center;
        padding: 60px 20px;
    }

    .inactive-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    .inactive-title {
        font-size: 20px;
        color: #1f2937;
        margin-bottom: 12px;
    }

    .inactive-message {
        color: #6b7280;
        margin-bottom: 24px;
    }

    /* ì œì•ˆ ì¹´ë“œ */
    .suggestion-card {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .drug-info h2 {
        font-size: 18px;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .drug-meta {
        font-size: 13px;
        color: #6b7280;
    }

    .similarity-badge {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }

    /* ë©”íŠ¸ë¦­ ì¹´ë“œ */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }

    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
    }

    .metric-value {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
    }

    .metric-label {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    /* ë„ì›€ë§ ì•„ì´ì½˜ íˆ´íŒ */
    .help-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 14px;
        height: 14px;
        font-size: 10px;
        font-weight: 600;
        color: #718096;
        background: #e2e8f0;
        border-radius: 50%;
        cursor: help;
        position: relative;
        flex-shrink: 0;
    }

    .help-icon:hover {
        background: #cbd5e0;
        color: #4a5568;
    }

    .help-icon .help-tip {
        display: none;
        position: fixed;
        background: #2d3748;
        color: white;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 400;
        width: 250px;
        white-space: normal;
        text-align: left;
        line-height: 1.5;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        pointer-events: none;
        box-sizing: border-box;
    }

    .help-icon:hover .help-tip {
        display: block;
    }

    /* ìŠ¤íŒŒí¬ë¼ì¸ */
    .sparkline-container {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .sparkline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .sparkline-title {
        font-size: 12px;
        color: #6b7280;
    }

    .sparkline-stock {
        font-size: 12px;
        color: #6b7280;
    }

    .sparkline-stock strong {
        color: #374151;
    }

    .chart-container {
        position: relative;
    }

    .chart-container svg {
        display: block;
    }

    /* ìœ ì‚¬ ì•½í’ˆ ì„¹ì…˜ */
    .similar-drugs-container {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .similar-drugs-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        user-select: none;
    }

    .similar-drugs-header:hover {
        opacity: 0.8;
    }

    .similar-drugs-title {
        font-size: 12px;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .similar-drugs-title .icon {
        font-size: 14px;
    }

    .similar-drugs-toggle {
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s;
    }

    .similar-drugs-list {
        margin-top: 12px;
    }

    .similar-drug-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #f8fafc;
        border-radius: 6px;
        margin-bottom: 8px;
        border-left: 3px solid #10b981;
    }

    .similar-drug-item:last-child {
        margin-bottom: 0;
    }

    .similar-drug-info {
        flex: 1;
        min-width: 0;
    }

    .similar-drug-name {
        font-size: 13px;
        font-weight: 500;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 280px;
    }

    .similar-drug-interval {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
    }

    .similar-drug-badge {
        flex-shrink: 0;
        background: #ecfdf5;
        color: #059669;
        font-size: 11px;
        font-weight: 500;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 10px;
    }

    /* ë“±ë¡ í¼ */
    .register-form {
        background: white;
        border-radius: 12px;
        padding: 20px;
    }

    .form-title {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .form-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 6px;
    }

    .form-group select,
    .form-group input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: #48bb78;
        box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
    }

    /* Patient Combobox */
    .patient-combobox {
        position: relative;
    }

    .patient-combobox input {
        padding-right: 36px;
    }

    .patient-combobox .clear-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 18px;
        padding: 0;
        display: none;
    }

    .patient-combobox .clear-btn:hover {
        color: #6b7280;
    }

    .patient-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 240px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
    }

    .patient-dropdown.visible {
        display: block;
    }

    .patient-option {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
    }

    .patient-option:last-child {
        border-bottom: none;
    }

    .patient-option:hover {
        background: #f7fafc;
    }

    .patient-option.selected {
        background: #ecfdf5;
    }

    .patient-option .name {
        font-weight: 500;
        color: #1f2937;
    }

    .patient-option .birth {
        font-size: 12px;
        color: #6b7280;
    }

    .patient-option.new-patient {
        background: #fef3c7;
        color: #92400e;
        font-weight: 500;
    }

    .patient-option.new-patient:hover {
        background: #fde68a;
    }

    .no-results {
        padding: 12px;
        text-align: center;
        color: #9ca3af;
        font-size: 13px;
    }

    /* New Patient Mini Modal */
    .mini-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 200;
        justify-content: center;
        align-items: center;
    }

    .mini-modal.visible {
        display: flex;
    }

    .mini-modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    /* Modal shake animation */
    @keyframes modalShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .mini-modal-content.shake {
        animation: modalShake 0.4s ease-in-out;
    }

    .mini-modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }

    .mini-modal-subtitle {
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 20px;
    }

    .mini-modal .form-group {
        margin-bottom: 16px;
    }

    .mini-modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .button-row {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #48bb78;
        color: white;
    }

    .btn-primary:hover {
        background: #38a169;
    }

    .btn-secondary {
        background: #e5e7eb;
        color: #4b5563;
    }

    .btn-secondary:hover {
        background: #d1d5db;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .skip-count {
        font-size: 12px;
        color: #9ca3af;
    }

    /* ì‹ ê·œ ì•½í’ˆ ì„¹ì…˜ */
    .new-drugs-section {
        margin-top: 24px;
        border-top: 1px solid #e5e7eb;
        padding-top: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 12px;
        background: #f7fafc;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .section-header:hover {
        background: #edf2f7;
    }

    .section-title {
        font-size: 14px;
        font-weight: 600;
        color: #4b5563;
    }

    .section-count {
        background: #e5e7eb;
        color: #4b5563;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
    }

    .new-drugs-list {
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }

    .new-drugs-list.visible {
        display: block;
    }

    .new-drug-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid #f3f4f6;
    }

    .new-drug-item:last-child {
        border-bottom: none;
    }

    .new-drug-name {
        font-size: 13px;
        color: #1f2937;
    }

    .new-drug-peaks {
        font-size: 12px;
        color: #9ca3af;
    }

    /* ê±´ë„ˆë›´ ì•½í’ˆ ì„¹ì…˜ */
    .skipped-drugs-section {
        margin-top: 24px;
        border-top: 1px solid #e5e7eb;
        padding-top: 24px;
    }

    .skipped-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: #fef3c7;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .skipped-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        flex: 1;
    }

    .skipped-header-left:hover {
        opacity: 0.8;
    }

    .skipped-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #92400e;
    }

    .skipped-section-count {
        background: #fbbf24;
        color: #78350f;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .reset-skipped-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: none;
        background: #f59e0b;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        margin-left: 12px;
    }

    .reset-skipped-btn:hover {
        background: #d97706;
        transform: scale(1.05);
    }

    .reset-skipped-btn svg {
        width: 18px;
        height: 18px;
        color: white;
    }

    .skipped-drugs-list {
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }

    .skipped-drugs-list.visible {
        display: block;
    }

    .skipped-drug-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background 0.2s;
    }

    .skipped-drug-item:last-child {
        border-bottom: none;
    }

    .skipped-drug-item:hover {
        background: #fef3c7;
    }

    .skipped-drug-info {
        flex: 1;
    }

    .skipped-drug-name {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
    }

    .skipped-drug-code {
        font-size: 12px;
        color: #6b7280;
    }

    .skipped-drug-badge {
        background: #fbbf24;
        color: #78350f;
        padding: 4px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }

    /* ì™„ë£Œ ìƒíƒœ */
    .complete-state {
        text-align: center;
        padding: 60px 20px;
    }

    .complete-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }

    .complete-title {
        font-size: 20px;
        color: #1f2937;
        margin-bottom: 12px;
    }

    .complete-message {
        color: #6b7280;
        margin-bottom: 24px;
    }

    /* Info Box */
    .info-box {
        background: #f0fdf4;
        border-left: 4px solid #48bb78;
        border-radius: 8px;
        margin-bottom: 24px;
        font-size: 0.95em;
        color: #166534;
        overflow: hidden;
    }

    .info-box-header {
        padding: 12px 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }

    .info-box-header:hover {
        background: #dcfce7;
    }

    .info-box-title {
        color: #15803d;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .info-box-arrow {
        color: #48bb78;
        font-size: 0.8em;
        transition: transform 0.3s ease;
    }

    .info-box-arrow.open {
        transform: rotate(180deg);
    }

    .info-box-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .info-box-content.open {
        max-height: 300px;
    }

    .info-box-body {
        padding: 0 15px 15px 15px;
        line-height: 1.6;
    }

    /* ë¡œë”© */
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }

    /* ë“±ë¡ ì™„ë£Œ ëª¨ë‹¬ */
    .success-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 300;
        justify-content: center;
        align-items: center;
    }

    .success-modal.visible {
        display: flex;
    }

    .success-modal-content {
        background: white;
        border-radius: 20px;
        padding: 28px;
        width: 90%;
        max-width: 420px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        animation: modalPop 0.3s ease;
    }

    @keyframes modalPop {
        from { opacity: 0; transform: scale(0.95) translateY(-10px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .success-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .success-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }

    .success-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .success-subtitle {
        font-size: 14px;
        color: #6b7280;
    }

    .success-info {
        background: #f0fdf4;
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 24px;
    }

    .success-info-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
    }

    .success-info-row:not(:last-child) {
        margin-bottom: 6px;
    }

    .success-info-label {
        color: #6b7280;
    }

    .success-info-value {
        color: #1f2937;
        font-weight: 500;
    }

    .success-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .success-option-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
    }

    .success-option-btn:hover {
        border-color: #48bb78;
        background: #f0fdf4;
    }

    .success-option-btn.primary {
        border-color: #48bb78;
        background: #f0fdf4;
    }

    .success-option-icon {
        font-size: 20px;
        width: 32px;
        text-align: center;
    }

    .success-option-text {
        flex: 1;
    }

    .success-option-title {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
        margin-bottom: 2px;
    }

    .success-option-desc {
        font-size: 12px;
        color: #6b7280;
    }

    /* í™˜ì ì•½í’ˆ ëª©ë¡ ëª¨ë‹¬ */
    .patient-drugs-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 350;
        justify-content: center;
        align-items: center;
    }

    .patient-drugs-modal.visible {
        display: flex;
    }

    .patient-drugs-content {
        background: white;
        border-radius: 20px;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .patient-drugs-header {
        margin-bottom: 16px;
    }

    .patient-drugs-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .patient-drugs-subtitle {
        font-size: 13px;
        color: #6b7280;
    }

    .patient-drugs-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 16px;
    }

    .patient-drug-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .patient-drug-item:hover {
        border-color: #48bb78;
        background: #f0fdf4;
    }

    .patient-drug-info {
        flex: 1;
    }

    .patient-drug-name {
        font-size: 14px;
        font-weight: 500;
        color: #1f2937;
    }

    .patient-drug-meta {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }

    .patient-drug-score {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .patient-drugs-empty {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
    }

    .patient-drugs-footer {
        display: flex;
        justify-content: flex-end;
    }

    /* ì•½í’ˆ ê²€ìƒ‰ ë°•ìŠ¤ */
    .drug-search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .drug-search-box input {
        width: 100%;
        padding: 12px 40px 12px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .drug-search-box input:focus {
        outline: none;
        border-color: #48bb78;
    }

    .drug-search-clear {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 20px;
        cursor: pointer;
        display: none;
    }

    .drug-search-clear.visible {
        display: block;
    }

    .drug-search-clear:hover {
        color: #6b7280;
    }

    /* ì²˜ë°©ëŸ‰ ì…ë ¥ ì˜ì—­ */
    .dosage-input-area {
        background: #f0fdf4;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        border: 2px solid #48bb78;
    }

    .selected-drug-info {
        margin-bottom: 12px;
    }

    .selected-drug-name {
        font-size: 15px;
        font-weight: 600;
        color: #1f2937;
    }

    .selected-drug-meta {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }

    .dosage-form-row {
        margin-bottom: 12px;
    }

    .dosage-form-row label {
        display: block;
        font-size: 13px;
        color: #4b5563;
        margin-bottom: 4px;
    }

    .dosage-form-row input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
    }

    .dosage-form-row input:focus {
        outline: none;
        border-color: #48bb78;
        box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
    }

    .dosage-buttons {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
    }

    .dosage-buttons .btn {
        padding: 8px 16px;
        font-size: 13px;
    }

    /* ë“±ë¡ëœ ì•½í’ˆ ì„¹ì…˜ */
    .registered-drugs-section {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 16px;
        border: 1px solid #e2e8f0;
    }

    .registered-drugs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .registered-drugs-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
    }

    .registered-drugs-count {
        font-size: 11px;
        color: #94a3b8;
    }

    .registered-drugs-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-height: 80px;
        overflow-y: auto;
    }

    .registered-drug-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #e0f2fe;
        color: #0369a1;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
    }

    .registered-drug-tag .check {
        color: #0ea5e9;
    }

    .registered-drugs-empty {
        font-size: 12px;
        color: #94a3b8;
        font-style: italic;
    }

    /* ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì´ë¯¸ ë“±ë¡ëœ ì•½í’ˆ í‘œì‹œ */
    .patient-drug-item.already-registered {
        opacity: 0.6;
        background: #f1f5f9;
        cursor: not-allowed;
    }

    .patient-drug-item.already-registered:hover {
        border-color: #e5e7eb;
        background: #f1f5f9;
    }

    .patient-drug-item.already-registered .patient-drug-name::after {
        content: ' (ë“±ë¡ë¨)';
        color: #94a3b8;
        font-size: 11px;
    }

    /* ì•½í’ˆì— í™˜ì ì¶”ê°€ ëª¨ë‹¬ */
    .drug-patients-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 350;
        justify-content: center;
        align-items: center;
    }

    .drug-patients-modal.visible {
        display: flex;
    }

    .drug-patients-content {
        background: white;
        border-radius: 20px;
        padding: 24px;
        width: 90%;
        max-width: 500px;
        overflow: visible;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .drug-patients-header {
        margin-bottom: 16px;
    }

    .drug-patients-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .drug-patients-subtitle {
        font-size: 13px;
        color: #6b7280;
    }

    /* ë“±ë¡ëœ í™˜ì ì„¹ì…˜ */
    .registered-patients-section {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 16px;
        border: 1px solid #e2e8f0;
    }

    .registered-patients-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .registered-patients-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
    }

    .registered-patients-count {
        font-size: 11px;
        color: #94a3b8;
    }

    .registered-patients-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-height: 80px;
        overflow-y: auto;
    }

    .registered-patient-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #fef3c7;
        color: #92400e;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
    }

    .registered-patient-tag .check {
        color: #f59e0b;
    }

    .registered-patients-empty {
        font-size: 12px;
        color: #94a3b8;
        font-style: italic;
    }

    /* í™˜ì ê²€ìƒ‰ ë°•ìŠ¤ */
    .patient-search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .patient-search-box input {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .patient-search-box input:focus {
        outline: none;
        border-color: #48bb78;
    }

    .patient-search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        margin-top: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
    }

    .patient-search-results.visible {
        display: block;
    }

    .patient-search-item {
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s;
    }

    .patient-search-item:last-child {
        border-bottom: none;
    }

    .patient-search-item:hover {
        background: #f0fdf4;
    }

    .patient-search-item.already-registered {
        opacity: 0.5;
        cursor: not-allowed;
        background: #f8fafc;
    }

    .patient-search-item.already-registered:hover {
        background: #f8fafc;
    }

    .patient-search-item .name {
        font-weight: 500;
        color: #1f2937;
    }

    .patient-search-item .birth {
        font-size: 12px;
        color: #6b7280;
    }

    .patient-search-item.new-patient {
        background: #fef3c7;
        color: #92400e;
        font-weight: 500;
    }

    .patient-search-item.new-patient:hover {
        background: #fde68a;
    }

    /* í™˜ì ì²˜ë°©ëŸ‰ ì…ë ¥ ì˜ì—­ */
    .patient-dosage-area {
        background: #f0fdf4;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        border: 2px solid #48bb78;
    }

    .selected-patient-info {
        margin-bottom: 12px;
    }

    .selected-patient-name {
        font-size: 15px;
        font-weight: 600;
        color: #1f2937;
    }

    .selected-patient-birth {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }

    .drug-patients-footer {
        display: flex;
        justify-content: flex-end;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 600px) {
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .form-row {
            flex-direction: column;
        }

        .button-row {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }

        .success-modal-content {
            margin: 20px;
        }

        .patient-drugs-content {
            margin: 20px;
            max-height: 90vh;
        }
    }
</style>
{% endblock %}

{% block toast_container %}
{% include 'partials/_toast_container.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <a href="/patient/manage" class="back-link">&larr; í™˜ì ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="header">
        <h1>ì•½í’ˆ ì¶”ì²œ</h1>
        <p>ì´ ì•½í’ˆì„ ì‚¬ìš©í•˜ëŠ” í™˜ìëŠ” ëˆ„êµ¬ì…ë‹ˆê¹Œ?</p>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        <div class="info-box-header" onclick="toggleInfoBox()">
            <span class="info-box-title">ğŸ’¡ ì´ ê¸°ëŠ¥ì€?</span>
            <span class="info-box-arrow" id="info-box-arrow">â–¼</span>
        </div>
        <div class="info-box-content" id="info-box-content">
            <div class="info-box-body">
                ì•½í’ˆì˜ ì›”ë³„ ì‚¬ìš©ëŸ‰ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ <strong>ì£¼ê¸°ì ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì•½í’ˆ</strong>ì„ ì¶”ì²œí•©ë‹ˆë‹¤.<br><br>
                ì£¼ê¸°ì  íŒ¨í„´ì€ íŠ¹ì • í™˜ìê°€ ì •ê¸°ì ìœ¼ë¡œ ë³µìš©í•˜ëŠ” ì•½í’ˆì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.
                ì¶”ì²œëœ ì•½í’ˆì´ ì–´ë–¤ í™˜ìì˜ ê²ƒì¸ì§€ í™•ì¸í•˜ì—¬ ë“±ë¡í•˜ë©´, í–¥í›„ í•´ë‹¹ í™˜ìì˜ ì•½í’ˆ ì¬ê³  ê´€ë¦¬ì— ë„ì›€ì´ ë©ë‹ˆë‹¤.<br><br>
                <strong>ìœ ì‚¬ë„</strong>: ì´ë¯¸ ë“±ë¡ëœ ì•½í’ˆë“¤ì˜ íŒ¨í„´ê³¼ ì–¼ë§ˆë‚˜ ë¹„ìŠ·í•œì§€ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <!-- ì§„í–‰ ë°” -->
    <div class="progress-section" id="progressSection" style="display: none;">
        <div class="progress-header">
            <span class="progress-label">ì§„í–‰ ìƒí™©</span>
            <span class="progress-count" id="progressCount">0 / 0</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ -->
    <div id="mainContent">
        <div class="loading">ë¡œë”© ì¤‘...</div>
    </div>

    <!-- ê±´ë„ˆë›´ ì•½í’ˆ ì„¹ì…˜ -->
    <div class="skipped-drugs-section" id="skippedDrugsSection" style="display: none;">
        <div class="skipped-section-header">
            <div class="skipped-header-left" onclick="toggleSkippedDrugs()">
                <span class="skipped-section-title">ğŸ“‹ ê±´ë„ˆë›´ ì•½í’ˆ</span>
                <span class="skipped-section-count" id="skippedDrugsCount">0ê°œ</span>
            </div>
            <button class="reset-skipped-btn" onclick="resetAllSkippedDrugs()" title="ì „ì²´ ë˜ëŒë¦¬ê¸°">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
            </button>
        </div>
        <div class="skipped-drugs-list" id="skippedDrugsList"></div>
    </div>

    <!-- ë°ì´í„° ë¶€ì¡± ì•½í’ˆ ì„¹ì…˜ -->
    <div class="new-drugs-section" id="newDrugsSection" style="display: none;">
        <div class="section-header" onclick="toggleNewDrugs()">
            <span class="section-title">ë°ì´í„° ë¶€ì¡± ì•½í’ˆ</span>
            <span class="section-count" id="newDrugsCount">0ê°œ</span>
        </div>
        <div class="new-drugs-list" id="newDrugsList"></div>
    </div>
</div>

<!-- ì‹ ê·œ í™˜ì ë“±ë¡ ëª¨ë‹¬ -->
<div class="mini-modal" id="newPatientModal">
    <div class="mini-modal-content">
        <div class="mini-modal-title">ìƒˆ í™˜ì ë“±ë¡</div>
        <div class="mini-modal-subtitle" id="newPatientName">í™ê¸¸ë™</div>
        <div class="form-group">
            <label for="newPatientBirth">ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ *</label>
            <input type="text" id="newPatientBirth" placeholder="ì˜ˆ: 900101" maxlength="6">
        </div>
        <div class="mini-modal-buttons">
            <button class="btn btn-secondary" onclick="closeNewPatientModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="createNewPatient()">ë“±ë¡</button>
        </div>
    </div>
</div>

<!-- ë“±ë¡ ì™„ë£Œ ëª¨ë‹¬ -->
<div class="success-modal" id="successModal">
    <div class="success-modal-content">
        <div class="success-header">
            <div class="success-icon">âœ…</div>
            <div class="success-title">ë“±ë¡ ì™„ë£Œ</div>
            <div class="success-subtitle" id="successSubtitle">ì•½í’ˆì´ í™˜ìì—ê²Œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤</div>
        </div>
        <div class="success-info">
            <div class="success-info-row">
                <span class="success-info-label">ì•½í’ˆ</span>
                <span class="success-info-value" id="successDrugName">-</span>
            </div>
            <div class="success-info-row">
                <span class="success-info-label">í™˜ì</span>
                <span class="success-info-value" id="successPatientName">-</span>
            </div>
            <div class="success-info-row">
                <span class="success-info-label">ì²˜ë°©ëŸ‰</span>
                <span class="success-info-value" id="successDosage">-</span>
            </div>
        </div>
        <div class="success-options">
            <button class="success-option-btn" onclick="addAnotherPatient()">
                <span class="success-option-icon">ğŸ‘¥</span>
                <div class="success-option-text">
                    <div class="success-option-title">ì´ ì•½í’ˆì— í™˜ì ì¶”ê°€</div>
                    <div class="success-option-desc">ê°™ì€ ì•½í’ˆì„ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ í™˜ì ë“±ë¡</div>
                </div>
            </button>
            <button class="success-option-btn" onclick="showPatientDrugs()">
                <span class="success-option-icon">ğŸ’Š</span>
                <div class="success-option-text">
                    <div class="success-option-title" id="patientDrugsTitle">í™˜ìì˜ ë‹¤ë¥¸ ì•½í’ˆ</div>
                    <div class="success-option-desc">ì´ í™˜ìê°€ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë‹¤ë¥¸ ì•½í’ˆ í™•ì¸</div>
                </div>
            </button>
            <button class="success-option-btn" onclick="goToNextSuggestion()">
                <span class="success-option-icon">â¡ï¸</span>
                <div class="success-option-text">
                    <div class="success-option-title">ë‹¤ìŒ ì¶”ì²œìœ¼ë¡œ</div>
                    <div class="success-option-desc">ë‹¤ìŒ ì•½í’ˆ ì¶”ì²œ ë³´ê¸°</div>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- í™˜ì ì•½í’ˆ ë“±ë¡ ëª¨ë‹¬ (ê²€ìƒ‰ ê¸°ë°˜) -->
<div class="patient-drugs-modal" id="patientDrugsModal">
    <div class="patient-drugs-content">
        <div class="patient-drugs-header">
            <div class="patient-drugs-title" id="patientDrugsModalTitle">í™˜ìì˜ ë‹¤ë¥¸ ì•½í’ˆ</div>
            <div class="patient-drugs-subtitle" id="patientDrugsModalSubtitle">ì•½í’ˆì„ ê²€ìƒ‰í•˜ì—¬ ë“±ë¡í•˜ì„¸ìš”</div>
        </div>

        <!-- ì´ë¯¸ ë“±ë¡ëœ ì•½í’ˆ ëª©ë¡ -->
        <div class="registered-drugs-section" id="registeredDrugsSection">
            <div class="registered-drugs-header">
                <span class="registered-drugs-label">ë“±ë¡ëœ ì•½í’ˆ</span>
                <span class="registered-drugs-count" id="registeredDrugsCount">0ê°œ</span>
            </div>
            <div class="registered-drugs-list" id="registeredDrugsList">
                <!-- ë“±ë¡ëœ ì•½í’ˆ íƒœê·¸ë“¤ -->
            </div>
        </div>

        <!-- ê²€ìƒ‰ ì…ë ¥ -->
        <div class="drug-search-box">
            <input type="text" id="drugSearchInput" placeholder="ì•½í’ˆëª… ë˜ëŠ” ì•½í’ˆì½”ë“œë¡œ ê²€ìƒ‰..." autocomplete="off" oninput="onDrugSearchInput()">
            <button class="drug-search-clear" id="drugSearchClear" onclick="clearDrugSearch()">&times;</button>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ -->
        <div class="patient-drugs-list" id="patientDrugsList">
            <div class="patient-drugs-empty">ì•½í’ˆëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”</div>
        </div>

        <!-- ì²˜ë°©ëŸ‰ ì…ë ¥ ì˜ì—­ (ì„ íƒ í›„ í‘œì‹œ) -->
        <div class="dosage-input-area" id="dosageInputArea" style="display: none;">
            <div class="selected-drug-info" id="selectedDrugInfo">
                <div class="selected-drug-name" id="selectedDrugName">-</div>
                <div class="selected-drug-meta" id="selectedDrugMeta">-</div>
            </div>
            <div class="dosage-form-row">
                <label for="patientDrugDosage">1íšŒ ì²˜ë°©ëŸ‰</label>
                <input type="number" id="patientDrugDosage" value="1" min="1">
            </div>
            <div class="dosage-buttons">
                <button class="btn btn-secondary" onclick="cancelDrugSelection()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="registerPatientDrug()">ë“±ë¡</button>
            </div>
        </div>

        <div class="patient-drugs-footer">
            <button class="btn btn-secondary" onclick="closePatientDrugsModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ì•½í’ˆì— í™˜ì ì¶”ê°€ ëª¨ë‹¬ -->
<div class="drug-patients-modal" id="drugPatientsModal">
    <div class="drug-patients-content">
        <div class="drug-patients-header">
            <div class="drug-patients-title" id="drugPatientsModalTitle">ì•½í’ˆì— í™˜ì ì¶”ê°€</div>
            <div class="drug-patients-subtitle" id="drugPatientsModalSubtitle">í™˜ìë¥¼ ê²€ìƒ‰í•˜ì—¬ ë“±ë¡í•˜ì„¸ìš”</div>
        </div>

        <!-- ì´ë¯¸ ë“±ë¡ëœ í™˜ì ëª©ë¡ -->
        <div class="registered-patients-section" id="registeredPatientsSection">
            <div class="registered-patients-header">
                <span class="registered-patients-label">ë“±ë¡ëœ í™˜ì</span>
                <span class="registered-patients-count" id="registeredPatientsCount">0ëª…</span>
            </div>
            <div class="registered-patients-list" id="registeredPatientsList">
                <!-- ë“±ë¡ëœ í™˜ì íƒœê·¸ë“¤ -->
            </div>
        </div>

        <!-- í™˜ì ê²€ìƒ‰ ì…ë ¥ -->
        <div class="patient-search-box">
            <input type="text" id="modalPatientSearchInput" placeholder="í™˜ìëª…ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off" oninput="onModalPatientSearchInput()" onfocus="showModalPatientResults()">
            <div class="patient-search-results" id="modalPatientSearchResults"></div>
        </div>

        <!-- ì²˜ë°©ëŸ‰ ì…ë ¥ ì˜ì—­ (ì„ íƒ í›„ í‘œì‹œ) -->
        <div class="patient-dosage-area" id="patientDosageArea" style="display: none;">
            <div class="selected-patient-info" id="selectedPatientInfo">
                <div class="selected-patient-name" id="selectedPatientName">-</div>
                <div class="selected-patient-birth" id="selectedPatientBirth">-</div>
            </div>
            <div class="dosage-form-row">
                <label for="modalPatientDosage">1íšŒ ì²˜ë°©ëŸ‰</label>
                <input type="number" id="modalPatientDosage" value="1" min="1">
            </div>
            <div class="dosage-buttons">
                <button class="btn btn-secondary" onclick="cancelPatientSelection()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="registerDrugPatient()">ë“±ë¡</button>
            </div>
        </div>

        <div class="drug-patients-footer">
            <button class="btn btn-secondary" onclick="closeDrugPatientsModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/jaego-core.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/confirm-modal.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.VERSION }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.VERSION }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    // ì „ì—­ ë³€ìˆ˜
    var currentSuggestion = null;
    var patients = [];
    var stats = null;
    var selectedPatient = null;
    var pendingNewPatientName = null;
    var lastRegistration = null;
    var selectedDrugForPatient = null;
    var drugSearchTimeout = null;
    var patientRegisteredDrugs = [];
    var drugRegisteredPatients = [];
    var selectedPatientForDrug = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ
    document.addEventListener('DOMContentLoaded', async function() {
        await loadPatients();
        await checkActivation();
    });

    // íˆ´íŒ ìœ„ì¹˜ ë™ì  ê³„ì‚° (ì´ë²¤íŠ¸ ìœ„ì„)
    document.addEventListener('mouseover', function(e) {
        var helpIcon = e.target.closest('.help-icon');
        if (!helpIcon) return;

        var tooltip = helpIcon.querySelector('.help-tip');
        if (!tooltip) return;

        var rect = helpIcon.getBoundingClientRect();
        var tooltipWidth = 250;
        var padding = 10;

        // ê¸°ë³¸: ì•„ì´ì½˜ ì•„ë˜ì— í‘œì‹œ
        var top = rect.bottom + 8;
        var left = rect.left + (rect.width / 2) - (tooltipWidth / 2);

        // í™”ë©´ ì™¼ìª½ì„ ë²—ì–´ë‚˜ë©´ ì¡°ì •
        if (left < padding) {
            left = padding;
        }
        // í™”ë©´ ì˜¤ë¥¸ìª½ì„ ë²—ì–´ë‚˜ë©´ ì¡°ì •
        if (left + tooltipWidth > window.innerWidth - padding) {
            left = window.innerWidth - tooltipWidth - padding;
        }

        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
    });

    // í™˜ì ëª©ë¡ ë¡œë“œ
    async function loadPatients() {
        try {
            var response = await fetch('/api/patients');
            var data = await response.json();
            if (data.status === 'success') {
                patients = data.data;
            }
        } catch (error) {
            console.error('í™˜ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // í™œì„±í™” ìƒíƒœ í™•ì¸
    async function checkActivation() {
        try {
            var response = await fetch('/api/suggestion/status');
            var data = await response.json();

            if (data.status === 'success') {
                if (data.data.active) {
                    await loadStats();
                    await loadNextSuggestion();
                    await loadNewDrugs();
                    await loadSkippedDrugs();
                } else {
                    showInactiveState(data.data);
                }
            }
        } catch (error) {
            console.error('í™œì„±í™” ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            document.getElementById('mainContent').innerHTML =
                '<div class="inactive-state">' +
                    '<div class="inactive-icon">âš ï¸</div>' +
                    '<div class="inactive-title">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>' +
                    '<div class="inactive-message">' + error.message + '</div>' +
                '</div>';
        }
    }

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
        try {
            var response = await fetch('/api/suggestion/stats');
            var data = await response.json();
            if (data.status === 'success') {
                stats = data.data;
                updateProgress();
            }
        } catch (error) {
            console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
    function updateProgress() {
        if (!stats) return;

        var total = stats.total_periodic;
        var done = stats.already_registered;
        var percent = total > 0 ? (done / total) * 100 : 0;

        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('progressCount').textContent = done + ' / ' + total;
        document.getElementById('progressFill').style.width = percent + '%';
    }

    // ë¹„í™œì„± ìƒíƒœ í‘œì‹œ
    function showInactiveState(status) {
        document.getElementById('mainContent').innerHTML =
            '<div class="inactive-state">' +
                '<div class="inactive-icon">ğŸ‘¥</div>' +
                '<div class="inactive-title">ì•½í’ˆ ì¶”ì²œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´</div>' +
                '<div class="inactive-message">' +
                    'ì•½í’ˆ ì¶”ì²œì„ ìœ„í•´ ë” ë§ì€ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br><br>' +
                    '<strong>í˜„ì¬:</strong> í™˜ì ' + status.patients_with_drugs + 'ëª…, ì•½í’ˆ ' + status.drugs_with_patients + 'ì¢…<br>' +
                    '<strong>ê¶Œì¥:</strong> í™˜ì ' + status.required_count + 'ëª… ì´ìƒ, ì•½í’ˆ ' + status.required_drugs + 'ì¢… ì´ìƒ' +
                '</div>' +
                '<a href="/patient/manage" class="btn btn-primary">í™˜ì ê´€ë¦¬ë¡œ ì´ë™</a>' +
            '</div>';
    }

    // ë‹¤ìŒ ì œì•ˆ ë¡œë“œ
    async function loadNextSuggestion() {
        try {
            var response = await fetch('/api/suggestion/next');
            var data = await response.json();

            if (data.status === 'success') {
                if (data.data) {
                    currentSuggestion = data.data;
                    renderSuggestionCard(data.data);
                } else {
                    showCompleteState();
                }
            }
        } catch (error) {
            console.error('ì œì•ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ì œì•ˆ ì¹´ë“œ ë Œë”ë§
    function renderSuggestionCard(suggestion) {
        selectedPatient = null;

        // í‰ê·  ê°„ê²© ë²”ìœ„ (min ~ max)
        var avgInterval = suggestion.avg_interval || 0;
        var intervalStd = (suggestion.avg_interval && suggestion.interval_cv)
            ? suggestion.avg_interval * suggestion.interval_cv
            : 0;
        var intervalMin = Math.max(0, avgInterval - intervalStd).toFixed(1);
        var intervalMax = (avgInterval + intervalStd).toFixed(1);
        var intervalDisplay = intervalStd > 0 ? intervalMin + '~' + intervalMax : avgInterval.toFixed(1);

        // í‰ê·  ì‚¬ìš©ëŸ‰ ë²”ìœ„ (min ~ max)
        var avgPeakHeight = suggestion.avg_peak_height || 0;
        var heightStd = (suggestion.avg_peak_height && suggestion.height_cv)
            ? suggestion.avg_peak_height * suggestion.height_cv
            : 0;
        var usageMin = Math.max(0, avgPeakHeight - heightStd).toFixed(0);
        var usageMax = (avgPeakHeight + heightStd).toFixed(0);
        var usageDisplay = heightStd > 0 ? usageMin + '~' + usageMax : avgPeakHeight.toFixed(0);

        // í™œë™ë¥  (í¼ì„¼íŠ¸)
        var activeMonths = suggestion.active_months || 0;
        var totalMonths = suggestion.total_months || 1;
        var activityPercent = Math.round((activeMonths / totalMonths) * 100);
        var activityDisplay = activityPercent + '%';

        // ëŸ°ì›¨ì´
        var runway = (suggestion.monthly_avg && suggestion.monthly_avg > 0)
            ? Math.round(suggestion.current_stock / suggestion.monthly_avg) + 'ê°œì›”'
            : '-';

        var skipText = suggestion.skip_count > 0 ? ' (' + suggestion.skip_count + 'íšŒ ê±´ë„ˆëœ€)' : '';

        // ì°¨íŠ¸ ìƒì„± (í˜„ì¬ ì¬ê³ ëŠ” ë³„ë„ í‘œì‹œ)
        var sparklineSvg = generateSparklineSVG(suggestion.monthly_usage || []);

        var registeredWarning = suggestion.registered_count > 0 ?
            '<div style="text-align: center; color: #f59e0b; font-size: 13px; margin-top: -12px; margin-bottom: 12px;">' +
                'âš ï¸ ì´ë¯¸ ' + suggestion.registered_count + 'ëª…ì˜ í™˜ìê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤' +
            '</div>' : '';

        document.getElementById('mainContent').innerHTML =
            '<div class="suggestion-card">' +
                '<div class="card-header">' +
                    '<div class="drug-info">' +
                        '<h2>' + escapeHtml(suggestion.drug_name) + '</h2>' +
                        '<div class="drug-meta">' + escapeHtml(suggestion.drug_code) + ' | ' + escapeHtml(suggestion.company) + ' | ' + escapeHtml(suggestion.drug_type) + '</div>' +
                    '</div>' +
                    '<div class="similarity-badge">ìœ ì‚¬ë„ ' + suggestion.similarity + '%</div>' +
                '</div>' +
                '<div class="metrics-grid">' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + intervalDisplay + '</div>' +
                        '<div class="metric-label">í‰ê·  ê°„ê²© (ê°œì›”) <span class="help-icon">?<span class="help-tip">ì‚¬ìš©ëŸ‰ì´ ë°œìƒí•œ ì›” ì‚¬ì´ì˜ í‰ê·  ê°„ê²©ì…ë‹ˆë‹¤. ë²”ìœ„ëŠ” Â±1Ïƒ(í‘œì¤€í¸ì°¨)ë¡œ, ì•½ 68%ì˜ ë°ì´í„°ê°€ ì´ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.</span></span></div>' +
                    '</div>' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + usageDisplay + '</div>' +
                        '<div class="metric-label">í‰ê·  ì‚¬ìš©ëŸ‰ (ê°œ) <span class="help-icon">?<span class="help-tip">ì‚¬ìš©ì´ ë°œìƒí•œ ì›”ì˜ í‰ê·  ì‚¬ìš©ëŸ‰ì…ë‹ˆë‹¤. ë²”ìœ„ëŠ” Â±1Ïƒ(í‘œì¤€í¸ì°¨)ë¡œ, ì•½ 68%ì˜ ë°ì´í„°ê°€ ì´ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.</span></span></div>' +
                    '</div>' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + activityDisplay + '</div>' +
                        '<div class="metric-label">í™œë™ë¥  <span class="help-icon">?<span class="help-tip">ì „ì²´ ë°ì´í„° ê¸°ê°„ ì¤‘ ì‹¤ì œë¡œ ì‚¬ìš©ì´ ë°œìƒí•œ ì›”ì˜ ë¹„ìœ¨ì…ë‹ˆë‹¤. ë†’ì„ìˆ˜ë¡ ê¾¸ì¤€íˆ ì‚¬ìš©ë˜ëŠ” ì•½í’ˆì…ë‹ˆë‹¤.</span></span></div>' +
                    '</div>' +
                    '<div class="metric-card">' +
                        '<div class="metric-value">' + runway + '</div>' +
                        '<div class="metric-label">ëŸ°ì›¨ì´ <span class="help-icon">?<span class="help-tip">í˜„ì¬ ì¬ê³ ë¡œ ë²„í‹¸ ìˆ˜ ìˆëŠ” ì˜ˆìƒ ê°œì›” ìˆ˜ì…ë‹ˆë‹¤. (í˜„ì¬ ì¬ê³  Ã· ì›”í‰ê·  ì‚¬ìš©ëŸ‰)</span></span></div>' +
                    '</div>' +
                '</div>' +
                '<div class="sparkline-container">' +
                    '<div class="sparkline-header">' +
                        '<div class="sparkline-title">ì›”ë³„ ì‚¬ìš©ëŸ‰ ì¶”ì´</div>' +
                        '<div class="sparkline-stock">í˜„ì¬ ì¬ê³ : <strong>' + suggestion.current_stock + '</strong>ê°œ</div>' +
                    '</div>' +
                    sparklineSvg +
                '</div>' +
                buildSimilarDrugsSection(suggestion.nearest_k_drugs) +
                '<div class="register-form">' +
                    '<div class="form-title">í™˜ì ë“±ë¡</div>' +
                    '<div class="form-row">' +
                        '<div class="form-group">' +
                            '<label for="patientInput">í™˜ì ê²€ìƒ‰</label>' +
                            '<div class="patient-combobox">' +
                                '<input type="text" id="patientInput" placeholder="í™˜ìëª…ìœ¼ë¡œ ê²€ìƒ‰..." autocomplete="off" oninput="filterPatients()" onfocus="showPatientDropdown()">' +
                                '<button class="clear-btn" id="clearPatientBtn" onclick="clearPatientSelection()">&times;</button>' +
                                '<div class="patient-dropdown" id="patientDropdown"></div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label for="dosageInput">1íšŒ ì²˜ë°©ëŸ‰</label>' +
                            '<input type="number" id="dosageInput" value="1" min="1">' +
                        '</div>' +
                    '</div>' +
                    '<div class="button-row">' +
                        '<button class="btn btn-secondary" onclick="skipDrug()">' +
                            'ê±´ë„ˆë›°ê¸° <span class="skip-count">' + skipText + '</span>' +
                        '</button>' +
                        '<button class="btn btn-primary" onclick="registerDrug()" id="registerBtn">ë“±ë¡í•˜ê¸°</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            registeredWarning +
            '<div style="text-align: center; color: #9ca3af; font-size: 13px;">' +
                'ë‚¨ì€ ì œì•ˆ: ' + suggestion.remaining_count + 'ê°œ' +
            '</div>';

        document.addEventListener('click', handleClickOutside);
    }

    // í™˜ì ê²€ìƒ‰/í•„í„°ë§
    function filterPatients() {
        var input = document.getElementById('patientInput');
        var query = input.value.trim().toLowerCase();
        var dropdown = document.getElementById('patientDropdown');

        if (query.length === 0) {
            renderPatientOptions(patients, '');
        } else {
            var filtered = patients.filter(function(p) {
                return p.í™˜ìëª….toLowerCase().includes(query) ||
                    (p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬ && p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬.includes(query));
            });
            renderPatientOptions(filtered, query);
        }

        dropdown.classList.add('visible');
    }

    // í™˜ì ì˜µì…˜ ë Œë”ë§
    function renderPatientOptions(filteredPatients, query) {
        var dropdown = document.getElementById('patientDropdown');
        var html = '';

        if (filteredPatients.length > 0) {
            html = filteredPatients.map(function(p) {
                return '<div class="patient-option" onclick="selectPatient(' + p.í™˜ìID + ', \'' + escapeHtml(p.í™˜ìëª…) + '\', \'' + (p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬ || '') + '\')">' +
                    '<div class="name">' + escapeHtml(p.í™˜ìëª…) + '</div>' +
                    '<div class="birth">' + (p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬ || '') + '</div>' +
                '</div>';
            }).join('');
        }

        if (query.length > 0) {
            html += '<div class="patient-option new-patient" onclick="openNewPatientModal(\'' + escapeHtml(query) + '\')">' +
                '+ "' + escapeHtml(query) + '" ìƒˆë¡œ ë“±ë¡' +
            '</div>';
        }

        if (!html) {
            html = '<div class="no-results">í™˜ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”</div>';
        }

        dropdown.innerHTML = html;
    }

    // í™˜ì ë“œë¡­ë‹¤ìš´ í‘œì‹œ
    function showPatientDropdown() {
        var input = document.getElementById('patientInput');
        if (!selectedPatient) {
            filterPatients();
        }
    }

    // í™˜ì ì„ íƒ
    function selectPatient(id, name, birth) {
        selectedPatient = { id: id, name: name, birth: birth };

        var input = document.getElementById('patientInput');
        input.value = name + ' (' + birth + ')';
        input.readOnly = true;

        var clearBtn = document.getElementById('clearPatientBtn');
        clearBtn.style.display = 'block';

        var dropdown = document.getElementById('patientDropdown');
        dropdown.classList.remove('visible');
    }

    // í™˜ì ì„ íƒ ì´ˆê¸°í™”
    function clearPatientSelection() {
        selectedPatient = null;

        var input = document.getElementById('patientInput');
        input.value = '';
        input.readOnly = false;
        input.focus();

        var clearBtn = document.getElementById('clearPatientBtn');
        clearBtn.style.display = 'none';
    }

    // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì²˜ë¦¬
    function handleClickOutside(e) {
        var combobox = document.querySelector('.patient-combobox');
        var dropdown = document.getElementById('patientDropdown');

        if (combobox && !combobox.contains(e.target)) {
            dropdown.classList.remove('visible');
        }
    }

    // ì‹ ê·œ í™˜ì ëª¨ë‹¬ ì—´ê¸°
    function openNewPatientModal(name) {
        pendingNewPatientName = name;
        document.getElementById('newPatientName').textContent = name;
        document.getElementById('newPatientBirth').value = '';
        document.getElementById('newPatientModal').classList.add('visible');

        document.getElementById('patientDropdown').classList.remove('visible');

        setTimeout(function() {
            document.getElementById('newPatientBirth').focus();
        }, 100);
    }

    // ì‹ ê·œ í™˜ì ëª¨ë‹¬ ë‹«ê¸°
    function closeNewPatientModal() {
        document.getElementById('newPatientModal').classList.remove('visible');
        document.getElementById('newPatientBirth').value = '';
        pendingNewPatientName = null;
    }

    // ëª¨ë‹¬ ë‚´ìš© í™•ì¸ í•¨ìˆ˜
    function hasNewPatientModalContent() {
        var birth = document.getElementById('newPatientBirth').value.trim();
        return birth !== '';
    }

    // ëª¨ë‹¬ í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜
    function shakeModal(modalId) {
        var modal = document.getElementById(modalId);
        var content = modal.querySelector('.mini-modal-content');
        if (content) {
            content.classList.add('shake');
            setTimeout(function() {
                content.classList.remove('shake');
            }, 400);
        }
    }

    // í™•ì¸ í›„ ëª¨ë‹¬ ë‹«ê¸°
    async function tryCloseNewPatientModal() {
        if (hasNewPatientModalContent()) {
            shakeModal('newPatientModal');
            var confirmed = await showConfirmModal({
                icon: 'âš ï¸',
                title: 'ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤',
                message: 'ì •ë§ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì…ë ¥í•œ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                confirmText: 'ë‹«ê¸°',
                isDanger: true
            });
            if (confirmed) {
                closeNewPatientModal();
            }
        } else {
            closeNewPatientModal();
        }
    }

    // ì‹ ê·œ í™˜ì ìƒì„±
    async function createNewPatient() {
        var birth = document.getElementById('newPatientBirth').value.trim();

        if (!birth) {
            showToast('ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        if (birth.length !== 6 || !/^\d{6}$/.test(birth)) {
            showToast('ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬ëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            var response = await fetch('/api/patient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: pendingNewPatientName,
                    birth: birth
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                var newPatient = {
                    í™˜ìID: data.patient_id,
                    í™˜ìëª…: pendingNewPatientName,
                    ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬: birth
                };
                patients.push(newPatient);

                selectPatient(data.patient_id, pendingNewPatientName, birth);
                closeNewPatientModal();
            } else {
                showToast(data.message || 'í™˜ì ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('í™˜ì ë“±ë¡ ì‹¤íŒ¨:', error);
            showToast('í™˜ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìœ ì‚¬ ì•½í’ˆ ì„¹ì…˜ ìƒì„±
    function buildSimilarDrugsSection(nearestDrugs) {
        if (!nearestDrugs || nearestDrugs.length === 0) {
            return '';
        }

        var html = '<div class="similar-drugs-container">' +
            '<div class="similar-drugs-header" onclick="toggleSimilarDrugs()">' +
                '<div class="similar-drugs-title">' +
                    '<span class="icon">ğŸ”—</span>' +
                    'ìœ ì‚¬í•œ íŒ¨í„´ì˜ ë“±ë¡ ì•½í’ˆ (KNN K=' + nearestDrugs.length + ')' +
                '</div>' +
                '<span class="similar-drugs-toggle">â–¶</span>' +
            '</div>' +
            '<div class="similar-drugs-list" style="display: none;">';

        for (var i = 0; i < nearestDrugs.length; i++) {
            var drug = nearestDrugs[i];
            var intervalText = drug.avg_interval ? drug.avg_interval.toFixed(1) + 'ê°œì›” ì£¼ê¸°' : '-';
            var rankBadge = (i + 1) + 'ìœ„';

            html += '<div class="similar-drug-item">' +
                '<div class="similar-drug-info">' +
                    '<div class="similar-drug-name">' + drug.drug_name + '</div>' +
                    '<div class="similar-drug-interval">' + intervalText + '</div>' +
                '</div>' +
                '<div class="similar-drug-badge">' + rankBadge + '</div>' +
            '</div>';
        }

        html += '</div></div>';
        return html;
    }

    // ìœ ì‚¬ ì•½í’ˆ ì„¹ì…˜ í† ê¸€
    function toggleSimilarDrugs() {
        var list = document.querySelector('.similar-drugs-list');
        var toggle = document.querySelector('.similar-drugs-toggle');
        if (list && toggle) {
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                list.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }
    }

    // ìŠ¤íŒŒí¬ë¼ì¸ SVG ìƒì„±
    function generateSparklineSVG(data) {
        if (!data || data.length === 0) {
            return '<div class="chart-container"><svg width="100%" height="80"></svg></div>';
        }

        var width = 700;
        var height = 80;
        var paddingLeft = 35;
        var paddingRight = 40;
        var paddingTop = 10;
        var paddingBottom = 5;
        var chartWidth = width - paddingLeft - paddingRight;
        var chartHeight = height - paddingTop - paddingBottom;

        var maxVal = Math.max.apply(null, data) || 1;
        var minVal = Math.min.apply(null, data.filter(function(v) { return v > 0; })) || 0;
        var avgVal = data.reduce(function(a, b) { return a + b; }, 0) / data.length;
        var lastVal = data[data.length - 1];
        var n = data.length;

        // Y ì¢Œí‘œ ê³„ì‚° í•¨ìˆ˜ (0~maxVal ë²”ìœ„)
        function getY(v) {
            return paddingTop + chartHeight - (v / maxVal) * chartHeight;
        }

        // X ì¢Œí‘œ ê³„ì‚° í•¨ìˆ˜
        function getX(i) {
            return paddingLeft + (i / (n - 1)) * chartWidth;
        }

        var points = data.map(function(v, i) {
            return getX(i) + ',' + getY(v);
        });

        var path = 'M' + points.join(' L');

        // í‰ê· ì„ 
        var avgY = getY(avgVal);
        var avgLine = '<line x1="' + paddingLeft + '" y1="' + avgY + '" x2="' + (width - paddingRight) + '" y2="' + avgY + '" stroke="#94a3b8" stroke-width="1" stroke-dasharray="4,4"/>';

        // ë°ì´í„° í¬ì¸íŠ¸ (ì›)
        var circles = data.map(function(v, i) {
            if (v > 0) {
                return '<circle cx="' + getX(i) + '" cy="' + getY(v) + '" r="3" fill="#48bb78"/>';
            }
            return '';
        }).join('');

        // ìµœëŒ€ê°’ ë ˆì´ë¸” (ì¢Œì¸¡)
        var maxLabel = '<text x="' + (paddingLeft - 5) + '" y="' + (paddingTop + 4) + '" text-anchor="end" font-size="10" fill="#6b7280">' + maxVal + '</text>';

        // í‰ê· ê°’ ë ˆì´ë¸” (ì¢Œì¸¡)
        var avgLabel = '<text x="' + (paddingLeft - 5) + '" y="' + (avgY + 3) + '" text-anchor="end" font-size="9" fill="#94a3b8">' + Math.round(avgVal) + '</text>';

        // 0 ë¼ì¸ (0ì¸ ê°’ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ)
        var hasZero = data.some(function(v) { return v === 0; });
        var zeroLine = '';
        var zeroLabel = '';
        if (hasZero) {
            var zeroY = getY(0);
            zeroLine = '<line x1="' + paddingLeft + '" y1="' + zeroY + '" x2="' + (width - paddingRight) + '" y2="' + zeroY + '" stroke="#cbd5e0" stroke-width="1"/>';
            zeroLabel = '<text x="' + (paddingLeft - 5) + '" y="' + (zeroY + 3) + '" text-anchor="end" font-size="9" fill="#cbd5e0">0</text>';
        }

        // ìµœê·¼ ê°’ ê°•ì¡° (ìš°ì¸¡ ë)
        var lastX = getX(n - 1);
        var lastY = getY(lastVal);
        var lastCircle = '<circle cx="' + lastX + '" cy="' + lastY + '" r="5" fill="#48bb78"/>';
        var lastLabel = '<text x="' + (lastX + 8) + '" y="' + (lastY + 4) + '" font-size="11" font-weight="600" fill="#48bb78">' + lastVal + '</text>';

        return '<div class="chart-container">' +
            '<svg width="100%" height="' + height + '" viewBox="0 0 ' + width + ' ' + height + '" preserveAspectRatio="none">' +
                zeroLine +
                avgLine +
                '<path d="' + path + '" fill="none" stroke="#48bb78" stroke-width="2"/>' +
                circles +
                lastCircle +
                maxLabel +
                avgLabel +
                zeroLabel +
                lastLabel +
            '</svg>' +
        '</div>';
    }

    // ì•½í’ˆ ë“±ë¡
    async function registerDrug() {
        if (!selectedPatient) {
            showToast('í™˜ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
            document.getElementById('patientInput').focus();
            return;
        }

        var dosage = document.getElementById('dosageInput').value;

        if (!currentSuggestion) return;

        var btn = document.getElementById('registerBtn');
        btn.disabled = true;
        btn.textContent = 'ë“±ë¡ ì¤‘...';

        try {
            var response = await fetch('/api/suggestion/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: currentSuggestion.drug_code,
                    patient_id: selectedPatient.id,
                    dosage: parseInt(dosage) || 1
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                lastRegistration = {
                    drug: Object.assign({}, currentSuggestion),
                    patient: Object.assign({}, selectedPatient),
                    dosage: parseInt(dosage) || 1
                };

                await loadStats();
                await loadSkippedDrugs();

                showSuccessModal();
            } else {
                showToast(data.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                btn.disabled = false;
                btn.textContent = 'ë“±ë¡í•˜ê¸°';
            }
        } catch (error) {
            console.error('ë“±ë¡ ì‹¤íŒ¨:', error);
            showToast('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            btn.disabled = false;
            btn.textContent = 'ë“±ë¡í•˜ê¸°';
        }
    }

    // ë“±ë¡ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
    function showSuccessModal() {
        if (!lastRegistration) return;

        document.getElementById('successDrugName').textContent = lastRegistration.drug.drug_name;
        document.getElementById('successPatientName').textContent =
            lastRegistration.patient.name + ' (' + lastRegistration.patient.birth + ')';
        document.getElementById('successDosage').textContent = lastRegistration.dosage + 'ì •';

        document.getElementById('patientDrugsTitle').textContent =
            lastRegistration.patient.name + 'ì˜ ë‹¤ë¥¸ ì•½í’ˆ';

        document.getElementById('successModal').classList.add('visible');
    }

    // ë“±ë¡ ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸°
    function closeSuccessModal() {
        document.getElementById('successModal').classList.remove('visible');
    }

    // ì´ ì•½í’ˆì— ë‹¤ë¥¸ í™˜ì ì¶”ê°€ (ëª¨ë‹¬ ì—´ê¸°)
    async function addAnotherPatient() {
        if (!lastRegistration) return;

        closeSuccessModal();

        var drugName = lastRegistration.drug.drug_name;
        var drugCode = lastRegistration.drug.drug_code;

        document.getElementById('drugPatientsModalTitle').textContent = 'ì•½í’ˆì— í™˜ì ì¶”ê°€';
        document.getElementById('drugPatientsModalSubtitle').textContent = drugName;

        document.getElementById('modalPatientSearchInput').value = '';
        document.getElementById('modalPatientSearchResults').classList.remove('visible');
        document.getElementById('patientDosageArea').style.display = 'none';
        selectedPatientForDrug = null;

        document.getElementById('registeredPatientsList').innerHTML =
            '<span class="registered-patients-empty">ë¡œë”© ì¤‘...</span>';
        document.getElementById('registeredPatientsCount').textContent = '-';

        document.getElementById('drugPatientsModal').classList.add('visible');

        await loadDrugRegisteredPatients(drugCode);

        setTimeout(function() {
            document.getElementById('modalPatientSearchInput').focus();
        }, 100);
    }

    // ì•½í’ˆì— ë“±ë¡ëœ í™˜ì ëª©ë¡ ë¡œë“œ
    async function loadDrugRegisteredPatients(drugCode) {
        try {
            var response = await fetch('/api/drug/' + drugCode + '/patients');
            var data = await response.json();

            if (data.status === 'success' && data.data) {
                drugRegisteredPatients = data.data.map(function(p) { return p.í™˜ìID; });
                renderRegisteredPatients(data.data);
            } else {
                drugRegisteredPatients = [];
                renderRegisteredPatients([]);
            }
        } catch (error) {
            console.error('ë“±ë¡ëœ í™˜ì ë¡œë“œ ì‹¤íŒ¨:', error);
            drugRegisteredPatients = [];
            renderRegisteredPatients([]);
        }
    }

    // ë“±ë¡ëœ í™˜ì íƒœê·¸ ë Œë”ë§
    function renderRegisteredPatients(patientsList) {
        var list = document.getElementById('registeredPatientsList');
        var countEl = document.getElementById('registeredPatientsCount');

        if (!patientsList || patientsList.length === 0) {
            list.innerHTML = '<span class="registered-patients-empty">ë“±ë¡ëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤</span>';
            countEl.textContent = '0ëª…';
            return;
        }

        countEl.textContent = patientsList.length + 'ëª…';
        list.innerHTML = patientsList.map(function(patient) {
            return '<span class="registered-patient-tag">' +
                '<span class="check">âœ“</span>' +
                escapeHtml(patient.í™˜ìëª…) +
            '</span>';
        }).join('');
    }

    // ëª¨ë‹¬ ë‚´ í™˜ì ê²€ìƒ‰ ì…ë ¥ í•¸ë“¤ëŸ¬
    function onModalPatientSearchInput() {
        filterModalPatients();
    }

    // ëª¨ë‹¬ í™˜ì ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function showModalPatientResults() {
        filterModalPatients();
    }

    // í™˜ì í•„í„°ë§ ë° ê²°ê³¼ ë Œë”ë§
    function filterModalPatients() {
        var input = document.getElementById('modalPatientSearchInput');
        var query = input.value.trim().toLowerCase();
        var resultsDiv = document.getElementById('modalPatientSearchResults');

        document.getElementById('patientDosageArea').style.display = 'none';
        selectedPatientForDrug = null;

        var filtered = patients;
        if (query.length > 0) {
            filtered = patients.filter(function(p) {
                return p.í™˜ìëª….toLowerCase().includes(query) ||
                    (p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬ && p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬.includes(query));
            });
        }

        var html = '';

        if (filtered.length > 0) {
            html = filtered.map(function(p) {
                var isRegistered = drugRegisteredPatients.includes(p.í™˜ìID);
                var registeredClass = isRegistered ? ' already-registered' : '';
                var onclick = isRegistered ? '' : 'onclick="selectPatientForDrug(' + p.í™˜ìID + ', \'' + escapeHtml(p.í™˜ìëª…) + '\', \'' + (p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬ || '') + '\')"';

                return '<div class="patient-search-item' + registeredClass + '" ' + onclick + '>' +
                    '<div class="name">' + escapeHtml(p.í™˜ìëª…) + (isRegistered ? ' (ë“±ë¡ë¨)' : '') + '</div>' +
                    '<div class="birth">' + (p.ì£¼ë¯¼ë²ˆí˜¸_ì•ìë¦¬ || '') + '</div>' +
                '</div>';
            }).join('');
        }

        if (query.length > 0) {
            html += '<div class="patient-search-item new-patient" onclick="openNewPatientModalFromDrug(\'' + escapeHtml(query) + '\')">' +
                '+ "' + escapeHtml(query) + '" ìƒˆë¡œ ë“±ë¡' +
            '</div>';
        }

        if (!html) {
            html = '<div class="patient-search-item" style="cursor: default; color: #9ca3af;">í™˜ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”</div>';
        }

        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('visible');
    }

    // ì•½í’ˆì— ë“±ë¡í•  í™˜ì ì„ íƒ
    function selectPatientForDrug(patientId, name, birth) {
        selectedPatientForDrug = {
            id: patientId,
            name: name,
            birth: birth
        };

        document.getElementById('modalPatientSearchResults').classList.remove('visible');

        document.getElementById('selectedPatientName').textContent = name;
        document.getElementById('selectedPatientBirth').textContent = birth || '-';

        document.getElementById('modalPatientDosage').value = 1;

        document.getElementById('patientDosageArea').style.display = 'block';

        setTimeout(function() {
            document.getElementById('modalPatientDosage').focus();
            document.getElementById('modalPatientDosage').select();
        }, 100);
    }

    // í™˜ì ì„ íƒ ì·¨ì†Œ
    function cancelPatientSelection() {
        selectedPatientForDrug = null;
        document.getElementById('patientDosageArea').style.display = 'none';
        document.getElementById('modalPatientSearchInput').value = '';
        document.getElementById('modalPatientSearchInput').focus();
    }

    // ì•½í’ˆì— í™˜ì ë“±ë¡
    async function registerDrugPatient() {
        if (!selectedPatientForDrug || !lastRegistration) return;

        var dosage = parseInt(document.getElementById('modalPatientDosage').value) || 1;
        var drugCode = lastRegistration.drug.drug_code;

        try {
            var response = await fetch('/api/patient/' + selectedPatientForDrug.id + '/link-drug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: drugCode,
                    dosage: dosage
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                showToast('âœ“ ' + selectedPatientForDrug.name + ' ë“±ë¡ ì™„ë£Œ', 'success');

                document.getElementById('modalPatientSearchInput').value = '';
                document.getElementById('modalPatientSearchResults').classList.remove('visible');
                document.getElementById('patientDosageArea').style.display = 'none';
                selectedPatientForDrug = null;

                document.getElementById('modalPatientSearchInput').focus();

                await loadDrugRegisteredPatients(drugCode);
                await loadStats();
            } else {
                showToast(data.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('í™˜ì ë“±ë¡ ì‹¤íŒ¨:', error);
            showToast('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì•½í’ˆì—ì„œ ì‹ ê·œ í™˜ì ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    function openNewPatientModalFromDrug(name) {
        pendingNewPatientName = name;
        document.getElementById('newPatientName').textContent = name;
        document.getElementById('newPatientBirth').value = '';
        document.getElementById('newPatientModal').classList.add('visible');

        document.getElementById('modalPatientSearchResults').classList.remove('visible');

        setTimeout(function() {
            document.getElementById('newPatientBirth').focus();
        }, 100);
    }

    // ì•½í’ˆ í™˜ì ëª¨ë‹¬ ë‹«ê¸° (ë‹¤ìŒ ì œì•ˆìœ¼ë¡œ ì´ë™)
    async function closeDrugPatientsModal() {
        document.getElementById('drugPatientsModal').classList.remove('visible');
        selectedPatientForDrug = null;
        drugRegisteredPatients = [];

        await loadNextSuggestion();
    }

    // í™˜ìì˜ ë‹¤ë¥¸ ì•½í’ˆ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    async function showPatientDrugs() {
        if (!lastRegistration) return;

        closeSuccessModal();

        var patientName = lastRegistration.patient.name;
        var patientId = lastRegistration.patient.id;

        document.getElementById('patientDrugsModalTitle').textContent =
            patientName + 'ì˜ ë‹¤ë¥¸ ì•½í’ˆ ë“±ë¡';

        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchClear').classList.remove('visible');
        document.getElementById('patientDrugsList').innerHTML =
            '<div class="patient-drugs-empty">ì•½í’ˆëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”</div>';
        document.getElementById('dosageInputArea').style.display = 'none';
        selectedDrugForPatient = null;

        document.getElementById('registeredDrugsList').innerHTML =
            '<span class="registered-drugs-empty">ë¡œë”© ì¤‘...</span>';
        document.getElementById('registeredDrugsCount').textContent = '-';

        document.getElementById('patientDrugsModal').classList.add('visible');

        await loadPatientRegisteredDrugs(patientId);

        setTimeout(function() {
            document.getElementById('drugSearchInput').focus();
        }, 100);
    }

    // ì•½í’ˆ ê²€ìƒ‰ (ë””ë°”ìš´ìŠ¤ ì ìš©)
    function onDrugSearchInput() {
        var input = document.getElementById('drugSearchInput');
        var query = input.value.trim();

        var clearBtn = document.getElementById('drugSearchClear');
        if (query.length > 0) {
            clearBtn.classList.add('visible');
        } else {
            clearBtn.classList.remove('visible');
        }

        document.getElementById('dosageInputArea').style.display = 'none';
        selectedDrugForPatient = null;

        if (drugSearchTimeout) {
            clearTimeout(drugSearchTimeout);
        }

        if (query.length < 2) {
            document.getElementById('patientDrugsList').innerHTML =
                '<div class="patient-drugs-empty">2ê¸€ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”</div>';
            return;
        }

        document.getElementById('patientDrugsList').innerHTML =
            '<div class="patient-drugs-empty">ê²€ìƒ‰ ì¤‘...</div>';

        drugSearchTimeout = setTimeout(function() {
            searchDrugsForPatient(query);
        }, 300);
    }

    // ì•½í’ˆ ê²€ìƒ‰ API í˜¸ì¶œ
    async function searchDrugsForPatient(query) {
        try {
            var response = await fetch('/api/search-inventory?q=' + encodeURIComponent(query));
            var data = await response.json();

            if (data.status === 'success') {
                renderDrugSearchResults(data.results);
            } else {
                document.getElementById('patientDrugsList').innerHTML =
                    '<div class="patient-drugs-empty">' + (data.message || 'ê²€ìƒ‰ ì‹¤íŒ¨') + '</div>';
            }
        } catch (error) {
            console.error('ì•½í’ˆ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
            document.getElementById('patientDrugsList').innerHTML =
                '<div class="patient-drugs-empty">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
        }
    }

    // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
    function renderDrugSearchResults(drugs) {
        var list = document.getElementById('patientDrugsList');

        if (!drugs || drugs.length === 0) {
            list.innerHTML = '<div class="patient-drugs-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }

        list.innerHTML = drugs.map(function(drug) {
            var isRegistered = patientRegisteredDrugs.includes(drug.ì•½í’ˆì½”ë“œ);
            var registeredClass = isRegistered ? ' already-registered' : '';
            var onclick = isRegistered ? '' : 'onclick="selectDrugForPatient(\'' + escapeHtml(drug.ì•½í’ˆì½”ë“œ) + '\', \'' + escapeHtml(drug.ì•½í’ˆëª…) + '\', \'' + escapeHtml(drug.ì œì•½íšŒì‚¬) + '\', ' + (drug.í˜„ì¬_ì¬ê³ ìˆ˜ëŸ‰ || 0) + ')"';

            return '<div class="patient-drug-item' + registeredClass + '" ' + onclick + '>' +
                '<div class="patient-drug-info">' +
                    '<div class="patient-drug-name">' + escapeHtml(drug.ì•½í’ˆëª…) + '</div>' +
                    '<div class="patient-drug-meta">' + escapeHtml(drug.ì•½í’ˆì½”ë“œ) + ' | ' + escapeHtml(drug.ì œì•½íšŒì‚¬) + ' | ì¬ê³ : ' + (drug.í˜„ì¬_ì¬ê³ ìˆ˜ëŸ‰ || 0) + '</div>' +
                '</div>' +
            '</div>';
        }).join('');
    }

    // ì•½í’ˆ ì„ íƒ ì‹œ ì²˜ë°©ëŸ‰ ì…ë ¥ ì˜ì—­ í‘œì‹œ
    function selectDrugForPatient(drugCode, drugName, company, stock) {
        selectedDrugForPatient = {
            drug_code: drugCode,
            drug_name: drugName,
            company: company,
            stock: stock
        };

        document.getElementById('selectedDrugName').textContent = drugName;
        document.getElementById('selectedDrugMeta').textContent =
            drugCode + ' | ' + company + ' | í˜„ì¬ ì¬ê³ : ' + stock;

        document.getElementById('patientDrugDosage').value = 1;

        document.getElementById('dosageInputArea').style.display = 'block';

        setTimeout(function() {
            document.getElementById('patientDrugDosage').focus();
            document.getElementById('patientDrugDosage').select();
        }, 100);
    }

    // ì•½í’ˆ ì„ íƒ ì·¨ì†Œ
    function cancelDrugSelection() {
        selectedDrugForPatient = null;
        document.getElementById('dosageInputArea').style.display = 'none';
    }

    // í™˜ìì—ê²Œ ì•½í’ˆ ë“±ë¡
    async function registerPatientDrug() {
        if (!selectedDrugForPatient || !lastRegistration) return;

        var dosage = parseInt(document.getElementById('patientDrugDosage').value) || 1;
        var patientId = lastRegistration.patient.id;

        try {
            var response = await fetch('/api/patient/' + patientId + '/link-drug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: selectedDrugForPatient.drug_code,
                    dosage: dosage
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                showToast('âœ“ ' + selectedDrugForPatient.drug_name + ' ë“±ë¡ ì™„ë£Œ', 'success');

                document.getElementById('drugSearchInput').value = '';
                document.getElementById('drugSearchClear').classList.remove('visible');
                document.getElementById('patientDrugsList').innerHTML =
                    '<div class="patient-drugs-empty">ì•½í’ˆëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”</div>';
                document.getElementById('dosageInputArea').style.display = 'none';
                selectedDrugForPatient = null;

                document.getElementById('drugSearchInput').focus();

                await loadPatientRegisteredDrugs(lastRegistration.patient.id);
                await loadStats();
            } else {
                showToast(data.message || 'ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ì•½í’ˆ ë“±ë¡ ì‹¤íŒ¨:', error);
            showToast('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
    function clearDrugSearch() {
        document.getElementById('drugSearchInput').value = '';
        document.getElementById('drugSearchClear').classList.remove('visible');
        document.getElementById('patientDrugsList').innerHTML =
            '<div class="patient-drugs-empty">ì•½í’ˆëª…ì„ ì…ë ¥í•˜ì—¬ ê²€ìƒ‰í•˜ì„¸ìš”</div>';
        document.getElementById('dosageInputArea').style.display = 'none';
        selectedDrugForPatient = null;
        document.getElementById('drugSearchInput').focus();
    }

    // í™˜ì ì•½í’ˆ ëª¨ë‹¬ ë‹«ê¸° (ë‹¤ìŒ ì œì•ˆìœ¼ë¡œ ì´ë™)
    async function closePatientDrugsModal() {
        document.getElementById('patientDrugsModal').classList.remove('visible');
        selectedDrugForPatient = null;
        patientRegisteredDrugs = [];

        await loadNextSuggestion();
    }

    // í™˜ìì˜ ë“±ë¡ëœ ì•½í’ˆ ëª©ë¡ ë¡œë“œ
    async function loadPatientRegisteredDrugs(patientId) {
        try {
            var response = await fetch('/api/patient/' + patientId + '/drugs-with-stock');
            var data = await response.json();

            if (data.status === 'success' && data.drugs) {
                patientRegisteredDrugs = data.drugs.map(function(d) { return d.drug_code; });
                renderRegisteredDrugs(data.drugs);
            } else {
                patientRegisteredDrugs = [];
                renderRegisteredDrugs([]);
            }
        } catch (error) {
            console.error('ë“±ë¡ëœ ì•½í’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
            patientRegisteredDrugs = [];
            renderRegisteredDrugs([]);
        }
    }

    // ë“±ë¡ëœ ì•½í’ˆ íƒœê·¸ ë Œë”ë§
    function renderRegisteredDrugs(drugs) {
        var list = document.getElementById('registeredDrugsList');
        var countEl = document.getElementById('registeredDrugsCount');

        if (!drugs || drugs.length === 0) {
            list.innerHTML = '<span class="registered-drugs-empty">ë“±ë¡ëœ ì•½í’ˆì´ ì—†ìŠµë‹ˆë‹¤</span>';
            countEl.textContent = '0ê°œ';
            return;
        }

        countEl.textContent = drugs.length + 'ê°œ';
        list.innerHTML = drugs.map(function(drug) {
            var displayName = drug.drug_name.length > 15 ? drug.drug_name.substring(0, 15) + '...' : drug.drug_name;
            return '<span class="registered-drug-tag">' +
                '<span class="check">âœ“</span>' +
                escapeHtml(displayName) +
            '</span>';
        }).join('');
    }

    // ë‹¤ìŒ ì¶”ì²œìœ¼ë¡œ ì´ë™
    async function goToNextSuggestion() {
        closeSuccessModal();
        await loadNextSuggestion();
    }

    // ê±´ë„ˆë›°ê¸°
    async function skipDrug() {
        if (!currentSuggestion) return;

        try {
            var response = await fetch('/api/suggestion/skip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    drug_code: currentSuggestion.drug_code
                })
            });

            var data = await response.json();

            if (data.status === 'success') {
                await loadStats();
                await loadNextSuggestion();
                await loadSkippedDrugs();
            } else {
                showToast(data.message || 'ê±´ë„ˆë›°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ê±´ë„ˆë›°ê¸° ì‹¤íŒ¨:', error);
        }
    }

    // ì™„ë£Œ ìƒíƒœ í‘œì‹œ
    function showCompleteState() {
        document.getElementById('mainContent').innerHTML =
            '<div class="complete-state">' +
                '<div class="complete-icon">ğŸ‰</div>' +
                '<div class="complete-title">ëª¨ë“  ì œì•ˆì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤!</div>' +
                '<div class="complete-message">' +
                    'ì£¼ê¸°ì  íŒ¨í„´ì˜ ì•½í’ˆë“¤ì„ ëª¨ë‘ í™•ì¸í–ˆìŠµë‹ˆë‹¤.<br>' +
                    'ìƒˆë¡œìš´ ë°ì´í„°ê°€ ì¶”ê°€ë˜ë©´ ë” ë§ì€ ì œì•ˆì´ ìƒì„±ë©ë‹ˆë‹¤.' +
                '</div>' +
                '<a href="/patient/manage" class="btn btn-primary">í™˜ì ê´€ë¦¬ë¡œ ì´ë™</a>' +
            '</div>';
    }

    // ì‹ ê·œ ì•½í’ˆ ë¡œë“œ
    async function loadNewDrugs() {
        try {
            var response = await fetch('/api/suggestion/new-drugs');
            var data = await response.json();

            if (data.status === 'success' && data.data.length > 0) {
                document.getElementById('newDrugsSection').style.display = 'block';
                document.getElementById('newDrugsCount').textContent = data.count + 'ê°œ';

                var list = document.getElementById('newDrugsList');
                list.innerHTML = data.data.map(function(drug) {
                    return '<div class="new-drug-item">' +
                        '<div>' +
                            '<div class="new-drug-name">' + escapeHtml(drug.drug_name) + '</div>' +
                            '<div class="new-drug-peaks">' + drug.drug_code + ' | ' + drug.company + '</div>' +
                        '</div>' +
                        '<div class="new-drug-peaks">í”¼í¬ ' + drug.peak_count + 'ê°œ</div>' +
                    '</div>';
                }).join('');
            }
        } catch (error) {
            console.error('ì‹ ê·œ ì•½í’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ì‹ ê·œ ì•½í’ˆ í† ê¸€
    function toggleNewDrugs() {
        var list = document.getElementById('newDrugsList');
        list.classList.toggle('visible');
    }

    // ê±´ë„ˆë›´ ì•½í’ˆ ë¡œë“œ
    async function loadSkippedDrugs() {
        try {
            var response = await fetch('/api/suggestion/skipped');
            var data = await response.json();

            if (data.status === 'success' && data.data.length > 0) {
                document.getElementById('skippedDrugsSection').style.display = 'block';
                document.getElementById('skippedDrugsCount').textContent = data.count + 'ê°œ';

                var list = document.getElementById('skippedDrugsList');
                list.innerHTML = data.data.map(function(drug) {
                    return '<div class="skipped-drug-item" onclick="loadSkippedDrug(\'' + escapeHtml(drug.drug_code) + '\')">' +
                        '<div class="skipped-drug-info">' +
                            '<div class="skipped-drug-name">' + escapeHtml(drug.drug_name) + '</div>' +
                            '<div class="skipped-drug-code">' + escapeHtml(drug.drug_code) + ' | ' + escapeHtml(drug.company) + '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } else {
                document.getElementById('skippedDrugsSection').style.display = 'none';
            }
        } catch (error) {
            console.error('ê±´ë„ˆë›´ ì•½í’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }

    // ê±´ë„ˆë›´ ì•½í’ˆ í† ê¸€
    function toggleSkippedDrugs() {
        var list = document.getElementById('skippedDrugsList');
        list.classList.toggle('visible');
    }

    // ê±´ë„ˆë›´ ì•½í’ˆ ì „ì²´ ë˜ëŒë¦¬ê¸°
    async function resetAllSkippedDrugs() {
        var countText = document.getElementById('skippedDrugsCount').textContent;
        var count = parseInt(countText) || 0;

        if (count === 0) {
            showToast('ë˜ëŒë¦´ ì•½í’ˆì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        var confirmed = await showConfirmModal({
            icon: 'â†©ï¸',
            title: 'ê±´ë„ˆë›´ ì•½í’ˆ ì „ì²´ ë˜ëŒë¦¬ê¸°',
            message: 'ê±´ë„ˆë›´ ì•½í’ˆ ' + count + 'ê°œë¥¼ ëª¨ë‘ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?<br><br>ë˜ëŒë¦¬ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì œì•ˆì„ ê²€í† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
            confirmText: 'ì „ì²´ ë˜ëŒë¦¬ê¸°',
            isDanger: false
        });

        if (!confirmed) {
            return;
        }

        try {
            var response = await fetch('/api/suggestion/skipped/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            var data = await response.json();

            if (data.status === 'success') {
                showToast(data.message || 'ê±´ë„ˆë›´ ì•½í’ˆì´ ëª¨ë‘ ë˜ëŒë ¤ì¡ŒìŠµë‹ˆë‹¤.', 'success');
                // ê±´ë„ˆë›´ ì•½í’ˆ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                document.getElementById('skippedDrugsSection').style.display = 'none';
                document.getElementById('skippedDrugsList').innerHTML = '';
                document.getElementById('skippedDrugsCount').textContent = '0ê°œ';
                // í†µê³„ ë° ì œì•ˆ ë‹¤ì‹œ ë¡œë“œ
                await loadStats();
                await loadNextSuggestion();
            } else {
                showToast(data.message || 'ë˜ëŒë¦¬ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ê±´ë„ˆë›´ ì•½í’ˆ ë˜ëŒë¦¬ê¸° ì‹¤íŒ¨:', error);
            showToast('ë˜ëŒë¦¬ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ê±´ë„ˆë›´ ì•½í’ˆ ì„ íƒ ì‹œ ë©”ì¸ ì¹´ë“œë¡œ í‘œì‹œ
    async function loadSkippedDrug(drugCode) {
        try {
            var response = await fetch('/api/suggestion/drug/' + drugCode);
            var data = await response.json();

            if (data.status === 'success' && data.data) {
                currentSuggestion = data.data;
                renderSuggestionCard(data.data);

                document.getElementById('skippedDrugsList').classList.remove('visible');

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                showToast('ì•½í’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ì•½í’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
            showToast('ì•½í’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Info Box í† ê¸€
    function toggleInfoBox() {
        var content = document.getElementById('info-box-content');
        var arrow = document.getElementById('info-box-arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
    }

    // ì‹ ê·œ í™˜ì ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('newPatientModal').addEventListener('click', function(e) {
        if (e.target === this) {
            tryCloseNewPatientModal();
        }
    });

    // ë“±ë¡ ì™„ë£Œ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('successModal').addEventListener('click', function(e) {
        if (e.target === this) {
            goToNextSuggestion();
        }
    });

    // í™˜ì ì•½í’ˆ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('patientDrugsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePatientDrugsModal();
        }
    });

    // ì•½í’ˆ í™˜ì ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('drugPatientsModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDrugPatientsModal();
        }
    });

    // ì•½í’ˆ í™˜ì ëª¨ë‹¬ ë‚´ ê²€ìƒ‰ ê²°ê³¼ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('drugPatientsModal').addEventListener('click', function(e) {
        var searchBox = document.querySelector('.patient-search-box');
        var resultsDiv = document.getElementById('modalPatientSearchResults');
        if (searchBox && !searchBox.contains(e.target) && resultsDiv.classList.contains('visible')) {
            resultsDiv.classList.remove('visible');
        }
    });

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ì·¨ì†Œ
            if (document.getElementById('confirmModal').classList.contains('visible')) {
                closeConfirmModal(false);
                return;
            }
            // ì•½í’ˆ í™˜ì ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë¨¼ì € ë‹«ê¸°
            if (document.getElementById('drugPatientsModal').classList.contains('visible')) {
                closeDrugPatientsModal();
            }
            // í™˜ì ì•½í’ˆ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            else if (document.getElementById('patientDrugsModal').classList.contains('visible')) {
                closePatientDrugsModal();
            }
            // ë“±ë¡ ì™„ë£Œ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            else if (document.getElementById('successModal').classList.contains('visible')) {
                goToNextSuggestion();
            }
            // ì‹ ê·œ í™˜ì ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            else if (document.getElementById('newPatientModal').classList.contains('visible')) {
                tryCloseNewPatientModal();
            }
        }
    });

    // ì‹ ê·œ í™˜ì ëª¨ë‹¬ì—ì„œ Enter í‚¤ë¡œ ë“±ë¡
    document.getElementById('newPatientBirth').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            createNewPatient();
        }
    });
</script>
{% endblock %}
