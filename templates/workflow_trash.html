{% extends "base.html" %}

{% block title %}약 휴지통 관리 - Jaego{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.get('VERSION', '1') }}">
{% endblock %}

{% block page_styles %}
<style>
    html {
        overflow-y: scroll;
    }

    body {
        background: #ebebeb;
    }

    .container {
        max-width: 900px;
        padding: 40px;
    }

    .page-header h1 {
        font-size: var(--text-xl);
        margin-bottom: var(--space-5);
    }

    /* Status Tabs */
    .status-tabs {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-5);
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 0;
    }

    .status-tab {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        padding: var(--space-3) var(--space-4);
        border: none;
        background: none;
        color: var(--color-text-muted);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        white-space: nowrap;
    }

    .status-tab:hover {
        color: var(--color-text-secondary);
        background: var(--color-surface-hover);
        border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .status-tab.active {
        color: var(--brand-primary);
        border-bottom-color: var(--brand-primary);
    }

    .status-tab .tab-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 20px;
        height: 20px;
        padding: 0 6px;
        border-radius: var(--radius-full);
        background: var(--color-surface-hover);
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
        color: var(--color-text-muted);
    }

    .status-tab.active .tab-count {
        background: var(--brand-primary-subtle);
        color: var(--brand-primary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--space-12) var(--space-4);
        color: var(--color-text-muted);
    }

    .empty-state .icon {
        width: 48px;
        height: 48px;
        margin-bottom: var(--space-4);
        opacity: 0.4;
    }

    .empty-state p {
        font-size: var(--text-sm);
        line-height: var(--leading-relaxed);
    }

    /* Table */
    .trash-table-wrap {
        margin-bottom: var(--space-6);
        max-height: 55vh;
        overflow-y: auto;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
    }

    .trash-table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--text-sm);
        table-layout: fixed;
    }

    /* Column widths */
    .trash-table .col-name     { width: 30%; }
    .trash-table .col-code     { width: 12%; }
    .trash-table .col-company  { width: 13%; }
    .trash-table .col-type     { width: 12%; }
    .trash-table .col-status   { width: 12%; }
    .trash-table .col-date     { width: 8%; }
    .trash-table .col-actions  { width: 13%; }

    .trash-table th {
        background: var(--color-surface-hover);
        padding: var(--space-3) var(--space-2);
        text-align: left;
        font-weight: var(--font-semibold);
        color: var(--color-text-secondary);
        border-bottom: 2px solid var(--color-border);
        white-space: nowrap;
        font-size: var(--text-xs);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .trash-table td {
        padding: var(--space-3) var(--space-2);
        border-bottom: 1px solid var(--color-border);
        vertical-align: middle;
    }

    /* 텍스트 잘림은 드롭다운이 없는 컬럼에만 적용 */
    .trash-table td.cell-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .trash-table tbody tr:hover {
        background: var(--color-surface-hover);
    }

    .drug-name {
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .drug-code {
        color: var(--color-text-muted);
        font-size: var(--text-xs);
        font-family: var(--font-mono);
    }

    .drug-company {
        color: var(--color-text-secondary);
        font-size: var(--text-xs);
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .checked-date {
        color: var(--color-text-muted);
        font-size: var(--text-xs);
        white-space: nowrap;
    }

    /* Inline Dropdown (compact for table cells) */
    .inline-dropdown {
        position: relative;
        display: inline-block;
        min-width: 80px;
    }

    .inline-dropdown-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        cursor: pointer;
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        color: var(--color-text-primary);
        transition: all var(--transition-fast);
        white-space: nowrap;
    }

    .inline-dropdown-btn:hover {
        border-color: var(--color-border-hover);
        background: var(--color-surface-hover);
    }

    .inline-dropdown-btn::after {
        content: '';
        width: 0;
        height: 0;
        border-left: 3px solid transparent;
        border-right: 3px solid transparent;
        border-top: 4px solid var(--color-text-muted);
        margin-left: 2px;
    }

    .inline-dropdown-menu {
        display: none;
        position: fixed;
        min-width: 100px;
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        z-index: var(--z-dropdown);
        overflow: hidden;
    }

    .inline-dropdown-menu.open {
        display: block;
    }

    .inline-dropdown-item {
        padding: 6px 10px;
        font-size: var(--text-xs);
        cursor: pointer;
        transition: background var(--transition-fast);
        white-space: nowrap;
    }

    .inline-dropdown-item:hover {
        background: var(--color-surface-hover);
    }

    .inline-dropdown-item.selected {
        background: var(--brand-primary-subtle);
        color: var(--brand-primary-dark);
        font-weight: var(--font-semibold);
    }

    .inline-dropdown-item.clear-option {
        color: var(--color-text-muted);
        font-style: italic;
        border-bottom: 1px solid var(--color-border);
    }

    /* Status Badge Colors */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
    }

    .status-badge.status-대기중 {
        background: var(--color-warning-light);
        color: var(--color-warning-dark);
    }

    .status-badge.status-처리중 {
        background: var(--color-info-light);
        color: var(--color-info-dark);
    }

    .status-badge.status-완료 {
        background: var(--color-success-light);
        color: var(--color-success-dark);
    }

    .status-badge.status-보류 {
        background: var(--color-surface-hover);
        color: var(--color-text-secondary);
    }

    /* Type Badge */
    .type-badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-medium);
        background: var(--color-surface-hover);
        color: var(--color-text-secondary);
        border: 1px solid var(--color-border);
    }

    .type-badge.empty {
        color: var(--color-text-muted);
        font-style: italic;
        border-style: dashed;
    }

    /* Memo Button */
    .memo-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        cursor: pointer;
        transition: all var(--transition-fast);
        color: var(--color-text-muted);
    }

    .memo-btn:hover {
        border-color: var(--color-border-hover);
        background: var(--color-surface-hover);
        color: var(--color-text-primary);
    }

    .memo-btn.has-memo {
        background: var(--color-warning-light);
        border-color: var(--color-warning);
        color: var(--color-warning-dark);
    }

    .memo-btn .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    /* Restore Button */
    .restore-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-surface);
        cursor: pointer;
        transition: all var(--transition-fast);
        color: var(--color-text-muted);
    }

    .restore-btn:hover {
        border-color: var(--color-success);
        background: var(--color-success-light);
        color: var(--color-success-dark);
    }

    .restore-btn .icon {
        width: var(--icon-xs);
        height: var(--icon-xs);
    }

    /* Processing Type Management Section */
    .type-management {
        background: var(--color-surface-hover);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-4);
    }

    .type-management-header {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
    }

    .type-management-header .icon {
        width: var(--icon-sm);
        height: var(--icon-sm);
        color: var(--brand-primary);
    }

    .type-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-2);
        align-items: center;
    }

    .type-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 12px;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        background: var(--color-surface);
        color: var(--color-text-primary);
        border: 1px solid var(--color-border);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .type-tag:hover {
        border-color: var(--color-border-hover);
        background: var(--color-surface-hover);
    }

    /* 편의 필터 (전체, 미지정) — 톤다운 */
    .type-tag.utility {
        background: transparent;
        border-color: transparent;
        color: var(--color-text-muted);
        font-weight: var(--font-medium);
    }

    .type-tag.utility:hover {
        background: transparent;
        color: var(--color-text-primary);
    }

    .type-tag.utility.active {
        background: transparent;
        border-color: transparent;
        color: var(--brand-primary);
    }

    /* 실제 카테고리 활성 상태 */
    .type-tag.active {
        background: var(--brand-primary);
        border-color: var(--brand-primary);
        color: white;
    }

    .type-tag.active .delete-type-btn {
        color: rgba(255, 255, 255, 0.7);
    }

    .type-tag.active .delete-type-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    /* 구분선 */
    .type-filter-divider {
        width: 1px;
        height: 20px;
        background: var(--color-border);
        margin: 0 var(--space-1);
    }

    .type-tag .delete-type-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border: none;
        background: none;
        cursor: pointer;
        color: var(--color-text-muted);
        border-radius: var(--radius-full);
        padding: 0;
        transition: all var(--transition-fast);
    }

    .type-tag .delete-type-btn:hover {
        background: var(--color-danger-light);
        color: var(--color-danger);
    }

    .add-type-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 12px;
        border-radius: var(--radius-full);
        font-size: var(--text-xs);
        font-weight: var(--font-semibold);
        background: var(--color-surface);
        color: var(--color-text-muted);
        border: 1px dashed var(--color-border-hover);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .add-type-btn:hover {
        border-color: var(--brand-primary);
        color: var(--brand-primary);
        background: var(--brand-primary-subtle);
    }

    .add-type-btn .icon {
        width: 12px;
        height: 12px;
    }

    .add-type-input-wrap {
        display: none;
        align-items: center;
        gap: var(--space-2);
    }

    .add-type-input-wrap.visible {
        display: inline-flex;
    }

    .add-type-input {
        padding: 4px 10px;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--text-xs);
        width: 120px;
        outline: none;
        transition: border-color var(--transition-fast);
    }

    .add-type-input:focus {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 2px var(--brand-primary-subtle);
    }

    .add-type-confirm-btn,
    .add-type-cancel-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border: none;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .add-type-confirm-btn {
        background: var(--brand-primary);
        color: white;
    }

    .add-type-confirm-btn:hover {
        background: var(--brand-primary-dark);
    }

    .add-type-cancel-btn {
        background: var(--color-surface-active);
        color: var(--color-text-muted);
    }

    .add-type-cancel-btn:hover {
        background: var(--color-surface-hover);
        color: var(--color-text-primary);
    }

    .add-type-confirm-btn .icon,
    .add-type-cancel-btn .icon {
        width: 12px;
        height: 12px;
    }

    /* Memo Modal */
    .memo-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: var(--z-modal);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(2px);
    }

    .memo-modal-overlay.visible {
        display: flex;
    }

    .memo-modal-box {
        background: var(--color-surface);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        max-width: 400px;
        width: 90%;
        box-shadow: var(--shadow-xl);
        animation: modalSlideIn var(--duration-normal) var(--ease-out);
    }

    .memo-modal-title {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        margin-bottom: var(--space-2);
    }

    .memo-modal-drug {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-bottom: var(--space-4);
    }

    .memo-textarea {
        width: 100%;
        min-height: 100px;
        padding: var(--space-3);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-family: var(--font-family);
        resize: vertical;
        outline: none;
        transition: border-color var(--transition-fast);
    }

    .memo-textarea:focus {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 2px var(--brand-primary-subtle);
    }

    .memo-modal-buttons {
        display: flex;
        gap: var(--space-3);
        justify-content: flex-end;
        margin-top: var(--space-4);
    }

    .memo-modal-buttons button {
        padding: var(--space-2) var(--space-4);
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
        font-weight: var(--font-semibold);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .memo-btn-cancel {
        background: var(--color-surface-hover);
        color: var(--color-text-secondary);
        border: 1px solid var(--color-border);
    }

    .memo-btn-cancel:hover {
        background: var(--color-surface-active);
    }

    .memo-btn-save {
        background: var(--brand-primary);
        color: white;
    }

    .memo-btn-save:hover {
        background: var(--brand-primary-dark);
    }

    /* Loading Spinner */
    .loading-wrap {
        text-align: center;
        padding: var(--space-12);
    }

    .loading-spinner {
        display: inline-block;
        width: 32px;
        height: 32px;
        border: 3px solid var(--color-border);
        border-top-color: var(--brand-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    .loading-wrap p {
        margin-top: var(--space-3);
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    /* Actions column */
    .actions-cell {
        display: flex;
        gap: 4px;
        align-items: center;
    }
</style>
{% endblock %}

{% block toast_container %}
{% include 'partials/_toast_container.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-btn">
        <svg class="icon" style="width: var(--icon-sm); height: var(--icon-sm);"><use href="#icon-arrow-left"></use></svg>
        홈으로 돌아가기
    </a>

    <h1>
        <svg class="icon" style="width: 24px; height: 24px;"><use href="#icon-trash-2"></use></svg>
        약 휴지통 관리
    </h1>
    <p style="text-align: center; color: var(--color-text-muted); font-size: var(--text-sm); margin-bottom: var(--space-5);">더 이상 쓸모 없어진 약품의 처리 상태와 처리 방식을 관리합니다</p>

    <!-- Status Tabs -->
    <div class="status-tabs">
        <button class="status-tab active" data-status="대기중" onclick="switchStatus('대기중')">
            대기중 <span class="tab-count" id="count-대기중">0</span>
        </button>
        <button class="status-tab" data-status="처리중" onclick="switchStatus('처리중')">
            처리 중 <span class="tab-count" id="count-처리중">0</span>
        </button>
        <button class="status-tab" data-status="완료" onclick="switchStatus('완료')">
            완료 <span class="tab-count" id="count-완료">0</span>
        </button>
        <button class="status-tab" data-status="보류" onclick="switchStatus('보류')">
            보류 <span class="tab-count" id="count-보류">0</span>
        </button>
    </div>

    <!-- Table Area -->
    <div id="tableArea">
        <div class="loading-wrap" id="loadingWrap">
            <div class="loading-spinner"></div>
            <p>데이터를 불러오는 중...</p>
        </div>
    </div>

    <!-- Processing Type Management -->
    <div class="type-management">
        <div class="type-management-header">
            <svg class="icon"><use href="#icon-filter"></use></svg>
            처리유형 필터
        </div>
        <div class="type-tags" id="typeTags">
            <!-- Dynamically rendered -->
        </div>
    </div>
</div>

<!-- Memo Modal -->
<div class="memo-modal-overlay" id="memoModal">
    <div class="memo-modal-box">
        <div class="memo-modal-title">메모 편집</div>
        <div class="memo-modal-drug" id="memoDrugInfo"></div>
        <textarea class="memo-textarea" id="memoTextarea" placeholder="메모를 입력하세요..."></textarea>
        <div class="memo-modal-buttons">
            <button class="memo-btn-cancel" onclick="closeMemoModal()">취소</button>
            <button class="memo-btn-save" onclick="saveMemo()">저장</button>
        </div>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    // ── State ──────────────────────────────
    var allItems = [];
    var allMemos = {};
    var processingTypes = [];
    var currentStatus = '대기중';
    var currentMemoDrugCode = null;
    var openDropdownId = null;
    var filterType = null;  // null = 전체, '' = 미지정, 'xxx' = 특정 유형

    // ── Init ───────────────────────────────
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });

    // Close dropdowns on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.inline-dropdown')) {
            closeAllDropdowns();
        }
    });

    // ESC to close dropdowns and memo modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllDropdowns();
            if (document.getElementById('memoModal').classList.contains('visible')) {
                closeMemoModal();
            }
        }
    });

    // ── Data Loading ───────────────────────
    function loadData() {
        Promise.all([
            fetch('/api/trash/items').then(function(r) { return r.json(); }),
            fetch('/api/trash/types').then(function(r) { return r.json(); }),
            fetch('/api/memos').then(function(r) { return r.json(); })
        ]).then(function(results) {
            var itemsRes = results[0];
            var typesRes = results[1];
            var memosRes = results[2];

            if (itemsRes.status === 'success') {
                allItems = itemsRes.items;
            }
            if (typesRes.status === 'success') {
                processingTypes = typesRes.types;
            }
            if (memosRes.status === 'success') {
                // Build memo lookup: {drug_code: memo_text}
                allMemos = {};
                memosRes.memos.forEach(function(m) {
                    allMemos[m.drug_code] = m.memo;
                });
            }

            updateTabCounts();
            renderTable();
            renderTypeTags();
        }).catch(function(err) {
            console.error('데이터 로드 실패:', err);
            document.getElementById('tableArea').innerHTML =
                '<div class="empty-state"><p>데이터를 불러오지 못했습니다.</p></div>';
        });
    }

    // ── Tab Switching ──────────────────────
    function switchStatus(status) {
        currentStatus = status;

        // Update tab active state
        document.querySelectorAll('.status-tab').forEach(function(tab) {
            tab.classList.toggle('active', tab.dataset.status === status);
        });

        renderTable();
    }

    // ── Tab Counts ─────────────────────────
    function updateTabCounts() {
        var counts = { '대기중': 0, '처리중': 0, '완료': 0, '보류': 0 };
        allItems.forEach(function(item) {
            var s = item['처리상태'] || '대기중';
            if (counts[s] !== undefined) counts[s]++;
        });

        Object.keys(counts).forEach(function(status) {
            var el = document.getElementById('count-' + status);
            if (el) el.textContent = counts[status];
        });
    }

    // ── Table Rendering ────────────────────
    function renderTable() {
        var filtered = allItems.filter(function(item) {
            if ((item['처리상태'] || '대기중') !== currentStatus) return false;
            if (filterType !== null) {
                var itemType = item['처리유형'] || '';
                if (itemType !== filterType) return false;
            }
            return true;
        });

        if (filtered.length === 0) {
            var msg;
            if (filterType !== null) {
                var typeName = filterType === '' ? '미지정' : filterType;
                msg = '"' + currentStatus + '" 상태에서 처리유형이 "' + typeName + '"인 약품이 없습니다.';
            } else {
                var emptyMessages = {
                    '대기중': '대기 중인 약품이 없습니다.',
                    '처리중': '처리 진행 중인 약품이 없습니다.',
                    '완료': '처리 완료된 약품이 없습니다.',
                    '보류': '보류 중인 약품이 없습니다.'
                };
                msg = emptyMessages[currentStatus] || '약품이 없습니다.';
            }
            document.getElementById('tableArea').innerHTML =
                '<div class="empty-state">' +
                '<svg class="icon"><use href="#icon-trash-2"></use></svg>' +
                '<p>' + msg + '</p>' +
                '</div>';
            return;
        }

        var html = '<div class="trash-table-wrap"><table class="trash-table">';
        html += '<thead><tr>';
        html += '<th class="col-name">약품명</th>';
        html += '<th class="col-code">약품코드</th>';
        html += '<th class="col-company">제약회사</th>';
        html += '<th class="col-type">처리유형</th>';
        html += '<th class="col-status">처리상태</th>';
        html += '<th class="col-date">등록일</th>';
        html += '<th class="col-actions">액션</th>';
        html += '</tr></thead><tbody>';

        filtered.forEach(function(item, idx) {
            var drugCode = item['약품코드'];
            var drugName = item['약품명'] || drugCode;
            var company = item['제약회사'] || '';
            var typeName = item['처리유형'] || '';
            var status = item['처리상태'] || '대기중';
            var date = item['체크일시'] || '';
            var hasMemo = !!allMemos[drugCode];
            var rowId = 'row-' + currentStatus + '-' + idx;

            // Format date: "2026-02-22 10:30:45" → "02/22"
            var shortDate = '';
            if (date) {
                var parts = date.split(' ')[0].split('-');
                if (parts.length === 3) {
                    shortDate = parts[1] + '/' + parts[2];
                }
            }

            html += '<tr id="' + rowId + '">';
            html += '<td class="cell-truncate"><span class="drug-name" title="' + escapeHtml(drugName) + '">' + escapeHtml(drugName) + '</span></td>';
            html += '<td class="cell-truncate"><span class="drug-code">' + escapeHtml(drugCode) + '</span></td>';
            html += '<td class="cell-truncate"><span class="drug-company" title="' + escapeHtml(company) + '">' + escapeHtml(company) + '</span></td>';

            // 처리유형 dropdown
            html += '<td>';
            html += renderTypeDropdown(drugCode, typeName, rowId);
            html += '</td>';

            // 처리상태 dropdown
            html += '<td>';
            html += renderStatusDropdown(drugCode, status, rowId);
            html += '</td>';

            html += '<td class="cell-truncate"><span class="checked-date">' + shortDate + '</span></td>';

            // Actions: memo + restore
            html += '<td><div class="actions-cell">';
            html += '<button class="memo-btn' + (hasMemo ? ' has-memo' : '') + '" title="메모" onclick="openMemoModal(\'' + escapeJs(drugCode) + '\', \'' + escapeJs(drugName) + '\')">';
            html += '<svg class="icon"><use href="#icon-pencil"></use></svg>';
            html += '</button>';
            html += '<button class="restore-btn" title="복원 (휴지통에서 꺼내기)" onclick="restoreItem(\'' + escapeJs(drugCode) + '\', \'' + escapeJs(drugName) + '\')">';
            html += '<svg class="icon"><use href="#icon-refresh-cw"></use></svg>';
            html += '</button>';
            html += '</div></td>';

            html += '</tr>';
        });

        html += '</tbody></table></div>';
        document.getElementById('tableArea').innerHTML = html;
    }

    // ── Type Dropdown (inline) ─────────────
    function renderTypeDropdown(drugCode, currentType, rowId) {
        var ddId = 'type-dd-' + drugCode.replace(/[^a-zA-Z0-9]/g, '_');
        var displayText = currentType || '미지정';
        var cssClass = currentType ? 'type-badge' : 'type-badge empty';

        var html = '<div class="inline-dropdown" id="' + ddId + '">';
        html += '<button class="inline-dropdown-btn" onclick="toggleInlineDropdown(event, \'' + ddId + '\')">';
        html += '<span class="' + cssClass + '">' + escapeHtml(displayText) + '</span>';
        html += '</button>';
        html += '<div class="inline-dropdown-menu">';

        // Clear option
        html += '<div class="inline-dropdown-item clear-option' + (!currentType ? ' selected' : '') + '" ';
        html += 'onclick="event.stopPropagation(); changeType(\'' + escapeJs(drugCode) + '\', \'\')">';
        html += '미지정</div>';

        processingTypes.forEach(function(t) {
            var selected = (t['유형명'] === currentType) ? ' selected' : '';
            html += '<div class="inline-dropdown-item' + selected + '" ';
            html += 'onclick="event.stopPropagation(); changeType(\'' + escapeJs(drugCode) + '\', \'' + escapeJs(t['유형명']) + '\')">';
            html += escapeHtml(t['유형명']) + '</div>';
        });

        html += '</div></div>';
        return html;
    }

    // ── Status Dropdown (inline) ───────────
    function renderStatusDropdown(drugCode, currentStatusVal, rowId) {
        var ddId = 'status-dd-' + drugCode.replace(/[^a-zA-Z0-9]/g, '_');
        var statuses = ['대기중', '처리중', '완료', '보류'];

        var html = '<div class="inline-dropdown" id="' + ddId + '">';
        html += '<button class="inline-dropdown-btn" onclick="toggleInlineDropdown(event, \'' + ddId + '\')">';
        html += '<span class="status-badge status-' + currentStatusVal + '">' + currentStatusVal + '</span>';
        html += '</button>';
        html += '<div class="inline-dropdown-menu">';

        statuses.forEach(function(s) {
            var selected = (s === currentStatusVal) ? ' selected' : '';
            html += '<div class="inline-dropdown-item' + selected + '" ';
            html += 'onclick="event.stopPropagation(); changeStatus(\'' + escapeJs(drugCode) + '\', \'' + s + '\')">';
            html += '<span class="status-badge status-' + s + '">' + s + '</span></div>';
        });

        html += '</div></div>';
        return html;
    }

    // ── Inline Dropdown Toggle ─────────────
    function toggleInlineDropdown(event, ddId) {
        event.stopPropagation();
        var dd = document.getElementById(ddId);
        if (!dd) return;
        var menu = dd.querySelector('.inline-dropdown-menu');
        var isOpen = menu.classList.contains('open');

        closeAllDropdowns();

        if (!isOpen) {
            var btn = dd.querySelector('.inline-dropdown-btn');
            var rect = btn.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + 2) + 'px';
            menu.style.minWidth = rect.width + 'px';
            menu.classList.add('open');
            openDropdownId = ddId;
        }
    }

    function closeAllDropdowns() {
        document.querySelectorAll('.inline-dropdown-menu.open').forEach(function(m) {
            m.classList.remove('open');
        });
        openDropdownId = null;
    }

    // ── API Calls ──────────────────────────
    function changeStatus(drugCode, newStatus) {
        closeAllDropdowns();

        // 즉시 로컬 상태 업데이트 (Optimistic UI)
        allItems.forEach(function(item) {
            if (item['약품코드'] === drugCode) {
                item['처리상태'] = newStatus;
            }
        });
        updateTabCounts();
        renderTable();

        fetch('/api/trash/update_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ drug_code: drugCode, status: newStatus })
        })
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(function(data) {
            if (data.status === 'success') {
                showToast('처리상태가 "' + newStatus + '"(으)로 변경되었습니다.', 'success');
            } else {
                // 실패 시 롤백 → 서버에서 최신 데이터 다시 로드
                showToast(data.message || '상태 변경 실패', 'error');
                loadData();
            }
        })
        .catch(function(err) {
            console.error('changeStatus error:', err);
            showToast('상태 변경 중 오류가 발생했습니다.', 'error');
            loadData();
        });
    }

    function changeType(drugCode, newType) {
        closeAllDropdowns();

        // 즉시 로컬 상태 업데이트 (Optimistic UI)
        allItems.forEach(function(item) {
            if (item['약품코드'] === drugCode) {
                item['처리유형'] = newType;
            }
        });
        renderTable();

        fetch('/api/trash/update_type', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ drug_code: drugCode, type: newType })
        })
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(function(data) {
            if (data.status === 'success') {
                showToast(newType ? '처리유형이 "' + newType + '"(으)로 변경되었습니다.' : '처리유형이 해제되었습니다.', 'success');
            } else {
                showToast(data.message || '유형 변경 실패', 'error');
                loadData();
            }
        })
        .catch(function(err) {
            console.error('changeType error:', err);
            showToast('유형 변경 중 오류가 발생했습니다.', 'error');
            loadData();
        });
    }

    async function restoreItem(drugCode, drugName) {
        var confirmed = await showConfirmModal({
            icon: 'info',
            title: '휴지통에서 복원',
            message: '<strong>' + escapeHtml(drugName) + '</strong>을(를) 휴지통에서 꺼내시겠습니까?',
            confirmText: '복원',
            isDanger: false
        });

        if (!confirmed) return;

        fetch('/api/toggle_checked_item', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ drug_code: drugCode, checked: false })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                // Remove from local list
                allItems = allItems.filter(function(item) {
                    return item['약품코드'] !== drugCode;
                });

                updateTabCounts();
                renderTable();
                showToast('"' + drugName + '"이(가) 복원되었습니다.', 'success');
            } else {
                showToast(data.message || '복원 실패', 'error');
            }
        })
        .catch(function(err) {
            showToast('복원 중 오류가 발생했습니다.', 'error');
        });
    }

    // ── Memo ───────────────────────────────
    function openMemoModal(drugCode, drugName) {
        currentMemoDrugCode = drugCode;
        document.getElementById('memoDrugInfo').textContent = drugName + ' (' + drugCode + ')';
        document.getElementById('memoTextarea').value = allMemos[drugCode] || '';
        document.getElementById('memoModal').classList.add('visible');
        document.getElementById('memoTextarea').focus();
    }

    function closeMemoModal() {
        document.getElementById('memoModal').classList.remove('visible');
        currentMemoDrugCode = null;
    }

    function saveMemo() {
        var memo = document.getElementById('memoTextarea').value.trim();
        var drugCode = currentMemoDrugCode;
        if (!drugCode) return;

        fetch('/api/update_memo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ drug_code: drugCode, memo: memo })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                if (memo) {
                    allMemos[drugCode] = memo;
                } else {
                    delete allMemos[drugCode];
                }
                renderTable();
                closeMemoModal();
                showToast('메모가 저장되었습니다.', 'success');
            } else {
                showToast(data.message || '메모 저장 실패', 'error');
            }
        })
        .catch(function(err) {
            showToast('메모 저장 중 오류가 발생했습니다.', 'error');
        });
    }

    // ── Processing Type Management ─────────
    function renderTypeTags() {
        var container = document.getElementById('typeTags');
        var html = '';

        // 편의 필터: 전체, 미지정
        html += '<span class="type-tag utility' + (filterType === null ? ' active' : '') + '" onclick="setTypeFilter(null)">';
        html += '전체';
        html += '</span>';
        html += '<span class="type-tag utility' + (filterType === '' ? ' active' : '') + '" onclick="setTypeFilter(\'\')">';
        html += '미지정';
        html += '</span>';

        // 구분선
        html += '<span class="type-filter-divider"></span>';

        // 등록된 처리유형 태그들
        processingTypes.forEach(function(t) {
            var isActive = filterType === t['유형명'];
            var isDefault = t['is_default'];
            html += '<span class="type-tag' + (isActive ? ' active' : '') + '" onclick="setTypeFilter(\'' + escapeJs(t['유형명']) + '\')">';
            html += escapeHtml(t['유형명']);
            if (!isDefault) {
                html += ' <button class="delete-type-btn" title="삭제" onclick="event.stopPropagation(); deleteType(\'' + escapeJs(t['유형명']) + '\')">';
                html += '<svg class="icon"><use href="#icon-x"></use></svg>';
                html += '</button>';
            }
            html += '</span>';
        });

        // Add button
        html += '<button class="add-type-btn" id="addTypeBtn" onclick="showAddTypeInput()">';
        html += '<svg class="icon"><use href="#icon-plus"></use></svg>';
        html += '추가';
        html += '</button>';

        // Add input
        html += '<span class="add-type-input-wrap" id="addTypeInputWrap">';
        html += '<input class="add-type-input" id="addTypeInput" type="text" placeholder="유형명" maxlength="20" onkeydown="if(event.key===\'Enter\')confirmAddType()">';
        html += '<button class="add-type-confirm-btn" onclick="confirmAddType()" title="추가">';
        html += '<svg class="icon"><use href="#icon-check"></use></svg>';
        html += '</button>';
        html += '<button class="add-type-cancel-btn" onclick="cancelAddType()" title="취소">';
        html += '<svg class="icon"><use href="#icon-x"></use></svg>';
        html += '</button>';
        html += '</span>';

        container.innerHTML = html;
    }

    function setTypeFilter(type) {
        // 같은 필터 다시 클릭 → 전체로 해제
        if (filterType === type) {
            filterType = null;
        } else {
            filterType = type;
        }
        renderTypeTags();
        renderTable();
    }

    function showAddTypeInput() {
        document.getElementById('addTypeBtn').style.display = 'none';
        document.getElementById('addTypeInputWrap').classList.add('visible');
        document.getElementById('addTypeInput').value = '';
        document.getElementById('addTypeInput').focus();
    }

    function cancelAddType() {
        document.getElementById('addTypeBtn').style.display = '';
        document.getElementById('addTypeInputWrap').classList.remove('visible');
    }

    function confirmAddType() {
        var name = document.getElementById('addTypeInput').value.trim();
        if (!name) {
            showToast('유형명을 입력해주세요.', 'warning');
            return;
        }

        fetch('/api/trash/types/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                processingTypes.push({ '유형명': name, 'is_default': false });
                renderTypeTags();
                renderTable();
                showToast('처리유형 "' + name + '"이(가) 추가되었습니다.', 'success');
            } else {
                showToast(data.message || '추가 실패', 'error');
            }
        })
        .catch(function(err) {
            showToast('처리유형 추가 중 오류가 발생했습니다.', 'error');
        });
    }

    async function deleteType(name) {
        var confirmed = await showConfirmModal({
            icon: 'danger',
            title: '처리유형 삭제',
            message: '처리유형 "<strong>' + escapeHtml(name) + '</strong>"을(를) 삭제하시겠습니까?<br><br>이 유형을 사용 중인 약품의 처리유형은 비워집니다.',
            confirmText: '삭제',
            isDanger: true
        });

        if (!confirmed) return;

        fetch('/api/trash/types/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                processingTypes = processingTypes.filter(function(t) { return t['유형명'] !== name; });

                // Clear type from local items
                allItems.forEach(function(item) {
                    if (item['처리유형'] === name) {
                        item['처리유형'] = '';
                    }
                });

                renderTypeTags();
                renderTable();
                showToast('처리유형 "' + name + '"이(가) 삭제되었습니다.', 'success');
            } else {
                showToast(data.message || '삭제 실패', 'error');
            }
        })
        .catch(function(err) {
            showToast('처리유형 삭제 중 오류가 발생했습니다.', 'error');
        });
    }

    // ── Utils ──────────────────────────────
    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function escapeJs(str) {
        if (!str) return '';
        return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }
</script>
{% endblock %}
