{% extends "base.html" %}

{% block title %}고변동성 약품 보고서{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/icons.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/dropdown.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.get('VERSION', '1') }}">
{% endblock %}

{% block page_styles %}
<style>
    /* CV Slider Styles */
    .cv-slider-container {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
    }

    .cv-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .cv-label {
        font-size: 0.9em;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 15px;
    }

    .cv-label.low {
        background: #d1fae5;
        color: #065f46;
    }

    .cv-label.mid {
        background: #fef3c7;
        color: #92400e;
    }

    .cv-label.high {
        background: #fee2e2;
        color: #991b1b;
    }

    .cv-bar {
        position: relative;
        height: 40px;
        background: #e2e8f0;
        border-radius: 20px;
        margin-bottom: 10px;
        display: flex;
        overflow: hidden;
    }

    .cv-segment {
        height: 100%;
        transition: width 0.1s ease;
    }

    .cv-segment.low {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }

    .cv-segment.mid {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .cv-segment.high {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    }

    .cv-handle {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 48px;
        background: white;
        border: 3px solid var(--brand-primary);
        border-radius: 8px;
        cursor: ew-resize;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: box-shadow 0.2s, transform 0.1s;
    }

    .cv-handle:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .cv-handle:active {
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        transform: translate(-50%, -50%) scale(1.05);
    }

    .cv-handle::before {
        content: '\22EE';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--brand-primary);
        font-size: 14px;
        font-weight: bold;
    }

    .cv-scale {
        position: relative;
        height: 20px;
        font-size: 0.85em;
        color: #718096;
        margin-bottom: 15px;
    }

    .cv-scale span {
        position: absolute;
        transform: translateX(-50%);
    }

    .cv-scale span:first-child {
        left: 0;
        transform: translateX(0);
    }

    .cv-scale span:last-child {
        left: 100%;
        transform: translateX(-100%);
    }

    .cv-values {
        display: flex;
        justify-content: center;
        gap: 30px;
    }

    .cv-value-box {
        text-align: center;
        background: white;
        padding: 12px 20px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        min-width: 140px;
    }

    .cv-value-label {
        display: block;
        font-size: 0.8em;
        color: #718096;
        margin-bottom: 5px;
    }

    .cv-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #2d3748;
    }


    /* Info box - gray theme for this page */
    .info-box-gray {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 30px;
        overflow: hidden;
    }

    .info-box-gray .info-box-header:hover {
        background-color: #edf2f7;
    }

    .info-box-gray .info-box-title {
        font-weight: 600;
        color: #4a5568;
    }

    .info-box-gray .info-box-arrow {
        color: #718096;
    }

    .info-box-gray .info-box-body {
        padding: 0 20px 20px 20px;
        color: #4a5568;
        font-size: 0.95em;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block toast_container %}
{% include 'partials/_toast_container.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-btn">
        <svg class="icon" style="width: var(--icon-sm); height: var(--icon-sm);"><use href="#icon-arrow-left"></use></svg>
        홈으로 돌아가기
    </a>

    <h1>
        <svg class="icon" style="width: 28px; height: 28px;"><use href="#icon-trending-up"></use></svg>
        고변동성 약품 보고서
    </h1>
    <p class="subtitle">월별 사용량 변동성 분석</p>

    <div class="info-box-gray">
        <div class="info-box-header" onclick="toggleInfoBox()">
            <span class="info-box-title">
                <svg class="icon" style="width: var(--icon-sm); height: var(--icon-sm);"><use href="#icon-info"></use></svg>
                이 보고서는?
            </span>
            <span class="info-box-arrow" id="info-box-arrow">▼</span>
        </div>
        <div class="info-box-content" id="info-box-content">
            <div class="info-box-body">
                월별 사용량의 <b>변동계수(CV)</b>를 분석하여 재고 관리가 어려운 약품을 식별합니다.<br><br>
                <b>CV (Coefficient of Variation)</b> = 표준편차 / 평균<br><br>
                • CV가 높을수록 사용량이 들쭉날쭉합니다<br>
                • 고변동성 약품은 안전재고를 더 많이 확보해야 합니다<br>
                • 산점도에서 우상단(고사용량 + 고변동성) 약품이 관리 우선순위가 높습니다
            </div>
        </div>
    </div>

    <form id="reportForm">
        <div class="form-group">
            <label>약품 유형 선택</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="dispense" name="mode" value="dispense" checked>
                    <label for="dispense">
                        <span class="radio-icon"><svg class="icon"><use href="#icon-pill"></use></svg></span>
                        <span class="radio-text">
                            <div class="radio-title">전문약</div>
                            <div class="radio-desc">조제수량 기준</div>
                        </span>
                    </label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sale" name="mode" value="sale">
                    <label for="sale">
                        <span class="radio-icon"><svg class="icon"><use href="#icon-building-2"></use></svg></span>
                        <span class="radio-text">
                            <div class="radio-title">일반약</div>
                            <div class="radio-desc">판매수량 기준</div>
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>
                분석 기간
                <span class="tooltip" title="분석에 사용할 데이터 기간을 선택합니다.&#10;최근 N개월 데이터만 사용하여 변동성을 분석합니다.">ⓘ</span>
            </label>
            <div class="custom-dropdown" id="analysisPeriodDropdown">
                <div class="custom-dropdown-selected" onclick="toggleDropdown('analysisPeriodDropdown')">
                    최근 12개월
                </div>
                <div class="custom-dropdown-options">
                    <div class="custom-dropdown-option" data-value="0">전체 기간</div>
                    <div class="custom-dropdown-option" data-value="3">최근 3개월</div>
                    <div class="custom-dropdown-option" data-value="6">최근 6개월</div>
                    <div class="custom-dropdown-option" data-value="9">최근 9개월</div>
                    <div class="custom-dropdown-option selected" data-value="12">최근 12개월</div>
                    <div class="custom-dropdown-option" data-value="24">최근 24개월</div>
                </div>
            </div>
            <input type="hidden" name="analysis_period" id="analysisPeriod" value="12">
        </div>

        <div class="form-group">
            <label>
                CV 임계값 설정
                <span class="tooltip" title="변동성 분류 기준을 설정합니다.&#10;• 고변동성: CV > 고/중 경계&#10;• 중변동성: 중/저 경계 ≤ CV ≤ 고/중 경계&#10;• 저변동성: CV < 중/저 경계">ⓘ</span>
            </label>
            <div class="cv-slider-container">
                <div class="cv-labels">
                    <span class="cv-label low">저변동성</span>
                    <span class="cv-label mid">중변동성</span>
                    <span class="cv-label high">고변동성</span>
                </div>
                <div class="cv-bar">
                    <div class="cv-segment low" id="segment-low"></div>
                    <div class="cv-segment mid" id="segment-mid"></div>
                    <div class="cv-segment high" id="segment-high"></div>
                    <div class="cv-handle" id="handle-mid" title="중/저 경계"></div>
                    <div class="cv-handle" id="handle-high" title="고/중 경계"></div>
                </div>
                <div class="cv-scale">
                    <span>0</span>
                    <span id="scale-mid">0.3</span>
                    <span id="scale-high">0.5</span>
                    <span>1.0+</span>
                </div>
                <div class="cv-values">
                    <div class="cv-value-box">
                        <span class="cv-value-label">중/저 경계</span>
                        <span class="cv-value" id="value-mid">0.30</span>
                    </div>
                    <div class="cv-value-box">
                        <span class="cv-value-label">고/중 경계</span>
                        <span class="cv-value" id="value-high">0.50</span>
                    </div>
                </div>
            </div>
            <input type="hidden" name="threshold_mid" id="threshold_mid" value="0.3">
            <input type="hidden" name="threshold_high" id="threshold_high" value="0.5">
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
            <svg class="icon" style="width: var(--icon-md); height: var(--icon-md);"><use href="#icon-file-text"></use></svg>
            보고서 생성하기
        </button>
    </form>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="color: #718096;">보고서를 생성하고 있습니다...</p>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/dropdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    function toggleInfoBox() {
        var content = document.getElementById('info-box-content');
        var arrow = document.getElementById('info-box-arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
    }

    // CV Slider Logic
    (function() {
        var MAX_VALUE = 1.0;
        var STEP = 0.05;
        var midValue = 0.3;
        var highValue = 0.5;

        var bar = document.querySelector('.cv-bar');
        var handleMid = document.getElementById('handle-mid');
        var handleHigh = document.getElementById('handle-high');
        var segmentLow = document.getElementById('segment-low');
        var segmentMid = document.getElementById('segment-mid');
        var segmentHigh = document.getElementById('segment-high');
        var scaleMid = document.getElementById('scale-mid');
        var scaleHigh = document.getElementById('scale-high');
        var valueMidEl = document.getElementById('value-mid');
        var valueHighEl = document.getElementById('value-high');
        var inputMid = document.getElementById('threshold_mid');
        var inputHigh = document.getElementById('threshold_high');

        function updateUI() {
            var midPercent = (midValue / MAX_VALUE) * 100;
            var highPercent = (highValue / MAX_VALUE) * 100;

            segmentLow.style.width = midPercent + '%';
            segmentMid.style.width = (highPercent - midPercent) + '%';
            segmentHigh.style.width = (100 - highPercent) + '%';

            handleMid.style.left = midPercent + '%';
            handleHigh.style.left = highPercent + '%';

            scaleMid.textContent = midValue.toFixed(2);
            scaleHigh.textContent = highValue.toFixed(2);
            scaleMid.style.left = midPercent + '%';
            scaleHigh.style.left = highPercent + '%';

            valueMidEl.textContent = midValue.toFixed(2);
            valueHighEl.textContent = highValue.toFixed(2);

            inputMid.value = midValue.toFixed(2);
            inputHigh.value = highValue.toFixed(2);
        }

        function getValueFromPosition(clientX) {
            var rect = bar.getBoundingClientRect();
            var percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            return Math.round(percent * MAX_VALUE / STEP) * STEP;
        }

        function makeDraggable(handle, isMid) {
            var isDragging = false;

            function startDrag(e) {
                isDragging = true;
                e.preventDefault();
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
            }

            function doDrag(e) {
                if (!isDragging) return;

                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var newValue = getValueFromPosition(clientX);

                if (isMid) {
                    newValue = Math.max(STEP, Math.min(newValue, highValue - STEP));
                    midValue = newValue;
                } else {
                    newValue = Math.max(midValue + STEP, Math.min(newValue, MAX_VALUE - STEP));
                    highValue = newValue;
                }

                updateUI();
            }

            function endDrag() {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }

            handle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', endDrag);

            handle.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('touchend', endDrag);
        }

        makeDraggable(handleMid, true);
        makeDraggable(handleHigh, false);
        updateUI();
    })();

    // Form submission
    document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault();

        var submitBtn = document.getElementById('submitBtn');
        var loading = document.getElementById('loading');

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg class="icon" style="width: var(--icon-md); height: var(--icon-md);"><use href="#icon-loader"></use></svg> 생성 중...';
        loading.classList.add('active');

        var formData = new FormData(this);

        fetch('/generate/volatility_report', {
            method: 'POST',
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                window.open(data.report_url, '_blank');

                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="icon" style="width: var(--icon-md); height: var(--icon-md);"><use href="#icon-file-text"></use></svg> 보고서 생성하기';
                loading.classList.remove('active');

                showToast('보고서가 성공적으로 생성되었습니다!', 'success');
            } else {
                throw new Error(data.message || '보고서 생성 실패');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showToast('보고서 생성 중 오류가 발생했습니다: ' + error.message, 'error');

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<svg class="icon" style="width: var(--icon-md); height: var(--icon-md);"><use href="#icon-file-text"></use></svg> 보고서 생성하기';
            loading.classList.remove('active');
        });
    });
</script>
{% endblock %}
