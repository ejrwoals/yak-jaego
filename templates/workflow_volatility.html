{% extends "base.html" %}

{% block title %}ê³ ë³€ë™ì„± ì•½í’ˆ ë³´ê³ ì„œ{% endblock %}

{% block component_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/confirm-modal.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/toast.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/dropdown.css') }}?v={{ config.get('VERSION', '1') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/shutdown-button.css') }}?v={{ config.get('VERSION', '1') }}">
{% endblock %}

{% block page_styles %}
<style>
    /* CV Slider Styles */
    .cv-slider-container {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
    }

    .cv-labels {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .cv-label {
        font-size: 0.9em;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 15px;
    }

    .cv-label.low {
        background: #d1fae5;
        color: #065f46;
    }

    .cv-label.mid {
        background: #fef3c7;
        color: #92400e;
    }

    .cv-label.high {
        background: #fee2e2;
        color: #991b1b;
    }

    .cv-bar {
        position: relative;
        height: 40px;
        background: #e2e8f0;
        border-radius: 20px;
        margin-bottom: 10px;
        display: flex;
        overflow: hidden;
    }

    .cv-segment {
        height: 100%;
        transition: width 0.1s ease;
    }

    .cv-segment.low {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    }

    .cv-segment.mid {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .cv-segment.high {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    }

    .cv-handle {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 48px;
        background: white;
        border: 3px solid #555;
        border-radius: 8px;
        cursor: ew-resize;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        transition: box-shadow 0.2s, transform 0.1s;
    }

    .cv-handle:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .cv-handle:active {
        box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        transform: translate(-50%, -50%) scale(1.05);
    }

    .cv-handle::before {
        content: '\22EE';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #555;
        font-size: 14px;
        font-weight: bold;
    }

    .cv-scale {
        position: relative;
        height: 20px;
        font-size: 0.85em;
        color: #718096;
        margin-bottom: 15px;
    }

    .cv-scale span {
        position: absolute;
        transform: translateX(-50%);
    }

    .cv-scale span:first-child {
        left: 0;
        transform: translateX(0);
    }

    .cv-scale span:last-child {
        left: 100%;
        transform: translateX(-100%);
    }

    .cv-values {
        display: flex;
        justify-content: center;
        gap: 30px;
    }

    .cv-value-box {
        text-align: center;
        background: white;
        padding: 12px 20px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        min-width: 140px;
    }

    .cv-value-label {
        display: block;
        font-size: 0.8em;
        color: #718096;
        margin-bottom: 5px;
    }

    .cv-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #2d3748;
    }

    /* Purple submit button for this page */
    .submit-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .submit-btn:hover {
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .spinner {
        border-top-color: #667eea;
    }

    /* Info box - gray theme for this page */
    .info-box-gray {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        margin-bottom: 30px;
        overflow: hidden;
    }

    .info-box-gray .info-box-header:hover {
        background-color: #edf2f7;
    }

    .info-box-gray .info-box-title {
        font-weight: 600;
        color: #4a5568;
    }

    .info-box-gray .info-box-arrow {
        color: #718096;
    }

    .info-box-gray .info-box-body {
        padding: 0 20px 20px 20px;
        color: #4a5568;
        font-size: 0.95em;
        line-height: 1.6;
    }
</style>
{% endblock %}

{% block toast_container %}
{% include 'partials/_toast_container.html' %}
{% endblock %}

{% block content %}
<div class="container">
    <a href="/" class="back-btn">&larr; í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

    <h1>ğŸ“ˆ ê³ ë³€ë™ì„± ì•½í’ˆ ë³´ê³ ì„œ</h1>
    <p class="subtitle">ì›”ë³„ ì‚¬ìš©ëŸ‰ ë³€ë™ì„± ë¶„ì„</p>

    <div class="info-box-gray">
        <div class="info-box-header" onclick="toggleInfoBox()">
            <span class="info-box-title">ğŸ’¡ ì´ ë³´ê³ ì„œëŠ”?</span>
            <span class="info-box-arrow" id="info-box-arrow">â–¼</span>
        </div>
        <div class="info-box-content" id="info-box-content">
            <div class="info-box-body">
                ì›”ë³„ ì‚¬ìš©ëŸ‰ì˜ <b>ë³€ë™ê³„ìˆ˜(CV)</b>ë¥¼ ë¶„ì„í•˜ì—¬ ì¬ê³  ê´€ë¦¬ê°€ ì–´ë ¤ìš´ ì•½í’ˆì„ ì‹ë³„í•©ë‹ˆë‹¤.<br><br>
                <b>CV (Coefficient of Variation)</b> = í‘œì¤€í¸ì°¨ / í‰ê· <br><br>
                â€¢ CVê°€ ë†’ì„ìˆ˜ë¡ ì‚¬ìš©ëŸ‰ì´ ë“¤ì­‰ë‚ ì­‰í•©ë‹ˆë‹¤<br>
                â€¢ ê³ ë³€ë™ì„± ì•½í’ˆì€ ì•ˆì „ì¬ê³ ë¥¼ ë” ë§ì´ í™•ë³´í•´ì•¼ í•©ë‹ˆë‹¤<br>
                â€¢ ì‚°ì ë„ì—ì„œ ìš°ìƒë‹¨(ê³ ì‚¬ìš©ëŸ‰ + ê³ ë³€ë™ì„±) ì•½í’ˆì´ ê´€ë¦¬ ìš°ì„ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤
            </div>
        </div>
    </div>

    <form id="reportForm">
        <div class="form-group">
            <label>ì•½í’ˆ ìœ í˜• ì„ íƒ</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="dispense" name="mode" value="dispense" checked>
                    <label for="dispense">
                        <span class="radio-icon">ğŸ’Š</span>
                        <span class="radio-text">
                            <div class="radio-title">ì „ë¬¸ì•½</div>
                            <div class="radio-desc">ì¡°ì œìˆ˜ëŸ‰ ê¸°ì¤€</div>
                        </span>
                    </label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="sale" name="mode" value="sale">
                    <label for="sale">
                        <span class="radio-icon">ğŸ¥</span>
                        <span class="radio-text">
                            <div class="radio-title">ì¼ë°˜ì•½</div>
                            <div class="radio-desc">íŒë§¤ìˆ˜ëŸ‰ ê¸°ì¤€</div>
                        </span>
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>
                ë¶„ì„ ê¸°ê°„
                <span class="tooltip" title="ë¶„ì„ì— ì‚¬ìš©í•  ë°ì´í„° ê¸°ê°„ì„ ì„ íƒí•©ë‹ˆë‹¤.&#10;ìµœê·¼ Nê°œì›” ë°ì´í„°ë§Œ ì‚¬ìš©í•˜ì—¬ ë³€ë™ì„±ì„ ë¶„ì„í•©ë‹ˆë‹¤.">â“˜</span>
            </label>
            <div class="custom-dropdown" id="analysisPeriodDropdown">
                <div class="custom-dropdown-selected" onclick="toggleDropdown('analysisPeriodDropdown')">
                    ìµœê·¼ 12ê°œì›”
                </div>
                <div class="custom-dropdown-options">
                    <div class="custom-dropdown-option" data-value="0">ì „ì²´ ê¸°ê°„</div>
                    <div class="custom-dropdown-option" data-value="3">ìµœê·¼ 3ê°œì›”</div>
                    <div class="custom-dropdown-option" data-value="6">ìµœê·¼ 6ê°œì›”</div>
                    <div class="custom-dropdown-option" data-value="9">ìµœê·¼ 9ê°œì›”</div>
                    <div class="custom-dropdown-option selected" data-value="12">ìµœê·¼ 12ê°œì›”</div>
                    <div class="custom-dropdown-option" data-value="24">ìµœê·¼ 24ê°œì›”</div>
                </div>
            </div>
            <input type="hidden" name="analysis_period" id="analysisPeriod" value="12">
        </div>

        <div class="form-group">
            <label>
                CV ì„ê³„ê°’ ì„¤ì •
                <span class="tooltip" title="ë³€ë™ì„± ë¶„ë¥˜ ê¸°ì¤€ì„ ì„¤ì •í•©ë‹ˆë‹¤.&#10;â€¢ ê³ ë³€ë™ì„±: CV > ê³ /ì¤‘ ê²½ê³„&#10;â€¢ ì¤‘ë³€ë™ì„±: ì¤‘/ì € ê²½ê³„ â‰¤ CV â‰¤ ê³ /ì¤‘ ê²½ê³„&#10;â€¢ ì €ë³€ë™ì„±: CV < ì¤‘/ì € ê²½ê³„">â“˜</span>
            </label>
            <div class="cv-slider-container">
                <div class="cv-labels">
                    <span class="cv-label low">ğŸŸ¢ ì €ë³€ë™ì„±</span>
                    <span class="cv-label mid">ğŸŸ¡ ì¤‘ë³€ë™ì„±</span>
                    <span class="cv-label high">ğŸ”´ ê³ ë³€ë™ì„±</span>
                </div>
                <div class="cv-bar">
                    <div class="cv-segment low" id="segment-low"></div>
                    <div class="cv-segment mid" id="segment-mid"></div>
                    <div class="cv-segment high" id="segment-high"></div>
                    <div class="cv-handle" id="handle-mid" title="ì¤‘/ì € ê²½ê³„"></div>
                    <div class="cv-handle" id="handle-high" title="ê³ /ì¤‘ ê²½ê³„"></div>
                </div>
                <div class="cv-scale">
                    <span>0</span>
                    <span id="scale-mid">0.3</span>
                    <span id="scale-high">0.5</span>
                    <span>1.0+</span>
                </div>
                <div class="cv-values">
                    <div class="cv-value-box">
                        <span class="cv-value-label">ì¤‘/ì € ê²½ê³„</span>
                        <span class="cv-value" id="value-mid">0.30</span>
                    </div>
                    <div class="cv-value-box">
                        <span class="cv-value-label">ê³ /ì¤‘ ê²½ê³„</span>
                        <span class="cv-value" id="value-high">0.50</span>
                    </div>
                </div>
            </div>
            <input type="hidden" name="threshold_mid" id="threshold_mid" value="0.3">
            <input type="hidden" name="threshold_high" id="threshold_high" value="0.5">
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
            ğŸš€ ë³´ê³ ì„œ ìƒì„±í•˜ê¸°
        </button>
    </form>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="color: #718096;">ë³´ê³ ì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>
</div>
{% endblock %}

{% block component_scripts %}
<script src="{{ url_for('static', filename='js/components/toast.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/dropdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
<script src="{{ url_for('static', filename='js/components/shutdown.js') }}?v={{ config.get('VERSION', '1') }}"></script>
{% endblock %}

{% block page_scripts %}
<script>
    function toggleInfoBox() {
        var content = document.getElementById('info-box-content');
        var arrow = document.getElementById('info-box-arrow');
        content.classList.toggle('open');
        arrow.classList.toggle('open');
    }

    // CV Slider Logic
    (function() {
        var MAX_VALUE = 1.0;
        var STEP = 0.05;
        var midValue = 0.3;
        var highValue = 0.5;

        var bar = document.querySelector('.cv-bar');
        var handleMid = document.getElementById('handle-mid');
        var handleHigh = document.getElementById('handle-high');
        var segmentLow = document.getElementById('segment-low');
        var segmentMid = document.getElementById('segment-mid');
        var segmentHigh = document.getElementById('segment-high');
        var scaleMid = document.getElementById('scale-mid');
        var scaleHigh = document.getElementById('scale-high');
        var valueMidEl = document.getElementById('value-mid');
        var valueHighEl = document.getElementById('value-high');
        var inputMid = document.getElementById('threshold_mid');
        var inputHigh = document.getElementById('threshold_high');

        function updateUI() {
            var midPercent = (midValue / MAX_VALUE) * 100;
            var highPercent = (highValue / MAX_VALUE) * 100;

            segmentLow.style.width = midPercent + '%';
            segmentMid.style.width = (highPercent - midPercent) + '%';
            segmentHigh.style.width = (100 - highPercent) + '%';

            handleMid.style.left = midPercent + '%';
            handleHigh.style.left = highPercent + '%';

            scaleMid.textContent = midValue.toFixed(2);
            scaleHigh.textContent = highValue.toFixed(2);
            scaleMid.style.left = midPercent + '%';
            scaleHigh.style.left = highPercent + '%';

            valueMidEl.textContent = midValue.toFixed(2);
            valueHighEl.textContent = highValue.toFixed(2);

            inputMid.value = midValue.toFixed(2);
            inputHigh.value = highValue.toFixed(2);
        }

        function getValueFromPosition(clientX) {
            var rect = bar.getBoundingClientRect();
            var percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            return Math.round(percent * MAX_VALUE / STEP) * STEP;
        }

        function makeDraggable(handle, isMid) {
            var isDragging = false;

            function startDrag(e) {
                isDragging = true;
                e.preventDefault();
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
            }

            function doDrag(e) {
                if (!isDragging) return;

                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var newValue = getValueFromPosition(clientX);

                if (isMid) {
                    newValue = Math.max(STEP, Math.min(newValue, highValue - STEP));
                    midValue = newValue;
                } else {
                    newValue = Math.max(midValue + STEP, Math.min(newValue, MAX_VALUE - STEP));
                    highValue = newValue;
                }

                updateUI();
            }

            function endDrag() {
                isDragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }

            handle.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', endDrag);

            handle.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('touchend', endDrag);
        }

        makeDraggable(handleMid, true);
        makeDraggable(handleHigh, false);
        updateUI();
    })();

    // Form submission
    document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault();

        var submitBtn = document.getElementById('submitBtn');
        var loading = document.getElementById('loading');

        submitBtn.disabled = true;
        submitBtn.textContent = '\u23F3 ìƒì„± ì¤‘...';
        loading.classList.add('active');

        var formData = new FormData(this);

        fetch('/generate/volatility_report', {
            method: 'POST',
            body: formData
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                window.open(data.report_url, '_blank');

                submitBtn.disabled = false;
                submitBtn.textContent = '\uD83D\uDE80 ë³´ê³ ì„œ ìƒì„±í•˜ê¸°';
                loading.classList.remove('active');

                showToast('\u2705 ë³´ê³ ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else {
                throw new Error(data.message || 'ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨');
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            showToast('\u274C ë³´ê³ ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');

            submitBtn.disabled = false;
            submitBtn.textContent = '\uD83D\uDE80 ë³´ê³ ì„œ ìƒì„±í•˜ê¸°';
            loading.classList.remove('active');
        });
    });
</script>
{% endblock %}
